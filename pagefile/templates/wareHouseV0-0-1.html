<!DOCTYPE html>
<html style="background-color:#555555;">

<head>
    <meta charset="=" utf-8 />
    <title>SoulForged 庫存管理系統</title>
    <link rel="icon" href="https://i.ibb.co/nLFwC08/paper-06.png" type="image/png">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> -->
    <link href="{{url_for('static',filename='css/wareHouseStyleV0-0-1.css')}}" rel="stylesheet" />
    <!-- <link href="/pagefile/static/css/mapStyleV1-0-4.css" rel="stylesheet" /> -->
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
        integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <!-- <script type="text/javascript" src="{{url_for('static',filename='js/jquery.min.js')}}"></script> -->
    <script type="text/javascript">
        var itemTypeTranslate = {'tool': '工具', 'woodcutting': '原木', 'carpentry': '木材', 'corpse': '屍體', 'doctoring': '屠宰', 'equipment': '防具',
            'medical': '藥品', 'smithing': '鍛造', 'mining': '礦石', 'cooked': '食品', 'foraging': '作物', 'gathering': '蒐集', 'furniture': '家俱', 'other': '其他'};
        var langCompared = {
            "checkUpdate":{"zh":"有新版本可用，需要重新載入網頁，是否現在更新？","en":"A new version is available. The page needs to be reloaded. Would you like to update now?"},
            "idShowAt":{"zh":" 已存在於 ","en":" has already been paired with "},
            "pleaseEdit":{"zh":" 請更正或清除錯誤的ID","en":". Please correct or clear the incorrect Node ID."},
            "unMatchedCre":{"zh":"未知生物：","en":"Unmatched Creatures"},
            "unMatchedRes":{"zh":"未知資源：","en":"Unmatched Resources"},
            "unMatchedInv":{"zh":"未知道具：","en":"Unmatched Item"},
            "cantFind":{"zh":"找不到","en":"Not in the list"},
            "cancelConfirm":{"zh":"尚未完成資源登錄，確認放棄新增?","en":"Resource pairing is not yet complete. Confirm to abandon the addition?"},
            "issueConfirm":{"zh":"將暫停本次新增，並將資料提交給管理者鑑別後再匯入。確認執行?","en":"Data import will be canceled, and the data will be submitted to the administrator for verification before re-importing. Confirm execution?"},
            "uploading":{"zh":"資料上傳中...","en":"Data submission in progress..."},
            "success":{"zh":"成功上傳","en":"Submission successful"},
            "dataErr":{"zh":"資料錯誤，將於管理員審查完成後再登錄","en":"Data anomaly detected. The data will be imported after the administrator's review is complete."},
            "inputErr":{"zh":"資料不合規","en":"Data is non-compliant"},
            "nodeUnmatch":{"zh":"未被記錄，請點選節點","en":" has not yet been paired. Please specify the node location."},
            "pathConfirm":{"zh":"所有資料已讀取，請確認路徑是否正確?","en":"Data has been successfully parsed. Please confirm if the node to be imported is correct?"},
            "search":{"zh":"搜尋","en":"Search"},
            "fill":{"zh":"中心填充","en":"Fill"},
            "border":{"zh":"邊框色彩","en":"Broder"},
            "creature":{"zh":"生物","en":"Creatures"},
            "resource":{"zh":"資源","en":"Resources"},
            "item":{"zh":"地上物品","en":"Item"},
            "renewTime":{"zh":"更新時間","en":"Update Interval"},
            "newest":{"zh":"最新記錄","en":"Latest"},
            "ever":{"zh":"曾經出現","en":"Ever"},
            "highest":{"zh":"過往最高","en":"Highest"},
            "lowest":{"zh":"過往最低","en":"Lowest"},
            "creatureList":{"zh":"生物列表","en":"Creatures List"},
            "resourceList":{"zh":"資源列表","en":"Resources List"},
            "itemList":{"zh":"物品列表","en":"Item List"},
            "filterByCategory":{"zh":"依類別篩選","en":"Filter by category"},
            "filterByName":{"zh":"依名稱篩選","en":"Filter by name"},
            "note":{"zh":"備註","en":"Note"},
            "add":{"zh":"新增","en":"Add"},
            "state":{"zh":"狀態","en":"State"},
            "active":{"zh":"主動","en":"Active"},
            "passive":{"zh":"被動","en":"Passive"},
            "quentity":{"zh":"數量","en":"Quentity"},
            "ok":{"zh":"確認","en":"OK"},
            "cancel":{"zh":"取消","en":"Cancel"},
            "del":{"zh":"刪除","en":"Del"},
            "full":{"zh":"滿","en":"Maximum"},
            "substantial":{"zh":"好","en":"Substantial"},
            "partial":{"zh":"差","en":"Partial"},
            "empty":{"zh":"劣","en":"Minimal"},
            "none":{"zh":"無","en":"Empty"},
            "submit":{"zh":"提交","en":"Submit"},
            "setAsDefault":{"zh":"設定","en":"Set as default"},
            "switchLanguage":{"zh":"切換語言","en":"Language"},
            "guide":{"zh":"說明文件","en":"How to use"},
            "entry":{"zh":"進入","en":"Entry"},
            "lastUpdate":{"zh":"更新時間","en":"Last update"},
            "noRecord":{"zh":"尚無資料紀錄，預設內容僅供參考","en":"No data records available; default content is for reference only."},
            "day":{"zh":"天","en":"day"},
            "hour":{"zh":"小時","en":"hr"},
            "min":{"zh":"分鐘前)","en":"min ago.)"},
            "by":{"zh":"由","en":"record by"},
            "record":{"zh":"記錄","en":""},
            "switchTo":{"zh":"切換為","en":"Switch to"},
            "nodeId":{"zh":"節點ID","en":"Node ID"},
            "hide":{"zh":"隱藏","en":"Hide"},
            "show":{"zh":"顯示","en":"Show"},
            "edit":{"zh":"編輯地圖","en":"Edit map"},
            "node":{"zh":"節點","en":"Node"},
            "route":{"zh":"路徑","en":"Route"},
            "prefix":{"zh":"前綴","en":"Prefix"},
            "suffix":{"zh":"後綴","en":"Suffix"},
            "done":{"zh":"完成","en":"Done"},
            "color":{"zh":"顏色","en":"Color"},
            "type":{"zh":"類型","en":"Type"},
            "mainstream":{"zh":"幹道","en":"Mainstream"},
            "sidetrack":{"zh":"支線","en":"Sidetrack"},
            "defaultNode":{"zh":"起始節點","en":"Default Node"},
            "nodeScaleSwitch":{"zh":"節點縮放","en":"Node Scale"},
            "nodeUnavilible":{"zh":"節點不存在","en":"The node does not exist"},
            "whitchNode":{"zh":"請輸入想尋找的NodeID","en":"Please enter the NodeID you wish to search for."},
            "delRouteConfirm":{"zh":"確認要刪除路徑","en":"Are you sure you want to delete the route "},
            "serverErr":{"zh":"伺服器連線異常，資料傳遞失敗","en":"Server connection is abnormal, data transmission failed."},
            "routeRepeat":{"zh":"路徑已存在，是否取代","en":"The path already exists, do you want to replace it?"},
            "delCheck":{"zh":"確定要刪除","en":"Are you sure you want to delete "},
            "entryPrefix":{"zh":"請輸入前綴","en":"Please enter the prefix."},
            "prefixErr":{"zh":"前綴僅能使用英文字母","en":"The prefix can only use English letters."},
            "suffixErr":{"zh":"後綴僅能使用英文字母","en":"The suffix can only use English letters."},
            "nodeRepeat":{"zh":"這個編碼方式已使用於","en":"This encoding method has been used in "},
            "yourName":{"zh":"是否要留下名稱，讓大家記得你的貢獻","en":"Would you like to leave your name so everyone will remember your contribution"},
            "display":{"zh":"檢視參數","en":"View Parameters"}

        }
        var animalList = [];
        var animalUrl = {};
        var carpentryUrl = {};
        var cookedUrl = {};
        var corpseUrl = {};
        var doctoringUrl = {};
        var furnitureUrl = {};
        var equipmentUrl = {};
        var foragingUrl = {};
        var gatheringUrl = {};
        var medicalUrl = {};
        var miningUrl = {};
        var otherUrl = {};
        var smithingUrl = {};
        var toolUrl = {};
        var woodCuttingUrl = {};
        var sacleRatio = 1;
        var rawData = [];
        var posisionDataMain = {};
        var posisionDataMH = {};
        var posisionDataTT = {};
        var hisData = {}
        var scaleModify = 1
        var userName = '';
        var funcNow = '';
        var indexNow = '';
        var nameNow = ''
        var typeNow = '';
        var userName = '';
        var urlFunc = ''
        var settingSelValue = '';
        var settingSelDOM = '';
        var settingInputDOM = '';
        var searchMethodState = 'type';
        var searchedName = '';
        var urlNow = '';
        var langNow = 'zh';
        var mapId = 'Main';
        var routeWidth = '2px';
        var continueAddState = 1;
        var routeNodePair = [];
        var routeColorSetting = '#ff0000';
        var routeType = 'mainstream';
        var defNodeId = '';
        var mapRouteMain = [];
        var mapRouteMH = [];
        var mapRouteTT = [];
        var editMapRoute = 0;
        var editMapNode = 0;
        var aimState = 0;
        var editdefaultNode = 0;
        var routeData = [];
        var searchSlot = {}
        var loadingCount = 0
        var tempSearchSlot = {}
        var jsonFromBackend = {}
        var oriDataSet = {};
        var nodeScaleNow = 1;
        var loadDoneState = 0;
        var center = {x: 0, y: 0};
        var jsonData = {}
        var recordNodeList = [];
        var nodeMaping = {};
        var indoorState = 0;
        var transformedData = [];
        var pasteData = {}
        var verifiedData = []
        var resDataDict = {}
        var creDataDict = {}
        var invDataDict = {}
        var tempRes = {}
        var tempCre = {}
        var tempInv = {}
        var lastSearchSlot = {}
        var lastnodeMaping = {}
        var fetchData = {}
        var formedInputData = {'input':{'owner':{},'shared':{}},'output':{'owner':{},'shared':{},'unAssignConflict':{},'force':{},'notMe':{}}}
        var houseId = ''
        var jsonImportState = 0
        var waitForClickNode = 0;
        var mesStr = '成功上傳'
        var pageIconSize = '50px';
        var pageFontSize = ''
        var errState = 0;
        var allItemUrl = {}
        var assignDataDict = {};
        var version = '0-0-1';
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function getWareHouseData(){
            $('#waitMessage').css({'visibility':'visible'})
            $('body').css({'visibility':'hidden'})
            $('#syncDiv').css({border:'#fdb75c solid 5px'});
            let formData = new FormData();
            formData.append('houseId',houseId);
            fetch('/getWareHouseData', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if(response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Server response was not ok: ' + response.statusText);
                    }
                })
                .then(data => {
                    let dataFromBackend = JSON.parse(data.replace(/'/g,'"'))
                    try{
                        if(dataFromBackend['ver'] != version){
                            let update = confirm('有新版本可用，需要重新載入網頁，是否現在更新？');
                            if (update) {
                                // 如果用戶選擇更新，則重新整理網頁
                                window.location.reload();
                            }
                            else{
                                $('#waitMessage').css({'visibility':'hidden'})
                                $('body').css({'visibility':'visible'})
                            }
                        }
                        else{
                            $('#infoPage').html('')
                            if(dataFromBackend['dbData'] == 'None')fetchData = {
                                "houseId": "1799541",
                                "resident": [
                                    "koen",
                                    "meatrose",
                                    "jadefish"
                                ],
                                "INV":{}
                            }
                            else fetchData = dataFromBackend['dbData']
                            console.log(fetchData)
                            function formatToLocalTime(timestamp) {
                                let date = new Date(timestamp);
                                return date.toLocaleString(); // 轉換為本地時間格式
                            }
                            let laseUpdateStr = ''
                            if('lastUpdate' in fetchData) laseUpdateStr = formatToLocalTime(fetchData['lastUpdate']);
                            else laseUpdateStr = '尚無資料紀錄'
                            $('#infoPage').css({left: '10px',top: '80px',right: '10px'})
                                .append($('<div>',{id:'showTimeStr'}).html(laseUpdateStr))
                                .append($('<div>', {id:'dataContener', class: "nodeDataArea" }))
                            for(onwer of fetchData['resident']){
                                $('#dataContener').append($('<div>', {id:'userDiv'+onwer, class: "nodeDataAreaTitle" }).append(onwer))
                                    .append($('<div>', { id:'itemShowDiv'+onwer, class: "nodeDataAreaContent" }))
                                $('#userDiv'+onwer).hide()
                                for(item in fetchData['INV']){
                                    if(onwer in fetchData['INV'][item]){
                                        let figPath = allItemUrl[item]
                                        $('#itemShowDiv'+onwer).append($('<div>', {id:'fig'+item.replace(/ /g,'').replace(/-/g,'')+onwer, class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                                            .append($('<img>', { class:'itemFig',src: figPath }))
                                            .append($('<div>', {
                                                    class: "itemQty blackBorder",
                                                    style: "cursor: auto;"
                                                }
                                            ).append(fetchData['INV'][item][onwer]))
                                        )
                                        $('#userDiv'+onwer).show()  
                                        let itemName = item
                                        $('#fig'+itemName.replace(/ /g,'').replace(/-/g,'')+onwer).mouseenter(function(e) {
                                            $('.info-tag').text(itemName).css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                                        }).mouseleave(function() {
                                            $('.info-tag').hide();
                                        });
                                    }
                                }
                                
                            }
                            $('#dataContener').append($('<div>', {id:'userDivshared', class: "nodeDataAreaTitle" }).append('公共物品'))
                                .append($('<div>', { id:'itemShowDivshared', class: "nodeDataAreaContent" }))
                            $('#userDivshared').hide()
                            for(item in fetchData['INV']){
                                if('shared' in fetchData['INV'][item]){
                                    let figPath = allItemUrl[item]
                                    $('#itemShowDivshared').append($('<div>', {id:'fig'+item.replace(/ /g,'').replace(/-/g,'')+'shared', class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                                        .append($('<img>', { class:'itemFig',src: figPath }))
                                        .append($('<div>', {
                                                class: "itemQty blackBorder",
                                                style: "cursor: auto;"
                                            }
                                        ).append(fetchData['INV'][item]['shared']))
                                    )
                                    $('#userDivshared').show()
                                    let itemName = item
                                    $('#fig'+itemName.replace(/ /g,'').replace(/-/g,'')+'shared').mouseenter(function(e) {
                                        $('.info-tag').text(itemName).css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                                    }).mouseleave(function() {
                                        $('.info-tag').hide();
                                    });
                                }
                                    
                            }
                            $('#dataContener').append($('<div>', {id:'userDivconflict', class: "nodeDataAreaTitle" }).append('未處理異常'))
                                .append($('<div>', { id:'itemShowDivconflict', class: "nodeDataAreaContent" }))
                            $('#userDivconflict').hide()
                            for(item in fetchData['INV']){
                                if('conflict' in fetchData['INV'][item]){
                                    let figPath = allItemUrl[item]
                                    $('#itemShowDivconflict').append($('<div>', {id:'fig'+item.replace(/ /g,'').replace(/-/g,'')+'conflict', class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                                        .append($('<img>', { class:'itemFig',src: figPath }))
                                        .append($('<div>', {
                                                class: "itemQty blackBorder"
                                            }
                                        ).append(fetchData['INV'][item]['conflict']))
                                    )
                                    $('#userDivconflict').show()
                                    let itemName = item
                                    $('#fig'+itemName.replace(/ /g,'').replace(/-/g,'')+'conflict').mouseenter(function(e) {
                                        $('.info-tag').text(itemName).css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                                    }).mouseleave(function() {
                                        $('.info-tag').hide();
                                    });
                                }
                                    
                            }


                            
                            $('#waitMessage').css({'visibility':'hidden'})
                            $('body').css({'visibility':'visible'})
                            $('#infoPage').show()
                            $('#syncDiv').css({border:'#00ff00 solid 5px'});
                            setTimeout(function() {
                                $('#syncDiv').css({border:'#000000 solid 5px'});
                            },5000)
                        }
                    }
                    catch{
                        throw new Error('Server response was not expected: ' + data);
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert(langCompared['serverErr'][langNow]);
                });
        }
        function jsonDataParse(){

        }
        function init() {
            $('#jsonInputDiv').hide();
            if (isMobileDevice()) {
                pageIconSize = '200px';
                pageFontSize = '45px';
                $('<style>')
                    .prop('type', 'text/css')
                    .appendTo('head');
                $('style').append("#waitMessage{font-size:90px;}")
                $('style').append(".loader{border: 20px solid #f3f3f3;border-top: 20px solid #bbbbbb;width: 100px;height: 100px;}")
            }
            urlNow = new URL(location.href);
            if(urlNow.searchParams.has('user'))userName = urlNow.searchParams.get('user')
            if(urlNow.searchParams.has('houseId'))houseId = urlNow.searchParams.get('houseId')
            
            jsonFromBackend = JSON.parse($('#getDataDiv').html().replace(/'/g, '"'))
            jsonData = jsonFromBackend['jsonData']
            nodeMaping = jsonFromBackend['nodeMaping']
            recordNodeList = Object.values(nodeMaping);
            lastnodeMaping = JSON.parse(JSON.stringify(nodeMaping))
            invDataDict = jsonFromBackend['invMaping']
            tempInv = JSON.parse(JSON.stringify(invDataDict))
            for(type in jsonData){
                for(item in jsonData[type]){
                    let name = item.replace(/-/g,' ').replace(/Red eyed/g,'Red-eyed');
                    allItemUrl[name] = jsonData[type][item]
                }
            }
            animalList = jsonData['animalList']
            animalUrl = jsonData['animalUrl']
            carpentryUrl = jsonData['carpentryUrl']
            cookedUrl = jsonData['cookedUrl']
            corpseUrl = jsonData['corpseUrl']
            doctoringUrl = jsonData['doctoringUrl']
            furnitureUrl = jsonData['furnitureUrl']
            equipmentUrl = jsonData['equipmentUrl']
            foragingUrl = jsonData['foragingUrl']
            gatheringUrl = jsonData['gatheringUrl']
            medicalUrl = jsonData['medicalUrl']
            miningUrl = jsonData['miningUrl']
            otherUrl = jsonData['otherUrl']
            smithingUrl = jsonData['smithingUrl']
            toolUrl = jsonData['toolUrl']
            woodCuttingUrl = jsonData['woodCuttingUrl']

            getWareHouseData();
            // $('body').css({backgroundColor:'#777777'})
            

        }
        function setItem(func, index = '') {
            function appendItemImage(itemIndex, dataList) {
                let figPath = dataList[itemIndex]['url'];
                let name = dataList[itemIndex]['name'];

                let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                    .append($('<img>', { class: "itemFig", src: figPath })
                        .click(function () {
                            let repeatItemIndex = '';
                            for(lastDBItemIndex in rawData[nodeNow]['item']){
                                if(rawData[nodeNow]['item'][lastDBItemIndex]['name'] == dataList[itemIndex]['name']){
                                    repeatItemIndex = lastDBItemIndex;
                                }
                            }
                            if(repeatItemIndex == ''){
                                $('#saveBTN').show();
                                nameNow = dataList[itemIndex]['name']
                                $('#optionDataDiv').hide();
                                $('#searchDiv').hide();
                                $('#optionTitleDiv').hide();
                                $('#itemTitleDiv').show();
                                $('#itemDataDiv').show();
                                $('#itemDataDiv').html('');
                                $('#itemDataDiv')
                                    // .append($('<div>', { class: "nodeDataSet" })
                                    //     .append($('<button>', { id: 'delBTN' }).append(langCompared['del'][langNow]))
                                    // )
                                    .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                        .append($('<img>', { id: "itemFig", class: "itemFig", src: figPath }))
                                        .append($('<div>', { id: 'stateDiv', class: 'itemQty' }))
                                    )
                                    .append($('<div>', { class: "qtyDiv"})
                                        .append('數量')
                                        .append($('<input>', { id: 'quentity', type: "number" }))
                                    )
                                
                                $('#quentity').keyup(function () {
                                    $('#stateDiv').html($('#quentity').val())
                                })
                                $('#saveBTN').click(function () {
                                    let oneItemData = {
                                        'name': dataList[itemIndex]['name'],
                                        'quentity': Number($('#quentity').val())
                                    }
                                    rawData[nodeNow]['item'].push(oneItemData)
                                    nodeOnclick(nodeNow);
                                    $('#settingPage').hide();
                                    $('#infoPage').show();
                                    settingInputDOM = ''
                                    settingSelDOM = ''
                                })
                                $('#delBTN').click(function () {
                                    $('#itemDataDiv').html('');
                                    $('#optionDataDiv').show();
                                    $('#searchDiv').show();
                                    $('#optionTitleDiv').show();
                                    $('#itemTitleDiv').hide();
                                    $('#itemDataDiv').hide();
                                    settingInputDOM = ''
                                    settingSelDOM = ''
                                })
                                $("#quentity").focus();
                            }
                            else setItem('edit','item',repeatItemIndex)
                        })
                    );


            let allItem = [];
            for (i in cookedUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'cooked'
                oneDict['url'] = cookedUrl[i]
                allItem.push(oneDict)
            }
            for (i in corpseUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'corpse'
                oneDict['url'] = corpseUrl[i]
                allItem.push(oneDict)
            }
            for (i in furnitureUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'furniture'
                oneDict['url'] = furnitureUrl[i]
                allItem.push(oneDict)
            }
            for (i in doctoringUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'doctoring'
                oneDict['url'] = doctoringUrl[i]
                allItem.push(oneDict)
            }
            for (i in equipmentUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'equipment'
                oneDict['url'] = equipmentUrl[i]
                allItem.push(oneDict)
            }
            for (i in foragingUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'foraging'
                oneDict['url'] = foragingUrl[i]
                allItem.push(oneDict)
            }
            for (i in gatheringUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'gathering'
                oneDict['url'] = gatheringUrl[i]
                allItem.push(oneDict)
            }
            for (i in medicalUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'medical'
                oneDict['url'] = medicalUrl[i]
                allItem.push(oneDict)
            }
            for (i in miningUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'mining'
                oneDict['url'] = miningUrl[i]
                allItem.push(oneDict)
            }
            for (i in otherUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'other'
                oneDict['url'] = otherUrl[i]
                allItem.push(oneDict)
            }
            for (i in toolUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'tool'
                oneDict['url'] = toolUrl[i]
                allItem.push(oneDict)
            }
            for (i in carpentryUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'carpentry'
                oneDict['url'] = carpentryUrl[i]
                allItem.push(oneDict)
            }
            for (i in woodCuttingUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'woodcutting'
                oneDict['url'] = woodCuttingUrl[i]
                allItem.push(oneDict)
            }
            for (i in smithingUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'smithing'
                oneDict['url'] = smithingUrl[i]
                allItem.push(oneDict)
            }
            filtiedResource(allItem);

            funcNow = func
            indexNow = index
            $('.info-tag').hide();
            $('#settingPage').html('')
            $('#saveBTN').hide();
            let itemSel = ''
            $('#itemTitleDiv').hide();
            $('#itemDataDiv').hide();
            $('#itemDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
            $('#itemDataDiv').after(
                $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0" })
                    .append($('<div>', { id: 'searchMethodDiv', style: "font-size:20px" }).append(langCompared['filterByCategory'][langNow]))
                    .append($('<select>', { id: 'typeSel', class: "qtyDiv", style: " padding:0px; height:30px" }))
                    .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                    .append($('<button>', { id: 'backBTN', style: 'width: auto;' }).append(langCompared['switchTo'][langNow]+langCompared['filterByName'][langNow]).click(function () {
                        if (searchMethodState == 'type') {
                            $('#optionDataDiv').html('');
                            searchMethodState = 'name';
                            $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByCategory'][langNow])
                            $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                            $('#typeSel').hide()
                            $('#searchInput').show()
                        }
                        else {
                            $('#searchInput').val('');
                            let allItem = [];
                            for (i in cookedUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'cooked'
                                oneDict['url'] = cookedUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in corpseUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'corpse'
                                oneDict['url'] = corpseUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in furnitureUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'furniture'
                                oneDict['url'] = furnitureUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in doctoringUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'doctoring'
                                oneDict['url'] = doctoringUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in equipmentUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'equipment'
                                oneDict['url'] = equipmentUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in foragingUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'foraging'
                                oneDict['url'] = foragingUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in gatheringUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'gathering'
                                oneDict['url'] = gatheringUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in medicalUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'medical'
                                oneDict['url'] = medicalUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in miningUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'mining'
                                oneDict['url'] = miningUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in otherUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'other'
                                oneDict['url'] = otherUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in toolUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'tool'
                                oneDict['url'] = toolUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in carpentryUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'carpentry'
                                oneDict['url'] = carpentryUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in woodCuttingUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'woodcutting'
                                oneDict['url'] = woodCuttingUrl[i]
                                allItem.push(oneDict)
                            }
                            for (i in smithingUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'smithing'
                                oneDict['url'] = smithingUrl[i]
                                allItem.push(oneDict)
                            }
                            filtiedResource(allItem);
                            searchMethodState = 'type';
                            $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByName'][langNow])
                            $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                            $('#typeSel').show()
                            $('#searchInput').hide()
                        }

                    }))
            )
            if (searchMethodState == 'name') {
                $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByCategory'][langNow])
                $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                $('#typeSel').hide()
                $('#searchInput').show()
            }
            else {
                $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByName'][langNow])
                $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                $('#typeSel').show()
                $('#searchInput').hide()
            }
            $('#itemDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle", style: "font-size:20px" }).append(langCompared['itemList'][langNow]))
            for (i in itemTypeTranslate) {
                if(langNow == 'zh') $('<option>', { value: i }).append(itemTypeTranslate[i]).appendTo($('#typeSel'))
                else if(langNow == 'en') $('<option>', { value: i }).append(i).appendTo($('#typeSel'))
            }
            

                // 綁定 mouseenter 和 mouseleave 事件
                newDiv.mouseenter(function(e) {
                    $('.info-tag').text(name)
                                .css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                }).mouseleave(function() {
                    $('.info-tag').hide();
                });

                $('#optionDataDiv').append(newDiv);
            }
            function filtiedResource(dataList) {
                $('#optionDataDiv').html('')
                for (var i = 0; i < dataList.length; i++) {
                    if (dataList[i]['type'] == $('#typeSel').val()) appendItemImage(i, dataList);
                }

            }
            let allItem = [];
            for (i in cookedUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'cooked'
                oneDict['url'] = cookedUrl[i]
                allItem.push(oneDict)
            }
            for (i in corpseUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'corpse'
                oneDict['url'] = corpseUrl[i]
                allItem.push(oneDict)
            }
            for (i in furnitureUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'furniture'
                oneDict['url'] = furnitureUrl[i]
                allItem.push(oneDict)
            }
            for (i in doctoringUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'doctoring'
                oneDict['url'] = doctoringUrl[i]
                allItem.push(oneDict)
            }
            for (i in equipmentUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'equipment'
                oneDict['url'] = equipmentUrl[i]
                allItem.push(oneDict)
            }
            for (i in foragingUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'foraging'
                oneDict['url'] = foragingUrl[i]
                allItem.push(oneDict)
            }
            for (i in gatheringUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'gathering'
                oneDict['url'] = gatheringUrl[i]
                allItem.push(oneDict)
            }
            for (i in medicalUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'medical'
                oneDict['url'] = medicalUrl[i]
                allItem.push(oneDict)
            }
            for (i in miningUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'mining'
                oneDict['url'] = miningUrl[i]
                allItem.push(oneDict)
            }
            for (i in otherUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'other'
                oneDict['url'] = otherUrl[i]
                allItem.push(oneDict)
            }
            for (i in toolUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'tool'
                oneDict['url'] = toolUrl[i]
                allItem.push(oneDict)
            }
            for (i in carpentryUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'carpentry'
                oneDict['url'] = carpentryUrl[i]
                allItem.push(oneDict)
            }
            for (i in woodCuttingUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'woodcutting'
                oneDict['url'] = woodCuttingUrl[i]
                allItem.push(oneDict)
            }
            for (i in smithingUrl) {
                let oneDict = {}
                oneDict['name'] = i.replace(/-/g, ' ')
                oneDict['type'] = 'smithing'
                oneDict['url'] = smithingUrl[i]
                allItem.push(oneDict)
            }

            $('#infoPage').hide();
            $('#settingPage').show();
            // if(type == 'item'){
            //     $("#quentity").focus();
            // }
        }

        function customSort(a, b) {
            var regex = /(\D+)(\d+)/; // 匹配開頭的字母和隨後的數字

            var matchA = a.match(regex);
            var matchB = b.match(regex);

            if (matchA && matchB) {
                var prefixA = matchA[1];
                var numberA = parseInt(matchA[2], 10);
                
                var prefixB = matchB[1];
                var numberB = parseInt(matchB[2], 10);

                // 先比較字母部分
                if (prefixA < prefixB) return -1;
                if (prefixA > prefixB) return 1;

                // 字母部分相同，比較數字部分
                return numberA - numberB;
            }
            
            return a.localeCompare(b); // 如果不匹配，直接比較整個字符串
        }
        function submit(){
            if(Object.keys(formedInputData['output']['unAssignConflict']).length != 0)alert('請設定領出「其他」欄位的黑框項目')
            else{
                $('#waitMessage').css({'visibility':'visible'})
                $('body').css({'visibility':'hidden'})
                let formData = new FormData();
                formData.append('houseId',houseId);
                formData.append('user',userName);
                formData.append('data',JSON.stringify(formedInputData));
                console.log(formedInputData)
                formData.append('timestamp',transformedData[0]['timestamp']);
                fetch('/importWareHouseData', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if(response.ok) {
                            getWareHouseData()
                        } else {
                            alert('傳輸失敗')
                        }
                    })
            }
                
        }
        function parseData(){
            $('#waitMessage').css({'visibility':'visible'})
            $('body').css({'visibility':'hidden'})
            let formData = new FormData();
            formData.append('houseId',houseId);
            fetch('/getWareHouseData', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if(response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Server response was not ok: ' + response.statusText);
                    }
                })
                .then(data => {
                    
                    try{
                        dataFromBackend = JSON.parse(data.replace(/'/g,'"'))
                        if(dataFromBackend['ver'] != version){
                            let update = confirm('有新版本可用，需要重新載入網頁，是否現在更新？');
                            if (update) {
                                // 如果用戶選擇更新，則重新整理網頁
                                window.location.reload();
                            }
                            else{
                                $('#waitMessage').css({'visibility':'hidden'})
                                $('body').css({'visibility':'visible'})
                            }
                        }
                        else{
                            $('#infoPage').html('')
                            if(dataFromBackend['dbData'] == 'None')fetchData = {
                                "houseId": "2331593",
                                "resident": [
                                    "Koen",
                                    "Meatrose",
                                    "JadeFish"
                                ],
                                "INV":{}
                            }
                            else fetchData = dataFromBackend['dbData']
                            console.log(fetchData)
                            function formatToLocalTime(timestamp) {
                                let date = new Date(timestamp);
                                return date.toLocaleString(); // 轉換為本地時間格式
                            }
                            let laseUpdateStr = ''
                            if('lastUpdate' in fetchData) laseUpdateStr = formatToLocalTime(fetchData['lastUpdate']);
                            else laseUpdateStr = '尚無資料紀錄'
                            $('#infoPage').css({left: '10px',top: '80px',right: '10px'})
                                .append($('<div>',{id:'showTimeStr'}).html(laseUpdateStr))
                                .append($('<div>', {id:'dataContener', class: "nodeDataArea" }))
                            for(onwer of fetchData['resident']){
                                $('#dataContener').append($('<div>', {id:'userDiv'+onwer, class: "nodeDataAreaTitle" }).append(onwer))
                                    .append($('<div>', { id:'itemShowDiv'+onwer, class: "nodeDataAreaContent" }))
                                $('#userDiv'+onwer).hide()
                                for(item in fetchData['INV']){
                                    if(onwer in fetchData['INV'][item]){
                                        let figPath = allItemUrl[item]
                                        $('#itemShowDiv'+onwer).append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                                            .append($('<img>', { class:'itemFig',src: figPath }))
                                            .append($('<div>', {
                                                    class: "itemQty blackBorder",
                                                    style: "cursor: auto;"
                                                }
                                            ).append(fetchData['INV'][item][onwer]))
                                        )
                                        $('#userDiv'+onwer).show()  
                                    }
                                }
                                
                            }
                            $('#dataContener').append($('<div>', {id:'userDivshared', class: "nodeDataAreaTitle" }).append('公共物品'))
                                .append($('<div>', { id:'itemShowDivshared', class: "nodeDataAreaContent" }))
                            $('#userDivshared').hide()
                            for(item in fetchData['INV']){
                                if('shared' in fetchData['INV'][item]){
                                    let figPath = allItemUrl[item]
                                    $('#itemShowDivshared').append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                                        .append($('<img>', { class:'itemFig',src: figPath }))
                                        .append($('<div>', {
                                                class: "itemQty blackBorder",
                                                style: "cursor: auto;"
                                            }
                                        ).append(fetchData['INV'][item]['shared']))
                                    )
                                    $('#userDivshared').show()
                                }
                                    
                            }
                            $('#dataContener').append($('<div>', {id:'userDivconflict', class: "nodeDataAreaTitle" }).append('未處理異常'))
                                .append($('<div>', { id:'itemShowDivconflict', class: "nodeDataAreaContent" }))
                            $('#userDivconflict').hide()
                            for(item in fetchData['INV']){
                                if('conflict' in fetchData['INV'][item]){
                                    let figPath = allItemUrl[item]
                                    $('#itemShowDivconflict').append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                                        .append($('<img>', { class:'itemFig',src: figPath }))
                                        .append($('<div>', {
                                                class: "itemQty blackBorder"
                                            }
                                        ).append(fetchData['INV'][item]['conflict']))
                                    )
                                    $('#userDivconflict').show()
                                }
                                    
                            }


                            
                            $('#waitMessage').css({'visibility':'hidden'})
                            $('body').css({'visibility':'visible'})
                            $('#infoPage').show()
                            $('#syncDiv').css({border:'#00ff00 solid 5px'});
                            let paste = $('#jsonStrInput').val();
                            transformedData = [];
                            let errState = 0
                            if(paste !== ''){

                                try {
                                    $('#waitMessage').css({'visibility':'visible'})
                                    $('body').css({'visibility':'hidden'})
                                    pasteData = JSON.parse(paste);
                                    // 轉換格式
                                    for(nodeId in pasteData['loc']){
                                        if('indoors' in pasteData['loc'][nodeId] == false){
                                            // mappingIndoorINV()
                                            continue
                                        }
                                        let oneNodeResult = {};
                                        oneNodeResult['Data'] = {}
                                        oneNodeResult['timestamp'] = pasteData['loc'][nodeId]['timestamp'];
                                        let localItemArray = []
                                        for (invId of pasteData['loc'][nodeId]['inventory']) {
                                            try {
                                                if (pasteData['inv'][invId]['durabilityStageName'] != 'Ruined' && pasteData['inv'][invId]['durabilityStageName'] != 'Rotten' && pasteData['inv'][invId]['name'].includes('Trophy') == false && pasteData['inv'][invId]['name'].includes('Research problem') == false) {
                                                    let oneData = {}
                                                    oneData['id'] = pasteData['inv'][invId]['icon'].substring(9, pasteData['inv'][invId]['icon'].lastIndexOf('.'))
                                                    oneData['name'] = pasteData['inv'][invId]['name'].substring(pasteData['inv'][invId]['name'].lastIndexOf(':') + 1, pasteData['inv'][invId]['name'].lastIndexOf('}'))
                                                    oneData['amount'] = pasteData['inv'][invId]['amount']
                                                    localItemArray.push(oneData)
                                                }
                                            }
                                            catch (e) {
                                                console.log(invId,e)
                                            }
                                        }
                                        oneNodeResult['Data']['INV'] = localItemArray;
                                        oneNodeResult['nodeId'] = nodeId;
                                        transformedData.push(oneNodeResult);
                                    }
                                    $('#jsonInputDiv').hide();
                                    $('#jsonStrInput').val('');
                                    jsonImportState = 0;
                                    $('#importDiv').css({border:'solid #000000 5px'});
                                } 
                                catch (e) {
                                    errState = 1
                                    console.log(e)
                                    alert(langCompared['inputErr'][langNow]);
                                }
                                $('#jsonStrInput').val('');
                                if(errState == 0){
                                    console.log(transformedData)
                                    parsingItemData();
                                }
                            }
                            $('#waitMessage').css({'visibility':'hidden'})
                            $('body').css({'visibility':'visible'})
                        }
                        
                    }
                    catch{
                        throw new Error('Server response was not expected: ' + data);
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert(langCompared['serverErr'][langNow]);
                });




            
        }
        function jsonImport(){
            if(jsonImportState == 0){
                $('#jsonInputDiv').show();
                jsonImportState = 1;    
                $('#importDiv').css({border:'solid #ff0000 5px'});
                
            }
            else{
                $('#jsonInputDiv').hide();
                $('#jsonStrInput').val('');
                jsonImportState = 0;
                $('#importDiv').css({border:'solid #000000 5px'});
            }
        }
        function showMsg(show,str=''){
            $('#msgDiv').html(str+' ');
            if(waitForClickNode){
                $('#msgDiv').append($('<span>',{id:"skip", class:"link"}).html(' Skip'))
                $('#skip').click(function(){
                    console.log(transformedData[verifiedData.length]['nodeId'])
                    transformedData.splice(verifiedData.length,1)
                    mutiNodeDataInput();
                })
            }
            if(show) $('#msgDiv').show();
            else $('#msgDiv').hide();
        }
        function parsingItemData(){
            let invQtyNow = {};
            for(houseData of transformedData){
                for(InvData of houseData['Data']['INV']){
                    if(InvData['id'] in invDataDict){
                        if(invDataDict[InvData['id']] in invQtyNow)invQtyNow[invDataDict[InvData['id']]] += InvData['amount'];
                        else invQtyNow[invDataDict[InvData['id']]] = InvData['amount'];
                    }
                    else alert(invDataDict[InvData['id']]+' 尚未配對');
                }
            }
            console.log(invQtyNow);
            let invConflict = {};
            for(itemName in invQtyNow){
                if(itemName in fetchData['INV']){
                    let oldQty = 0;
                    for(owner in fetchData['INV'][itemName])oldQty += fetchData['INV'][itemName][owner];
                    if(oldQty != invQtyNow[itemName]) invConflict[itemName] = invQtyNow[itemName] - oldQty;
                }
                else invConflict[itemName] = invQtyNow[itemName];
            }
            for(itemName in fetchData['INV']){
                if(itemName in invQtyNow == false){
                    let oldQty = 0;
                    for(owner in fetchData['INV'][itemName]) oldQty -= fetchData['INV'][itemName][owner];
                    invConflict[itemName] = oldQty;
                }
            }
            console.log(invConflict)
            if(Object.keys(invConflict).length != 0){
                formedInputData = {'input':{'owner':{},'shared':{}},'output':{'owner':{},'shared':{},'unAssignConflict':{},'force':{},'notMe':{}}}
                for(item in invConflict){
                    if(invConflict[item] >0) formedInputData['input']['owner'][item] = invConflict[item]
                    if(invConflict[item] <0){
                        let itemQty = invConflict[item]*-1
                        let oldQty = 0
                        let figPath = allItemUrl[item]
                        if(userName in fetchData['INV'][item])oldQty +=fetchData['INV'][item][userName]
                        if(oldQty >= itemQty) formedInputData['output']['owner'][item] = itemQty; 
                        else{
                            if('shared' in fetchData['INV'][item])oldQty +=fetchData['INV'][item]['shared']
                            if(oldQty>= itemQty) {
                                console.log(oldQty)
                                let fromSharedQty = itemQty
                                if(userName in fetchData['INV'][item])fromSharedQty -= fetchData['INV'][item][userName]
                                if(userName in fetchData['INV'][item] && fetchData['INV'][item][userName] != 0) formedInputData['output']['owner'][item] = fetchData['INV'][item][userName];

                                formedInputData['output']['shared'][item] = fromSharedQty;
                            }
                            else{
                                let fromSharedQty = itemQty;
                                if(userName in fetchData['INV'][item])fromSharedQty -= fetchData['INV'][item][userName]
                                if(userName in fetchData['INV'][item] && fetchData['INV'][item][userName] != 0) formedInputData['output']['owner'][item] = fetchData['INV'][item][userName];
                                if('shared' in fetchData['INV'][item] && fetchData['INV'][item]['shared'] != 0) formedInputData['output']['shared'][item] = fetchData['INV'][item]['shared'];
                                if('shared' in fetchData['INV'][item])fromSharedQty -= fetchData['INV'][item]['shared']
                                formedInputData['output']['unAssignConflict'][item] = fromSharedQty;
                            }
                        }
                            
                        console.log(formedInputData)
                        $('#outputItemTitle').show()
                    }
                }
                importVerify()
            }
            else{
                alert('庫存內容與資料庫無差異')
                $('#waitMessage').css({'visibility':'hidden'})
                $('body').css({'visibility':'visible'})
            }
        }
        function importVerify(){
            $('#infoPage').html('')
                .append($('<div>', {id:'BTNDiv' ,style:"flex-direction: row;display: flex;justify-content: space-between;"})
                    .append($('<button>',{id:'allShare'}).html('全部存入共享').on('click',function() {
                        let objectA = formedInputData['input']['owner']
                        let objectB = formedInputData['input']['shared']
                        for (var key in objectA) {
                            if (objectA.hasOwnProperty(key)) {
                                if (objectB.hasOwnProperty(key)) {
                                    objectB[key] += objectA[key]; // 如果键已存在于对象B中，将值相加
                                } else {
                                    objectB[key] = objectA[key]; // 如果键不存在于对象B中，将属性和值添加到对象B中
                                }
                            }
                        }
                        for (var key in objectA) {
                            if (objectA.hasOwnProperty(key)) {
                                delete objectA[key];
                            }
                        }
                        importVerify()
                    }))
                    .append($('<button>',{id:'submit'}).html('上傳').on('click',function() {
                        submit();
                    }))
                    .append($('<button>',{id:'cancel'}).html('取消').on('click',function() {
                        formedInputData = {'input':{'owner':{},'shared':{}},'output':{'owner':{},'shared':{},'unAssignConflict':{},'force':{},'notMe':{}}}
                        assignDataDict = {}
                        getWareHouseData();
                    }))
                )
                .append($('<div>', {id:'dataContener', class: "nodeDataArea" }))
            
            $('#dataContener').append($('<div>', {id:'inputItemTitle', class: "nodeDataAreaTitle" }).append('本次存入'))
                .append($('<div>', { id:'inputItemDiv', class: "conflictItemDivLayer0" })
                    .append($('<div>', { id:'inputOwnDiv', class: "conflictItemDivLayer1" })
                        .append($('<div>', { id:'inputOwnTitle', class: "conflictItemDivLayerTitle" }).html('個人'))
                        .append($('<div>', { id:'inputOwnContent', class: "conflictItemDivLayerContent" }))
                    )
                    .append($('<div>', { id:'inputSharedDiv', class: "conflictItemDivLayer1" })
                        .append($('<div>', { id:'inputSharedTitle', class: "conflictItemDivLayerTitle" }).html('共享'))
                        .append($('<div>', { id:'inputSharedContent', class: "conflictItemDivLayerContent" }))
                    )
                )
            $('#inputItemTitle').hide()
            $('#inputItemDiv').hide()
            $('#dataContener').append($('<div>', {id:'outputItemTitle', class: "nodeDataAreaTitle" }).append('本次取出'))
                .append($('<div>', { id:'outputItemDiv', class: "conflictItemDivLayer0" })
                    .append($('<div>', { id:'outputOwnDiv', class: "conflictItemDivLayer1" })
                        .append($('<div>', { id:'outputOwnTitle', class: "conflictItemDivLayerTitle" }).html('個人'))
                        .append($('<div>', { id:'outputOwnContent', class: "conflictItemDivLayerContent" }))
                    )
                    .append($('<div>', { id:'outputSharedDiv', class: "conflictItemDivLayer1" })
                        .append($('<div>', { id:'outputSharedTitle', class: "conflictItemDivLayerTitle" }).html('共享'))
                        .append($('<div>', { id:'outputSharedContent', class: "conflictItemDivLayerContent" }))
                    )
                    .append($('<div>', { id:'conflictOutputOwnDiv', class: "conflictItemDivLayer1" })
                        .append($('<div>', { id:'conflictOutputOwnTitle', class: "conflictItemDivLayerTitle" }).html('其他'))
                        .append($('<div>', { id:'conflictOutputOwnContent', class: "conflictItemDivLayerContent" }))
                    )
                )
            $('#outputItemTitle').hide()
            $('#outputItemDiv').hide()
            let inputToOwner = formedInputData['input']['owner']
            if(Object.keys(inputToOwner).length != 0){
                for(item in inputToOwner){
                    let figPath = allItemUrl[item]
                    $('#inputOwnContent')
                        .append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                            .append($('<img>', { class:'itemFig',src: figPath }))
                            .append($('<div>', { id:'inputowner'+item.replace(/ /g,'').replace(/-/g,''),
                                                class: "itemQty blackBorder",
                                                onclick:"itemAssignment('input','owner','"+item+"')"})
                                .append(inputToOwner[item])
                            )
                        )
                    $('#inputItemTitle').show()
                    $('#inputItemDiv').show()
                    // $('#inputItemTitle').click(itemAssignment('input','owner',item))
                }
            }
            let inputToShared = formedInputData['input']['shared']
            if(Object.keys(inputToShared).length != 0){
                for(item in inputToShared){
                    let figPath = allItemUrl[item]
                    $('#inputSharedContent').append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                            .append($('<img>', { class:'itemFig',src: figPath }))
                            .append($('<div>', { id:'inputshared'+item.replace(/ /g,'').replace(/-/g,''),
                                                class: "itemQty blackBorder",
                                                onclick:"itemAssignment('input','shared','"+item+"')"}).append(inputToShared[item]))
                        )
                        $('#inputItemTitle').show()
                        $('#inputItemDiv').show()
                }
            }
            let outputFromOwner = formedInputData['output']['owner']
            if(Object.keys(outputFromOwner).length != 0){
                for(item in outputFromOwner){
                    let figPath = allItemUrl[item]
                    $('#outputOwnContent').append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                            .append($('<img>', { class:'itemFig',src: figPath }))
                            .append($('<div>', { id:'outputowner'+item.replace(/ /g,'').replace(/-/g,''),
                                                class: "itemQty blackBorder",
                                                onclick:"itemAssignment('output','owner','"+item+"')"}).append(outputFromOwner[item]))
                        )
                        $('#outputItemTitle').show()
                        $('#outputItemDiv').show()
                }
            }
            let outputFromShared = formedInputData['output']['shared']
            if(Object.keys(outputFromShared).length != 0){
                for(item in outputFromShared){
                    let figPath = allItemUrl[item]
                    $('#outputSharedContent').append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                            .append($('<img>', { class:'itemFig',src: figPath }))
                            .append($('<div>', { id:'outputshared'+item.replace(/ /g,'').replace(/-/g,''),
                                                class: "itemQty blackBorder",
                                                onclick:"itemAssignment('output','shared','"+item+"')"}).append(outputFromShared[item]))
                        )
                        $('#outputItemTitle').show()
                        $('#outputItemDiv').show()
                }
            }
            let outputConflict = formedInputData['output']['unAssignConflict']
            if(Object.keys(outputConflict).length != 0){
                for(item in outputConflict){
                    let figPath = allItemUrl[item]
                    $('#conflictOutputOwnContent').append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                            .append($('<img>', { class:'itemFig',src: figPath }))
                            .append($('<div>', { id:'outputconflict'+item.replace(/ /g,'').replace(/-/g,''),
                                                class: "itemQty blackBorder",
                                                onclick:"itemAssignment('output','unAssignConflict','"+item+"')"}).append(outputConflict[item]))
                        )
                        $('#outputItemTitle').show()
                        $('#outputItemDiv').show()
                }
            }
            let outputAssignConflict = formedInputData['output']['force']
            if(Object.keys(outputAssignConflict).length != 0){
                for(item in outputAssignConflict){
                    let figPath = allItemUrl[item]
                    $('#conflictOutputOwnContent').append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                            .append($('<img>', { class:'itemFig',src: figPath }))
                            .append($('<div>', { id:'outputconflict'+item.replace(/ /g,'').replace(/-/g,''),
                                                class: "itemQty blackBorder",
                                                style:"border: solid #0000ff 3px",
                                                onclick:"itemAssignment('output','force','"+item+"')"}).append(outputAssignConflict[item]))
                        )
                        $('#outputItemTitle').show()
                        $('#outputItemDiv').show()
                }
            }
            let notMe = formedInputData['output']['notMe']
            if(Object.keys(notMe).length != 0){
                for(item in notMe){
                    let figPath = allItemUrl[item]
                    $('#conflictOutputOwnContent').append($('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                            .append($('<img>', { class:'itemFig',src: figPath }))
                            .append($('<div>', { id:'outputconflict'+item.replace(/ /g,'').replace(/-/g,''),
                                                class: "itemQty blackBorder",
                                                style:"border: solid #0000ff 3px",
                                                onclick:"itemAssignment('output','notMe','"+item+"')"}).append(notMe[item]))
                        )
                        $('#outputItemTitle').show()
                        $('#outputItemDiv').show()
                }
            }
            $('#waitMessage').css({'visibility':'hidden'})
            $('body').css({'visibility':'visible'})
            $('#infoPage').show()
        }
        function itemAssignment(IO,place,item){
            if(place == 'unAssignConflict' || place == 'force'|| place == 'notMe') conflictAssign(place,item);
            else{
                if(JSON.stringify(assignDataDict) == '{}'){
                    assignDataDict['IO'] = IO;
                    assignDataDict['place'] = place;
                    assignDataDict['item'] = item;
                    $('#'+IO+place+item.replace(/ /g,'').replace(/-/g,'')).css({border:'solid #00ff00 3px'});
                    if(IO == 'input'){
                        if(place == 'owner')placeAssign('input','shared');
                        else placeAssign('input','owner');
                        // $('#inputOwnTitle').on('click',function() {
                        //     placeAssign('input','owner');
                        // }).css({background:'#00ff00',cursor: 'pointer'});
                        // $('#inputSharedTitle').on('click',function() {
                        //     placeAssign('input','shared');
                        // }).css({background:'#00ff00',cursor: 'pointer'});
                    }
                    else{
                        $('#outputOwnTitle').on('click',function() {
                            placeAssign('output','owner');
                        }).css({background:'#00ff00',cursor: 'pointer'});
                        $('#outputSharedTitle').on('click',function() {
                            placeAssign('output','shared');
                        }).css({background:'#00ff00',cursor: 'pointer'});
                        $('#conflictOutputOwnTitle').on('click',function() {
                            conflictAssign(place,item);
                        }).css({background:'#00ff00',cursor: 'pointer'});
                    } 
                    assignState = 1;
                }
                else{
                    if(assignDataDict['IO'] != IO || assignDataDict['place'] != place || assignDataDict['item'] != item){
                        $('#'+assignDataDict['IO']+assignDataDict['place']+assignDataDict['item'].replace(/ /g,'').replace(/-/g,'')).css({border:'solid #000000 3px'});
                        assignDataDict['IO'] = IO;
                        assignDataDict['place'] = place;
                        assignDataDict['item'] = item;
                        $('#'+IO+place+item.replace(/ /g,'').replace(/-/g,'')).css({border:'solid #00ff00 3px'});
                    }
                    else{
                        $('#'+IO+place+item.replace(/ /g,'').replace(/-/g,'')).css({border:'solid #000000 3px'});
                        $('#inputOwnTitle').off('click').css({background:'#cccccc',cursor: 'auto'});
                        $('#inputSharedTitle').off('click').css({background:'#cccccc',cursor: 'auto'});
                        $('#outputOwnTitle').off('click').css({background:'#cccccc',cursor: 'auto'});
                        $('#outputSharedTitle').off('click').css({background:'#cccccc',cursor: 'auto'});
                        $('#conflictOutputOwnTitle').off('click').css({background:'#cccccc',cursor: 'auto'});
                        assignDataDict = {}
                        assignState = 0;
                    }
                }
            }
        }
        function placeAssign(IO,place){
            let lastQty = formedInputData[assignDataDict['IO']][assignDataDict['place']][assignDataDict['item']]
            let assignQty = prompt('請輸入數量',lastQty);
            if(assignQty !== null && assignQty !== "" && assignQty != 0){
                assignQty = assignQty.trim();
                if (!assignQty.match(/^-?\d+$/)) {
                    alert("请输入有效的数字");
                } 
                else {
                    if(assignDataDict['item'] in formedInputData[IO][place]) formedInputData[IO][place][assignDataDict['item']] += Number(assignQty);
                    else formedInputData[IO][place][assignDataDict['item']] = Number(assignQty);
                    if(lastQty == Number(assignQty)) delete formedInputData[assignDataDict['IO']][assignDataDict['place']][assignDataDict['item']]
                    else formedInputData[assignDataDict['IO']][assignDataDict['place']][assignDataDict['item']] -= Number(assignQty);
                    assignDataDict = {}
                    assignState = 0;
                    importVerify();
                }
            }
        }
        function conflictAssign(place,item){
            console.log(item)
            $('#conflictPage').show()
            $('#conflictPage').append($('<button>',{id:'notMeBTN'}).html('不是我拿的')).append($('<button>',{id:'isMeBTN'}).html('拿別人的'))
            $('#notMeBTN')
                .on('click',function() {
                    formedInputData['output']['notMe'][item] = formedInputData['output'][place][item];
                    if(place != 'notMe') delete formedInputData['output'][place][item];
                    $('#conflictPage').html('');
                    $('#conflictPage').hide();
                    importVerify();
                })
            $('#isMeBTN')
                .on('click',function() {
                    formedInputData['output']['force'][item] = formedInputData['output'][place][item]
                    if(place != 'force') delete formedInputData['output'][place][item]
                    $('#conflictPage').html('');
                    $('#conflictPage').hide();
                    importVerify();
                })
        }
        window.onload = init;
    </script>
</head>

<body style="height: 100%; display: flex; flex-direction: column;user-select: none;visibility: hidden; background-color:#555555;">
    
    <div style="display: flex; justify-content: center;">
        
        <div id="msgDiv" style="z-index:99;"></div>
        <div id="importDiv" onclick="jsonImport();">
            <img id="importIcon" src="https://i.ibb.co/K5HpvPQ/json.png" style=" width: 50px;"/>
        </div>
        <div id="syncDiv" onclick="getWareHouseData();">
            <img id="syncIcon" src="https://i.ibb.co/DzKh7bB/symc.png" style=" width: 50px;"/>
        </div>
        <div id="infoPage" style="display: none;"></div>
        <div id="conflictPage" style="display: none;"></div>
        <div id="jsonInputDiv">
            JSON Input : 
            <input id="jsonStrInput" type="text" style="margin-left: 10px;width: 80px;height: 25px;"/>
            <button id="jsonSubmitBTN" onclick="parseData();" style="width: 100px;">Submit</button>
        </div>
        <div class="info-tag" style="position: absolute; display: none;border-radius: 5px; border: 1px solid;background-color: #b1b1b1;padding: 5px;white-space: nowrap;"></div>
        <div id="waitMessage" style="visibility: visible;">
            <div style="display: flex;">
                Loading...
                <div class="loader"></div>
            </div>
        </div>
    </div>
    
    <!-- <div id="searchSettingPage" style="display: none;"></div> -->
    <div id="getDataDiv" style="display: none;">{{data}}</div>
</body>

</html>