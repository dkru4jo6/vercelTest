<!DOCTYPE html>
<html>

<head>
    <meta charset="=" utf-8 />
    <title>JSON 批次匯入 - SoulForged 資源共享地圖</title>
    <link rel="icon" href="https://i.ibb.co/nLFwC08/paper-06.png" type="image/png">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> -->
    <link href="{{url_for('static',filename='css/mapStyleV1-0-10.css')}}" rel="stylesheet" />
    <!-- <link href="/pagefile/static/css/mapStyleV1-0-4.css" rel="stylesheet" /> -->
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
        integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <!-- <script type="text/javascript" src="{{url_for('static',filename='js/jquery.min.js')}}"></script> -->
    <script type="text/javascript">
        var itemTypeTranslate = {'tool': '工具', 'woodcutting': '原木', 'carpentry': '木材', 'corpse': '屍體', 'doctoring': '屠宰', 'equipment': '防具',
            'medical': '藥品', 'smithing': '鍛造', 'mining': '礦石', 'cooked': '食品', 'foraging': '作物', 'gathering': '蒐集', 'furniture': '家俱', 'other': '其他'};
        var langCompared = {
            "search":{"zh":"搜尋","en":"Search"},
            "fill":{"zh":"中心填充","en":"Fill"},
            "border":{"zh":"邊框色彩","en":"Broder"},
            "creature":{"zh":"生物","en":"Creatures"},
            "resource":{"zh":"資源","en":"Resources"},
            "item":{"zh":"地上物品","en":"Item"},
            "renewTime":{"zh":"更新時間","en":"Update Interval"},
            "newest":{"zh":"最新記錄","en":"Latest"},
            "ever":{"zh":"曾經出現","en":"Ever"},
            "highest":{"zh":"過往最高","en":"Highest"},
            "lowest":{"zh":"過往最低","en":"Lowest"},
            "creatureList":{"zh":"生物列表","en":"Creatures List"},
            "resourceList":{"zh":"資源列表","en":"Resources List"},
            "itemList":{"zh":"物品列表","en":"Item List"},
            "filterByCategory":{"zh":"依類別篩選","en":"Filter by category"},
            "filterByName":{"zh":"依名稱篩選","en":"Filter by name"},
            "note":{"zh":"備註","en":"Note"},
            "add":{"zh":"新增","en":"Add"},
            "state":{"zh":"狀態","en":"State"},
            "active":{"zh":"主動","en":"Active"},
            "passive":{"zh":"被動","en":"Passive"},
            "quentity":{"zh":"數量","en":"Quentity"},
            "ok":{"zh":"確認","en":"OK"},
            "cancel":{"zh":"取消","en":"Cancel"},
            "del":{"zh":"刪除","en":"Del"},
            "full":{"zh":"滿","en":"Maximum"},
            "substantial":{"zh":"好","en":"Substantial"},
            "partial":{"zh":"差","en":"Partial"},
            "empty":{"zh":"劣","en":"Minimal"},
            "none":{"zh":"無","en":"Empty"},
            "submit":{"zh":"提交","en":"Submit"},
            "setAsDefault":{"zh":"設定","en":"Set as default"},
            "switchLanguage":{"zh":"切換語言","en":"Language"},
            "guide":{"zh":"說明文件","en":"How to use"},
            "entry":{"zh":"進入","en":"Entry"},
            "lastUpdate":{"zh":"更新時間","en":"Last update"},
            "noRecord":{"zh":"尚無資料紀錄，預設內容僅供參考","en":"No data records available; default content is for reference only."},
            "day":{"zh":"天","en":"day"},
            "hour":{"zh":"小時","en":"hr"},
            "min":{"zh":"分鐘前)","en":"min ago.)"},
            "by":{"zh":"由","en":"record by"},
            "record":{"zh":"記錄","en":""},
            "switchTo":{"zh":"切換為","en":"Switch to"},
            "nodeId":{"zh":"節點ID","en":"Node ID"},
            "hide":{"zh":"隱藏","en":"Hide"},
            "show":{"zh":"顯示","en":"Show"},
            "edit":{"zh":"編輯地圖","en":"Edit map"},
            "node":{"zh":"節點","en":"Node"},
            "route":{"zh":"路徑","en":"Route"},
            "prefix":{"zh":"前綴","en":"Prefix"},
            "suffix":{"zh":"後綴","en":"Suffix"},
            "done":{"zh":"完成","en":"Done"},
            "color":{"zh":"顏色","en":"Color"},
            "type":{"zh":"類型","en":"Type"},
            "mainstream":{"zh":"幹道","en":"Mainstream"},
            "sidetrack":{"zh":"支線","en":"Sidetrack"},
            "defaultNode":{"zh":"起始節點","en":"Default Node"},
            "nodeScaleSwitch":{"zh":"節點縮放","en":"Node Scale"},
            "nodeUnavilible":{"zh":"節點不存在","en":"The node does not exist"},
            "whitchNode":{"zh":"請輸入想尋找的NodeID","en":"Please enter the NodeID you wish to search for."},
            "delRouteConfirm":{"zh":"確認要刪除路徑","en":"Are you sure you want to delete the route "},
            "serverErr":{"zh":"伺服器連線異常，資料傳遞失敗","en":"Server connection is abnormal, data transmission failed."},
            "routeRepeat":{"zh":"路徑已存在，是否取代","en":"The path already exists, do you want to replace it?"},
            "delCheck":{"zh":"確定要刪除","en":"Are you sure you want to delete "},
            "entryPrefix":{"zh":"請輸入前綴","en":"Please enter the prefix."},
            "prefixErr":{"zh":"前綴僅能使用英文字母","en":"The prefix can only use English letters."},
            "suffixErr":{"zh":"後綴僅能使用英文字母","en":"The suffix can only use English letters."},
            "nodeRepeat":{"zh":"這個編碼方式已使用於","en":"This encoding method has been used in "},
            "yourName":{"zh":"是否要留下名稱，讓大家記得你的貢獻","en":"Would you like to leave your name so everyone will remember your contribution"},
            "display":{"zh":"檢視參數","en":"View Parameters"}

        }
        var entryList = ['Q21DM1','EDMH','FTDMH','MHUE','MHUFT','M1UQ21','EDM','CDM','W1DM','W2DM','W3DM','W4DM','MUE','MUC','MUW1','MUW2','MUW3','MUW4']
        var animalList = [];
        var animalUrl = {};
        var carpentryUrl = {};
        var cookedUrl = {};
        var corpseUrl = {};
        var doctoringUrl = {};
        var furnitureUrl = {};
        var equipmentUrl = {};
        var foragingUrl = {};
        var gatheringUrl = {};
        var medicalUrl = {};
        var miningUrl = {};
        var otherUrl = {};
        var smithingUrl = {};
        var toolUrl = {};
        var woodCuttingUrl = {};
        var sacleRatio = 1;
        var rawData = [];
        var nowData = [];
        var rawHis0 = [];
        var rawHis1 = [];
        var rawHis2 = [];
        var rawHis = [];
        var myWindow;
        var posisionDataMain = {};
        var posisionDataMH = {};
        var posisionDataTT = {};
        // var posisionDataCh2 = {};
        var hisData = {}
        var scaleModify = 1
        var nodeNow = '';
        var funcNow = '';
        var indexNow = '';
        var nameNow = ''
        var typeNow = '';
        var userName = '';
        var routeState = 1;
        var urlFunc = ''
        var settingSelValue = '';
        var settingSelDOM = ''
        var settingInputDOM = ''
        var searchMethodState = 'type';
        var searchedName = ''
        var urlNow = ''
        var langNow = 'zh'
        var mapId = 'Main'
        var routeWidth = '2px'
        var continueAddState = 1;
        var routeNodePair = []
        var routeColorSetting = '#ff0000'
        var routeType = 'mainstream'
        var defNodeId = ''
        var mapRouteMain = [];
        var mapRouteMH = [];
        var mapRouteTT = [];
        var editMapRoute = 0;
        var editMapNode = 0;
        var aimState = 0;
        var editdefaultNode = 0;
        var routeData = [];
        var searchSlot = {}
        var loadingCount = 0
        var tempSearchSlot = {}
        var jsonFromBackend = {}
        var oriDataSet = {};
        var nodeScaleNow = 1;
        var loadDoneState = 0;
        var mutiInputState = 0;
        var waitForClickNode = 0;
        var inputDataIndex = 0;
        var indoorState = 0;
        var transformedData = []
        var verifiedData = []
        var resDataDict = {}
        var creDataDict = {}
        var invDataDict = {}
        var tempRes = {}
        var tempCre = {}
        var tempInv = {}
        var mesStr = '成功上傳'
        var center = {x: 0, y: 0};
        var huntableAnimalList = ['Rabbit', 'Chicken', 'Mallard', 'Frog', 'Tortoise', 'Goat', 'Boar', 'Pigune', 
            'Fierce Tusk', 'Scarlet Grub',"Fishing Spot","Fluffin","Brown Squitmunk","Grey Squitmunk","Hawn","Bison","Lightning Bug","Giant Mosquito"];
        var jsonData = {}
        var nameData = {}
        var pageIconSize = '50px';
        var pageFontSize = ''
        var errState = 0;
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        
        var continueSet = function (){

            
            var img = document.getElementById('imgMain');
            var img2 = document.getElementById('imgMH');
            var img3 = document.getElementById('imgTT');
            var oneImgOnload = function(){
                if (img.complete && img2.complete && img3.complete)onImageLoaded();
            }
            var onImageLoaded = function () {
                loadDoneState = 1;
                loadingCount = 0;
                // 根据 posisionData 创建圆圈
                for (i in posisionDataMain) {
                    var data = posisionDataMain[i];
                    
                    var newCircle = document.createElement('div');
                    newCircle.id = i;
                    if(entryList.includes(i)){
                        newCircle.innerHTML = langCompared['entry'][langNow];
                        newCircle.style.backgroundColor = '#ff00ff';
                    }
                    else newCircle.innerHTML = i;
                    let innerColor = 'black';
                    if(recordNodeList.includes(i)) innerColor = 'green';
                    newCircle.className = 'interactive-circle '+innerColor;
                    newCircle.style.position = 'absolute';
                    
                    // newCircle.onclick = function () { nodeOnclick(this.id); };
                    document.getElementById('mapMain').appendChild(newCircle);
                    positionAndResizeCircle(newCircle.id, data['X'], data['Y'],sacleRatio);
                }

                for (i in posisionDataMH) {
                    var newCircle = document.createElement('div');
                    newCircle.id = i;
                    if(entryList.includes(i)){
                        newCircle.innerHTML = langCompared['entry'][langNow];
                        newCircle.style.backgroundColor = '#ff00ff';
                    }
                    else newCircle.innerHTML = i;
                    newCircle.className = 'interactive-circle black';
                    newCircle.style.position = 'absolute';
                    // newCircle.onclick = function () { nodeOnclick(this.id); };
                    document.getElementById('mapMineHead').appendChild(newCircle);
                    let newRatio = 1/sacleRatio
                    content.style.transform = `scale(${newRatio})`;
                    scaleModify = sacleRatio

                    var img = document.getElementById('imgMH');
                    var circle = document.getElementById(newCircle.id);

                    var imgRect = img.getBoundingClientRect();
                    var imgWidth = imgRect.width;
                    var imgHeight = imgRect.height;

                    circle.style.left = (imgWidth * posisionDataMH[i]['X']) + 'px'; // 减去圆点宽度的一半
                    circle.style.top = (imgHeight * posisionDataMH[i]['Y']) + 'px'; // 减去圆点高度的一半
                    scaleModify = 1
                    content.style.transform = `scale(${sacleRatio})`;
                }
                for (i in posisionDataTT) {
                    var newCircle = document.createElement('div');
                    newCircle.id = i;
                    if(entryList.includes(i)){
                        newCircle.innerHTML = langCompared['entry'][langNow];
                        newCircle.style.backgroundColor = '#ff00ff';
                    }
                    else newCircle.innerHTML = i;
                    newCircle.className = 'interactive-circle black';
                    newCircle.style.position = 'absolute';
                    // newCircle.onclick = function () { nodeOnclick(this.id); };
                    document.getElementById('mapTT').appendChild(newCircle);
                    let newRatio = 1/sacleRatio
                    content.style.transform = `scale(${newRatio})`;
                    scaleModify = sacleRatio

                    var img = document.getElementById('imgTT');
                    var circle = document.getElementById(newCircle.id);


                    var imgRect = img.getBoundingClientRect();
                    var imgWidth = imgRect.width;
                    var imgHeight = imgRect.height;

                    circle.style.left = (imgWidth * posisionDataTT[i]['X']) + 'px'; // 减去圆点宽度的一半
                    circle.style.top = (imgHeight * posisionDataTT[i]['Y']) + 'px'; // 减去圆点高度的一半
                    scaleModify = 1
                    content.style.transform = `scale(${sacleRatio})`;
                }
                window.scrollTo(0, 0);
                setTimeout(function() {
                    document.getElementById('svgMain').style.height = document.getElementById('imgMain').height + 'px';
                    document.getElementById('svgMain').style.width = document.getElementById('imgMain').width + 'px';
                    document.getElementById('svgMH').style.height = document.getElementById('imgMH').height + 'px';
                    document.getElementById('svgMH').style.width = document.getElementById('imgMH').width + 'px';
                    document.getElementById('svgTT').style.height = document.getElementById('imgTT').height + 'px';
                    document.getElementById('svgTT').style.width = document.getElementById('imgTT').width + 'px';
                    
                    $('#waitMessage').css({'visibility':'hidden'})
                    $('body').css({'visibility':'visible'})
                    $('#mapMain').css({'visibility':'visible'})
                    $('#mapMineHead').css({'visibility':'hidden'})
                    $('#mapTT').css({'visibility':'hidden'})
                    $('#svgMH').css({'visibility':'hidden'});
                    $('#svgMain').css({'visibility':'visible'});
                    $('#svgTT').css({'visibility':'hidden'});
                    defNodeId = 'W25'
                    
                    $('#setDefaultNode').html(defNodeId);
                    element = document.getElementById(defNodeId);
                    // 如果元素存在，将其滚动到视窗中心
                    if (element) {
                        element.scrollIntoView({block: 'center', inline: 'center' });
                    }
                    if (isMobileDevice()) {
                        $('#syncIcon').css({'width':pageIconSize})
                        $('#aimIcon').css({'width':pageIconSize})
                        $('#settingIcon').css({'width':'200px'})
                        $('#settingIconDiv').css({'border-radius':'100px'})
                        $('#search').css({'width':'300px','height':'auto','font-size':'70px'})
                        
                        $('style').append("button{width:650px;font-size:80px;}")
                        $('style').append(".itemFig{width:200px;height:200px;font-size:100px;}")
                        $('style').append("select{height:80px;font-size:"+pageFontSize+"}")
                        $('style').append("input{height:80px;font-size:80px}")
                        $('style').append("input[type=number]{height:80px;font-size:80px;width:100px;}")
                        $('style').append("#timeSearchBTN{font-size:75px;width:200px;height:200px;}")
                        $('style').append("#showTimeStr{font-size:60px;}")
                        $('style').append("#settingManu{font-size: 100px; top:30%; left: 5%; right: 5%;}")
                        $('style').append(".nodeDataAreaTitle{font-size:60px;}")
                        $('style').append(".nodeDataAreaContent{font-size:80px;}")
                        $('style').append("#optionDataDiv0{max-height:none;}")
                        $('style').append("#optionDataDiv1{max-height:none;}")
                        $('style').append("#searchNodeDiv{font-size:100px;}")
                        $('style').append("#note{font-size:80px;}")
                        $('style').append(".text{font-size: 100px;height: 100px;width: 500px;}")
                        $('style').append("#nodeEditBTN{width: 250px;}")
                        $('style').append("#routeEditBTN{width: 250px;}")
                        $('style').append("#delBTN{width: 300px;}")
                        $('style').append("#infoPage{left: 1%; right: 1%; top: 10%;}")
                        $('style').append("#settingPage{left: 1%; right: 1%; top: 10%;}")
                        $('style').append(".qtyDiv{font-size:80px;}")
                        $('style').append("#resourceShowDiv{max-height: 300px; overflow: scroll;}")
                        $('style').append("#animalShowDiv{max-height: 300px; overflow: scroll;position: relative;}")
                        $('style').append("#itemShowDiv{max-height: 300px; overflow: scroll;position: relative;}")
                        $('style').append(".itemQty{font-size:80px;width:200px;height:200px;}")
                        $('style').append(".addingBTN{font-size:80px;width:220px;height:220px;border: #000000 solid 15px;margin:12px;}")
                        $('style').append(".greenBorder{border: solid #00ff00 15px;}")
                        $('style').append(".yellowBorder{border: solid #ffff00 15px;}")
                        $('style').append(".orangeBorder{border: solid #ffb100 15px;}")
                        $('style').append(".redBorder{border: solid #ff0000 15px;}")
                        $('style').append(".blackBorder{border: solid #000000 15px;}")
                        $('style').append(".figDiv{margin:12px;}")
                        $('style').append('input[type="range"]{height: 100px;width: 650px;}')
                        $('style').append('input[type="range"]::-webkit-slider-runnable-track{border-radius: 50px;}')
                        $('style').append('input[type="range"]::-webkit-slider-thumb{border: #000000 solid 50px;}')
                        
                        if(langNow == 'en'){
                            $('style').append("#timeSearchBTN{font-size:40px;width:200px;height:200px;}")
                            $('style').append("#settingManu{font-size: 75px; top:30%; left: 5%; right: 5%;}")
                            $('style').append("#setDefault{font-size: 75px;}")
                        }
                    }
                    else{
                        $('style').append(".itemFig{width:auto;}")
                        $('style').append("#nodeEditBTN{width: 70px;}")
                        $('style').append("#routeEditBTN{width: 70px;}")
                        if(langNow == 'en')$('style').append("#setDefault{font-size: 15px;}")
                        else $('style').append("#setDefault{font-size: 20px;}")
                    }
                    // if(urlNow.searchParams.has('node') && urlNow.searchParams.get('node') == 'hide')nodeIdSwitch();
                }, 0);
                    
                    
            };

            if (img.complete && img2.complete && img3.complete) {
                // 图片已加载，直接调用处理函数
                onImageLoaded();
            } 
            else {
                // 图片还没加载，设置加载完成后的处理函数
                img.onload = oneImgOnload();
                img2.onload = oneImgOnload();
                img3.onload = oneImgOnload();
            }
            for(entryID in entryList){
                $('#'+entryList[entryID]).html(langCompared['entry'][langNow]);
            }
            for(routeIndex in mapRouteMain) drawLineBetweenCircles(mapRouteMain[routeIndex]['start'], mapRouteMain[routeIndex]['end'],mapRouteMain[routeIndex]['color'],mapRouteMain[routeIndex]['width'],'Main');
            for(routeIndex in mapRouteMH) drawLineBetweenCircles(mapRouteMH[routeIndex]['start'], mapRouteMH[routeIndex]['end'],mapRouteMH[routeIndex]['color'],mapRouteMH[routeIndex]['width'],'MH');
            for(routeIndex in mapRouteTT) drawLineBetweenCircles(mapRouteTT[routeIndex]['start'], mapRouteTT[routeIndex]['end'],mapRouteTT[routeIndex]['color'],mapRouteTT[routeIndex]['width'],'TT');
            
            dragElement(document.getElementById("pageContainer"));

            let isDragging = false;
            let startPos = null;

            const image = document.getElementById('imgMain'); // 替換為您的圖片ID
            image.addEventListener('mousedown', function (event) {
                isDragging = false; // 當按下滑鼠時，先假設不是拖動
                startPos = { x: event.clientX, y: event.clientY }; // 記錄起始位置
            }, false);

            image.addEventListener('mousemove', function (event) {
                if (startPos) {
                    // 只有當滑鼠有從初始位置移動時，才設定isDragging為true
                    isDragging = event.clientX !== startPos.x || event.clientY !== startPos.y;
                }
            }, false);

            image.addEventListener('mouseup', function (event) {
                startPos = null; // 清除起始位置
            }, false);

            image.addEventListener('mouseup', function (event) {
                startPos = null; // 清除起始位置
                if (isDragging) {
                    isDragging = false; // 重置拖動狀態
                }
                else if(editMapNode == 1){
                    var imageRect = this.getBoundingClientRect(); // 获取图片的位置和尺寸
                    var x = event.pageX - imageRect.left - window.scrollX; // 获取点击位置的X坐标，加上页面滚动
                    var y = event.pageY - imageRect.top - window.scrollY; // 获取点击位置的Y坐标，加上页面滚动
                    var xPercent = x / this.clientWidth/sacleRatio;
                    var yPercent = y / this.clientHeight/sacleRatio;
                    let noteId = '';
                    if(continueAddState == 0) noteId = prompt('座標ID');
                    else{
                        let serNum = 1;
                        if($('#prefix').val().trim() !== ''){
                            const regex = /^[A-Za-z]+$/;
                            if(regex.test($('#prefix').val().trim())){
                                if($('#suffix').val() !== '' && regex.test($('#suffix').val().trim()) == false){
                                    alert(langCompared['suffixErr'][langNow]);
                                    return;
                                }
                                for(i in posisionDataMH){
                                    if(i.substr(0,$('#prefix').val().trim().length) === $('#prefix').val().trim()){
                                        if(i.includes($('#suffix').val().trim())){
                                            alert(langCompared['nodeRepeat'][langNow] + 'Mine Head');
                                            return
                                        }
                                    }
                                }
                                for(i in posisionDataTT){
                                    if(i.substr(0,$('#prefix').val().trim().length) === $('#prefix').val().trim()){
                                        if(i.includes($('#suffix').val().trim())){
                                            alert(langCompared['nodeRepeat'][langNow] + 'The Tongue');
                                            return
                                        }
                                    }
                                }
                                while($('#prefix').val().trim()+serNum+$('#suffix').val().trim() in posisionDataMain)serNum+=1
                            }
                            else{
                                alert(langCompared['prefixErr'][langNow]);
                                return;
                            }
                        }  
                        else{
                            alert(langCompared['entryPrefix'][langNow]);
                            return
                        } 
                        noteId = $('#prefix').val().trim() + serNum + $('#suffix').val().trim()
                    }
                    if (noteId != '' && noteId != null) {
                        if(noteId in posisionDataMain){
                            window.scrollTo(0, 0);
                            element = document.getElementById(noteId);
                            // 如果元素存在，将其滚动到视窗中心
                            if (element) {
                                element.scrollIntoView({block: 'center', inline: 'center' });
                            }
                            alert('Node ID已存在');
                            return;
                        }
                        let data = { 'id': noteId, 'X': Number(xPercent.toFixed(3)), 'Y': Number(yPercent.toFixed(3)) }
                        posisionDataMain[noteId] = data
                        var newCircle = document.createElement('div');
                        newCircle.id = data['id'];
                        newCircle.innerHTML = data['id'];
                        newCircle.className = 'interactive-circle black';
                        newCircle.style.position = 'absolute';
                        newCircle.onclick = function () { nodeOnclick(this.id); };
                        document.getElementById('mapMain').appendChild(newCircle);
                        let newRatio = 1/sacleRatio
                        content.style.transform = `scale(${newRatio})`;
                        scaleModify = sacleRatio
                        var img = document.getElementById('imgMain');
                        var circle = document.getElementById(newCircle.id);

                        var circleSize = 0.0035; // 圆点的大小，相对于图片宽度的百分比

                        var imgRect = img.getBoundingClientRect();
                        var imgWidth = imgRect.width;
                        var imgHeight = imgRect.height;

                        // 大小
                        // var newSize = imgWidth * circleSize; // 计算新的圆点大小
                        // circle.style.width = newSize*sacleRatio/nodeScaleNow   + 'px';
                        // circle.style.height = newSize*sacleRatio/nodeScaleNow   + 'px';
                        // 位置
                        circle.style.left = (imgWidth * data['X']*sacleRatio) + 'px'; // 减去圆点宽度的一半
                        circle.style.top = (imgHeight * data['Y']*sacleRatio) + 'px'; // 减去圆点高度的一半
                        scaleModify = 1
                        content.style.transform = `scale(${sacleRatio})`;
                        sendMapDotData(noteId,data['X'],data['Y'])
                    }
                }
            }, false);
            
            let isDraggingMH = false;
            let startPosMH = null;

            const image2 = document.getElementById('imgMH'); // 替換為您的圖片ID
            image2.addEventListener('mousedown', function (event) {
                isDraggingMH = false; // 當按下滑鼠時，先假設不是拖動
                startPosMH = { x: event.clientX, y: event.clientY }; // 記錄起始位置
            }, false);

            image2.addEventListener('mousemove', function (event) {
                if (startPosMH) {
                    // 只有當滑鼠有從初始位置移動時，才設定isDraggingMH為true
                    isDraggingMH = event.clientX !== startPosMH.x || event.clientY !== startPosMH.y;
                }
            }, false);

            image2.addEventListener('mouseup', function (event) {
                startPosMH = null; // 清除起始位置
            }, false);

            image2.addEventListener('mouseup', function (event) {
                startPosMH = null; // 清除起始位置
                if (isDraggingMH) {
                    isDraggingMH = false; // 重置拖動狀態
                }
                else if(editMapNode == 1){
                    var imageRect = this.getBoundingClientRect(); // 获取图片的位置和尺寸
                    var x = event.pageX - imageRect.left - window.scrollX; // 获取点击位置的X坐标，加上页面滚动
                    var y = event.pageY - imageRect.top - window.scrollY; // 获取点击位置的Y坐标，加上页面滚动
                    var xPercent = x / this.clientWidth/sacleRatio;
                    var yPercent = y / this.clientHeight/sacleRatio;
                    let noteId = '';
                    if(continueAddState == 0) noteId = prompt('座標ID');
                    else{
                        let serNum = 1;
                        if($('#prefix').val().trim() !== ''){
                            const regex = /^[A-Za-z]+$/;
                            if(regex.test($('#prefix').val().trim())){
                                if($('#suffix').val() !== '' && regex.test($('#suffix').val().trim()) == false){
                                    alert(langCompared['suffixErr'][langNow]);
                                    return;
                                }
                                for(i in posisionDataTT){
                                    if(i.substr(0,$('#prefix').val().trim().length) === $('#prefix').val().trim()){
                                        if(i.includes($('#suffix').val().trim())){
                                            alert(langCompared['nodeRepeat'][langNow] + 'The Tongue');
                                            return
                                        }
                                    }
                                }
                                for(i in posisionDataMain){
                                    if(i.substr(0,$('#prefix').val().trim().length) === $('#prefix').val().trim()){
                                        if(i.includes($('#suffix').val().trim())){
                                            alert(langCompared['nodeRepeat'][langNow] + 'Main Map');
                                            return
                                        }
                                    }
                                }
                                while($('#prefix').val().trim()+serNum+$('#suffix').val().trim() in posisionDataMH)serNum+=1
                            }
                            else{
                                alert(langCompared['prefixErr'][langNow]);
                                return;
                            }
                        }  
                        else{
                            alert(langCompared['entryPrefix'][langNow]);
                            return
                        } 
                        noteId = $('#prefix').val().trim() + serNum + $('#suffix').val().trim()
                    }
                    if (noteId != '' && noteId != null) {
                        if(noteId in posisionDataMH){
                            window.scrollTo(0, 0);
                            element = document.getElementById(noteId);
                            // 如果元素存在，将其滚动到视窗中心
                            if (element) {
                                element.scrollIntoView({block: 'center', inline: 'center' });
                            }
                            alert('Node ID已存在');
                            return;
                        }
                        let data = { 'id': noteId, 'X': Number(xPercent.toFixed(3)), 'Y': Number(yPercent.toFixed(3)) }
                        posisionDataMH[noteId] = data
                        var newCircle = document.createElement('div');
                        newCircle.id = data['id'];
                        newCircle.innerHTML = data['id'];
                        newCircle.className = 'interactive-circle black';
                        newCircle.style.position = 'absolute';
                        newCircle.onclick = function () { nodeOnclick(this.id); };
                        document.getElementById('mapMineHead').appendChild(newCircle);
                        let newRatio = 1/sacleRatio
                        content.style.transform = `scale(${newRatio})`;
                        scaleModify = sacleRatio
                        var img = document.getElementById('imgMH');
                        var circle = document.getElementById(newCircle.id);

                        var circleSize = 0.007; // 圆点的大小，相对于图片宽度的百分比

                        var imgRect = img.getBoundingClientRect();
                        var imgWidth = imgRect.width;
                        var imgHeight = imgRect.height;

                        // 大小
                        // var newSize = imgWidth * circleSize; // 计算新的圆点大小
                        // circle.style.width = newSize*scaleModify/nodeScaleNow  + 'px';
                        // circle.style.height = newSize*scaleModify/nodeScaleNow  + 'px';
                        // 位置
                        circle.style.left = (imgWidth * data['X']*sacleRatio) + 'px'; // 减去圆点宽度的一半
                        circle.style.top = (imgHeight * data['Y']*sacleRatio) + 'px'; // 减去圆点高度的一半
                        scaleModify = 1
                        content.style.transform = `scale(${sacleRatio})`;
                        sendMapDotData(noteId,data['X'],data['Y'])
                    }
                }
            }, false);

            let isDraggingTT = false;
            let startPosTT = null;

            const image3 = document.getElementById('imgTT'); // 替換為您的圖片ID
            image3.addEventListener('mousedown', function (event) {
                isDraggingTT = false; // 當按下滑鼠時，先假設不是拖動
                startPosTT = { x: event.clientX, y: event.clientY }; // 記錄起始位置
            }, false);

            image3.addEventListener('mousemove', function (event) {
                if (startPosTT) {
                    // 只有當滑鼠有從初始位置移動時，才設定isDraggingTT為true
                    isDraggingTT = event.clientX !== startPosTT.x || event.clientY !== startPosTT.y;
                }
            }, false);

            image3.addEventListener('mouseup', function (event) {
                startPosTT = null; // 清除起始位置
            }, false);

            image3.addEventListener('mouseup', function (event) {
                startPosTT = null; // 清除起始位置
                if (isDraggingTT) {
                    isDraggingTT = false; // 重置拖動狀態
                }
                else if(editMapNode == 1){
                    var imageRect = this.getBoundingClientRect(); // 获取图片的位置和尺寸
                    var x = event.pageX - imageRect.left - window.scrollX; // 获取点击位置的X坐标，加上页面滚动
                    var y = event.pageY - imageRect.top - window.scrollY; // 获取点击位置的Y坐标，加上页面滚动
                    var xPercent = x / this.clientWidth/sacleRatio;
                    var yPercent = y / this.clientHeight/sacleRatio;
                    let noteId = '';
                    if(continueAddState == 0) noteId = prompt('座標ID');
                    else{
                        let serNum = 1;
                        if($('#prefix').val().trim() !== ''){
                            const regex = /^[A-Za-z]+$/;
                            if(regex.test($('#prefix').val().trim())){
                                if($('#suffix').val() !== '' && regex.test($('#suffix').val().trim()) == false){
                                    alert(langCompared['suffixErr'][langNow]);
                                    return;
                                }
                                for(i in posisionDataMH){
                                    if(i.substr(0,$('#prefix').val().trim().length) === $('#prefix').val().trim()){
                                        if(i.includes($('#suffix').val().trim())){
                                            alert(langCompared['nodeRepeat'][langNow] + 'Mine Head');
                                            return
                                        }
                                    }
                                }
                                for(i in posisionDataMain){
                                    if(i.substr(0,$('#prefix').val().trim().length) === $('#prefix').val().trim()){
                                        if(i.includes($('#suffix').val().trim())){
                                            alert(langCompared['nodeRepeat'][langNow] + 'Main Map');
                                            return
                                        }
                                    }
                                }
                                while($('#prefix').val().trim()+serNum+$('#suffix').val().trim() in posisionDataTT)serNum+=1
                            }
                            else{
                                alert(langCompared['prefixErr'][langNow]);
                                return;
                            }
                        }  
                        else{
                            alert(langCompared['entryPrefix'][langNow]);
                            return
                        } 
                        noteId = $('#prefix').val().trim() + serNum + $('#suffix').val().trim()
                    }
                    if (noteId != '' && noteId != null) {
                        if(noteId in posisionDataTT){
                            window.scrollTo(0, 0);
                            element = document.getElementById(noteId);
                            // 如果元素存在，将其滚动到视窗中心
                            if (element) {
                                element.scrollIntoView({block: 'center', inline: 'center' });
                            }
                            alert('Node ID已存在');
                            return;
                        }
                        let data = { 'id': noteId, 'X': Number(xPercent.toFixed(3)), 'Y': Number(yPercent.toFixed(3)) }
                        posisionDataTT[noteId] = data
                        var newCircle = document.createElement('div');
                        newCircle.id = data['id'];
                        newCircle.innerHTML = data['id'];
                        newCircle.className = 'interactive-circle black';
                        newCircle.style.position = 'absolute';
                        newCircle.onclick = function () { nodeOnclick(this.id); };
                        document.getElementById('mapTT').appendChild(newCircle);
                        let newRatio = 1/sacleRatio
                        content.style.transform = `scale(${newRatio})`;
                        scaleModify = sacleRatio

                        var img = document.getElementById('imgTT');
                        var circle = document.getElementById(newCircle.id);

                        var circleSize = 0.007; // 圆点的大小，相对于图片宽度的百分比

                        var imgRect = img.getBoundingClientRect();
                        var imgWidth = imgRect.width;
                        var imgHeight = imgRect.height;

                        // 大小
                        // var newSize = imgWidth * circleSize; // 计算新的圆点大小
                        // circle.style.width = newSize*scaleModify/nodeScaleNow  + 'px';
                        // circle.style.height = newSize*scaleModify/nodeScaleNow  + 'px';
                        // 位置
                        circle.style.left = (imgWidth * data['X']*sacleRatio) + 'px'; // 减去圆点宽度的一半
                        circle.style.top = (imgHeight * data['Y']*sacleRatio) + 'px'; // 减去圆点高度的一半
                        scaleModify = 1
                        content.style.transform = `scale(${sacleRatio})`;
                        sendMapDotData(noteId,data['X'],data['Y'])
                    }
                }
            }, false);

            $('.interactive-circle').addClass('black');
            var isDrag = false;

            $(".interactive-circle")
                .mousedown(function() {
                    isDrag = false;
                })
                .mousemove(function() {
                    isDrag = true;
                })
                .mouseup(function(e) {
                    if (!isDrag) {
                        nodeOnclick(e.target.id);
                    }
                    isDrag = false;
                });
            showInfo();
        }
        var dataOnLoad = function (){
            let dataLoad = loadingCount;
            if(document.getElementById('imgMain').complete) dataLoad += 1;
            if(document.getElementById('imgMH').complete) dataLoad += 1;
            if(document.getElementById('imgTT').complete) dataLoad += 1;
            $('#loadCount').html(dataLoad);
            if(loadingCount == 6)continueSet();
        }

        function init() {
            if (isMobileDevice()) {
                pageIconSize = '200px';
                pageFontSize = '45px';
                $('<style>')
                    .prop('type', 'text/css')
                    .appendTo('head');
                $('style').append("#waitMessage{font-size:90px;}")
                $('style').append(".loader{border: 20px solid #f3f3f3;border-top: 20px solid #bbbbbb;width: 100px;height: 100px;}")
            }
            jsonFromBackend = JSON.parse($('#getDataDiv').html().replace(/'/g, '"'))
            jsonData = jsonFromBackend['jsonData']
            nameData = jsonFromBackend['nameData']
            if ('username' in jsonFromBackend) {
                userName = jsonFromBackend['username'];
            }
            // for(i in nameData['foragingUrl']){
            //     if(i.includes('Seed'))delete nameData['foragingUrl'][i]
            // }
            resDataDict = jsonFromBackend['resMaping']
            tempRes = JSON.parse(JSON.stringify(resDataDict))
            creDataDict = jsonFromBackend['creMaping']
            tempCre = JSON.parse(JSON.stringify(creDataDict))
            invDataDict = jsonFromBackend['invMaping']
            tempInv = JSON.parse(JSON.stringify(invDataDict))
            recordNodeList = Object.values(jsonData);
            getDataFromBackend('mapDotMain');
            getDataFromBackend('mapDotMH');
            getDataFromBackend('mapDotTT');
            getDataFromBackend('mapRouteMain');
            getDataFromBackend('mapRouteMH');
            getDataFromBackend('mapRouteTT');
            animalList = nameData['animalList']
            animalUrl = nameData['animalUrl']
            carpentryUrl = nameData['carpentryUrl']
            cookedUrl = nameData['cookedUrl']
            corpseUrl = nameData['corpseUrl']
            doctoringUrl = nameData['doctoringUrl']
            furnitureUrl = nameData['furnitureUrl']
            equipmentUrl = nameData['equipmentUrl']
            foragingUrl = nameData['foragingUrl']
            gatheringUrl = nameData['gatheringUrl']
            medicalUrl = nameData['medicalUrl']
            miningUrl = nameData['miningUrl']
            otherUrl = nameData['otherUrl']
            smithingUrl = nameData['smithingUrl']
            toolUrl = nameData['toolUrl']
            woodCuttingUrl = nameData['woodCuttingUrl']
            
        }
        function mappingIndoorINV(){
            indoorState = 1;
            for(invData of transformedData[0]['Data']['INV']){
                if(invData['id'] in tempInv == false){
                    for(typeName in nameData){
                        if(typeName != 'animalList' && typeName != 'animalUrl'){
                            if(invData['name'].replace(/ /g,'-') in nameData[typeName]){
                                tempInv[invData['id']] = invData['name'];
                                break
                            }
                        }
                    }
                    if(invData['id'] in tempInv == false){
                        showSettingPage('INV',invData);
                        return
                    }
                }
            }
            for (let key in invDataDict) {
                if (invDataDict.hasOwnProperty(key) && tempInv.hasOwnProperty(key)) {
                    delete tempInv[key];
                }
            }
            if(Object.keys(tempInv).length != 0){
                // console.log(tempInv)
                sendData('INV',JSON.stringify(tempInv))
                Object.assign(invDataDict, tempInv);
                transformedData = [];
            }
            tempInv = JSON.parse(JSON.stringify(invDataDict))
        }
        function showInfo(){
            $('#infoDiv').html('')
            let totalNode = Object.keys(posisionDataMain).length
            totalNode += Object.keys(posisionDataMH).length
            totalNode += Object.keys(posisionDataTT).length
            let totalRES = huntableAnimalList.length
            totalRES += Object.keys(foragingUrl).length
            // for(i of Object.keys(foragingUrl)){
            //     if(i.includes('Seed'))totalRES-=1;
            // }
            totalRES += Object.keys(gatheringUrl).length
            totalRES += Object.keys(miningUrl).length
            totalRES += Object.keys(woodCuttingUrl).length
            let totalCRE = Object.keys(animalUrl).length-1
            let totalINV = Object.keys(carpentryUrl).length
            totalINV += Object.keys(cookedUrl).length
            totalINV += Object.keys(corpseUrl).length
            totalINV += Object.keys(doctoringUrl).length
            totalINV += Object.keys(furnitureUrl).length
            totalINV += Object.keys(equipmentUrl).length
            totalINV += Object.keys(foragingUrl).length
            totalINV += Object.keys(gatheringUrl).length
            totalINV += Object.keys(medicalUrl).length
            totalINV += Object.keys(miningUrl).length
            totalINV += Object.keys(otherUrl).length
            totalINV += Object.keys(smithingUrl).length
            totalINV += Object.keys(toolUrl).length
            totalINV += Object.keys(woodCuttingUrl).length
            $('#infoDiv')
                .append($('<div>')
                .append('Node : '+Object.keys(jsonData).length+' / '+totalNode+'<br>'))
                .append($('<div>',{onclick:"showLast('RES');",style:"cursor: pointer;"})
                    .append('Resource : '+Object.keys(resDataDict).length+' / '+totalRES+'<br>'))
                .append($('<div>',{onclick:"showLast('CRE');",style:"cursor: pointer;"})
                    .append('Creature : '+Object.keys(creDataDict).length+' / '+totalCRE+'<br>'))
                .append($('<div>',{onclick:"showLast('INV');",style:"cursor: pointer;"})
                    .append('Item : '+Object.keys(invDataDict).length+' / '+totalINV+'<br>'))
                
            
        }
        function showLast(type){
            if(type == 'RES'){
                $('#settingPage').show();
                $('#settingPage').html('')
                $('#settingPage')
                    .append($('<div>', { id: "resourceDataDiv", class: "nodeDataAreaContent",style:"flex-direction: column;" }))
                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'backBTN' }).append('返回'))
                    )
                $('#backBTN').click(function () {
                    $('#settingPage').html('')
                    $('#settingPage').hide();
                })
                $('#resourceDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                $('#resourceDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0;font-size:20px;" })
                        .append(langCompared['filterByName'][langNow])
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                )
                $('#resourceDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append('未完成ID配對清單-資源'))
                $('#searchInput').keyup(function () {
                    let allResource = []
                    for (i in huntableAnimalList) {
                        if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(creDataDict).includes(i) == false) {
                            let oneDict = {}
                            oneDict['name'] = huntableAnimalList[i]
                            oneDict['url'] = animalUrl[huntableAnimalList[i].replace(/ /g, '-')]
                            allResource.push(oneDict)
                        }
                    }
                    for (i in foragingUrl) {
                        if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && i.includes('Seed') == false && Object.values(resDataDict).includes(i.replace(/-/g, ' ')) == false) {
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['url'] = foragingUrl[i]
                            allResource.push(oneDict)
                        }
                    }
                    for (i in gatheringUrl) {
                        if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(resDataDict).includes(i.replace(/-/g, ' ')) == false) {
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['url'] = gatheringUrl[i]
                            allResource.push(oneDict)
                        }
                    }
                    for (i in miningUrl) {
                        if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(resDataDict).includes(i.replace(/-/g, ' ')) == false) {
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['url'] = miningUrl[i]
                            allResource.push(oneDict)
                        }
                    }
                    for (i in woodCuttingUrl) {
                        if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(resDataDict).includes(i.replace(/-/g, ' ')) == false) {
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['url'] = woodCuttingUrl[i]
                            allResource.push(oneDict)
                        }
                    }
                    filtiedResource(allResource);
                })
                let allResource = []
                for (i in huntableAnimalList) {
                    if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(resDataDict).includes(huntableAnimalList[i]) == false) {
                        let oneDict = {}
                        oneDict['name'] = huntableAnimalList[i]
                        oneDict['url'] = animalUrl[huntableAnimalList[i].replace(/ /g, '-')]
                        allResource.push(oneDict)
                    }
                }
                for (i in foragingUrl) {
                    if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && i.includes('Seed') == false && Object.values(resDataDict).includes(i.replace(/-/g, ' ')) == false
                         && i.includes('Seed') == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = foragingUrl[i]
                        allResource.push(oneDict)
                    }
                }
                for (i in gatheringUrl) {
                    if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(resDataDict).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = gatheringUrl[i]
                        allResource.push(oneDict)
                    }
                }
                for (i in miningUrl) {
                    if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(resDataDict).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = miningUrl[i]
                        allResource.push(oneDict)
                    }
                }
                for (i in woodCuttingUrl) {
                    if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(resDataDict).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = woodCuttingUrl[i]
                        allResource.push(oneDict)
                    }
                }
                filtiedResource(allResource);
                function filtiedResource(dataList) {
                    $('#optionDataDiv').html('');
                    for (var i = 0; i < dataList.length; i++) {
                        appendResourceImage(i);
                    }
                    function appendResourceImage(resourceIndex) {
                        let figPath = dataList[resourceIndex]['url'];
                        let name = dataList[resourceIndex]['name'];

                        let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                        .append($('<img>', { class: "itemFig", src: figPath }));

                        // 綁定 mouseenter 和 mouseleave 事件
                        newDiv.mouseenter(function(e) {
                            $('.info-tag').text(name)
                                        .css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                        }).mouseleave(function() {
                            $('.info-tag').hide();
                        });

                        $('#optionDataDiv').append(newDiv);
                    }
                }
            }
            else if(type == 'CRE'){
                $('#settingPage').show();
                $('#settingPage').html('')
                $('#settingPage')
                    .append($('<div>', { id: "animalDataDiv", class: "nodeDataAreaContent",style:"flex-direction: column;" }))
                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;"})
                        .append($('<button>', { id: 'backBTN' }).append('返回'))
                    )
                $('#resourceFig').hide();
                $('#backBTN').click(function () {
                    $('#settingPage').html('')
                    $('#settingPage').hide();
                })
                $('#animalDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                $('#animalDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0;font-size:20px;" })
                        .append(langCompared['filterByName'][langNow])
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                )
                $('#animalDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append('未完成ID配對清單-生物'))
                $('#searchInput').keyup(function () {
                    let newList = []                        
                    for (i of animalUrl) {
                        if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempCre).includes(i.replace(/-/g, ' ')) == false && i!='Fishing-Spot') {
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['url'] = animalUrl[i]
                            newList.push(oneDict)
                        }
                    }
                    filtiedAnimal(newList);
                })
                let newList = []
                for (i in animalUrl) {
                    if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempCre).includes(i.replace(/-/g, ' ')) == false && i!='Fishing-Spot') {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = animalUrl[i]
                        newList.push(oneDict)
                    }
                }
                filtiedAnimal(newList);
                function filtiedAnimal(dataList) {
                    $('#optionDataDiv').html('')
                    for (var i = 0; i < dataList.length; i++) {
                        appendAnimalImage(i);
                    }
                    function appendAnimalImage(animalIndex) {
                        let figPath = dataList[animalIndex]['url'];
                        let name = dataList[animalIndex]['name'];

                        let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                        .append($('<img>', { class: "itemFig", src: figPath }));

                        // 綁定 mouseenter 和 mouseleave 事件
                        newDiv.mouseenter(function(e) {
                            $('.info-tag').text(name)
                                        .css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                        }).mouseleave(function() {
                            $('.info-tag').hide();
                        });

                        $('#optionDataDiv').append(newDiv);
                    }
                }
            }
            else if(type == 'INV'){
                $('#settingPage').show();
                $('#settingPage').html('')
                $('#settingPage')
                    .append($('<div>', { id: "itemDataDiv", class: "nodeDataAreaContent",style:"flex-direction: column;" }))
                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'backBTN' }).append('返回'))
                    )
                $('#resourceFig').hide();
                $('#backBTN').click(function () {
                    $('#settingPage').html('')
                    $('#settingPage').hide();
                })
                $('#itemDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                $('#itemDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0" })
                        .append($('<div>', { id: 'searchMethodDiv', style: "font-size:20px" }).append(langCompared['filterByCategory'][langNow]))
                        .append($('<select>', { id: 'typeSel', class: "qtyDiv", style: "font-size:20px; padding:0px; height:30px" }))
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                        .append($('<button>', { id: 'backBTN', style: 'width: auto;' }).append(langCompared['switchTo'][langNow]+langCompared['filterByName'][langNow]).click(function () {
                            if (searchMethodState == 'type') {
                                $('#optionDataDiv').html('');
                                searchMethodState = 'name';
                                $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByCategory'][langNow])
                                $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                                $('#typeSel').hide()
                                $('#searchInput').show()
                            }
                            else {
                                $('#searchInput').val('');
                                let allItem = [];
                                for (i in cookedUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'cooked'
                                        oneDict['url'] = cookedUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in corpseUrl) {
                                    let name = i.replace(/-/g, ' ');
                                    name = name.replace(/Red eyed/g, 'Red-eyed')
                                    if (Object.values(tempInv).includes(name) == false){
                                        let oneDict = {}
                                        oneDict['name'] = name
                                        oneDict['type'] = 'corpse'
                                        oneDict['url'] = corpseUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in furnitureUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'furniture'
                                        oneDict['url'] = furnitureUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in doctoringUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'doctoring'
                                        oneDict['url'] = doctoringUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in equipmentUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'equipment'
                                        oneDict['url'] = equipmentUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in foragingUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'foraging'
                                        oneDict['url'] = foragingUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in gatheringUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'gathering'
                                        oneDict['url'] = gatheringUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in medicalUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'medical'
                                        oneDict['url'] = medicalUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in miningUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'mining'
                                        oneDict['url'] = miningUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in otherUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'other'
                                        oneDict['url'] = otherUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in toolUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'tool'
                                        oneDict['url'] = toolUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in carpentryUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'carpentry'
                                        oneDict['url'] = carpentryUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in woodCuttingUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'woodcutting'
                                        oneDict['url'] = woodCuttingUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in smithingUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'smithing'
                                        oneDict['url'] = smithingUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                filtiedResource(allItem);
                                searchMethodState = 'type';
                                $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByName'][langNow])
                                $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                                $('#typeSel').show()
                                $('#searchInput').hide()
                            }

                        }))
                )
                if (searchMethodState == 'name') {
                    $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByCategory'][langNow])
                    $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                    $('#typeSel').hide()
                    $('#searchInput').show()
                }
                else {
                    $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByName'][langNow])
                    $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                    $('#typeSel').show()
                    $('#searchInput').hide()
                }
                $('#itemDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle", style: "font-size:20px" }).append(langCompared['itemList'][langNow]))
                for (i in itemTypeTranslate) {
                    if(langNow == 'zh') $('<option>', { value: i }).append(itemTypeTranslate[i]).appendTo($('#typeSel'))
                    else if(langNow == 'en') $('<option>', { value: i }).append(i).appendTo($('#typeSel'))
                }
                
                function appendItemImage(itemIndex, dataList) {
                    let figPath = dataList[itemIndex]['url'];
                    let name = dataList[itemIndex]['name'];

                    let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                    .append($('<img>', { class: "itemFig", src: figPath }));

                    // 綁定 mouseenter 和 mouseleave 事件
                    newDiv.mouseenter(function(e) {
                        $('.info-tag').text(name)
                                    .css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                    }).mouseleave(function() {
                        $('.info-tag').hide();
                    });

                    $('#optionDataDiv').append(newDiv);
                }
                function filtiedResource(dataList) {
                    $('#optionDataDiv').html('')
                    for (var i = 0; i < dataList.length; i++) {
                        if (dataList[i]['type'] == $('#typeSel').val()) appendItemImage(i, dataList);
                    }

                }
                let allItem = [];
                for (i in cookedUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'cooked'
                        oneDict['url'] = cookedUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in corpseUrl) {
                    let name = i.replace(/-/g, ' ');
                    name = name.replace(/Red eyed/g, 'Red-eyed')
                    if (Object.values(tempInv).includes(name) == false){
                        let oneDict = {}
                        oneDict['name'] = name
                        oneDict['type'] = 'corpse'
                        oneDict['url'] = corpseUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in furnitureUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'furniture'
                        oneDict['url'] = furnitureUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in doctoringUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'doctoring'
                        oneDict['url'] = doctoringUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in equipmentUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'equipment'
                        oneDict['url'] = equipmentUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in foragingUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'foraging'
                        oneDict['url'] = foragingUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in gatheringUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'gathering'
                        oneDict['url'] = gatheringUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in medicalUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'medical'
                        oneDict['url'] = medicalUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in miningUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'mining'
                        oneDict['url'] = miningUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in otherUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'other'
                        oneDict['url'] = otherUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in toolUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'tool'
                        oneDict['url'] = toolUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in carpentryUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'carpentry'
                        oneDict['url'] = carpentryUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in woodCuttingUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'woodcutting'
                        oneDict['url'] = woodCuttingUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in smithingUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'smithing'
                        oneDict['url'] = smithingUrl[i]
                        allItem.push(oneDict)
                    }
                }

                $('#typeSel').change(function (event) {
                    filtiedResource(allItem);
                })
                filtiedResource(allItem);
                $('#searchInput').keyup(() => {
                    $('#optionDataDiv').html('')
                    let allItem = [];
                    for (i in cookedUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'cooked'
                            oneDict['url'] = cookedUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in corpseUrl) {
                        let name = i.replace(/-/g, ' ');
                        name = name.replace(/Red eyed/g, 'Red-eyed')
                        if (Object.values(tempInv).includes(name) == false){
                            let oneDict = {}
                            oneDict['name'] = name
                            oneDict['type'] = 'corpse'
                            oneDict['url'] = corpseUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in furnitureUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'furniture'
                            oneDict['url'] = furnitureUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in doctoringUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'doctoring'
                            oneDict['url'] = doctoringUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in equipmentUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'equipment'
                            oneDict['url'] = equipmentUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in foragingUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'foraging'
                            oneDict['url'] = foragingUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in gatheringUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'gathering'
                            oneDict['url'] = gatheringUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in medicalUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'medical'
                            oneDict['url'] = medicalUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in miningUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'mining'
                            oneDict['url'] = miningUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in otherUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'other'
                            oneDict['url'] = otherUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in toolUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'tool'
                            oneDict['url'] = toolUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in carpentryUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'carpentry'
                            oneDict['url'] = carpentryUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in woodCuttingUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'woodcutting'
                            oneDict['url'] = woodCuttingUrl[i]
                            allItem.push(oneDict)
                        }
                    }
                    for (i in smithingUrl) {
                        if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['type'] = 'smithing'
                            oneDict['url'] = smithingUrl[i]
                            allItem.push(oneDict)
                        }
                    }

                    let newList = []
                    for (i in allItem) {
                        if (allItem[i]['name'].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = allItem[i]['name']
                            oneDict['url'] = allItem[i]['url']
                            newList.push(oneDict)
                        }
                    }
                    for (i in newList) {
                        appendItemImage(i, newList);
                    }
                })
            }
        }
        function resetNodeColor(){
            for(i of $('.interactive-circle')){
                let innerColor = 'black';
                if(recordNodeList.includes(i.id)) innerColor = 'green';
                $('#'+i.id).attr('class','interactive-circle '+innerColor)
            }
        }
        function mutiNodeDataInput(){
            if(verifiedData.length != transformedData.length){
                for(index = verifiedData.length; index<transformedData.length;index++){
                    if(transformedData[index]['nodeId'] in jsonData == false){
                        console.log(transformedData)
                        mutiInputState = 1;
                        if(index == 0 && nodeNow !== ''){
                            transformedData[index]['mapId'] = nodeNow;
                            verifiedData.push(transformedData[index]);
                            $('#'+nodeNow).attr('class','interactive-circle redCircle orange')
                            showMsg(0)
                        }
                        else if(nodeNow === '' || nodeNow === verifiedData[verifiedData.length-1]['mapId']){
                            waitForClickNode = 1
                            // console.log(transformedData[index]['nodeId'])
                            showMsg(1,'節點'+transformedData[index]['nodeId']+'未被記錄，請點選節點('+verifiedData.length+' / '+transformedData.length+')');
                            return
                        }
                    }
                    else{
                        transformedData[index]['mapId'] = jsonData[transformedData[index]['nodeId']];
                        verifiedData.push(transformedData[index]);
                        if(nodeNow !== '') $('#'+nodeNow).attr('class','interactive-circle blackCircle orange')

                        nodeNow = transformedData[index]['mapId'];
                        $('#'+nodeNow).attr('class','interactive-circle redCircle orange')
                        $('.blackCircle').css('border', 5/nodeScaleNow+'px #000000 solid')
                        $('.redCircle').css('border', 5/nodeScaleNow+'px #ff0000 solid')
                        showMsg(0)
                    }
                }
            }
            if(verifiedData.length == transformedData.length){
                nodeNow = ''
                showMsg(0)
                setTimeout(function() {
                    $('.interactive-circle').css('border', 5/nodeScaleNow+'px #000000 solid')
                    if(confirm('所有資料已讀取，請確認路徑是否正確?')){
                        let dataContent = []
                        for(i of verifiedData){
                            if(i['nodeId'] in jsonData == false){
                                let oneData = {}
                                oneData['authNodeId'] = i['nodeId']
                                oneData['mapNodeId'] = i['mapId']
                                dataContent.push(oneData)
                                jsonData[i['nodeId']] = i['mapId']
                            }
                        }
                        if(dataContent.length != 0) sendData('nodeId',JSON.stringify(dataContent));
                        recordNodeList = Object.values(jsonData);
                        resetNodeColor();
                        // console.log(verifiedData);
                        transformedData = [];
                        dataMaping('RES');
                    }
                    else{
                        alert('已取消輸入');
                        $('.interactive-circle orange').attr('class','interactive-circle blackCircle orange')
                        $('.interactive-circle green').attr('class','interactive-circle blackCircle green')
                        transformedData = []
                        verifiedData = []
                        recordNodeList = Object.values(jsonData);
                        resetNodeColor()
                    }
                }, 0)
                
            }
        }
        function dataMaping(type){
            if(type == 'RES'){
                for(i of verifiedData){
                    for(resData of i['Data']['RES']){
                        if(resData['id'] in tempRes == false){
                            for(typeName in nameData){
                                if(typeName != 'animalList'){
                                    if(resData['name'].replace(/ /g,'-') in nameData[typeName]){
                                        tempRes[resData['id']] = resData['name'];
                                        break
                                    }
                                }
                            }
                            if(resData['id'] in tempRes == false){
                                showSettingPage('RES',resData);
                                return
                            }
                        }
                    }
                }
                for (let key in resDataDict) {
                    if (resDataDict.hasOwnProperty(key) && tempRes.hasOwnProperty(key)) {
                        delete tempRes[key];
                    }
                }
                if(Object.keys(tempRes).length != 0){
                    sendData('RES',JSON.stringify(tempRes))
                    Object.assign(resDataDict, tempRes);
                }
                tempRes = JSON.parse(JSON.stringify(resDataDict))
                dataMaping('CRE')
            }
            else if(type == 'CRE'){
                for(i of verifiedData){
                    for(creData of i['Data']['CRE']){
                        if(creData['id'] in tempCre == false){
                            showSettingPage('CRE',creData);
                            return
                        }
                    }
                }
                for (let key in creDataDict) {
                    if (creDataDict.hasOwnProperty(key) && tempCre.hasOwnProperty(key)) {
                        delete tempCre[key];
                    }
                }
                if(Object.keys(tempCre).length != 0){
                    // console.log(tempCre)
                    sendData('CRE',JSON.stringify(tempCre))
                    Object.assign(creDataDict, tempCre);
                }
                tempCre = JSON.parse(JSON.stringify(creDataDict))
                dataMaping('INV')
            }
            else if(type == 'INV'){
                for(i of verifiedData){
                    for(invData of i['Data']['INV']){
                        if(invData['id'] in tempInv == false){
                            for(typeName in nameData){
                                if(typeName != 'animalList' && typeName != 'animalUrl'){
                                    if(invData['name'].replace(/ /g,'-') in nameData[typeName]){
                                        tempInv[invData['id']] = invData['name'];
                                        break
                                    }
                                }
                            }
                            if(invData['id'] in tempInv == false){
                                showSettingPage('INV',invData);
                                return
                            }
                        }
                    }
                }
                for (let key in invDataDict) {
                    if (invDataDict.hasOwnProperty(key) && tempInv.hasOwnProperty(key)) {
                        delete tempInv[key];
                    }
                }
                if(Object.keys(tempInv).length != 0){
                    // console.log(tempInv)
                    sendData('INV',JSON.stringify(tempInv))
                    Object.assign(invDataDict, tempInv);
                }
                tempInv = JSON.parse(JSON.stringify(invDataDict))
                let outputRecord = []
                let outputInfo = {}
                if (userName == '') {
                    let name = prompt(langCompared['yourName'][langNow]+'？')
                    if (name != null && name != '') userName = name;
                    else {
                        userName = ''
                    }
                }
                for(oneData of verifiedData){
                    let outputNode = {}
                    let outputCre = []
                    let outputRes = []
                    let outputInv = []
                    let oneInfo = {}
                    for(oneCreOri of oneData['Data']['CRE']){
                        let hasShow = 0;
                        for(oneReadyCreIndex in outputCre){
                            if(outputCre[oneReadyCreIndex]['name'] == tempCre[oneCreOri['id']] && outputCre[oneReadyCreIndex]['activity'] != oneCreOri['nonAggressive']){
                                outputCre[oneReadyCreIndex]['quentity'] +=1;
                                hasShow = 1;
                                break
                            }
                        }
                        if(hasShow == 0){
                            let oneCreData = {}
                            oneCreData['name'] = tempCre[oneCreOri['id']]
                            oneCreData['quentity'] = 1
                            if(oneCreOri['nonAggressive'])oneCreData['activity'] = 0
                            else oneCreData['activity'] = 1
                            outputCre.push(oneCreData)
                        }
                    }
                    for(oneResOri of oneData['Data']['RES']){
                        let oneResData = {}
                        oneResData['name'] = tempRes[oneResOri['id']]
                        if(oneResOri['density'] >4)oneResOri['density'] = 4
                        oneResData['quentity'] = oneResOri['density']
                        outputRes.push(oneResData)
                    }
                    for(oneInvOri of oneData['Data']['INV']){
                        let hasShow = 0;
                        for(oneReadyInvIndex in outputInv){
                            if(outputInv[oneReadyInvIndex]['name'] == tempInv[oneInvOri['id']] && 
                                oneInvOri['durabilityStageName'] != "Rotten"&& 
                                oneInvOri['durabilityStageName'] != "Spoiling"&& 
                                oneInvOri['durabilityStageName'] != "Ruined"&& 
                                oneInvOri['durabilityStageName'] != "Battered"){
                                outputInv[oneReadyInvIndex]['quentity'] +=oneInvOri['amount'];
                                hasShow = 1;
                                break
                            }
                        }
                        if(hasShow == 0 && oneInvOri['durabilityStageName'] != "Rotten" && 
                            oneInvOri['durabilityStageName'] != "Spoiling" && 
                            oneInvOri['durabilityStageName'] != "Ruined" && 
                            oneInvOri['durabilityStageName'] != "Battered"){
                            let oneInvData = {}
                            oneInvData['name'] = tempInv[oneInvOri['id']]
                            oneInvData['quentity'] = oneInvOri['amount']
                            outputInv.push(oneInvData)
                        }
                    }
                    outputNode['area'] = oneData['mapId']
                    outputNode['animal'] = outputCre
                    outputNode['resource'] = outputRes
                    outputNode['item'] = outputInv
                    if (userName != ''){
                        outputNode['recorder'] = userName
                        oneInfo['recorder'] = userName
                    } 
                    // outputRecord.push(outputNode)
                    sendData('Record',JSON.stringify(outputNode))
                    oneInfo['order'] = oneData['Data']['order']
                    oneInfo['space'] = oneData['Data']['SPACE']
                    oneInfo['path'] = oneData['Data']['PATHS']
                    outputInfo[oneData['mapId']] = oneInfo
                }
                // sendData('Record',JSON.stringify(outputRecord))
                sendData('Info',JSON.stringify(outputInfo))
            }
        }
        function showSettingPage(type,data){
            $('#settingPage').show();
            $('#settingPage').html('')
            var windowFeatures = "width=50,height=50,resizable=yes,scrollbars=yes";
            // myWindow = window.open('https://play.soulforged.net/api/res/457261.png', 'ImageWindow', windowFeatures);
            var x = window.screenX + 100; // 主窗口的位置 + 100px
            var y = window.screenY + 100; // 主窗口的位置 + 100px
            var width = 50;
            var height = 50;
            // console.log(data['id'])
            myWindow = window.open('https://play.soulforged.net/api/res/'+data['id']+'.png', data['name'], "width=" + width + ",height=" + height + ",left=" + x + ",top=" + y);
            // alwaysShow();
            if(myWindow) myWindow.focus();
            if(type == 'RES'){
                $('#settingPage')
                    .append($('<div>', { id: 'resourceTitleDiv', class: "nodeDataAreaTitle" })
                        .append('未知資源：'+ data['name'])
                    )
                    .append($('<div>', { id: "resourceDataDiv", class: "nodeDataAreaContent",style:"flex-direction: column;height:100px;" })
                        .append($('<img>', { id: "resourceFig", class: "itemFig" }))
                        .append($('<div>',{id:'resName'})
                        .append(data['name'])))
                        

                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'noFoundBTN' }).append('找不到'))
                        .append($('<div>',{class:'emptyFlex'}))
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['ok'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                $('#resourceFig').hide();
                $('#noFoundBTN').click(function () {
                    $('#settingPage').hide();
                    if(myWindow)myWindow.close();
                    if(confirm('將暫停本次新增，並將資料提交給管理者鑑別後再匯入。確認執行?') ==false) dataMaping('RES');
                    else sendData('Issue',JSON.stringify(verifiedData));
                })
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    if(myWindow)myWindow.close();
                    if(confirm('尚未完成資源登錄，確認放棄新增?') ==false) dataMaping('RES');
                    else {
                        $('.interactive-circle green').attr('class','interactive-circle blackCircle green')
                        transformedData = []
                        verifiedData = []
                        recordNodeList = Object.values(jsonData);
                        resetNodeColor()
                    }
                })
                $('#saveBTN').hide();
                $('#resourceDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                $('#resourceDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0;font-size:20px;" })
                        .append(langCompared['filterByName'][langNow])
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                )
                $('#resourceDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append(langCompared['resourceList'][langNow]))
                $('#searchInput').keyup(function () {
                    let allResource = []
                    for (i in huntableAnimalList) {
                        if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = huntableAnimalList[i]
                            oneDict['url'] = animalUrl[huntableAnimalList[i].replace(/ /g, '-')]
                            allResource.push(oneDict)
                        }
                    }
                    for (i in foragingUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && i.includes('Seed') == false) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = foragingUrl[i]
                            allResource.push(oneDict)
                        }
                    }
                    for (i in gatheringUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = gatheringUrl[i]
                            allResource.push(oneDict)
                        }
                    }
                    for (i in miningUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = miningUrl[i]
                            allResource.push(oneDict)
                        }
                    }
                    for (i in woodCuttingUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = woodCuttingUrl[i]
                            allResource.push(oneDict)
                        }
                    }
                    filtiedResource(allResource);
                })
                let allResource = []
                for (i in huntableAnimalList) {
                    if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(huntableAnimalList[i]) == false) {
                        let oneDict = {}
                        oneDict['name'] = huntableAnimalList[i]
                        oneDict['url'] = animalUrl[huntableAnimalList[i].replace(/ /g, '-')]
                        allResource.push(oneDict)
                    }
                }
                for (i in foragingUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(i) == false && i.includes('Seed') == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = foragingUrl[i]
                        allResource.push(oneDict)
                    }
                }
                for (i in gatheringUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(i) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = gatheringUrl[i]
                        allResource.push(oneDict)
                    }
                }
                for (i in miningUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(i) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = miningUrl[i]
                        allResource.push(oneDict)
                    }
                }
                for (i in woodCuttingUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(i) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = woodCuttingUrl[i]
                        allResource.push(oneDict)
                    }
                }
                filtiedResource(allResource);
                function filtiedResource(dataList) {
                    $('#optionDataDiv').html('');
                    for (var i = 0; i < dataList.length; i++) {
                        appendResourceImage(i);
                    }
                    
                    function appendResourceImage(resourceIndex) {
                        let figPath = dataList[resourceIndex]['url'];
                        let name = dataList[resourceIndex]['name'];

                        let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                            .append($('<img>', { class: "itemFig", src: figPath })
                                .click(function () {
                                    $('.info-tag').hide();
                                    $('#saveBTN').click(function () {
                                        if(myWindow)myWindow.close();
                                        $('#settingPage').hide();
                                        tempRes[data['id']] = dataList[resourceIndex]['name'];
                                        // console.log(dataList[resourceIndex]['name'])
                                        dataMaping('RES');
                                    })
                                    $('#saveBTN').show();
                                    $('#resourceFig').show();
                                    $('#resName').html(dataList[resourceIndex]['name'])
                                    $('#resourceFig').attr('src',dataList[resourceIndex]['url'])
                                    // console.log(dataList[resourceIndex]['name'])
                                    
                                })
                            );

                        // 綁定 mouseenter 和 mouseleave 事件
                        newDiv.mouseenter(function(e) {
                            $('.info-tag').text(name)
                                        .css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                        }).mouseleave(function() {
                            $('.info-tag').hide();
                        });

                        $('#optionDataDiv').append(newDiv);
                    }
                }
            }
            else if(type == 'CRE'){
                $('#settingPage')
                    .append($('<div>', { id: 'animalTitleDiv', class: "nodeDataAreaTitle" })
                        .append('未知生物')
                    )
                    .append($('<div>', { id: "animalDataDiv", class: "nodeDataAreaContent",style:"flex-direction: column;height:100px;" })
                        .append($('<img>', { id: "resourceFig", class: "itemFig" }))
                        .append($('<div>',{id:'resName'})
                        .append(data['name'])))

                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;"})
                        .append($('<button>', { id: 'noFoundBTN' }).append('找不到'))
                        .append($('<div>',{class:'emptyFlex'}))
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['ok'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                $('#resourceFig').hide();
                $('#noFoundBTN').click(function () {
                    $('#settingPage').hide();
                    if(myWindow)myWindow.close();
                    if(confirm('將暫停本次新增，並將資料提交給管理者鑑別後再匯入。確認執行?') ==false) dataMaping('CRE');
                    else sendData('Issue',JSON.stringify(verifiedData));
                })
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    if(myWindow)myWindow.close();
                    if(confirm('尚未完成資源登錄，確認放棄新增?') ==false) dataMaping('CRE');
                    else {
                        $('.interactive-circle green').attr('class','interactive-circle blackCircle green')
                        transformedData = []
                        verifiedData = []
                        recordNodeList = Object.values(jsonData);
                        resetNodeColor()
                    }
                })
                $('#animalDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                $('#animalDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0;font-size:20px;" })
                        .append(langCompared['filterByName'][langNow])
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                )
                $('#animalDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append(langCompared['creatureList'][langNow]))
                $('#searchInput').keyup(function () {
                    let newList = []
                        
                    for (i in animalUrl) {
                        if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempCre).includes(i) == false && i!='Fishing-Spot') {
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['url'] = animalUrl[i]
                            newList.push(oneDict)
                        }
                    }
                    filtiedAnimal(newList);
                })
                let newList = []
                for (i in animalUrl) {
                    if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempCre).includes(i) == false && i!='Fishing-Spot') {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = animalUrl[i]
                        newList.push(oneDict)
                    }
                }
                filtiedAnimal(newList);
                function filtiedAnimal(dataList) {
                    $('#optionDataDiv').html('')
                    for (var i = 0; i < dataList.length; i++) {
                        appendAnimalImage(i);
                    }
                    function appendAnimalImage(animalIndex) {
                        let figPath = dataList[animalIndex]['url'];
                        let name = dataList[animalIndex]['name'];

                        let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                        .append($('<img>', { class: "itemFig", src: figPath })
                                        .click(function () {
                                            $('.info-tag').hide();
                                            $('#saveBTN').click(function () {
                                                if(myWindow)myWindow.close();
                                                $('#settingPage').hide();
                                                tempCre[data['id']] = dataList[animalIndex]['name'];
                                                // console.log(dataList[animalIndex]['name'])
                                                dataMaping('CRE');
                                                })
                                            $('#saveBTN').show();
                                            $('#resourceFig').show();
                                            $('#resName').html(dataList[animalIndex]['name'])
                                            $('#resourceFig').attr('src',dataList[animalIndex]['url'])
                                            // console.log(dataList[animalIndex]['name'])
                                            
                                            })
                                        );

                        // 綁定 mouseenter 和 mouseleave 事件
                        newDiv.mouseenter(function(e) {
                            $('.info-tag').text(name)
                                        .css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                        }).mouseleave(function() {
                            $('.info-tag').hide();
                        });

                        $('#optionDataDiv').append(newDiv);
                    }
                }
            }
            else if(type == 'INV'){
                $('#settingPage')
                    .append($('<div>', { id: 'itemTitleDiv', class: "nodeDataAreaTitle" })
                        .append('未知道具')
                    )
                    .append($('<div>', { id: "itemDataDiv", class: "nodeDataAreaContent",style:"flex-direction: column;height:100px;" })
                        .append($('<img>', { id: "resourceFig", class: "itemFig" }))
                        .append($('<div>',{id:'resName'})
                        .append(data['name'])))

                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'noFoundBTN' }).append('找不到'))
                        .append($('<div>',{class:'emptyFlex'}))
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['ok'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                $('#resourceFig').hide();
                $('#noFoundBTN').click(function () {
                    $('#settingPage').hide();
                    if(myWindow)myWindow.close();
                    if(confirm('將暫停本次新增，並將資料提交給管理者鑑別後再匯入。確認執行?') ==false) dataMaping('INV');
                    else sendData('Issue',JSON.stringify(verifiedData));
                })
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    if(myWindow)myWindow.close();
                    if(confirm('尚未完成資源登錄，確認放棄新增?') ==false) dataMaping('INV');
                    else {
                        $('.interactive-circle green').attr('class','interactive-circle blackCircle green')
                        transformedData = []
                        verifiedData = []
                        recordNodeList = Object.values(jsonData);
                        resetNodeColor()
                    }
                })
                $('#itemDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                $('#itemDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0" })
                        .append($('<div>', { id: 'searchMethodDiv', style: "font-size:20px" }).append(langCompared['filterByCategory'][langNow]))
                        .append($('<select>', { id: 'typeSel', class: "qtyDiv", style: "font-size:20px; padding:0px; height:30px" }))
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                        .append($('<button>', { id: 'backBTN', style: 'width: auto;' }).append(langCompared['switchTo'][langNow]+langCompared['filterByName'][langNow]).click(function () {
                            if (searchMethodState == 'type') {
                                $('#optionDataDiv').html('');
                                searchMethodState = 'name';
                                $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByCategory'][langNow])
                                $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                                $('#typeSel').hide()
                                $('#searchInput').show()
                            }
                            else {
                                $('#searchInput').val('');
                                let allItem = [];
                                for (i in cookedUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'cooked'
                                        oneDict['url'] = cookedUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in corpseUrl) {
                                    let name = i.replace(/-/g, ' ');
                                    name = name.replace(/Red eyed/g, 'Red-eyed')
                                    if (Object.values(tempInv).includes(name) == false){
                                        let oneDict = {}
                                        oneDict['name'] = name
                                        oneDict['type'] = 'corpse'
                                        oneDict['url'] = corpseUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in furnitureUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'furniture'
                                        oneDict['url'] = furnitureUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in doctoringUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'doctoring'
                                        oneDict['url'] = doctoringUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in equipmentUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'equipment'
                                        oneDict['url'] = equipmentUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in foragingUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'foraging'
                                        oneDict['url'] = foragingUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in gatheringUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'gathering'
                                        oneDict['url'] = gatheringUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in medicalUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'medical'
                                        oneDict['url'] = medicalUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in miningUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'mining'
                                        oneDict['url'] = miningUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in otherUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'other'
                                        oneDict['url'] = otherUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in toolUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'tool'
                                        oneDict['url'] = toolUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in carpentryUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'carpentry'
                                        oneDict['url'] = carpentryUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in woodCuttingUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'woodcutting'
                                        oneDict['url'] = woodCuttingUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i in smithingUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'smithing'
                                        oneDict['url'] = smithingUrl[i]
                                        allItem.push(oneDict)
                                    }
                                }
                                filtiedResource(allItem);
                                searchMethodState = 'type';
                                $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByName'][langNow])
                                $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                                $('#typeSel').show()
                                $('#searchInput').hide()
                            }

                        }))
                )
                if (searchMethodState == 'name') {
                    $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByCategory'][langNow])
                    $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                    $('#typeSel').hide()
                    $('#searchInput').show()
                }
                else {
                    $('#backBTN').html(langCompared['switchTo'][langNow]+langCompared['filterByName'][langNow])
                    $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                    $('#typeSel').show()
                    $('#searchInput').hide()
                }
                $('#itemDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle", style: "font-size:20px" }).append(langCompared['itemList'][langNow]))
                for (i in itemTypeTranslate) {
                    if(langNow == 'zh') $('<option>', { value: i }).append(itemTypeTranslate[i]).appendTo($('#typeSel'))
                    else if(langNow == 'en') $('<option>', { value: i }).append(i).appendTo($('#typeSel'))
                }
                function appendItemImage(itemIndex, dataList) {
                    let figPath = dataList[itemIndex]['url'];
                    let name = dataList[itemIndex]['name'];

                    let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                        .append($('<img>', { class: "itemFig", src: figPath })
                            .click(function () {
                                $('.info-tag').hide();
                                $('#saveBTN').click(function () {
                                    if(myWindow)myWindow.close();
                                    $('#settingPage').hide();
                                    tempInv[data['id']] = dataList[itemIndex]['name'];
                                    // console.log(dataList[itemIndex]['name'])
                                    if(indoorState == 1) mappingIndoorINV()
                                    else dataMaping('INV');
                                })
                                $('#saveBTN').show();
                                $('#resourceFig').show();
                                $('#resName').html(dataList[itemIndex]['name'])
                                $('#resourceFig').attr('src',dataList[itemIndex]['url'])
                                // console.log(dataList[itemIndex]['name'])
                            })
                        );

                    // 綁定 mouseenter 和 mouseleave 事件
                    newDiv.mouseenter(function(e) {
                        $('.info-tag').text(name)
                                    .css({ top: e.pageY+50 + 'px', left: e.pageX -10 + 'px', display: 'block' });
                    }).mouseleave(function() {
                        $('.info-tag').hide();
                    });

                    $('#optionDataDiv').append(newDiv);
                }
                function filtiedResource(dataList) {
                    $('#optionDataDiv').html('')
                    for (var i = 0; i < dataList.length; i++) {
                        if (dataList[i]['type'] == $('#typeSel').val()) appendItemImage(i, dataList);
                    }

                }
                let allItem = [];
                for (i in cookedUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'cooked'
                        oneDict['url'] = cookedUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in corpseUrl) {
                    let name = i.replace(/-/g, ' ');
                    name = name.replace(/Red eyed/g, 'Red-eyed')
                    if (Object.values(tempInv).includes(name) == false){
                        let oneDict = {}
                        oneDict['name'] = name
                        oneDict['type'] = 'corpse'
                        oneDict['url'] = corpseUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in doctoringUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'doctoring'
                        oneDict['url'] = doctoringUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in furnitureUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'furniture'
                        oneDict['url'] = furnitureUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in equipmentUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'equipment'
                        oneDict['url'] = equipmentUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in foragingUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'foraging'
                        oneDict['url'] = foragingUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in gatheringUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'gathering'
                        oneDict['url'] = gatheringUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in medicalUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'medical'
                        oneDict['url'] = medicalUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in miningUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'mining'
                        oneDict['url'] = miningUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in otherUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'other'
                        oneDict['url'] = otherUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in toolUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'tool'
                        oneDict['url'] = toolUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in carpentryUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'carpentry'
                        oneDict['url'] = carpentryUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in woodCuttingUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'woodcutting'
                        oneDict['url'] = woodCuttingUrl[i]
                        allItem.push(oneDict)
                    }
                }
                for (i in smithingUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'smithing'
                        oneDict['url'] = smithingUrl[i]
                        allItem.push(oneDict)
                    }
                }

                $('#typeSel').change(function (event) {
                    filtiedResource(allItem);
                })
                filtiedResource(allItem);
                $('#searchInput').keyup(() => {
                    if ($('#searchInput').val().length >= 1) {
                        $('#optionDataDiv').html('')

                        let allItem = [];
                        for (i in cookedUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'cooked'
                                oneDict['url'] = cookedUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in corpseUrl) {
                            let name = i.replace(/-/g, ' ');
                            name = name.replace(/Red eyed/g, 'Red-eyed')
                            if (Object.values(tempInv).includes(name) == false){
                                let oneDict = {}
                                oneDict['name'] = name
                                oneDict['type'] = 'corpse'
                                oneDict['url'] = corpseUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in furnitureUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'furniture'
                                oneDict['url'] = furnitureUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in doctoringUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'doctoring'
                                oneDict['url'] = doctoringUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in equipmentUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'equipment'
                                oneDict['url'] = equipmentUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in foragingUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'foraging'
                                oneDict['url'] = foragingUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in gatheringUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'gathering'
                                oneDict['url'] = gatheringUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in medicalUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'medical'
                                oneDict['url'] = medicalUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in miningUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'mining'
                                oneDict['url'] = miningUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in otherUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'other'
                                oneDict['url'] = otherUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in toolUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'tool'
                                oneDict['url'] = toolUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in carpentryUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'carpentry'
                                oneDict['url'] = carpentryUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in woodCuttingUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'woodcutting'
                                oneDict['url'] = woodCuttingUrl[i]
                                allItem.push(oneDict)
                            }
                        }
                        for (i in smithingUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false){
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'smithing'
                                oneDict['url'] = smithingUrl[i]
                                allItem.push(oneDict)
                            }
                        }

                        let newList = []
                        for (i in allItem) {
                            if (allItem[i]['name'].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                let oneDict = {}
                                oneDict['name'] = allItem[i]['name']
                                oneDict['url'] = allItem[i]['url']
                                newList.push(oneDict)
                            }
                        }
                        for (i in newList) {
                            appendItemImage(i, newList);
                        }
                    }
                    else $('#optionDataDiv').html('');
                })
            }
        }
        function showMsg(show,str=''){
            $('#msgDiv').html(str);
            if(show) $('#msgDiv').show();
            else $('#msgDiv').hide();
        }
        function sendData(type, data){
            showMsg(0)
            // console.log(data)
            var formData = new FormData();
            formData.append('type',type);
            formData.append('data',data);
            fetch('/JsonImput', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if(response.ok) {
                        // HTTP狀態碼在200-299之間，表示請求成功
                        return response.text();  // 你可以用 response.json() 如果後端返回的是 JSON 格式
                    } else {
                        // HTTP狀態碼在300以上，表示請求失敗
                        throw new Error('Server response was not ok: ' + response.statusText);
                    }
                })
                .then(textData => {
                    // 這裡的 data 是上面的 response.text() 的結果
                    if(textData.length == 13) {
                        if(type == 'Record' || indoorState == 1){
                            showMsg(1,'成功上傳')
                            verifiedData = []
                            indoorState = 0;
                        }
                        showInfo()
                        setTimeout(function() {
                            showMsg(0)
                        },5000)
                    } 
                    else if(textData == 'dataErr')alert('資料錯誤，將於管理員審查完成後再登錄')
                    else {
                        throw new Error('Server response was not expected: ' + textData);
                    }
                })
                .catch(error => {
                    // 這裡處理網絡錯誤和上面拋出的錯誤
                    console.error('There was a problem with the fetch operation:', error);
                    alert(langCompared['serverErr'][langNow]);
                });

        }
        function nodeOnclick(id){
            if(id == 'Q21DM1'){
                window.scrollTo(0, 0);
                $('#mapMineHead').css({'visibility':'visible'});
                $('#mapMain').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'visible'});
                $('#svgMain').css({'visibility':'hidden'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("M1UQ21");
                mapId = 'MH';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'M1UQ21'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'visible'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'visible'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("Q21DM1");
                mapId = 'Main';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'EDMH'){
                window.scrollTo(0, 0);
                $('#mapMineHead').css({'visibility':'visible'});
                $('#mapMain').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'visible'});
                $('#svgMain').css({'visibility':'hidden'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MHUE");
                mapId = 'MH';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'MHUE'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'visible'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'visible'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("EDMH");
                mapId = 'Main';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'FTDMH'){
                window.scrollTo(0, 0);
                $('#mapMineHead').css({'visibility':'visible'});
                $('#mapMain').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'visible'});
                $('#svgMain').css({'visibility':'hidden'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MHUFT");
                mapId = 'MH';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'MHUFT'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'visible'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'visible'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("FTDMH");
                mapId = 'Main';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'MUE'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'visible'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'visible'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("EDM");
                mapId = 'Main';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'MUC'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'visible'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'visible'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("CDM");
                mapId = 'Main';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'MUW1'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'visible'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'visible'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("W1DM");
                mapId = 'Main';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'MUW2'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'visible'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'visible'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("W2DM");
                mapId = 'Main';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'MUW3'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'visible'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'visible'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("W3DM");
                mapId = 'Main';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'MUW4'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'visible'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'hidden'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'visible'});
                $('#svgTT').css({'visibility':'hidden'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("W4DM");
                mapId = 'Main';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'EDM'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'hidden'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'visible'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'hidden'});
                $('#svgTT').css({'visibility':'visible'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUE");
                mapId = 'TT';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'CDM'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'hidden'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'visible'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'hidden'});
                $('#svgTT').css({'visibility':'visible'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUC");
                mapId = 'TT';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'W1DM'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'hidden'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'visible'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'hidden'});
                $('#svgTT').css({'visibility':'visible'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUW1");
                mapId = 'TT';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'W2DM'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'hidden'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'visible'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'hidden'});
                $('#svgTT').css({'visibility':'visible'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUW2");
                mapId = 'TT';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'W3DM'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'hidden'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'visible'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'hidden'});
                $('#svgTT').css({'visibility':'visible'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUW3");
                mapId = 'TT';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else if(id == 'W4DM'){
                window.scrollTo(0, 0);
                $('#mapMain').css({'visibility':'hidden'});
                $('#mapMineHead').css({'visibility':'hidden'});
                $('#mapTT').css({'visibility':'visible'});
                $('#svgMH').css({'visibility':'hidden'});
                $('#svgMain').css({'visibility':'hidden'});
                $('#svgTT').css({'visibility':'visible'});
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUW4");
                mapId = 'TT';
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({block: 'center', inline: 'center' });
                }
            }
            else{
                let innerColor = 'black';
                if(recordNodeList.includes(id)) innerColor = 'green';
                
                if(nodeNow != id){
                    if ($('#'+id).hasClass('orange')) {
                        console.log('return')
                        return
                    } else {
                        console.log('go')
                        if(mutiInputState != 0) innerColor = 'orange';
                        if(nodeNow != ''){
                            let lastInner = 'black';
                            if(recordNodeList.includes(nodeNow)) lastInner = 'green';
                            if(mutiInputState != 0){
                                lastInner = 'orange';
                                transformedData[verifiedData.length]['mapId'] = id;
                                verifiedData.push(transformedData[verifiedData.length]);
                                $('#'+nodeNow).attr('class','interactive-circle blackCircle '+lastInner)
                            }
                            else $('#'+nodeNow).attr('class','interactive-circle blackCircle '+lastInner)
                        }
                        else if(mutiInputState != 0){
                            lastInner = 'orange';
                            transformedData[verifiedData.length]['mapId'] = id;
                            verifiedData.push(transformedData[verifiedData.length]);
                        }
                        nodeNow = id
                        $('#'+id).attr('class','interactive-circle redCircle '+innerColor)
                    }
                } 
                else{
                    nodeNow = ''
                    if(mutiInputState != 0) verifiedData.pop();
                    $('#'+id).attr('class','interactive-circle blackCircle '+innerColor)
                } 
                $('.blackCircle').css('border', 5/nodeScaleNow+'px #000000 solid')
                $('.redCircle').css('border', 5/nodeScaleNow+'px #ff0000 solid')
                if(waitForClickNode == 1){
                    waitForClickNode = 0
                    mutiNodeDataInput();
                }
            }
                
        }
        function positionAndResizeCircle(circleId, posX, posY,scaleSet) {
            // var img = document.querySelector('.image-container img');
            var img = document.getElementById('imgMain')
            var circle = document.getElementById(circleId);

            var imgRect = img.getBoundingClientRect();
            var imgWidth = imgRect.width;
            var imgHeight = imgRect.height;

            // 大小
            // var newSize = 30; // 计算新的圆点大小
            // circle.style.width = newSize*scaleModify / scaleSet/nodeScaleNow  + 'px';
            // circle.style.height = newSize*scaleModify / scaleSet/nodeScaleNow  + 'px';

            // 位置
            circle.style.left = (imgWidth * posX) + 'px'; // 减去圆点宽度的一半
            circle.style.top = (imgHeight * posY) + 'px'; // 减去圆点高度的一半
        }
        function getDataFromBackend(item){
            formData = new FormData();
            formData.append('item',item);
            fetch('/getDataSet', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if(response.ok) {
                        // HTTP狀態碼在200-299之間，表示請求成功
                        return response.text();  // 你可以用 response.json() 如果後端返回的是 JSON 格式
                    } else {
                        // HTTP狀態碼在300以上，表示請求失敗
                        throw new Error('Server response was not ok: ' + response.statusText);
                    }
                })
                .then(data => {
                    let jsaonFromBE = JSON.parse(data.replace(/'/g, '"'))
                    if(item == 'mapDotMain') posisionDataMain = jsaonFromBE;
                    if(item == 'mapDotMH') posisionDataMH = jsaonFromBE;
                    if(item == 'mapDotTT') posisionDataTT = jsaonFromBE;
                    if(item == 'mapRouteMain') mapRouteMain = jsaonFromBE;
                    if(item == 'mapRouteMH') mapRouteMH = jsaonFromBE;
                    if(item == 'mapRouteTT') mapRouteTT = jsaonFromBE;
                    loadingCount += 1
                    dataOnLoad();
                })
                .catch(error => {
                    // 這裡處理網絡錯誤和上面拋出的錯誤
                    console.error('There was a problem with the fetch operation:', error);
                    console.log(item)
                    alert(langCompared['serverErr'][langNow]);
                });
        }
        function drawLineBetweenCircles(circle1Id, circle2Id,color,Rwidth,map) {
            var circle1 = document.getElementById(circle1Id);
            var circle2 = document.getElementById(circle2Id);
            // 计算圆点中心的位置
            var x1 = parseFloat(circle1.style.left);
            var y1 = parseFloat(circle1.style.top);
            var x2 = parseFloat(circle2.style.left);
            var y2 = parseFloat(circle2.style.top);

            var dx = x2 - x1;
            var dy = y2 - y1;
            
            var length = Math.sqrt(dx * dx + dy * dy);
            var dxNormalized = dx / length;
            var dyNormalized = dy / length;
            var shortenLength = 15/nodeScaleNow
            x1 = x1 + shortenLength * dxNormalized;
            y1 = y1 + shortenLength * dyNormalized;
            x2 = x2 - shortenLength * dxNormalized;
            y2 = y2 - shortenLength * dyNormalized;

            var svgNS = "http://www.w3.org/2000/svg";
            var line = document.createElementNS(svgNS, 'line');
            line.id = circle1Id + 'Link' + circle2Id;
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('style', 'stroke:' + color + ';stroke-width:'+Rwidth+';pointer-events: auto;'); 
            line.addEventListener('click', function() {
                if(editMapRoute == 1)delRoute(circle1Id , circle2Id);
            });

            if(map == 'Main') var svgContainer = document.getElementById("svgMain");
            else if(map == 'MH') var svgContainer = document.getElementById("svgMH");
            else if(map == 'TT') var svgContainer = document.getElementById("svgTT");

            
            svgContainer.appendChild(line);
        }
        function parseData(){
            showMsg(0)
            waitForClickNode = 0;
            transformedData = [];
            let paste = $('#jsonStrInput').val();
            if(paste !== ''){
                try {
                    let pasteData = JSON.parse(paste);
                    // 轉換格式
                    transformedData = Object.entries(pasteData).map(([nodeId, Data]) => ({ nodeId, Data }));
                    // 根據 order 屬性排序
                    transformedData.sort((a, b) => a.Data.order - b.Data.order);
                    console.log(transformedData)
                    indoorState = 0;
                    mutiInputState = 0
                    if('indoor' in transformedData[0]['Data']) mappingIndoorINV()
                    else mutiNodeDataInput();
                    $('#jsonStrInput').val('')
                        
                } catch (e) {
                    console.log(e)
                    alert('資料無效\n'+e);
                }
            }
        }
        
        window.onload = init;
    </script>
</head>

<body style="height: 100%; display: flex; flex-direction: column;user-select: none;visibility: hidden;">
    <div>
        <div id="pageContainer">
            <div id="mapMain" class="image-container" style="position:absolute; top:0px; left:0px;">
                <img id="imgMain" src="https://i.ibb.co/0VgtJWV/Main-0-01.jpg"
                    style=" transition: transform 0.05s ease;" />
                <!-- <img id="imgMain" src="https://i.ibb.co/WHFn1PD/Main-L.jpg"
                    style=" transition: transform 0.05s ease;" /> -->
            </div>
            <div id="mapMineHead" class="image-container" style="position:absolute; top:4531px; left:4058px;">
                <!-- <img id="imgMH" src="https://i.ibb.co/dpB88Y4/MH-02-02.png"
                    style=" transition: transform 0.05s ease;position: relative;" /> -->
                <img id="imgMH" src="https://i.ibb.co/DYRdT4f/MH.jpg"
                    style=" transition: transform 0.05s ease;position: relative;" />
            </div>
            <div id="mapTT" class="image-container" style="position:absolute; top:856px; left:1493px;">
                <img id="imgTT" src="https://i.ibb.co/DfCrDYQ/TT.jpg"
                    style=" transition: transform 0.05s ease;position: relative;" />
            </div>
            <svg id="svgMain" style="position: absolute;top:0px; left:0px;pointer-events: none;"></svg>
            <svg id="svgMH" style="position: absolute;top:4531px; left:4058px;pointer-events: none;"></svg>
            <svg id="svgTT" style="position: absolute;top:856px; left:1493px;pointer-events: none;"></svg>
        </div>
    </div>
    <div style="display: flex; justify-content: center;">
        <!-- <div class="leftBottomDiv" style="left:300px">
            
        </div> -->
        <div style="display:flex; align-items: center;position: fixed; bottom: 10px; left: 10px; background-color: white; padding: 10px; border-radius: 10px;">
            <span id="nodeScaleSwitch">節點大小</span><input type="range" id="nodeScaleControl" min="1" max="10" value="4" step="1">
        </div>
        <div id="infoDiv" style="display:flex; flex-direction: column; position: fixed; bottom: 10px; right: 10px; background-color: white; padding: 10px; border-radius: 10px;"></div>
        <div id="msgDiv" style="display:none; align-items: center;position: fixed; top: 10px; left: 10px; background-color: white; padding: 10px; border-radius: 10px;"></div>
        <!-- <div id="nodeScaleValue">1</div> -->
        <script>
            // 獲取滑動條元素
            var slider = document.getElementById('nodeScaleControl');

            // 滑動條滑動事件，暫時不更新數值
            slider.oninput = function() {
                // 不立即更新，僅用於展示如何綁定事件
            }

            // 滑鼠按鍵放開或觸摸結束時更新數值
            function updateVolume() {
                var value = slider.value;
                // document.getElementById('nodeScaleValue').textContent = value;

                nodeScaleNow = 4/value;
                loadingCount = 8;
                $('.interactive-circle').css({width: 30/nodeScaleNow+'px',height: 30/nodeScaleNow+'px', fontSize:20/nodeScaleNow+'px'})
                $('.interactive-circle').css('border', 5/nodeScaleNow+'px #000000 solid')
                $('.blackCircle').css('border', 5/nodeScaleNow+'px #000000 solid')
                $('.redCircle').css('border', 5/nodeScaleNow+'px #ff0000 solid')
                $('.greenCircle').css('border', 5/nodeScaleNow+'px #00ff00 solid')
                $('line').remove()
                for(routeIndex in mapRouteMain) drawLineBetweenCircles(mapRouteMain[routeIndex]['start'], mapRouteMain[routeIndex]['end'],mapRouteMain[routeIndex]['color'],mapRouteMain[routeIndex]['width'],'Main');
                for(routeIndex in mapRouteMH) drawLineBetweenCircles(mapRouteMH[routeIndex]['start'], mapRouteMH[routeIndex]['end'],mapRouteMH[routeIndex]['color'],mapRouteMH[routeIndex]['width'],'MH');
                for(routeIndex in mapRouteTT) drawLineBetweenCircles(mapRouteTT[routeIndex]['start'], mapRouteTT[routeIndex]['end'],mapRouteTT[routeIndex]['color'],mapRouteTT[routeIndex]['width'],'TT');

            }

            // 為滑動條添加滑鼠按鍵放開事件監聽器
            slider.addEventListener('mouseup', updateVolume);

            // 為滑動條添加觸摸結束事件監聽器
            slider.addEventListener('touchend', updateVolume);

            // function nodeScale(value) {
            //     // document.getElementById('nodeScaleValue').textContent = value;
            //     nodeScaleNow = value;
            //     loadingCount = 8;
            //     onReload();
            // }
        </script>
        <div id="settingPage" style="display: none;"></div>
        <div style="position: fixed; display: flex;border-radius: 5px; border: 1px solid;background-color: #b1b1b1;padding: 5px;white-space: nowrap; align-items: center;">
            JSON Input : 
            <input id="jsonStrInput" type="text"/>
            <button onclick="parseData();">Submit</button>
        </div>
        <div class="info-tag" style="position: absolute; display: none;border-radius: 5px; border: 1px solid;background-color: #b1b1b1;padding: 5px;white-space: nowrap;"></div>
        <div id="waitMessage" style="visibility: visible;">
            <div style="display: flex;">
                Loading...(<span id="loadCount">0</span>/9)
                <div class="loader"></div>
            </div>
        </div>
    </div>
    
    <!-- <div id="searchSettingPage" style="display: none;"></div> -->
    <div id="getDataDiv" style="display: none;">{{data}}</div>
</body>

<script>
    var img = document.getElementById('imgMain');
    var img2 = document.getElementById('imgMH');
    var img3 = document.getElementById('imgTT');
    img.onload = dataOnLoad();
    img2.onload = dataOnLoad();
    img3.onload = dataOnLoad();
    let scale = 1;
    const content = document.getElementById('pageContainer');
    content.style.transformOrigin = '0 0'; // 初始的變換原點設置為左上角

    function onWheel(event) {
        
        var rect1 = content.getBoundingClientRect();
        event.preventDefault();
        // // 防止瀏覽器默認行為
        // event.preventDefault();

        // 獲取滾輪事件的座標
        const mouseX = event.clientX;
        const mouseY = event.clientY;

        // // 獲取元素的當前邊界框
        // const rect = content.getBoundingClientRect();

        // 計算滑鼠相對於元素的位置，考慮當前的縮放
        const relX = (mouseX - rect1.left) * (1 / scale);
        const relY = (mouseY - rect1.top) * (1 / scale);

        // 計算新的縮放級別
        let newScale = scale - event.deltaY * 0.003;

        // newScale = Math.max(newScale, 1);  // 限制最小縮放比例


        // 如果新的縮放級別超出範圍，不要進行縮放
        if (newScale < 0.1 || newScale > 4) {
            return; // 直接返回，不做任何事情
        }

        
        // 設置變換原點為滑鼠當前的位置，考慮當前的縮放
        content.style.transformOrigin = `${relX}px ${relY}px`;

        // 應用縮放
        content.style.transform = `scale(${newScale})`;

        // 更新當前縮放級別
        scale = newScale;
        sacleRatio = scale
    }
    // 使用非被動（non-passive）事件監聽器來覆蓋默認的被動（passive）行為
    document.addEventListener('wheel', onWheel, { passive: false });
    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        if (document.getElementById(elmnt.id + "header")) {
            // if present, the header is where you move the DIV from:
            document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
        } else {
            // otherwise, move the DIV from anywhere inside the DIV:
            elmnt.onmousedown = dragMouseDown;
        }

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            // stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }
    let initialDistance = null;

    let initialScale = scale;
    let initialTouchMidpoint = { x: 0, y: 0 };

    content.addEventListener('touchstart', function(e) {
        if (e.touches.length === 2) {
            // 如果有兩個觸點，則開始縮放
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            initialDistance = Math.sqrt(Math.pow(touch2.clientX - touch1.clientX, 2) + Math.pow(touch2.clientY - touch1.clientY, 2));
            initialScale = scale;

            // 計算並存儲兩個觸點的中心點
            initialTouchMidpoint = {
                x: (touch1.clientX + touch2.clientX) / 2,
                y: (touch1.clientY + touch2.clientY) / 2
            };
            const rect = content.getBoundingClientRect();
            const relX = (initialTouchMidpoint.x - rect.left) * (1 / scale);
            const relY = (initialTouchMidpoint.y - rect.top) * (1 / scale);
            content.style.transformOrigin = `${relX}px ${relY}px`;
            e.preventDefault();
        }
    }, { passive: false });

    content.addEventListener('touchmove', function(e) {
        if (e.touches.length === 2) {
            // 如果有兩個觸點，則計算縮放比例
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            const currentDistance = Math.sqrt(Math.pow(touch2.clientX - touch1.clientX, 2) + Math.pow(touch2.clientY - touch1.clientY, 2));
            const scaleChange = currentDistance / initialDistance;

            const newScale = initialScale * scaleChange;
            // 如果新的縮放級別超出範圍，不要進行縮放
            if (newScale < 0.7 || newScale > 6) {
                return; // 直接返回，不做任何事情
            }
            // scale = initialScale * scaleChange;
            

            
            content.style.transform = `scale(${newScale})`;
            scale = newScale;
            e.preventDefault();
        }
    }, { passive: false });

    content.addEventListener('touchend', function (e) {
        if (e.touches.length < 2) {
            initialDistance = null;
        }
    });
</script>

</html>