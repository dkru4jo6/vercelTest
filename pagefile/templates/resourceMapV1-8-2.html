<!DOCTYPE html>
<html>

<head>
    <meta charset="=" utf-8 />
    <title>SoulForged 資源共享地圖</title>
    <link rel="icon" href="https://i.ibb.co/nLFwC08/paper-06.png" type="image/png">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> -->
    <link href="{{url_for('static',filename='css/mapStyleV1-0-10.css')}}" rel="stylesheet" />
    <!-- <link href="/pagefile/static/css/mapStyleV1-0-7.css" rel="stylesheet" /> -->
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
        integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <!-- <script type="text/javascript" src="{{url_for('static',filename='js/jquery.min.js')}}"></script> -->
    <script type="text/javascript">
        var itemTypeTranslate = {
            'tool': '工具', 'woodcutting': '原木', 'carpentry': '木材', 'corpse': '屍體', 'doctoring': '屠宰', 'equipment': '防具',
            'medical': '藥品', 'smithing': '鍛造', 'mining': '礦石', 'cooked': '食品', 'foraging': '作物', 'gathering': '蒐集', 'furniture': '家俱', 'other': '其他'
        };
        var langCompared = {
            "unlimited":{"zh":"無限量","en":"unlimited"},
            "enterStart":{"zh":"請輸入起點節點ID","en":"Please enter the starting nodeID"},
            "enterEnd":{"zh":"請輸入目標節點ID","en":"Please enter the target nodeID"},
            "cannotReach":{"zh":"無法到達","en":"Unable to reach"},
            "checkUpdate": { "zh": "有新版本可用，需要重新載入網頁，是否現在更新？", "en": "A new version is available. The page needs to be reloaded. Would you like to update now?" },
            "idShowAt": { "zh": " 已存在於 ", "en": " has already been paired with " },
            "pleaseEdit": { "zh": " 請更正或清除錯誤的ID", "en": ". Please correct or clear the incorrect Node ID." },
            "unMatchedCre": { "zh": "未知生物：", "en": "Unmatched Creatures" },
            "unMatchedRes": { "zh": "未知資源：", "en": "Unmatched Resources" },
            "unMatchedInv": { "zh": "未知道具：", "en": "Unmatched Item" },
            "cantFind": { "zh": "找不到", "en": "Not in the list" },
            "cancelConfirm": { "zh": "尚未完成資源登錄，確認放棄新增?", "en": "Resource pairing is not yet complete. Confirm to abandon the addition?" },
            "issueConfirm": { "zh": "將暫停本次新增，並將資料提交給管理者鑑別後再匯入。確認執行?", "en": "Data import will be canceled, and the data will be submitted to the administrator for verification before re-importing. Confirm execution?" },
            "uploading": { "zh": "資料上傳中...", "en": "Data submission in progress..." },
            "success": { "zh": "成功上傳", "en": "Submission successful" },
            "dataErr": { "zh": "資料錯誤，將於管理員審查完成後再登錄", "en": "Data anomaly detected. The data will be imported after the administrator's review is complete." },
            "inputErr": { "zh": "資料不合規", "en": "Data is non-compliant" },
            "nodeUnmatch": { "zh": "未被記錄，請點選節點", "en": " has not yet been paired. Please specify the node location." },
            "pathConfirm": { "zh": "所有資料已讀取，請確認路徑是否正確?", "en": "Data has been successfully parsed. Please confirm if the node to be imported is correct?" },
            "search": { "zh": "搜尋", "en": "Search" },
            "fill": { "zh": "中心填充", "en": "Fill" },
            "border": { "zh": "邊框色彩", "en": "Border" },
            "creature": { "zh": "生物", "en": "Creatures" },
            "resource": { "zh": "資源", "en": "Resources" },
            "item": { "zh": "地上物品", "en": "Item" },
            "renewTime": { "zh": "更新時間", "en": "Update Interval" },
            "newest": { "zh": "最新記錄", "en": "Latest" },
            "ever": { "zh": "曾經出現", "en": "Ever" },
            "highest": { "zh": "過往最高", "en": "Highest" },
            "lowest": { "zh": "過往最低", "en": "Lowest" },
            "creatureList": { "zh": "生物列表", "en": "Creatures List" },
            "resourceList": { "zh": "資源列表", "en": "Resources List" },
            "itemList": { "zh": "物品列表", "en": "Item List" },
            "filterByCategory": { "zh": "依類別篩選", "en": "Filter by category" },
            "filterByName": { "zh": "依名稱篩選", "en": "Filter by name" },
            "note": { "zh": "備註", "en": "Note" },
            "add": { "zh": "新增", "en": "Add" },
            "state": { "zh": "狀態", "en": "State" },
            "active": { "zh": "主動", "en": "Active" },
            "passive": { "zh": "被動", "en": "Passive" },
            "quentity": { "zh": "數量", "en": "Quentity" },
            "ok": { "zh": "確認", "en": "OK" },
            "cancel": { "zh": "取消", "en": "Cancel" },
            "del": { "zh": "刪除", "en": "Del" },
            "full": { "zh": "滿", "en": "Maximum" },
            "substantial": { "zh": "好", "en": "Substantial" },
            "partial": { "zh": "差", "en": "Partial" },
            "empty": { "zh": "劣", "en": "Minimal" },
            "none": { "zh": "無", "en": "Empty" },
            "submit": { "zh": "提交", "en": "Submit" },
            "setAsDefault": { "zh": "設為預設", "en": "Set as default" },
            "switchLanguage": { "zh": "切換語言", "en": "Language" },
            "guide": { "zh": "說明文件", "en": "How to use" },
            "entry": { "zh": "進入", "en": "Entry" },
            "lastUpdate": { "zh": "更新時間", "en": "Last update" },
            "noRecord": { "zh": "尚無資料紀錄，預設內容僅供參考", "en": "No data records available; default content is for reference only." },
            "day": { "zh": "天", "en": "day" },
            "hour": { "zh": "小時", "en": "hr" },
            "min": { "zh": "分鐘前)", "en": "min ago.)" },
            "by": { "zh": "由", "en": "record by" },
            "record": { "zh": "記錄", "en": "" },
            "switchTo": { "zh": "切換為", "en": "Switch to" },
            "nodeId": { "zh": "節點ID", "en": "Node ID" },
            "hide": { "zh": "隱藏", "en": "Hide" },
            "show": { "zh": "顯示", "en": "Show" },
            "edit": { "zh": "編輯地圖", "en": "Edit map" },
            "node": { "zh": "節點", "en": "Node" },
            "route": { "zh": "路徑", "en": "Route" },
            "prefix": { "zh": "前綴", "en": "Prefix" },
            "suffix": { "zh": "後綴", "en": "Suffix" },
            "done": { "zh": "完成", "en": "Done" },
            "color": { "zh": "顏色", "en": "Color" },
            "type": { "zh": "類型", "en": "Type" },
            "mainstream": { "zh": "幹道", "en": "Mainstream" },
            "sidetrack": { "zh": "支線", "en": "Sidetrack" },
            "defaultNode": { "zh": "起始節點", "en": "Default Node" },
            "nodeScaleSwitch": { "zh": "節點縮放", "en": "Node Scale" },
            "nodeUnavilible": { "zh": "節點不存在", "en": "The node does not exist" },
            "whitchNode": { "zh": "請輸入想尋找的NodeID", "en": "Please enter the NodeID you wish to search for." },
            "delRouteConfirm": { "zh": "確認要刪除路徑", "en": "Are you sure you want to delete the route " },
            "serverErr": { "zh": "伺服器連線異常，資料傳遞失敗", "en": "Server connection is abnormal, data transmission failed." },
            "routeRepeat": { "zh": "路徑已存在，是否取代", "en": "The path already exists, do you want to replace it?" },
            "delCheck": { "zh": "確定要刪除", "en": "Are you sure you want to delete " },
            "entryPrefix": { "zh": "請輸入前綴", "en": "Please enter the prefix." },
            "prefixErr": { "zh": "前綴僅能使用英文字母", "en": "The prefix can only use English letters." },
            "suffixErr": { "zh": "後綴僅能使用英文字母", "en": "The suffix can only use English letters." },
            "nodeRepeat": { "zh": "這個編碼方式已使用於", "en": "This encoding method has been used in " },
            "yourName": { "zh": "是否要留下名稱，讓大家記得你的貢獻", "en": "Would you like to leave your name so everyone will remember your contribution" },
            "display": { "zh": "檢視參數", "en": "View Parameters" }

        }
        var entryList = ['Q21DM1', 'Q62DM36', 'M36UQ62', 'EDMH', 'FTDMH', 'MHUE', 'MHUFT', 'M1UQ21', 'EDM', 'CDM', 'W1DM', 'W2DM', 'W3DM', 'W4DM', 'MUE', 'MUC', 'MUW1', 'MUW2', 'MUW3', 'MUW4']
        var iconUrlData = {
            "animalList": [
                "Rat",
                "Rabbit",
                "Mole",
                "Green Snake",
                "Porcupine",
                "Squink",
                "Wolf",
                "Black Wolf",
                "Red-eyed Wolf",
                "Brown Bear",
                "Black Bear",
                "Grey Bear",
                "Pigune",
                "Boar",
                "Fierce Tusk",
                "Boarzilla",
                "Grey Squitmunk",
                "Brown Squitmunk",
                "Lizard",
                "Beetle",
                "Fire Beetle",
                "Black Widow",
                "Scarlet Grub",
                "Emerald Grub",
                "Sulfur Grub",
                "Leto Worm",
                "Giant Mosquito",
                "Chicken",
                "Mallard",
                "Frog",
                "Tortoise",
                "Alligator",
                "Bat",
                "Goat",
                "Hawn",
                "Bison",
                "Manticore",
                "Sabertooth",
                "Gorilla",
                "Forest Dweller",
                "Ogre",
                "Earth Golem",
                "Skeleton",
                "Blahaj",
                "Fluffin",
                "Gob A",
                "Gob B",
                "Gob C",
                "Gob D",
                "Gob E",
                "Gob F",
                "Gob G",
                "Sharpshell"
            ],
            "animalUrl": [
                "Alligator",
                "Bat",
                "Beetle",
                "Bison",
                "Black-Bear",
                "Black-Widow",
                "Black-Wolf",
                "Blahaj",
                "Boar",
                "Boarzilla",
                "Brown-Bear",
                "Brown-Squitmunk",
                "Chicken",
                "Earth-Golem",
                "Emerald-Grub",
                "Fierce-Tusk",
                "Fire-Beetle",
                "Fluffin",
                "Forest-Dweller",
                "Frog",
                "Giant-Mosquito",
                "Goat",
                "Gorilla",
                "Green-Snake",
                "Grey-Bear",
                "Grey-Squitmunk",
                "Hawn",
                "Lightning-Bug",
                "Lizard",
                "Mallard",
                "Manticore",
                "Mole",
                "Ogre",
                "Pigune",
                "Porcupine",
                "Rabbit",
                "Rat",
                "Red-eyed-Wolf",
                "Sabertooth",
                "Scarlet-Grub",
                "Sharpshell",
                "Skeleton",
                "Squink",
                "Sulfur-Grub",
                "Tortoise",
                "Fishing-Spot",
                "Wolf",
                "Leto-Worm"
            ],
            "carpentryUrl": [
                "Poplar-Plank",
                "Poplar-Pole",
                "Pine-Plank",
                "Pine-Pole",
                "Waterwood-Plank",
                "Waterwood-Pole",
                "Cayew-Plank",
                "Cayew-Pole"
            ],
            "cookedUrl": [
                "Wheat-Flour",
                "Hearty-Stew",
                "Camping-Stew",
                "Pluck-Stew",
                "Spicy-Soup",
                "Stewpendous",
                "Sausage",
                "Cookies",
                "Kebab",
                "Nanwich",
                "Barf-Bowl",
                "Omniscient-Mash",
                "Cooked-Tough-Meat",
                "Tender-Steak",
                "Cooked-Fish",
                "Cooked-Chicken-Leg",
                "Cooked-Rib",
                "Bread",
                "Crust",
                "Ogre-Stuffing",
                "Ogre-Pie",
                "Carrot-Stuffing",
                "Carrot-Pie",
                "Pea-Stuffing",
                "Peas-Pie",
                "Mushroom-Pie",
                "Cooked-Jerky",
                "Salted-Brown-Mushroom",
                "Salted-Chicken-Leg",
                "Salted-Raw-Fish",
                "Salted-Rib-Rack",
                "Salted-Tough-Meat",
                "Salted-Blueshroom",
                "Salted-Blueberry",
                "Salted-Burst",
                "Salted-Strawberry",
                "Salted-Tender-Meat",
                "Cooked-Lean-Meat"
            ],
            "corpseUrl": [
                "Rat-Corpse",
                "Rabbit-Corpse",
                "Mole-Corpse",
                "Green-Snake-Corpse",
                "Porcupine-Corpse",
                "Squink-Corpse",
                "Wolf-Corpse",
                "Black-Wolf-Corpse",
                "Red-eyed-Wolf-Corpse",
                "Brown-Bear-Corpse",
                "Black-Bear-Corpse",
                "Grey-Bear-Corpse",
                "Pigune-Corpse",
                "Boar-Corpse",
                "Fierce-Tusk-Corpse",
                "Boarzilla-Corpse",
                "Brown-Squitmunk-Corpse",
                "Grey-Squitmunk-Corpse",
                "Lizard-Corpse",
                "Beetle-Corpse",
                "Fire-Beetle-Corpse",
                "Black-Widow-Corpse",
                "Lightning-Bug",
                "Scarlet-Grub-Corpse",
                "Emerald-Grub-Corpse",
                "Sulfur-Grub-Corpse",
                "Giant-Mosquito-Corpse",
                "Chicken-Corpse",
                "Mallard-Corpse",
                "Frog-Corpse",
                "Tortoise-Corpse",
                "Alligator-Cropse",
                "Bat-Corpse",
                "Goat-Corpse",
                "Hawn-Corpse",
                "Bison-Corpse",
                "Manticore-Corpse",
                "Sabertooth-Corpse",
                "Gorilla-Corpse",
                "Forest-Dweller-Corpse",
                "Ogre-Corpse",
                "Earth-Golem-Corpse",
                "Skeleton-Corpse",
                "Human-Corpse",
                "Blahaj-Corpse",
                "Fluffin-Corpse",
                "Sharpshell-Corpse",
                "Red-Snapper",
                "Grayscale",
                "Scalefish",
                "Stinkfish",
                "Fat-Fish",
                "Yellow-Crest"
            ],
            "doctoringUrl": [
                "Thin-Hide",
                "Brown-Hide",
                "Grey-Hide",
                "Black-Hide",
                "Scale-Hide",
                "Orange-Hide",
                "Thin-Bone",
                "Sturdy-Bone",
                "Tough-Bone",
                "Raw-Fat",
                "Guts",
                "Blood",
                "Tough-Meat",
                "Tender-Meat",
                "Rib-Rack",
                "Raw-Fish",
                "Chicken-Leg",
                "Rat-Tail",
                "Fangs",
                "Snake-Fang",
                "Quills",
                "Feather",
                "Delicate-Plume",
                "Chitin",
                "Goat-Hoof",
                "Bat-Wing",
                "Dark-Sting",
                "Stuffin",
                "Sharpshard",
                "Mantihorn",
                "Gold-Chitin",
                "Hawn-Hawn",
                "Lizard-Pock",
                "Long-Horn",
                "Long-Tooth",
                "Scent-Gland",
                "Shark-Fin",
                "Lean-Meat",
                "Thin-Guts"
            ],
            "equipmentUrl": [
                "Plain-Vest",
                "Plain-Boots",
                "Plain-Gloves",
                "Plain-Hood",
                "Pettiwood-Vest",
                "Pettiwood-Boots",
                "Pettiwood-Cuffs",
                "Pettiwood-Hood",
                "Studded-Leather",
                "Leather-Boots",
                "Leather-Cap",
                "Leather-Gloves",
                "Scaled-Vest",
                "Scaled-Boots",
                "Scaled-Gloves",
                "Scaled-Helm",
                "Gambeson-Vest",
                "Gambeson-Boots",
                "Gambeson-Gloves",
                "Gambeson-Helm",
                "Ranger-Coat",
                "Scuttleplate",
                "Crawlers",
                "Pincers",
                "Beetle-Cap",
                "Darkscale-Plate",
                "Darkscale-Bracers",
                "Darkscale-Cowl",
                "Darkscale-Mask",
                "Brick-Plate",
                "Brick-Stompers",
                "Royal-Platemail",
                "Weave-Tunic",
                "Weave-Boots",
                "Weave-Gloves",
                "Eris-Bunny-Hood",
                "Villager-Robe",
                "Villager-Boots",
                "Villager-Gloves",
                "Fedora",
                "Farm-Robe",
                "Farm-Boots",
                "Farm-Gloves",
                "Farm-Hat",
                "Hearth-s-Heart",
                "Flame-Walkers",
                "Embracers",
                "Sparks-Kiss",
                "Magister-Drip",
                "Butchermittens",
                "Magister-Kicks",
                "Magister-Capi",
                "Protecc",
                "Targe",
                "Aegis",
                "Buckler",
                "Kite-Shield"
            ],
            "foragingUrl": [
                "Long-Grass",
                "Peas",
                "Bitterleaf",
                "Carrot",
                "Potato",
                "Wheat",
                "Onion",
                "Pepper",
                "Blueberries",
                "Muckroot",
                "Bluebell",
                "Apple",
                "Brown-Mushroom",
                "Orange",
                "Holly",
                "Burst",
                "Beetroot",
                "Blueshroom",
                "Leaflower",
                "Punchkin",
                "Strawberry",
                "Goldstream-Leaf",
                "Blood-Bud",
                "Devils-Trumpets",
                "Hops",
                "Dust-Reed",
                "Grass-Seed",
                "Pea-Seed",
                "Bitterleaf-Seed",
                "Carrot-Seed",
                "Potato-Seed",
                "Wheat-Seed",
                "Onion-Seed",
                "Pepper-Seed",
                "Henbane",
                "Cowslip",
                "Mandrake"
            ],
            "gatheringUrl": [
                "Twig",
                "Stone",
                "Water",
                "Honeycomb",
                "Sand",
                "Salt-Water"
            ],
            "medicalUrl": [
                "Tourniquets",
                "Bandages",
                "Autumn-Wrap",
                "Bruise-Ointment",
                "Bruise-Ointment-2",
                "Stab-Bandage",
                "Endurance-Potion",
                "Strength-Potion",
                "Rage-Potion",
                "Pain-Potion",
                "Stoneskin-Potion",
                "Hulk-Potion",
                "Cats-Eye-Potion",
                "Longstrider-Potion",
                "Omnipotion",
                "Transfusion",
                "Acid",
                "Lime-Slime",
                "Smoke-Screen",
                "Dexterity-Potion",
                "Remedy-Potion"
            ],
            "miningUrl": [
                "Limestone",
                "Clay",
                "Granite",
                "Blackmark",
                "Scarlet-Ore",
                "Dulral",
                "Shore",
                "Mithril-Ore",
                "Flint",
                "Scarlet-Nugget",
                "Shore-Nugget",
                "Mithril-Nugget",
                "Shinning-Ore",
                "Blackmark-Two",
                "Salt"
            ],
            "otherUrl": [
                "Bark-Rope",
                "Gutrope",
                "Grass-Thread",
                "Grassweave",
                "Oil",
                "Ink",
                "Paper",
                "Thin-Leather",
                "Brown-Leather",
                "Grey-Leather",
                "Black-Leather",
                "Leather-Rope",
                "Leather-Strap",
                "Wooden-Cogwheel",
                "Spring",
                "Hinge",
                "Catgut",
                "Orange-Leather",
                "Thatch",
                "Limestone-Dust",
                "Granite-Block",
                "Essence",
                "Soul-Stone",
                "Song-Scroll-Gob-Murder-Tune"
            ],
            "smithingUrl": [
                "Scarlet-Ingot",
                "Scarlet-Plate",
                "Scarlet-Ring",
                "Scarlet-Rod",
                "Dulral-Ingot",
                "Dulral-Plate",
                "Dulral-Ring",
                "Dulral-Rod",
                "Bronze-Ingot",
                "Bronze-Plate",
                "Bronze-Ring",
                "Bronze-Rod",
                "Mithril-Ingot",
                "Mithril-Plate",
                "Mithril-Ring",
                "Mithril-Rod",
                "Shine-Ingot",
                "Shine-Plate",
                "Shine-Ring",
                "Shine-Rod",
                "Buckle",
                "Nail",
                "Armored-Plate",
                "Sawblade",
                "Cauldron"
            ],
            "toolUrl": [
                "Sharp-Stone",
                "Basic-Pick",
                "Fragile-Pick",
                "Scarlet-Pick",
                "Bone-Sickle",
                "Moon-Sickle",
                "Stone-Axe",
                "Bone-Greataxe",
                "Handaxe",
                "Francisca",
                "Savage-Axe-2",
                "Battleaxe",
                "The-Gimli",
                "Bone-Nailbat",
                "Bone-Basher",
                "Snakebite",
                "Billy-Club",
                "Flanged-Mace",
                "Fanged-Club",
                "The-Boner",
                "Stone-Hammer",
                "The-Crusher",
                "Wooden-Sledge",
                "Smasher",
                "Smith-Hammer",
                "Warhammer",
                "Hunting-Spear",
                "Feathered-Spear",
                "Pike",
                "Bone-Knife",
                "Scarlet-Edge",
                "Main-Gauche",
                "Khepri-s-Claw",
                "Heartstopper",
                "Short-Sword",
                "Gladius",
                "Broadsword",
                "Savage-Sword",
                "Long-Kukri",
                "Rapier",
                "Bug-Net",
                "Fishing-Rod",
                "Angler",
                "Handsaw",
                "Hermit-Hoe",
                "Pen",
                "Quill-Needle",
                "War-Drum",
                "War-Horn",
                "Torch",
                "Candle",
                "Bug-Light",
                "Lantern",
                "Lyre",
                "Lute"
            ],
            "woodCuttingUrl": [
                "Poplar-Log",
                "Pine-Log",
                "Waterwood-Log",
                "Cayew-Log"
            ],
            "furnitureUrl": [
                "Bar-Stool",
                "Bearskin-Rug",
                "Bear-Statue",
                "Bed",
                "Bone-Chimes",
                "Comfy-Chair",
                "Cottontail",
                "Dining-Chair",
                "Dream-Catcher",
                "Dream-Weaver",
                "Fancy-Table",
                "Flying-Carpet",
                "Fur-Bedroll",
                "Leather-Rug",
                "Manticore-Bust",
                "Model-Bun-Bun",
                "Rickety-Table",
                "Simple-Table",
                "Stool",
                "Straw-Mattress",
                "Wooden-Chimes",
                "Welding-Mask"
            ]
        }
        var loadingDataList = [
            'newestData',
            'mapDotMain',
            'mapDotMH',
            'mapDotTT',
            'mapRouteMain',
            'mapRouteMH',
            'mapRouteTT',
            'hisData',
            'nodeMaping',
            'eliteRecord'
        ]
        var qualityColor = ['#d9b800','#bbbbbb','#8b5817','#000000']
        var conditionColor = ['#676767','#ffc100','#9b6000']
        var animalList = [];
        var animalUrl = {};
        var carpentryUrl = {};
        var cookedUrl = {};
        var corpseUrl = {};
        var doctoringUrl = {};
        var furnitureUrl = {};
        var equipmentUrl = {};
        var foragingUrl = {};
        var gatheringUrl = {};
        var medicalUrl = {};
        var miningUrl = {};
        var otherUrl = {};
        var smithingUrl = {};
        var toolUrl = {};
        var woodCuttingUrl = {};
        var sacleRatio = 1;
        var rawData = [];
        var posisionDataMain = {};
        var posisionDataMH = {};
        var posisionDataTT = {};
        var hisData = {}
        var scaleModify = 1
        var nodeNow = '';
        var funcNow = '';
        var indexNow = '';
        var nameNow = ''
        var typeNow = '';
        var userName = '';
        var urlFunc = ''
        var settingSelValue = '';
        var settingSelDOM = '';
        var settingInputDOM = '';
        var searchMethodState = 'type';
        var searchedName = '';
        var urlNow = '';
        var langNow = 'zh';
        var mapId = 'Main';
        var routeWidth = '2px';
        var continueAddState = 1;
        var routeNodePair = [];
        var routeColorSetting = '#ff0000';
        var routeType = 'mainstream';
        var defNodeId = '';
        var mapRouteMain = [];
        var mapRouteMH = [];
        var mapRouteTT = [];
        var editMapRoute = 0;
        var editMapNode = 0;
        var aimState = 0;
        var pathPlainningState = 0;
        var pathFindingArray = []
        var editdefaultNode = 0;
        var routeData = [];
        var searchSlot = {}
        var loadingCount = 0
        var tempSearchSlot = {}
        var jsonFromBackend = {}
        var oriDataSet = {};
        var nodeScaleNow = 1;
        var loadDoneState = 0;
        var center = { x: 0, y: 0 };
        var huntableAnimalList = ['Rabbit', 'Chicken', 'Mallard', 'Frog', 'Tortoise', 'Goat', 'Boar', 'Pigune',
            'Fierce Tusk', 'Scarlet Grub', "Fishing Spot", "Fluffin", "Brown Squitmunk", "Grey Squitmunk", "Hawn", "Bison", "Lightning Bug", "Giant Mosquito"];
        var jsonData = {}
        var recordNodeList = [];
        var nodeMaping = {};
        var indoorState = 0;
        var transformedData = [];
        var pasteData = {}
        var verifiedData = []
        var resDataDict = {}
        var creDataDict = {}
        var invDataDict = {}
        var tempRes = {}
        var tempCre = {}
        var tempInv = {}
        var lastSearchSlot = {}
        var lastnodeMaping = {}
        var jsonImportState = 0
        var waitForClickNode = 0;
        var nodeIdChangeState = 0;
        var sendingQty = 0;
        var sendingCount = 0;
        let pathResult = {};
        let finalNode = '';
        var mesStr = '成功上傳'
        var pageIconSize = '50px';
        var pageFontSize = ''
        var errState = 0;
        var staticPath = ''
        var lastAim = ''
        var totalBAP = 0;
        var bAPEmptyCount = 0;
        var alertInterval = 0;
        var delPanding = 0;
        var houseListObject = {}
        var eliteRecord = []
        var planningMethod = 'Path';
        var version = '1-8-2';
        function isMobileDevice() {
            let check = true
            try{
                check = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            }
            catch{
                check = true
            }
            return check
        }
        urlNow = new URL(location.href);
        if (urlNow.host.includes('vercel')){
            staticPath = 'pagefile/'
        } 

        var continueSet = function () {

            for (i in posisionDataMain) {
                if (i in rawData == false) {
                    rawData[i] = { "area": i, "animal": [], "item": [], "recordTime": 1697212800000, "resource": [], "note": "" }
                }
            }
            for (i in posisionDataMH) {
                if (i in rawData == false) {
                    rawData[i] = { "area": i, "animal": [], "item": [], "recordTime": 1697212800000, "resource": [], "note": "" }
                }
            }
            for (i in posisionDataTT) {
                if (i in rawData == false) {
                    rawData[i] = { "area": i, "animal": [], "item": [], "recordTime": 1697212800000, "resource": [], "note": "" }
                }
            }
            if ('username' in jsonFromBackend && jsonFromBackend['username'] !='unSigned' && jsonFromBackend['username'] !='undefined') {
                userName = jsonFromBackend['username'];
            }

            var img = document.getElementById('imgMain');
            var img2 = document.getElementById('imgMH');
            var img3 = document.getElementById('imgTT');
            var oneImgOnload = function () {
                if (img.complete && img2.complete && img3.complete) onImageLoaded();
            }
            var onImageLoaded = function () {
                loadDoneState = 1;
                loadingCount = 0;
                console.log('OK', loadingCount)
                // 根据 posisionData 创建圆圈
                for (i in posisionDataMain) {
                    var data = posisionDataMain[i];

                    var newCircle = document.createElement('div');
                    newCircle.id = i;
                    if (entryList.includes(i)) {
                        newCircle.innerHTML = langCompared['entry'][langNow];
                        newCircle.style.backgroundColor = '#ff00ff';
                    }
                    else newCircle.innerHTML = i;
                    newCircle.className = 'interactive-circle black';
                    newCircle.style.position = 'absolute';

                    // newCircle.onclick = function () { nodeOnclick(this.id); };
                    document.getElementById('mapMain').appendChild(newCircle);
                    positionAndResizeCircle(newCircle.id, data['X'], data['Y'], sacleRatio);
                }

                for (i in posisionDataMH) {
                    var newCircle = document.createElement('div');
                    newCircle.id = i;
                    if (entryList.includes(i)) {
                        newCircle.innerHTML = langCompared['entry'][langNow];
                        newCircle.style.backgroundColor = '#ff00ff';
                    }
                    else newCircle.innerHTML = i;
                    newCircle.className = 'interactive-circle black';
                    newCircle.style.position = 'absolute';
                    // newCircle.onclick = function () { nodeOnclick(this.id); };
                    document.getElementById('mapMineHead').appendChild(newCircle);
                    let newRatio = 1 / sacleRatio
                    content.style.transform = `scale(${newRatio})`;
                    scaleModify = sacleRatio

                    var img = document.getElementById('imgMH');
                    var circle = document.getElementById(newCircle.id);

                    var imgRect = img.getBoundingClientRect();
                    var imgWidth = imgRect.width;
                    var imgHeight = imgRect.height;

                    // 大小
                    // var newSize = 30; // 计算新的圆点大小
                    // circle.style.width = newSize*scaleModify/nodeScaleNow   + 'px';
                    // circle.style.height = newSize*scaleModify/nodeScaleNow   + 'px';
                    // 位置
                    circle.style.left = (imgWidth * posisionDataMH[i]['X']) + 'px'; // 减去圆点宽度的一半
                    circle.style.top = (imgHeight * posisionDataMH[i]['Y']) + 'px'; // 减去圆点高度的一半
                    scaleModify = 1
                    content.style.transform = `scale(${sacleRatio})`;
                }
                for (i in posisionDataTT) {
                    var newCircle = document.createElement('div');
                    newCircle.id = i;
                    if (entryList.includes(i)) {
                        newCircle.innerHTML = langCompared['entry'][langNow];
                        newCircle.style.backgroundColor = '#ff00ff';
                    }
                    else newCircle.innerHTML = i;
                    newCircle.className = 'interactive-circle black';
                    newCircle.style.position = 'absolute';
                    // newCircle.onclick = function () { nodeOnclick(this.id); };
                    document.getElementById('mapTT').appendChild(newCircle);
                    let newRatio = 1 / sacleRatio
                    content.style.transform = `scale(${newRatio})`;
                    scaleModify = sacleRatio

                    var img = document.getElementById('imgTT');
                    var circle = document.getElementById(newCircle.id);


                    var imgRect = img.getBoundingClientRect();
                    var imgWidth = imgRect.width;
                    var imgHeight = imgRect.height;

                    // 大小
                    // var newSize = 30; // 计算新的圆点大小
                    // circle.style.width = newSize*scaleModify/nodeScaleNow   + 'px';
                    // circle.style.height = newSize*scaleModify/nodeScaleNow   + 'px';
                    // 位置
                    circle.style.left = (imgWidth * posisionDataTT[i]['X']) + 'px'; // 减去圆点宽度的一半
                    circle.style.top = (imgHeight * posisionDataTT[i]['Y']) + 'px'; // 减去圆点高度的一半
                    scaleModify = 1
                    content.style.transform = `scale(${sacleRatio})`;
                }
                window.scrollTo(0, 0);
                setTimeout(function () {
                    document.getElementById('svgMain').style.height = document.getElementById('imgMain').height + 'px';
                    document.getElementById('svgMain').style.width = document.getElementById('imgMain').width + 'px';
                    document.getElementById('svgMH').style.height = document.getElementById('imgMH').height + 'px';
                    document.getElementById('svgMH').style.width = document.getElementById('imgMH').width + 'px';
                    document.getElementById('svgTT').style.height = document.getElementById('imgTT').height + 'px';
                    document.getElementById('svgTT').style.width = document.getElementById('imgTT').width + 'px';
                    if (urlNow.searchParams.has('map')) {
                        if (urlNow.searchParams.get('map') == 'MH') {
                            defNodeId = 'M1'
                            if (urlNow.searchParams.has('defNode')) defNodeId = urlNow.searchParams.get('defNode')
                            element = document.getElementById(defNodeId);
                            $('#setDefaultNode').html(defNodeId);
                            $('#waitMessage').css({ 'visibility': 'hidden' })
                            $('body').css({ 'visibility': 'visible' })
                            $('#mapMain').css({ 'visibility': 'hidden' })
                            $('#mapMineHead').css({ 'visibility': 'visible' })
                            $('#mapTT').css({ 'visibility': 'hidden' })
                            $('#svgMH').css({ 'visibility': 'visible' });
                            $('#svgMain').css({ 'visibility': 'hidden' });
                            $('#svgTT').css({ 'visibility': 'hidden' });
                            element = document.getElementById(defNodeId);
                            // 如果元素存在，将其滚动到视窗中心
                            if (element) element.scrollIntoView({ block: 'center', inline: 'center' });
                        }
                        else if (urlNow.searchParams.get('map') == 'Main') {
                            defNodeId = 'W25'
                            if (urlNow.searchParams.has('defNode')) defNodeId = urlNow.searchParams.get('defNode')
                            element = document.getElementById(defNodeId);
                            $('#setDefaultNode').html(defNodeId);
                            $('#waitMessage').css({ 'visibility': 'hidden' })
                            $('body').css({ 'visibility': 'visible' })
                            $('#mapMain').css({ 'visibility': 'visible' })
                            $('#mapMineHead').css({ 'visibility': 'hidden' })
                            $('#mapTT').css({ 'visibility': 'hidden' })
                            $('#svgMH').css({ 'visibility': 'hidden' });
                            $('#svgMain').css({ 'visibility': 'visible' });
                            $('#svgTT').css({ 'visibility': 'hidden' });
                            element = document.getElementById(defNodeId);
                            // 如果元素存在，将其滚动到视窗中心
                            if (element) element.scrollIntoView({ block: 'center', inline: 'center' });
                        }
                        else if (urlNow.searchParams.get('map') == 'TT') {
                            defNodeId = 'MUC'
                            if (urlNow.searchParams.has('defNode')) defNodeId = urlNow.searchParams.get('defNode')
                            element = document.getElementById(defNodeId);
                            $('#setDefaultNode').html(defNodeId);
                            $('#waitMessage').css({ 'visibility': 'hidden' })
                            $('body').css({ 'visibility': 'visible' })
                            $('#mapMain').css({ 'visibility': 'hidden' })
                            $('#mapMineHead').css({ 'visibility': 'hidden' })
                            $('#mapTT').css({ 'visibility': 'visible' })
                            $('#svgMH').css({ 'visibility': 'hidden' });
                            $('#svgMain').css({ 'visibility': 'hidden' });
                            $('#svgTT').css({ 'visibility': 'visible' });
                            element = document.getElementById(defNodeId);
                            // 如果元素存在，将其滚动到视窗中心
                            if (element) element.scrollIntoView({ block: 'center', inline: 'center' });
                        }
                    }
                    else {
                        $('#waitMessage').css({ 'visibility': 'hidden' })
                        $('body').css({ 'visibility': 'visible' })
                        $('#mapMain').css({ 'visibility': 'visible' })
                        $('#mapMineHead').css({ 'visibility': 'hidden' })
                        $('#mapTT').css({ 'visibility': 'hidden' })
                        $('#svgMH').css({ 'visibility': 'hidden' });
                        $('#svgMain').css({ 'visibility': 'visible' });
                        $('#svgTT').css({ 'visibility': 'hidden' });
                        defNodeId = 'W25'
                        if (urlNow.searchParams.has('defNode')) defNodeId = urlNow.searchParams.get('defNode')
                        $('#setDefaultNode').html(defNodeId);
                        element = document.getElementById(defNodeId);
                        // 如果元素存在，将其滚动到视窗中心
                        if (element) {
                            element.scrollIntoView({ block: 'center', inline: 'center' });
                        }
                    }
                    if (isMobileDevice()) {
                        $('#syncIcon').css({ 'width': pageIconSize })
                        $('#aimIcon').css({ 'width': pageIconSize })
                        $('#importIcon').css({ 'width': pageIconSize })
                        $('#pathIcon').css({ 'width': pageIconSize })
                        $('#houseIcon').css({ 'width': pageIconSize })
                        $('#eliteIcon').css({ 'width': pageIconSize })
                        $('#cleanIcon').css({ 'width': pageIconSize })
                        $('#jsonInputDiv').css({ 'height': pageIconSize, 'right': '250px', 'font-size': '60px' })
                        $('#jsonStrInput').css({ 'height': '150px', 'width': '250px' })
                        $('.qtyDiv').css({ 'font-size': '100px' })
                        $('#jsonSubmitBTN').css({ 'font-size': '60px', 'width': '300px' })
                        $('#pathDiv').css({ 'right': '250px','top':'10px' })
                        $('#aimDiv').css({ 'right': '490px','top':'10px' })
                        $('#houseDiv').css({ 'right': '730px','top':'10px' })
                        $('#eliteDiv').css({ 'right': '970px','top':'10px' })
                        $('#settingIcon').css({ 'width': '200px' })
                        $('#logInBTN').css({ 'width': '800px' })
                        $('#userNameInput').css({ 'width': '400px','height': '80px','font-size': pageFontSize })
                        $('#settingIconDiv').css({ 'border-radius': '100px' })
                        $('#search').css({ 'width': '300px', 'height': 'auto', 'font-size': '70px' })
                        $('#msgDiv').css({ 'font-size': pageFontSize })
                        $('#msgDiv2').css({ 'font-size': pageFontSize ,'top':'275px'})
                        $('.info-tag').css({ 'font-size': pageFontSize })

                        $('style').append("button{width:650px;font-size:80px;}")
                        $('style').append(".itemFig{width:200px;height:200px;font-size:100px;}")
                        $('style').append("#searchNodeDiv .itemFig{width:200px;}")
                        $('style').append("select{height:80px;font-size:" + pageFontSize + "}")
                        $('style').append("input[type=number]{height:80px;font-size:80px;width:100px;}")
                        $('style').append("#timeSearchBTN{font-size:75px;width:200px;height:200px;}")
                        $('style').append("#showTimeStr{font-size:60px;}")
                        $('style').append("#settingManu{font-size: 100px; top:30%; left: 5%; right: 5%;}")
                        $('style').append(".nodeDataAreaTitle{font-size:60px;}")
                        $('style').append(".nodeDataAreaContent{font-size:80px;}")
                        $('style').append("#optionDataDiv0{max-height:none;}")
                        $('style').append("#optionDataDiv1{max-height:none;}")
                        $('style').append("#searchNodeDiv{font-size:100px;}")
                        $('style').append("#note{font-size:80px;}")
                        $('style').append(".text{font-size: 100px;height: 100px;width: 500px;}")
                        $('style').append("#nodeEditBTN{width: 250px;}")
                        $('style').append("#routeEditBTN{width: 250px;}")
                        $('style').append("#delBTN{width: 300px;}")
                        $('style').append(".houseInputTitle{width: 400px;}")
                        $('style').append("#infoPage{left: 1%; right: 1%; top: 10%;font-size: 60px;}")
                        $('style').append("#houseListPage{width:auto;left: 1%; right: 1%; top: 10%;font-size: 60px;}")
                        $('style').append("#settingPage{left: 1%; right: 1%; top: 10%;}")
                        $('style').append(".qtyDiv{font-size:80px;}")
                        $('style').append("#resourceShowDiv{max-height: 300px; overflow: scroll;}")
                        $('style').append("#animalShowDiv{max-height: 300px; overflow: scroll;position: relative;}")
                        $('style').append("#itemShowDiv{max-height: 300px; overflow: scroll;position: relative;}")
                        $('style').append(".itemQty{font-size:80px;width:200px;height:200px;}")
                        $('style').append(".addingBTN{font-size:80px;width:220px;height:220px;border: #000000 solid 15px;margin:12px;}")
                        $('style').append(".greenBorder{border: solid #00ff00 15px;}")
                        $('style').append(".yellowBorder{border: solid #ffff00 15px;}")
                        $('style').append(".orangeBorder{border: solid #ffb100 15px;}")
                        $('style').append(".redBorder{border: solid #ff0000 15px;}")
                        $('style').append(".blackBorder{border: solid #000000 15px;}")
                        $('style').append(".figDiv{margin:12px;}")
                        $('style').append('input[type="range"]{height: 100px;width: 650px;}')
                        $('style').append('input[type="range"]::-webkit-slider-runnable-track{border-radius: 50px;}')
                        $('style').append('input[type="range"]::-webkit-slider-thumb{border: #000000 solid 50px;}')
                        $('style').append("#quentity{height:150px;width:500px;}")
                        $('style').append("#EthnarIdDiv{font-size:60px;}")
                        $('style').append("#EthnarId{height:150px;width:300px;}")
                        $('style').append(".storage-button{width: 90%;border-radius: 100px;font-size: 100px;}")
                        $('style').append(".storage-location-title{border-top-left-radius: 50px;border-top-right-radius: 50px;font-size: 100px;}")
                        $('style').append(".addHouse{width: 500px;}")
                        $('style').append("input{height:80px;font-size:80px}")
                        $('style').append(".row input{height:80px;font-size:80px;width:500px;}")
                        $('style').append("#planningMethodDiv{flex-direction: column;}")

                        if (langNow == 'en') {
                            $('style').append("#timeSearchBTN{font-size:40px;width:200px;height:200px;}")
                            $('style').append("#settingManu{font-size: 75px; top:30%; left: 5%; right: 5%;}")
                            $('style').append("#setDefault{font-size: 75px;}")
                        }
                    }
                    else {
                        $('style').append(".itemFig{width:50px;}")
                        $('style').append("#nodeEditBTN{width: 70px;}")
                        $('style').append("#routeEditBTN{width: 70px;}")
                        if (langNow == 'en') {
                            $('style').append("#setDefault{font-size: 15px;}")
                            $('style').append("#timeSearchBTN{font-size: 14px;}")
                        }
                        else $('style').append("#setDefault{font-size: 20px;}")
                    }
                    // if(urlNow.searchParams.has('node') && urlNow.searchParams.get('node') == 'hide')nodeIdSwitch();
                }, 0);
            };

            if (img.complete && img2.complete && img3.complete) {
                // 图片已加载，直接调用处理函数
                onImageLoaded();
            }
            else {
                // 图片还没加载，设置加载完成后的处理函数
                img.onload = oneImgOnload();
                img2.onload = oneImgOnload();
                img3.onload = oneImgOnload();
            }
            if (urlNow.searchParams.has('defNodeSize')) {
                $('#nodeScaleControl').val(urlNow.searchParams.get('defNodeSize'))
                var value = slider.value;
                // document.getElementById('nodeScaleValue').textContent = value;

                nodeScaleNow = 4 / value;
                $('.interactive-circle').css({ width: 30 / nodeScaleNow + 'px', height: 30 / nodeScaleNow + 'px', fontSize: 20 / nodeScaleNow + 'px' })
                $('.interactive-circle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                $('.blackCircle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                $('.redCircle').css('border', 5 / nodeScaleNow + 'px #ff0000 solid')
                $('.orangeCircle').css('border', 5 / nodeScaleNow + 'px #ffb100 solid')
                $('.yellowCircle').css('border', 5 / nodeScaleNow + 'px #ffff00 solid')
                $('.greenCircle').css('border', 5 / nodeScaleNow + 'px #00ff00 solid')
                // $('line').remove()
                // for(routeIndex in mapRouteMain) drawLineBetweenCircles(mapRouteMain[routeIndex]['start'], mapRouteMain[routeIndex]['end'],mapRouteMain[routeIndex]['color'],mapRouteMain[routeIndex]['width'],'Main');
                // for(routeIndex in mapRouteMH) drawLineBetweenCircles(mapRouteMH[routeIndex]['start'], mapRouteMH[routeIndex]['end'],mapRouteMH[routeIndex]['color'],mapRouteMH[routeIndex]['width'],'MH');
                // for(routeIndex in mapRouteTT) drawLineBetweenCircles(mapRouteTT[routeIndex]['start'], mapRouteTT[routeIndex]['end'],mapRouteTT[routeIndex]['color'],mapRouteTT[routeIndex]['width'],'TT');

            }
            else {
                $('#nodeScaleControl').val('3')
                var value = slider.value;
                // document.getElementById('nodeScaleValue').textContent = value;

                nodeScaleNow = 4 / value;
                $('.interactive-circle').css({ width: 30 / nodeScaleNow + 'px', height: 30 / nodeScaleNow + 'px', fontSize: 20 / nodeScaleNow + 'px' })
                $('.interactive-circle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                $('.blackCircle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                $('.redCircle').css('border', 5 / nodeScaleNow + 'px #ff0000 solid')
                $('.orangeCircle').css('border', 5 / nodeScaleNow + 'px #ffb100 solid')
                $('.yellowCircle').css('border', 5 / nodeScaleNow + 'px #ffff00 solid')
                $('.greenCircle').css('border', 5 / nodeScaleNow + 'px #00ff00 solid')
            }
            if (urlNow.searchParams.has('searchObj')) {
                let urlData = JSON.parse(urlNow.searchParams.get('searchObj'))
                resetSearchDiv(urlData);
                searchSlot = urlData;
                if (urlNow.searchParams.get('node') == 'hide') nodeIdSwitch();
            }
            else {
                search('start', 0);
                search('time', 0);
                searchResultShow();
            }
            $('#search').html(langCompared['search'][langNow]);
            $('#settingCancel').html(langCompared['cancel'][langNow]);
            $('#setDefault').html(langCompared['setAsDefault'][langNow]);
            $('#display').html(langCompared['display'][langNow]);
            $('#langSwitch').html(langCompared['switchLanguage'][langNow]);
            $('#guide').html(langCompared['guide'][langNow]);
            $('#nodeIdSwitch').html(langCompared['nodeId'][langNow]);
            $('#mapEdit').html(langCompared['edit'][langNow]);
            $('#nodeEditBTN').html(langCompared['node'][langNow]);
            $('#routeEditBTN').html(langCompared['route'][langNow]);
            $('#prefixDiv').html(langCompared['prefix'][langNow]);
            $('#suffixDiv').html(langCompared['suffix'][langNow]);
            $('#mapEditDone').html(langCompared['done'][langNow]);
            $('#colorDiv').html(langCompared['color'][langNow]);
            $('#typeDiv').html(langCompared['type'][langNow]);
            $('#mainstream').html(langCompared['mainstream'][langNow]);
            $('#sidetrack').html(langCompared['sidetrack'][langNow]);
            $('#defaultNode').html(langCompared['defaultNode'][langNow]);
            $('#cancelNodeDefSel').html(langCompared['cancel'][langNow]);
            $('#nodeScaleSwitch').html(langCompared['nodeScaleSwitch'][langNow]);
            for (entryID in entryList) {
                $('#' + entryList[entryID]).html(langCompared['entry'][langNow]);
            }
            if (langNow == 'zh') {
                $('#langBTN').html('English');
                $('title').html('SoulForged 資源共享地圖');
            }
            else if (langNow == 'en') {
                $('#langBTN').html('中文');
                $('title').html('SoulForged Resource Sharing Map');
            }
            for (routeIndex in mapRouteMain) drawLineBetweenCircles(mapRouteMain[routeIndex]['start'], mapRouteMain[routeIndex]['end'], mapRouteMain[routeIndex]['color'], mapRouteMain[routeIndex]['width'], 'Main', 'Link');
            for (routeIndex in mapRouteMH) drawLineBetweenCircles(mapRouteMH[routeIndex]['start'], mapRouteMH[routeIndex]['end'], mapRouteMH[routeIndex]['color'], mapRouteMH[routeIndex]['width'], 'MH', 'Link');
            for (routeIndex in mapRouteTT) drawLineBetweenCircles(mapRouteTT[routeIndex]['start'], mapRouteTT[routeIndex]['end'], mapRouteTT[routeIndex]['color'], mapRouteTT[routeIndex]['width'], 'TT', 'Link');
            searchResultShow();
            window.document.addEventListener('keypress', function (e) {
                if (event.keyCode === 13) {
                    if ($('#settingPage').is(':visible') == false && $('#infoPage').is(':visible')) return
                    else {
                        if (typeNow == 'animal') {
                            if (funcNow == 'add') {
                                let oneAnimalData = {
                                    'name': nameNow,
                                    'quentity': Number($('#quentity').val()),
                                    'activity': settingSelValue
                                }
                                rawData[nodeNow]['animal'].push(oneAnimalData)
                                nodeOnclick(nodeNow);
                                $('#settingPage').hide();
                                $('#infoPage').show();
                                settingInputDOM = ''
                                settingSelDOM = ''
                            }
                            else if (funcNow == 'edit') {
                                rawData[nodeNow]['animal'][indexNow]['activity'] = settingSelValue;
                                rawData[nodeNow]['animal'][indexNow]['quentity'] = Number($('#quentity').val());
                                nodeOnclick(nodeNow);
                                $('#settingPage').hide();
                                $('#infoPage').show();
                                settingInputDOM = ''
                                settingSelDOM = ''
                            }
                        }
                        else if (typeNow == 'resource') {
                            if (funcNow == 'add') {
                                let oneResourceData = {
                                    'name': nameNow,
                                    'quentity': settingSelValue
                                }
                                rawData[nodeNow]['resource'].push(oneResourceData)
                                nodeOnclick(nodeNow);
                                $('#settingPage').hide();
                                $('#infoPage').show();
                                settingInputDOM = ''
                                settingSelDOM = ''
                            }
                            else if (funcNow == 'edit') {
                                rawData[nodeNow]['resource'][indexNow]['quentity'] = settingSelValue;
                                nodeOnclick(nodeNow);
                                $('#settingPage').hide();
                                $('#infoPage').show();
                                settingInputDOM = ''
                                settingSelDOM = ''
                            }
                        }
                        else if (typeNow == 'item') {
                            if (funcNow == 'add') {
                                let oneItemData = {
                                    'name': nameNow,
                                    'quentity': Number($('#quentity').val())
                                }
                                rawData[nodeNow]['item'].push(oneItemData)
                                nodeOnclick(nodeNow);
                                $('#settingPage').hide();
                                $('#infoPage').show();
                                settingInputDOM = ''
                                settingSelDOM = ''
                            }
                            else if (funcNow == 'edit') {
                                rawData[nodeNow]['item'][indexNow]['quentity'] = Number($('#quentity').val());
                                nodeOnclick(nodeNow);
                                $('#settingPage').hide();
                                $('#infoPage').show();
                                settingInputDOM = ''
                                settingSelDOM = ''
                            }
                        }
                    }
                }
            })
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' || event.keyCode === 27) {
                    if($('#infoPage').is(':visible')){
                        if($('#HouseNameDiv').is(':visible')) housePageShow();
                        else cancel();
                    } 
                    else if($('#houseAddingDiv').is(':visible')) resetHousePage();
                    else if($('#houseList').is(':visible')) housePageShow();
                }
            });
            dragElement(document.getElementById("pageContainer"));

            document.addEventListener('keydown', function (event) {
                if (settingSelValue !== '') {
                    if (settingInputDOM != '') {
                        if (document.activeElement !== settingInputDOM) { // 如果當前焦點不在input上
                            const key = event.key;
                            if (key == '1') {
                                settingSelValue = 1
                                $('#stateDiv').attr('class', 'itemQty redBorder');
                                setTimeout(function () {
                                    $("#quentity").focus();
                                }, 0);
                            }
                            else if (key == '2') {
                                settingSelValue = 0
                                $('#stateDiv').attr('class', 'itemQty greenBorder');
                                setTimeout(function () {
                                    $("#quentity").focus();
                                }, 0);
                            }
                        }
                    }
                    else {
                        const key = event.key;
                        if (key == '1') {
                            settingSelValue = 1
                            $('#resourceFig').attr('class', 'itemFig redBorder');
                        }
                        else if (key == '2') {
                            settingSelValue = 2
                            $('#resourceFig').attr('class', 'itemFig orangeBorder');
                        }
                        else if (key == '3') {
                            settingSelValue = 3
                            $('#resourceFig').attr('class', 'itemFig yellowBorder');
                        }
                        else if (key == '4') {
                            settingSelValue = 4
                            $('#resourceFig').attr('class', 'itemFig greenBorder');
                        }
                        else if (key == '0') {
                            settingSelValue = 0
                            $('#resourceFig').attr('class', 'itemFig blackBorder');
                        }

                    }
                }

            });

            let isDragging = false;
            let startPos = null;

            const image = document.getElementById('imgMain'); // 替換為您的圖片ID
            image.addEventListener('mousedown', function (event) {
                isDragging = false; // 當按下滑鼠時，先假設不是拖動
                startPos = { x: event.clientX, y: event.clientY }; // 記錄起始位置
            }, false);

            image.addEventListener('mousemove', function (event) {
                if (startPos) {
                    // 只有當滑鼠有從初始位置移動時，才設定isDragging為true
                    isDragging = event.clientX !== startPos.x || event.clientY !== startPos.y;
                }
            }, false);

            image.addEventListener('mouseup', function (event) {
                startPos = null; // 清除起始位置
            }, false);

            image.addEventListener('mouseup', function (event) {
                startPos = null; // 清除起始位置
                if (isDragging) {
                    isDragging = false; // 重置拖動狀態
                }
                else if (editMapNode == 1) {
                    var imageRect = this.getBoundingClientRect(); // 获取图片的位置和尺寸
                    var x = event.pageX - imageRect.left - window.scrollX; // 获取点击位置的X坐标，加上页面滚动
                    var y = event.pageY - imageRect.top - window.scrollY; // 获取点击位置的Y坐标，加上页面滚动
                    var xPercent = x / this.clientWidth / sacleRatio;
                    var yPercent = y / this.clientHeight / sacleRatio;
                    let noteId = '';
                    if (continueAddState == 0) noteId = prompt('座標ID');
                    else {
                        let serNum = 1;
                        if ($('#prefix').val().trim() !== '') {
                            const regex = /^[A-Za-z]+$/;
                            if (regex.test($('#prefix').val().trim())) {
                                if ($('#suffix').val() !== '' && regex.test($('#suffix').val().trim()) == false) {
                                    alert(langCompared['suffixErr'][langNow]);
                                    return;
                                }
                                for (i in posisionDataMH) {
                                    if (i.substr(0, $('#prefix').val().trim().length) === $('#prefix').val().trim()) {
                                        if (i.includes($('#suffix').val().trim()) && /\d/.test(i.charAt($('#prefix').val().trim().length))) {
                                            alert(langCompared['nodeRepeat'][langNow] + 'Mine Head');
                                            return
                                        }
                                    }
                                }
                                for (i in posisionDataTT) {
                                    if (i.substr(0, $('#prefix').val().trim().length) === $('#prefix').val().trim()) {
                                        if (i.includes($('#suffix').val().trim()) && /\d/.test(i.charAt($('#prefix').val().trim().length))) {
                                            alert(langCompared['nodeRepeat'][langNow] + 'The Tongue');
                                            return
                                        }
                                    }
                                }
                                while ($('#prefix').val().trim() + serNum + $('#suffix').val().trim() in posisionDataMain) serNum += 1
                            }
                            else {
                                alert(langCompared['prefixErr'][langNow]);
                                return;
                            }
                        }
                        else {
                            alert(langCompared['entryPrefix'][langNow]);
                            return
                        }
                        noteId = $('#prefix').val().trim() + serNum + $('#suffix').val().trim()
                    }
                    if (noteId != '' && noteId != null) {
                        if (noteId in posisionDataMain) {
                            window.scrollTo(0, 0);
                            element = document.getElementById(noteId);
                            // 如果元素存在，将其滚动到视窗中心
                            if (element) {
                                element.scrollIntoView({ block: 'center', inline: 'center' });
                            }
                            alert('Node ID已存在');
                            return;
                        }
                        let data = { 'id': noteId, 'X': Number(xPercent.toFixed(3)), 'Y': Number(yPercent.toFixed(3)) }
                        posisionDataMain[noteId] = data
                        for (i in posisionDataMain) {
                            if (i in rawData == false) {
                                rawData[i] = { "area": i, "animal": [], "item": [], "recordTime": 1697212800000, "resource": [], "note": "" }
                            }
                        }
                        var newCircle = document.createElement('div');
                        newCircle.id = data['id'];
                        newCircle.innerHTML = data['id'];
                        newCircle.className = 'interactive-circle black';
                        newCircle.style.position = 'absolute';
                        // newCircle.onclick = function () { nodeOnclick(this.id); };
                        document.getElementById('mapMain').appendChild(newCircle);
                        let newRatio = 1 / sacleRatio
                        content.style.transform = `scale(${newRatio})`;
                        scaleModify = sacleRatio
                        var img = document.getElementById('imgMain');
                        var circle = document.getElementById(newCircle.id);

                        var circleSize = 0.0035; // 圆点的大小，相对于图片宽度的百分比

                        var imgRect = img.getBoundingClientRect();
                        var imgWidth = imgRect.width;
                        var imgHeight = imgRect.height;

                        // 大小
                        // var newSize = imgWidth * circleSize; // 计算新的圆点大小
                        // circle.style.width = newSize*sacleRatio/nodeScaleNow   + 'px';
                        // circle.style.height = newSize*sacleRatio/nodeScaleNow   + 'px';
                        // 位置
                        circle.style.left = (imgWidth * data['X'] * sacleRatio) + 'px'; // 减去圆点宽度的一半
                        circle.style.top = (imgHeight * data['Y'] * sacleRatio) + 'px'; // 减去圆点高度的一半
                        scaleModify = 1
                        content.style.transform = `scale(${sacleRatio})`;
                        sendMapDotData(noteId, data['X'], data['Y'])
                    }
                }
            }, false);

            let isDraggingMH = false;
            let startPosMH = null;

            const image2 = document.getElementById('imgMH'); // 替換為您的圖片ID
            image2.addEventListener('mousedown', function (event) {
                isDraggingMH = false; // 當按下滑鼠時，先假設不是拖動
                startPosMH = { x: event.clientX, y: event.clientY }; // 記錄起始位置
            }, false);

            image2.addEventListener('mousemove', function (event) {
                if (startPosMH) {
                    // 只有當滑鼠有從初始位置移動時，才設定isDraggingMH為true
                    isDraggingMH = event.clientX !== startPosMH.x || event.clientY !== startPosMH.y;
                }
            }, false);

            image2.addEventListener('mouseup', function (event) {
                startPosMH = null; // 清除起始位置
            }, false);

            image2.addEventListener('mouseup', function (event) {
                startPosMH = null; // 清除起始位置
                if (isDraggingMH) {
                    isDraggingMH = false; // 重置拖動狀態
                }
                else if (editMapNode == 1) {
                    var imageRect = this.getBoundingClientRect(); // 获取图片的位置和尺寸
                    var x = event.pageX - imageRect.left - window.scrollX; // 获取点击位置的X坐标，加上页面滚动
                    var y = event.pageY - imageRect.top - window.scrollY; // 获取点击位置的Y坐标，加上页面滚动
                    var xPercent = x / this.clientWidth / sacleRatio;
                    var yPercent = y / this.clientHeight / sacleRatio;
                    let noteId = '';
                    if (continueAddState == 0) noteId = prompt('座標ID');
                    else {
                        let serNum = 1;
                        if ($('#prefix').val().trim() !== '') {
                            const regex = /^[A-Za-z]+$/;
                            if (regex.test($('#prefix').val().trim())) {
                                if ($('#suffix').val() !== '' && regex.test($('#suffix').val().trim()) == false) {
                                    alert(langCompared['suffixErr'][langNow]);
                                    return;
                                }
                                for (i in posisionDataTT) {
                                    if (i.substr(0, $('#prefix').val().trim().length) === $('#prefix').val().trim()) {
                                        if (i.includes($('#suffix').val().trim()) && /\d/.test(i.charAt($('#prefix').val().trim().length))) {
                                            alert(langCompared['nodeRepeat'][langNow] + 'The Tongue');
                                            return
                                        }
                                    }
                                }
                                for (i in posisionDataMain) {
                                    if (i.substr(0, $('#prefix').val().trim().length) === $('#prefix').val().trim()) {
                                        if (i.includes($('#suffix').val().trim()) && /\d/.test(i.charAt($('#prefix').val().trim().length))) {
                                            alert(langCompared['nodeRepeat'][langNow] + 'Main Map');
                                            return
                                        }
                                    }
                                }
                                while ($('#prefix').val().trim() + serNum + $('#suffix').val().trim() in posisionDataMH) serNum += 1
                            }
                            else {
                                alert(langCompared['prefixErr'][langNow]);
                                return;
                            }
                        }
                        else {
                            alert(langCompared['entryPrefix'][langNow]);
                            return
                        }
                        noteId = $('#prefix').val().trim() + serNum + $('#suffix').val().trim()
                    }
                    if (noteId != '' && noteId != null) {
                        if (noteId in posisionDataMH) {
                            window.scrollTo(0, 0);
                            element = document.getElementById(noteId);
                            // 如果元素存在，将其滚动到视窗中心
                            if (element) {
                                element.scrollIntoView({ block: 'center', inline: 'center' });
                            }
                            alert('Node ID已存在');
                            return;
                        }
                        let data = { 'id': noteId, 'X': Number(xPercent.toFixed(3)), 'Y': Number(yPercent.toFixed(3)) }
                        posisionDataMH[noteId] = data
                        for (i in posisionDataMH) {
                            if (i in rawData == false) {
                                rawData[i] = { "area": i, "animal": [], "item": [], "recordTime": 1697212800000, "resource": [], "note": "" }
                            }
                        }
                        var newCircle = document.createElement('div');
                        newCircle.id = data['id'];
                        newCircle.innerHTML = data['id'];
                        newCircle.className = 'interactive-circle black';
                        newCircle.style.position = 'absolute';
                        // newCircle.onclick = function () { nodeOnclick(this.id); };
                        document.getElementById('mapMineHead').appendChild(newCircle);
                        let newRatio = 1 / sacleRatio
                        content.style.transform = `scale(${newRatio})`;
                        scaleModify = sacleRatio
                        var img = document.getElementById('imgMH');
                        var circle = document.getElementById(newCircle.id);

                        var circleSize = 0.007; // 圆点的大小，相对于图片宽度的百分比

                        var imgRect = img.getBoundingClientRect();
                        var imgWidth = imgRect.width;
                        var imgHeight = imgRect.height;

                        // 大小
                        // var newSize = imgWidth * circleSize; // 计算新的圆点大小
                        // circle.style.width = newSize*scaleModify/nodeScaleNow  + 'px';
                        // circle.style.height = newSize*scaleModify/nodeScaleNow  + 'px';
                        // 位置
                        circle.style.left = (imgWidth * data['X'] * sacleRatio) + 'px'; // 减去圆点宽度的一半
                        circle.style.top = (imgHeight * data['Y'] * sacleRatio) + 'px'; // 减去圆点高度的一半
                        scaleModify = 1
                        content.style.transform = `scale(${sacleRatio})`;
                        sendMapDotData(noteId, data['X'], data['Y'])
                    }
                }
            }, false);

            let isDraggingTT = false;
            let startPosTT = null;

            const image3 = document.getElementById('imgTT'); // 替換為您的圖片ID
            image3.addEventListener('mousedown', function (event) {
                isDraggingTT = false; // 當按下滑鼠時，先假設不是拖動
                startPosTT = { x: event.clientX, y: event.clientY }; // 記錄起始位置
            }, false);

            image3.addEventListener('mousemove', function (event) {
                if (startPosTT) {
                    // 只有當滑鼠有從初始位置移動時，才設定isDraggingTT為true
                    isDraggingTT = event.clientX !== startPosTT.x || event.clientY !== startPosTT.y;
                }
            }, false);

            image3.addEventListener('mouseup', function (event) {
                startPosTT = null; // 清除起始位置
            }, false);

            image3.addEventListener('mouseup', function (event) {
                startPosTT = null; // 清除起始位置
                if (isDraggingTT) {
                    isDraggingTT = false; // 重置拖動狀態
                }
                else if (editMapNode == 1) {
                    var imageRect = this.getBoundingClientRect(); // 获取图片的位置和尺寸
                    var x = event.pageX - imageRect.left - window.scrollX; // 获取点击位置的X坐标，加上页面滚动
                    var y = event.pageY - imageRect.top - window.scrollY; // 获取点击位置的Y坐标，加上页面滚动
                    var xPercent = x / this.clientWidth / sacleRatio;
                    var yPercent = y / this.clientHeight / sacleRatio;
                    let noteId = '';
                    if (continueAddState == 0) noteId = prompt('座標ID');
                    else {
                        let serNum = 1;
                        if ($('#prefix').val().trim() !== '') {
                            const regex = /^[A-Za-z]+$/;
                            if (regex.test($('#prefix').val().trim())) {
                                if ($('#suffix').val() !== '' && regex.test($('#suffix').val().trim()) == false) {
                                    alert(langCompared['suffixErr'][langNow]);
                                    return;
                                }
                                for (i in posisionDataMH) {
                                    if (i.substr(0, $('#prefix').val().trim().length) === $('#prefix').val().trim()) {
                                        if (i.includes($('#suffix').val().trim()) && /\d/.test(i.charAt($('#prefix').val().trim().length))) {
                                            alert(langCompared['nodeRepeat'][langNow] + 'Mine Head');
                                            return
                                        }
                                    }
                                }
                                for (i in posisionDataMain) {
                                    if (i.substr(0, $('#prefix').val().trim().length) === $('#prefix').val().trim()) {
                                        if (i.includes($('#suffix').val().trim()) && /\d/.test(i.charAt($('#prefix').val().trim().length))) {
                                            alert(langCompared['nodeRepeat'][langNow] + 'Main Map');
                                            return
                                        }
                                    }
                                }
                                while ($('#prefix').val().trim() + serNum + $('#suffix').val().trim() in posisionDataTT) serNum += 1
                            }
                            else {
                                alert(langCompared['prefixErr'][langNow]);
                                return;
                            }
                        }
                        else {
                            alert(langCompared['entryPrefix'][langNow]);
                            return
                        }
                        noteId = $('#prefix').val().trim() + serNum + $('#suffix').val().trim()
                    }
                    if (noteId != '' && noteId != null) {
                        if (noteId in posisionDataTT) {
                            window.scrollTo(0, 0);
                            element = document.getElementById(noteId);
                            // 如果元素存在，将其滚动到视窗中心
                            if (element) {
                                element.scrollIntoView({ block: 'center', inline: 'center' });
                            }
                            alert('Node ID已存在');
                            return;
                        }
                        let data = { 'id': noteId, 'X': Number(xPercent.toFixed(3)), 'Y': Number(yPercent.toFixed(3)) }
                        posisionDataTT[noteId] = data
                        for (i in posisionDataTT) {
                            if (i in rawData == false) {
                                rawData[i] = { "area": i, "animal": [], "item": [], "recordTime": 1697212800000, "resource": [], "note": "" }
                            }
                        }
                        var newCircle = document.createElement('div');
                        newCircle.id = data['id'];
                        newCircle.innerHTML = data['id'];
                        newCircle.className = 'interactive-circle black';
                        newCircle.style.position = 'absolute';
                        // newCircle.onclick = function () { nodeOnclick(this.id); };
                        document.getElementById('mapTT').appendChild(newCircle);
                        let newRatio = 1 / sacleRatio
                        content.style.transform = `scale(${newRatio})`;
                        scaleModify = sacleRatio

                        var img = document.getElementById('imgTT');
                        var circle = document.getElementById(newCircle.id);

                        var circleSize = 0.007; // 圆点的大小，相对于图片宽度的百分比

                        var imgRect = img.getBoundingClientRect();
                        var imgWidth = imgRect.width;
                        var imgHeight = imgRect.height;

                        // 大小
                        // var newSize = imgWidth * circleSize; // 计算新的圆点大小
                        // circle.style.width = newSize*scaleModify/nodeScaleNow  + 'px';
                        // circle.style.height = newSize*scaleModify/nodeScaleNow  + 'px';
                        // 位置
                        circle.style.left = (imgWidth * data['X'] * sacleRatio) + 'px'; // 减去圆点宽度的一半
                        circle.style.top = (imgHeight * data['Y'] * sacleRatio) + 'px'; // 减去圆点高度的一半
                        scaleModify = 1
                        content.style.transform = `scale(${sacleRatio})`;
                        sendMapDotData(noteId, data['X'], data['Y'])
                    }
                }
            }, false);

            // $('.interactive-circle').addClass('black');
            var isDrag = false;

            $(".interactive-circle")
                .mousedown(function () {
                    isDrag = false;
                })
                .mousemove(function () {
                    isDrag = true;
                })
                .mouseup(function (e) {
                    if (!isDrag) {
                        nodeOnclick(e.target.id);
                    }
                    isDrag = false;
                });

            // $('.interactive-circle').addClass('black');
            for (pathData of mapRouteMain) {
                if ('bAP' in pathData) {
                    (function (pathData) {
                        $('#' + pathData['start'] + 'Link' + pathData['end']).mouseenter(function (e) {
                            $('.info-tag').text(pathData['bAP'])
                                .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                        }).mouseleave(function () {
                            $('.info-tag').hide();
                        });
                    })(pathData); // 使用IIFE将当前pathData传递给函数
                }
                else $('#'+pathData['start']+'Link'+pathData['end']).css({'stroke-dasharray':4})
            }
            for (pathData of mapRouteMH) {
                if ('bAP' in pathData) {
                    (function (pathData) {
                        $('#' + pathData['start'] + 'Link' + pathData['end']).mouseenter(function (e) {
                            $('.info-tag').text(pathData['bAP'])
                                .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                        }).mouseleave(function () {
                            $('.info-tag').hide();
                        });
                    })(pathData); // 使用IIFE将当前pathData传递给函数
                }
                else $('#'+pathData['start']+'Link'+pathData['end']).css({'stroke-dasharray':4})
            }
            for (pathData of mapRouteTT) {
                if ('bAP' in pathData) {
                    (function (pathData) {
                        $('#' + pathData['start'] + 'Link' + pathData['end']).mouseenter(function (e) {
                            $('.info-tag').text(pathData['bAP'])
                                .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                        }).mouseleave(function () {
                            $('.info-tag').hide();
                        });
                    })(pathData); // 使用IIFE将当前pathData传递给函数
                }
                else $('#'+pathData['start']+'Link'+pathData['end']).css({'stroke-dasharray':4})
            }

            if (urlNow.searchParams.has('pathArray')) {
                let pathStr = urlNow.searchParams.get('pathArray')
                if (pathStr[pathStr.length - 1] != ']') {
                    pathStr += ']'
                }
                try {
                    pathFindingArray = JSON.parse(pathStr);
                    pathFinding();
                    planningMethodChange('Node')
                    for (id of pathFindingArray) $('#' + id).css({ 'background-color': '#ff0000' });
                    setTimeout(function () {
                        if (pathFindingArray[0] in posisionDataTT) nodeOnclick('CDM');
                        else if (pathFindingArray[0] in posisionDataMH) nodeOnclick('Q21DM1');
                        window.scrollTo(0, 0);
                        if (pathFindingArray.length != 0) document.getElementById(pathFindingArray[0]).scrollIntoView({ block: 'center', inline: 'center' });
                        else document.getElementById('W25').scrollIntoView({ block: 'center', inline: 'center' });
                    }, 0);
                }
                catch {
                    console.log('pathArray loading error')
                }


            }
            $('#syncIcon').mouseenter(function (e) {
                $('.info-tag').text('Refresh')
                    .css({ top: e.pageY + 10 + 'px', left: e.pageX + 'px', display: 'block' });
            }).mouseleave(function () {
                $('.info-tag').hide();
            });
            $('#settingIcon').mouseenter(function (e) {
                $('.info-tag').text('Setting')
                    .css({ top: e.pageY - 30 + 'px', left: e.pageX - 100 + 'px', display: 'block' });
            }).mouseleave(function () {
                $('.info-tag').hide();
            });
            $('#importIcon').mouseenter(function (e) {
                $('.info-tag').text('Resource Data Import')
                    .css({ top: e.pageY + 10 + 'px', left: e.pageX - 220 + 'px', display: 'block' });
            }).mouseleave(function () {
                $('.info-tag').hide();
            });
            $('#aimIcon').mouseenter(function (e) {
                $('.info-tag').text('Node Finding')
                    .css({ top: e.pageY + 10 + 'px', left: e.pageX - 170 + 'px', display: 'block' });
            }).mouseleave(function () {
                $('.info-tag').hide();
            });
            $('#pathIcon').mouseenter(function (e) {
                $('.info-tag').text('Travel Planning')
                    .css({ top: e.pageY + 10 + 'px', left: e.pageX - 180 + 'px', display: 'block' });
            }).mouseleave(function () {
                $('.info-tag').hide();
            });
            $('#houseIcon').mouseenter(function (e) {
                $('.info-tag').text('House')
                    .css({ top: e.pageY + 10 + 'px', left: e.pageX - 100 + 'px', display: 'block' });
            }).mouseleave(function () {
                $('.info-tag').hide();
            });
            $('#eliteIcon').mouseenter(function (e) {
                $('.info-tag').text('Elite')
                    .css({ top: e.pageY + 10 + 'px', left: e.pageX - 100 + 'px', display: 'block' });
            }).mouseleave(function () {
                $('.info-tag').hide();
            });
        }
        var dataOnLoad = function () {

            let dataLoad = loadingCount;
            if (document.getElementById('imgMain').complete) dataLoad += 1;
            if (document.getElementById('imgMH').complete) dataLoad += 1;
            if (document.getElementById('imgTT').complete) dataLoad += 1;
            $('#loadCount').html(dataLoad);
            if (dataLoad == loadingDataList.length+3) continueSet();
        }

        function init() {
            $('#totalLoadCount').html(loadingDataList.length+3)
            fetch('/checkVer')
                .then(response => response.text())
                .then(serverVersion => {
                    // 比較伺服器版本和當前版本
                    if (serverVersion !== version) {
                        // 如果版本不一致，提示用戶
                        let update = confirm(langCompared['checkUpdate'][langNow]);
                        if (update) {
                            // 如果用戶選擇更新，則重新整理網頁
                            window.location.reload();
                        }
                    }
                })
                .catch(error => {
                    console.error('server error:', error);
                });
            $('#versionNum').html(version.replace(/-/g, '.'))
            $('#jsonInputDiv').hide();
            $('#settingPageMobile').hide();
            if (isMobileDevice()) {
                pageIconSize = '200px';
                pageFontSize = '45px';
                $('<style>')
                    .prop('type', 'text/css')
                    .appendTo('head');
                $('style').append("#waitMessage{font-size:90px;}")
                $('style').append(".loader{border: 20px solid #f3f3f3;border-top: 20px solid #bbbbbb;width: 100px;height: 100px;}")
            }
            // urlNow = new URL(location.href);
            // if(urlNow.host.includes('vercel'))staticPath = 'pagefile/'
            if (urlNow.searchParams.has('func')) urlFunc = urlNow.searchParams.get('func')
            if (urlNow.searchParams.has('lang')) langNow = urlNow.searchParams.get('lang')

            jsonFromBackend = JSON.parse($('#getDataDiv').html().replace(/'/g, '"'))
            jsonData = iconUrlData
            nodeMaping = jsonFromBackend['nodeMaping']
            recordNodeList = Object.values(nodeMaping);
            lastnodeMaping = JSON.parse(JSON.stringify(nodeMaping))
            resDataDict = jsonFromBackend['resMaping']
            tempRes = JSON.parse(JSON.stringify(resDataDict))
            creDataDict = jsonFromBackend['creMaping']
            tempCre = JSON.parse(JSON.stringify(creDataDict))
            invDataDict = jsonFromBackend['invMaping']
            tempInv = JSON.parse(JSON.stringify(invDataDict))
            if('houseList' in jsonFromBackend) houseListObject = jsonFromBackend['houseList']
            for(i of loadingDataList)getDataFromBackend(i);
            animalList = jsonData['animalList']
            animalUrl = jsonData['animalUrl']
            carpentryUrl = jsonData['carpentryUrl']
            cookedUrl = jsonData['cookedUrl']
            corpseUrl = jsonData['corpseUrl']
            doctoringUrl = jsonData['doctoringUrl']
            furnitureUrl = jsonData['furnitureUrl']
            equipmentUrl = jsonData['equipmentUrl']
            foragingUrl = jsonData['foragingUrl']
            gatheringUrl = jsonData['gatheringUrl']
            medicalUrl = jsonData['medicalUrl']
            miningUrl = jsonData['miningUrl']
            otherUrl = jsonData['otherUrl']
            smithingUrl = jsonData['smithingUrl']
            toolUrl = jsonData['toolUrl']
            woodCuttingUrl = jsonData['woodCuttingUrl']
        }

        function resetSearchDiv(dataList) {
            for (i in dataList) {
                // searchSlot[i] = {}
                // searchSlot[i]['slot'] = dataList[i]['slot']
                if ($('#slot' + dataList[i]['slot']).length) $('#slot' + dataList[i]['slot']).remove();
                $('#searchNodeDiv').prepend($('<div>', { id: 'slot' + dataList[i]['slot'], class: 'searchSettingPage' }))
                $('#slot' + dataList[i]['slot'])
                    .append($('<button>', { onclick: "search('animal'," + dataList[i]['slot'] + ");" }).append(langCompared['creature'][langNow]))
                    .append($('<button>', { onclick: "search('resource'," + dataList[i]['slot'] + ");" }).append(langCompared['resource'][langNow]))
                    .append($('<button>', { onclick: "search('item'," + dataList[i]['slot'] + ");" }).append(langCompared['item'][langNow]))
                    .append($('<button>', { onclick: "search('time'," + dataList[i]['slot'] + ");" }).append(langCompared['renewTime'][langNow]))
                    .append($('<button>', { onclick: "search('cancel'," + dataList[i]['slot'] + ");" }).append(langCompared['cancel'][langNow]))
                if (dataList[i]['type'] == 'animal') {
                    searchedName = dataList[i]['name'];
                    // searchSlot[dataList[i]['slot']]['name'] = searchedName;
                    $('#slot' + dataList[i]['slot']).html('');
                    $('#slot' + dataList[i]['slot'])
                        .append($('<img>', { class: "itemFig", src: staticPath + "static/cre/" + dataList[i]['name'].replace(/ /g, '-') + '.jpg', onclick: "search('cancel','" + dataList[i]['slot'] + "');" }))
                        .append($('<select>', { id: 'circleSearchMethod' + dataList[i]['slot'], onchange: 'searchResultShow();' })
                            .append($('<option>').html(langCompared['newest'][langNow]))
                            .append($('<option>').html(langCompared['ever'][langNow]))
                        )
                        .append($('<select>', { id: 'circleSearchDisplay' + dataList[i]['slot'], onchange: 'siteChange("' + dataList[i]['slot'] + '");searchResultShow();' })
                            .append($('<option>').html(langCompared['fill'][langNow]))
                            .append($('<option>').html(langCompared['border'][langNow]))
                        )
                }
                else if (dataList[i]['type'] == 'resource') {
                    searchedName = dataList[i]['name'];
                    // searchSlot[dataList[i]['slot']]['name'] = searchedName;

                    let figPath = ''
                    for (p in huntableAnimalList) {
                        if (huntableAnimalList[p].toLowerCase().includes(searchedName.toLowerCase())) {
                            figPath = staticPath + "static/res/" + huntableAnimalList[p].replace(/ /g, '-') + '.jpg'
                        }
                    }
                    if (figPath == '') {
                        for (p of foragingUrl) {
                            if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) {
                                figPath = staticPath + "static/res/" + p + '.jpg'

                            }
                        }
                    }
                    if (figPath == '') {
                        for (p of gatheringUrl) {
                            if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) {
                                figPath = staticPath + "static/res/" + p + '.jpg'
                            }
                        }
                    }
                    if (figPath == '') {
                        for (p of miningUrl) {
                            if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) {
                                figPath = staticPath + "static/res/" + p + '.jpg'
                            }
                        }
                    }
                    if (figPath == '') {
                        for (p of woodCuttingUrl) {
                            if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) {
                                figPath = staticPath + "static/res/" + p + '.jpg'
                            }
                        }
                    }
                    $('#slot' + dataList[i]['slot']).html('');
                    $('#slot' + dataList[i]['slot'])
                        .append($('<img>', { class: "itemFig", src: figPath, onclick: "search('cancel','" + dataList[i]['slot'] + "');" }))
                        .append($('<select>', { id: 'circleSearchMethod' + dataList[i]['slot'], onchange: 'searchResultShow();' })
                            .append($('<option>').html(langCompared['newest'][langNow]))
                            .append($('<option>').html(langCompared['highest'][langNow]))
                            .append($('<option>').html(langCompared['lowest'][langNow]))
                        )
                        .append($('<select>', { id: 'circleSearchDisplay' + dataList[i]['slot'], onchange: 'siteChange("' + dataList[i]['slot'] + '");searchResultShow();' })
                            .append($('<option>').html(langCompared['fill'][langNow]))
                            .append($('<option>').html(langCompared['border'][langNow]))
                        )
                }
                else if (dataList[i]['type'] == 'item') {
                    searchedName = dataList[i]['name'];

                    let figPath = '';
                    if (figPath == '') for (p of cookedUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of corpseUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of furnitureUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of doctoringUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of equipmentUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of foragingUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of gatheringUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of medicalUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of miningUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of otherUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of toolUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of carpentryUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of woodCuttingUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'
                    if (figPath == '') for (p of smithingUrl) if (p.toLowerCase().replace(/-/g, ' ') == searchedName.toLowerCase()) figPath = staticPath + "static/res/" + p + '.jpg'


                    $('#slot' + dataList[i]['slot']).html('');
                    $('#slot' + dataList[i]['slot'])
                        .append($('<img>', { class: "itemFig", src: figPath, onclick: "search('cancel','" + dataList[i]['slot'] + "');" }))
                        .append($('<select>', { id: 'circleSearchMethod' + dataList[i]['slot'], style: 'visibility:hidden;' })
                        )
                        .append($('<select>', { id: 'circleSearchDisplay' + dataList[i]['slot'], onchange: 'siteChange("' + dataList[i]['slot'] + '");searchResultShow();' })
                            .append($('<option>').html(langCompared['fill'][langNow]))
                            .append($('<option>').html(langCompared['border'][langNow]))
                        )
                }
                else if (dataList[i]['type'] == 'time') {
                    let fontSize = '27';
                    if (langNow == 'en') fontSize = '14';
                    if (isMobileDevice()) {
                        fontSize = '100';
                        if (langNow == 'en') fontSize = '60';
                    }
                    $('#slot' + dataList[i]['slot']).html('');
                    $('#slot' + dataList[i]['slot'])
                        .append($('<button>', { id: 'timeSearchBTN', class: 'itemFig', style: 'border: black solid;background: white;color: black;', onclick: "search('cancel','" + dataList[i]['slot'] + "');" }).append(langCompared["renewTime"][langNow]))
                        .append($('<select>', { style: 'visibility:hidden;' }))
                        .append($('<select>', { id: 'circleSearchDisplay' + dataList[i]['slot'], onchange: 'siteChange(' + dataList[i]['slot'] + ');searchResultShow();' })
                            .append($('<option>').html(langCompared["fill"][langNow]))
                            .append($('<option>').html(langCompared["border"][langNow]))
                        )
                }
                if (Object.keys(dataList).length == 2) $('#btnDiv').hide();
                $('#circleSearchDisplay' + dataList[i]['slot']).val(dataList[i]['display']);
                if (dataList[i]['type'] == 'resource' || dataList[i]['type'] == 'animal') {
                    $('#circleSearchMethod' + dataList[i]['slot']).val(dataList[i]['method']);
                    // delete dataList[i]['method'];
                }
                // delete dataList[i]['display'];
                // searchSlot[i] = dataList[i]
            }
            setTimeout(function () {
                searchResultShow();
            }, 0);

        }

        function sendMapDotData(id, X, Y) {
            formData = new FormData();
            formData.append('id', id);
            formData.append('X', X);
            formData.append('Y', Y);
            let fetchUrl = '';
            formData.append('map', mapId);
            fetch('/saveMapDot', {
                method: 'POST',
                body: formData
            })
                .then(response => {

                })
        }

        function positionAndResizeCircle(circleId, posX, posY, scaleSet) {
            // var img = document.querySelector('.image-container img');
            var img = document.getElementById('imgMain')
            var circle = document.getElementById(circleId);

            var imgRect = img.getBoundingClientRect();
            var imgWidth = imgRect.width;
            var imgHeight = imgRect.height;

            // 大小
            // var newSize = 30; // 计算新的圆点大小
            // circle.style.width = newSize*scaleModify / scaleSet/nodeScaleNow  + 'px';
            // circle.style.height = newSize*scaleModify / scaleSet/nodeScaleNow  + 'px';

            // 位置
            circle.style.left = (imgWidth * posX) + 'px'; // 减去圆点宽度的一半
            circle.style.top = (imgHeight * posY) + 'px'; // 减去圆点高度的一半
        }

        function updateRawdata() {
            $('#syncDiv').css({ border: 'solid #ffb100 5px' });
            for(i of loadingDataList)getDataFromBackend(i);
        }
        function onReload() {
            if (loadingCount == loadingDataList.length) {
                loadingCount = 0;
                $('.interactive-circle').remove()
                $('line').remove()
                let lastSacleRatio = sacleRatio;
                sacleRatio = 1
                content.style.transform = `scale(1)`;

                for (i in posisionDataMain) {
                    if (i in rawData == false) {
                        rawData[i] = { "area": i, "animal": [], "item": [], "recordTime": 1697212800000, "resource": [], "note": "" }
                    }
                }
                for (i in posisionDataMH) {
                    if (i in rawData == false) {
                        rawData[i] = { "area": i, "animal": [], "item": [], "recordTime": 1697212800000, "resource": [], "note": "" }
                    }
                }
                for (i in posisionDataTT) {
                    if (i in rawData == false) {
                        rawData[i] = { "area": i, "animal": [], "item": [], "recordTime": 1697212800000, "resource": [], "note": "" }
                    }
                }
                for (i in posisionDataMain) {
                    var data = posisionDataMain[i];

                    var newCircle = document.createElement('div');
                    newCircle.id = i;
                    if (entryList.includes(i)) {
                        newCircle.innerHTML = langCompared['entry'][langNow];
                        newCircle.style.backgroundColor = '#ff00ff';
                    }
                    else newCircle.innerHTML = i;
                    newCircle.className = 'interactive-circle black';
                    newCircle.style.position = 'absolute';

                    // newCircle.onclick = function () { nodeOnclick(this.id); };
                    document.getElementById('mapMain').appendChild(newCircle);
                    positionAndResizeCircle(newCircle.id, data['X'], data['Y'], sacleRatio);
                }
                for (i in posisionDataMH) {
                    var newCircle = document.createElement('div');
                    newCircle.id = i;
                    if (entryList.includes(i)) {
                        newCircle.innerHTML = langCompared['entry'][langNow];
                        newCircle.style.backgroundColor = '#ff00ff';
                    }
                    else newCircle.innerHTML = i;
                    newCircle.className = 'interactive-circle black';
                    newCircle.style.position = 'absolute';
                    // newCircle.onclick = function () { nodeOnclick(this.id); };
                    document.getElementById('mapMineHead').appendChild(newCircle);
                    let newRatio = 1 / sacleRatio
                    content.style.transform = `scale(${newRatio})`;
                    scaleModify = sacleRatio

                    var img = document.getElementById('imgMH');
                    var circle = document.getElementById(newCircle.id);

                    var imgRect = img.getBoundingClientRect();
                    var imgWidth = imgRect.width;
                    var imgHeight = imgRect.height;

                    // 大小
                    // var newSize = 30; // 计算新的圆点大小
                    // circle.style.width = newSize*scaleModify/nodeScaleNow   + 'px';
                    // circle.style.height = newSize*scaleModify/nodeScaleNow   + 'px';
                    // 位置
                    circle.style.left = (imgWidth * posisionDataMH[i]['X']) + 'px'; // 减去圆点宽度的一半
                    circle.style.top = (imgHeight * posisionDataMH[i]['Y']) + 'px'; // 减去圆点高度的一半
                    scaleModify = 1
                    content.style.transform = `scale(${sacleRatio})`;
                }
                for (i in posisionDataTT) {
                    var newCircle = document.createElement('div');
                    newCircle.id = i;
                    if (entryList.includes(i)) {
                        newCircle.innerHTML = langCompared['entry'][langNow];
                        newCircle.style.backgroundColor = '#ff00ff';
                    }
                    else newCircle.innerHTML = i;
                    newCircle.className = 'interactive-circle black';
                    newCircle.style.position = 'absolute';
                    // newCircle.onclick = function () { nodeOnclick(this.id); };
                    document.getElementById('mapTT').appendChild(newCircle);
                    let newRatio = 1 / sacleRatio
                    content.style.transform = `scale(${newRatio})`;
                    scaleModify = sacleRatio

                    var img = document.getElementById('imgTT');
                    var circle = document.getElementById(newCircle.id);


                    var imgRect = img.getBoundingClientRect();
                    var imgWidth = imgRect.width;
                    var imgHeight = imgRect.height;

                    // 大小
                    // var newSize = 30; // 计算新的圆点大小
                    // circle.style.width = newSize*scaleModify/nodeScaleNow   + 'px';
                    // circle.style.height = newSize*scaleModify/nodeScaleNow   + 'px';
                    // 位置
                    circle.style.left = (imgWidth * posisionDataTT[i]['X']) + 'px'; // 减去圆点宽度的一半
                    circle.style.top = (imgHeight * posisionDataTT[i]['Y']) + 'px'; // 减去圆点高度的一半
                    scaleModify = 1
                    content.style.transform = `scale(${sacleRatio})`;
                }
                var isDrag = false;
                $(".interactive-circle")
                    .mousedown(function () {
                        isDrag = false;
                    })
                    .mousemove(function () {
                        isDrag = true;
                    })
                    .mouseup(function (e) {
                        if (!isDrag) {
                            nodeOnclick(e.target.id);
                        }
                        isDrag = false;
                    });
                for (routeIndex in mapRouteMain) drawLineBetweenCircles(mapRouteMain[routeIndex]['start'], mapRouteMain[routeIndex]['end'], mapRouteMain[routeIndex]['color'], mapRouteMain[routeIndex]['width'], 'Main', 'Link');
                for (routeIndex in mapRouteMH) drawLineBetweenCircles(mapRouteMH[routeIndex]['start'], mapRouteMH[routeIndex]['end'], mapRouteMH[routeIndex]['color'], mapRouteMH[routeIndex]['width'], 'MH', 'Link');
                for (routeIndex in mapRouteTT) drawLineBetweenCircles(mapRouteTT[routeIndex]['start'], mapRouteTT[routeIndex]['end'], mapRouteTT[routeIndex]['color'], mapRouteTT[routeIndex]['width'], 'TT', 'Link');
                sacleRatio = lastSacleRatio;
                content.style.transform = `scale(${sacleRatio})`;
                searchResultShow();
                $('#syncDiv').css({ border: 'solid #00ff00 5px' });
                for (pathData of mapRouteMain) {
                    if ('bAP' in pathData) {
                        (function (pathData) {
                            $('#' + pathData['start'] + 'Link' + pathData['end']).mouseenter(function (e) {
                                $('.info-tag').text(pathData['bAP'])
                                    .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                            }).mouseleave(function () {
                                $('.info-tag').hide();
                            });
                        })(pathData); // 使用IIFE将当前pathData传递给函数
                    }
                    else $('#'+pathData['start']+'Link'+pathData['end']).css({'stroke-dasharray':4})
                }
                for (pathData of mapRouteMH) {
                    if ('bAP' in pathData) {
                        (function (pathData) {
                            $('#' + pathData['start'] + 'Link' + pathData['end']).mouseenter(function (e) {
                                $('.info-tag').text(pathData['bAP'])
                                    .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                            }).mouseleave(function () {
                                $('.info-tag').hide();
                            });
                        })(pathData); // 使用IIFE将当前pathData传递给函数
                    }
                    else $('#'+pathData['start']+'Link'+pathData['end']).css({'stroke-dasharray':4})
                }
                for (pathData of mapRouteTT) {
                    if ('bAP' in pathData) {
                        (function (pathData) {
                            $('#' + pathData['start'] + 'Link' + pathData['end']).mouseenter(function (e) {
                                $('.info-tag').text(pathData['bAP'])
                                    .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                            }).mouseleave(function () {
                                $('.info-tag').hide();
                            });
                        })(pathData); // 使用IIFE将当前pathData传递给函数
                    }
                    else $('#'+pathData['start']+'Link'+pathData['end']).css({'stroke-dasharray':4})
                }
                setInterval(syncColorDone, 60000)
                $('.interactive-circle').css({ width: 30 / nodeScaleNow + 'px', height: 30 / nodeScaleNow + 'px', fontSize: 20 / nodeScaleNow + 'px' })
                $('.interactive-circle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                $('.blackCircle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                $('.redCircle').css('border', 5 / nodeScaleNow + 'px #ff0000 solid')
                $('.orangeCircle').css('border', 5 / nodeScaleNow + 'px #ffb100 solid')
                $('.yellowCircle').css('border', 5 / nodeScaleNow + 'px #ffff00 solid')
                $('.greenCircle').css('border', 5 / nodeScaleNow + 'px #00ff00 solid')
                if($('#houseListPage').is(':visible'))resetHousePage();
            }
        }
        function syncColorDone() {
            $('#syncDiv').css({ border: 'solid #000000 5px' });
        }
        function recordTimeShow(displaySite) {
            if (displaySite == 'outter') {
                $('.greenCircle').removeClass('greenCircle');
                $('.orangeCircle').removeClass('orangeCircle');
                $('.yellowCircle').removeClass('yellowCircle');
                $('.redCircle').removeClass('redCircle');
            }
            else {
                $('.interactive-circle').addClass('black');
                $('.green').removeClass('green');
                $('.orange').removeClass('orange');
                $('.yellow').removeClass('yellow');
                $('.red').removeClass('red');
            }
            function showNodeTime(areaId) {
                if (areaId in rawData) {
                    let nowTime = Date.now();
                    let timeDef = nowTime - rawData[areaId]['recordTime'];
                    let classStr = $('#' + areaId).attr('class') + ' '

                    if (rawData[areaId]['recordTime'] == 1697212800000) {
                        classStr += 'black'
                    }
                    else if (timeDef >= 72000000) {
                        classStr += 'red'
                    }
                    else if (timeDef < 72000000 && timeDef > 10800000) {
                        classStr += 'orange'
                    }
                    else if (timeDef <= 10800000 && timeDef > 1800000) {
                        classStr += 'yellow'
                    }
                    else if (timeDef <= 1800000) {
                        classStr += 'green'
                    }
                    if (displaySite == 'outter') {
                        classStr += 'Circle'
                    }

                    $('#' + areaId).attr('class', classStr)
                }
            }
            for (areaId in posisionDataMain) showNodeTime(areaId);
            for (areaId in posisionDataMH) showNodeTime(areaId);
            for (areaId in posisionDataTT) showNodeTime(areaId);
            
            // for (areaId in posisionDataCh2) showNodeTime(areaId);
        }
        function customSort(a, b) {
            var regex = /(\D+)(\d+)/; // 匹配開頭的字母和隨後的數字

            var matchA = a.match(regex);
            var matchB = b.match(regex);

            if (matchA && matchB) {
                var prefixA = matchA[1];
                var numberA = parseInt(matchA[2], 10);

                var prefixB = matchB[1];
                var numberB = parseInt(matchB[2], 10);

                // 先比較字母部分
                if (prefixA < prefixB) return -1;
                if (prefixA > prefixB) return 1;

                // 字母部分相同，比較數字部分
                return numberA - numberB;
            }

            return a.localeCompare(b); // 如果不匹配，直接比較整個字符串
        }
        function nodeOnclick(id) {
            $('#houseListPage').hide()
            console.log(id)
            if (editMapNode == 1) {
                if (entryList.includes(id) == false) {
                    if (confirm(langCompared['delCheck'][langNow] + id + '?')) {
                        formData = new FormData();
                        formData.append('id', id);
                        formData.append('map', mapId);
                        fetch('/delMapDot', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                if (response.ok) {
                                    // HTTP狀態碼在200-299之間，表示請求成功
                                    return response.text();  // 你可以用 response.json() 如果後端返回的是 JSON 格式
                                } else {
                                    // HTTP狀態碼在300以上，表示請求失敗
                                    throw new Error('Server response was not ok: ' + response.statusText);
                                }
                            })
                            .then(data => {
                                // 這裡的 data 是上面的 response.text() 的結果
                                if (data === 'OK') {
                                    $('line[id*=Link' + id + ']').remove()
                                    $('line[id*=' + id + 'Link]').remove()
                                    delete posisionDataMain[id]
                                    if (mapId == 'Main') {
                                        mapRouteMain = mapRouteMain.filter(function (item) {
                                            return item.start !== id && item.end !== id;
                                        });
                                    }
                                    else if (mapId == 'MH') {
                                        mapRouteMH = mapRouteMH.filter(function (item) {
                                            return item.start !== id && item.end !== id;
                                        });
                                    }
                                    else if (mapId == 'TT') {
                                        mapRouteTT = mapRouteTT.filter(function (item) {
                                            return item.start !== id && item.end !== id;
                                        });
                                    }
                                    $('#' + id).remove();
                                } else {
                                    throw new Error('Server response was not expected: ' + data);
                                }
                            })
                            .catch(error => {
                                // 這裡處理網絡錯誤和上面拋出的錯誤
                                console.error('There was a problem with the fetch operation:', error);
                                alert(langCompared['serverErr'][langNow]);
                            });
                    }
                }
            }
            else if (editMapRoute == 1) {
                if (routeNodePair.length == 0) {
                    routeNodePair.push(id);
                    $('#' + id).css({ 'background-color': '#00ff00' });
                }
                else if (routeNodePair.includes(id)) {
                    $('#' + id).css('background-color', '');
                    routeNodePair = []
                }
                else {
                    routeNodePair.push(id);
                    routeNodePair.sort(customSort);
                    let oneData = { 'start': routeNodePair[0], 'end': routeNodePair[1], 'color': routeColorSetting, 'width': routeWidth }
                    let repeatCheck = 0;
                    if (mapId == 'Main') {
                        for (routeDataIndex in mapRouteMain) {
                            if (mapRouteMain[routeDataIndex]['start'] == routeNodePair[0] && mapRouteMain[routeDataIndex]['end'] == routeNodePair[1]) {
                                if (confirm(langCompared['routeRepeat'][langNow])) {
                                    mapRouteMain[routeDataIndex] = oneData;
                                    $('#' + routeNodePair[0] + 'Link' + routeNodePair[1]).remove()
                                    repeatCheck = 1;
                                }
                                else {
                                    $('#' + routeNodePair[0]).css('background-color', '');
                                    $('#' + routeNodePair[1]).css('background-color', '');
                                    // $('#'+routeNodePair[1]).css({'background-color':'#4e4e4e'});
                                    // $('#'+routeNodePair[0]).css({'background-color':'#4e4e4e'});
                                    searchResultShow();
                                    routeNodePair = []
                                    return;
                                }
                                break;
                            }
                        }
                        if (repeatCheck == 0) mapRouteMain.push(oneData)
                    }
                    else if (mapId == 'MH') {
                        for (routeDataIndex in mapRouteMH) {
                            if (mapRouteMH[routeDataIndex]['start'] == routeNodePair[0] && mapRouteMH[routeDataIndex]['end'] == routeNodePair[1]) {
                                if (confirm(langCompared['routeRepeat'][langNow])) {
                                    mapRouteMH[routeDataIndex] = oneData;
                                    $('#' + routeNodePair[0] + 'Link' + routeNodePair[1]).remove()
                                    repeatCheck = 1;
                                }
                                else {
                                    $('#' + routeNodePair[0]).css('background-color', '');
                                    $('#' + routeNodePair[1]).css('background-color', '');
                                    searchResultShow();
                                    routeNodePair = []
                                    return;
                                }
                                break;
                            }
                        }
                        if (repeatCheck == 0) mapRouteMH.push(oneData)
                    }
                    else if (mapId == 'TT') {
                        for (routeDataIndex in mapRouteTT) {
                            if (mapRouteTT[routeDataIndex]['start'] == routeNodePair[0] && mapRouteTT[routeDataIndex]['end'] == routeNodePair[1]) {
                                if (confirm(langCompared['routeRepeat'][langNow])) {
                                    mapRouteTT[routeDataIndex] = oneData;
                                    $('#' + routeNodePair[0] + 'Link' + routeNodePair[1]).remove()
                                    repeatCheck = 1;
                                }
                                else {
                                    $('#' + routeNodePair[0]).css('background-color', '');
                                    $('#' + routeNodePair[1]).css('background-color', '');
                                    searchResultShow();
                                    routeNodePair = []
                                    return;
                                }
                                break;
                            }
                        }
                        if (repeatCheck == 0) mapRouteTT.push(oneData)
                    }
                    drawLineBetweenCircles(routeNodePair[0], routeNodePair[1], routeColorSetting, routeWidth, mapId, 'Link');
                    if (routeNodePair[0] == id) {
                        $('#' + routeNodePair[0]).css({ 'background-color': '#00ff00' });
                        $('#' + routeNodePair[1]).css('background-color', '');
                    }
                    else {
                        $('#' + routeNodePair[1]).css({ 'background-color': '#00ff00' });
                        $('#' + routeNodePair[0]).css('background-color', '');
                    }
                    routeNodePair = [id];

                    formData = new FormData();
                    formData.append('map', mapId);
                    formData.append('data', JSON.stringify(oneData));
                    fetch('/addMapRoute', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (response.ok) {
                                // HTTP狀態碼在200-299之間，表示請求成功
                                return response.text();  // 你可以用 response.json() 如果後端返回的是 JSON 格式
                            } else {
                                // HTTP狀態碼在300以上，表示請求失敗
                                throw new Error('Server response was not ok: ' + response.statusText);
                            }
                        })
                        .then(data => {
                            // 這裡的 data 是上面的 response.text() 的結果
                            if (data === 'OK') {

                            } else {
                                throw new Error('Server response was not expected: ' + data);
                            }
                        })
                        .catch(error => {
                            // 這裡處理網絡錯誤和上面拋出的錯誤
                            console.error('There was a problem with the fetch operation:', error);
                            alert(langCompared['serverErr'][langNow]);
                        });
                }
            }
            else if (editdefaultNode == 1) setDefaultNode(id)
            else if (id == 'Q21DM1') {
                window.scrollTo(0, 0);
                $('#mapMineHead').css({ 'visibility': 'visible' });
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'visible' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("M1UQ21");
                mapId = 'MH';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'M1';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'M1';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'M1UQ21') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("Q21DM1");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'W25';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'W25';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'Q62DM36') {
                window.scrollTo(0, 0);
                $('#mapMineHead').css({ 'visibility': 'visible' });
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'visible' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("M36UQ62");
                mapId = 'MH';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'M1';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'M1';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'M36UQ62') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("Q62DM36");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'W25';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'W25';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'EDMH') {
                window.scrollTo(0, 0);
                $('#mapMineHead').css({ 'visibility': 'visible' });
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'visible' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MHUE");
                mapId = 'MH';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'MHUE';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'MHUE';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'MHUE') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("EDMH");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'EDMH';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'EDMH';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'FTDMH') {
                window.scrollTo(0, 0);
                $('#mapMineHead').css({ 'visibility': 'visible' });
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'visible' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MHUFT");
                mapId = 'MH';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'MHUFT';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'MHUFT';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'MHUFT') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("FTDMH");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'FTDMH';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'FTDMH';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'MUE') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("EDM");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'W25';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'W25';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'MUC') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("CDM");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'W25';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'W25';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'MUW1') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("W1DM");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'W25';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'W25';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'MUW2') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("W2DM");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'W25';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'W25';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'MUW3') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("W3DM");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'W25';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'W25';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'MUW4') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'visible' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'hidden' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'visible' });
                $('#svgTT').css({ 'visibility': 'hidden' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("W4DM");
                mapId = 'Main';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'W25';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'W25';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'EDM') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'visible' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'visible' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUE");
                mapId = 'TT';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'MUC';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'MUC';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'CDM') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'visible' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'visible' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUC");
                mapId = 'TT';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'MUC';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'MUC';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'W1DM') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'visible' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'visible' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUW1");
                mapId = 'TT';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'MUC';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'MUC';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'W2DM') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'visible' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'visible' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUW2");
                mapId = 'TT';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'MUC';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'MUC';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'W3DM') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'visible' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'visible' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUW3");
                mapId = 'TT';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'MUC';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'MUC';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (id == 'W4DM') {
                window.scrollTo(0, 0);
                $('#mapMain').css({ 'visibility': 'hidden' });
                $('#mapMineHead').css({ 'visibility': 'hidden' });
                $('#mapTT').css({ 'visibility': 'visible' });
                $('#svgMH').css({ 'visibility': 'hidden' });
                $('#svgMain').css({ 'visibility': 'hidden' });
                $('#svgTT').css({ 'visibility': 'visible' });
                // 选择您想要滚动到的元素
                let element = '';
                element = document.getElementById("MUW4");
                mapId = 'TT';
                if (urlNow.searchParams.has('map') == false) defNodeId = 'MUC';
                else if (urlNow.searchParams.get('map') != mapId) defNodeId = 'MUC';
                else defNodeId = urlNow.searchParams.get('map')
                UpdateUrl();
                // 如果元素存在，将其滚动到视窗中心
                if (element) {
                    element.scrollIntoView({ block: 'center', inline: 'center' });
                }
            }
            else if (pathPlainningState == 1) {
                if (planningMethod == 'Node') {
                    if (pathFindingArray.includes(id)) {
                        pathFindingArray.splice(pathFindingArray.indexOf(id), 1)
                        $('#' + id).css({ 'background-color': '#000000' });
                    }
                    else {
                        pathFindingArray.push(id);
                        $('#' + id).css({ 'background-color': '#ff0000' });
                    }
                    history.replaceState({ id: 'defaultSetting' }, '', '?pathArray=' + JSON.stringify(pathFindingArray) + '&lang=' + langNow);
                }
            }
            else if (jsonImportState == 0) {
                if (nodeNow != id) {
                    if (nodeNow != '') rawData[nodeNow] = JSON.parse(JSON.stringify(oriDataSet));
                    oriDataSet = JSON.parse(JSON.stringify(rawData[id]));
                }

                let nowTime = Date.now();
                let timeDef = nowTime - rawData[id]['recordTime'];
                nodeNow = id;
                $('#infoPage').html('');
                function formatToLocalTime(timestamp) {
                    let date = new Date(timestamp);
                    return date.toLocaleString(); // 轉換為本地時間格式
                }
                let timeStr = id + ' ' + langCompared['lastUpdate'][langNow] + '：';
                if (rawData[id]['recordTime'] == 1697212800000) {
                    timeStr = id + ' ' + langCompared['noRecord'][langNow];
                }
                else {
                    timeStr += formatToLocalTime(rawData[id]['recordTime']) + ' (';
                    let defDay = Math.floor(timeDef / (1000 * 60 * 60 * 24));
                    let defHourMilli = (timeDef % (1000 * 60 * 60 * 24))
                    let defHour = Math.floor(defHourMilli / (1000 * 60 * 60));
                    let defMinute = Math.floor((timeDef % (1000 * 60 * 60)) / (1000 * 60))
                    if (defDay != 0) timeStr += defDay + ' ' + langCompared['day'][langNow] + ' ';
                    if (defHour != 0) timeStr += defHour + ' ' + langCompared['hour'][langNow] + ' ';
                    timeStr += defMinute + ' ' + langCompared['min'][langNow];

                    if ('recorder' in rawData[id]) timeStr += langCompared['by'][langNow] + ' ' + rawData[id]['recorder'] + ' ' + langCompared['record'][langNow]
                }
                let animalData = $('<div>', { id: 'animalShowDiv', class: "nodeDataAreaContent" });
                if ('animal' in rawData[id] && rawData[id]['animal'].length != 0) {
                    rawData[id]['animal'].sort((a, b) => {
                        // 首先根据 activity 值排序
                        if (a.activity > b.activity) return -1;
                        if (a.activity < b.activity) return 1;

                        // activity 相同，按 name 排序
                        return a.name.localeCompare(b.name);
                    });
                    for (animalID in rawData[id]['animal']) {
                        let borderColorClass = 'itemQty greenBorder'
                        if (rawData[id]['animal'][animalID]['activity']) borderColorClass = 'itemQty redBorder';

                        let animalFig = $('<img>', {
                            src: staticPath + "static/cre/" + rawData[id]['animal'][animalID]['name'].replace(/ /g, '-') + '.jpg',
                            class: "itemFig"
                        })

                        let stateDiv = $('<div>', {
                            class: borderColorClass,
                            // onclick: "setItem('edit','animal'," + animalID + ")"
                        })
                        let name = rawData[id]['animal'][animalID]['name'];
                        if('eliteIcon' in rawData[id]['animal'][animalID]){
                            stateDiv.attr("onclick", "setItem('edit','elite'," + animalID + ")")
                            let eliteIcon = $('<img>', {
                                src: staticPath + "static/eliteIcon/" + rawData[id]['animal'][animalID]['eliteIcon'] + '.png',
                                class: "eliteIcon"
                            })
                            stateDiv.append(eliteIcon);
                            if('note' in eliteRecord[rawData[id]['animal'][animalID]['eliteId']]) name += ' : '+ eliteRecord[rawData[id]['animal'][animalID]['eliteId']]['note']
                        }
                        else{
                            stateDiv.attr("onclick", "setItem('edit','animal'," + animalID + ")")
                            stateDiv.append(rawData[id]['animal'][animalID]['quentity']);
                        } 
                        
                        // 綁定 mouseenter 和 mouseleave 事件
                        stateDiv.mouseenter(function (e) {
                            $('.info-tag').text(name)
                                .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                        }).mouseleave(function () {
                            $('.info-tag').hide();
                        });
                        animalData.append($('<div>', {
                            class: "form-head figDiv",
                            style: "justify-content: center;width: auto; padding:0;"
                        })
                            .append(animalFig)
                            .append(stateDiv))

                    }
                }
                animalData.append($('<button>', { class: "addingBTN", onclick: "setItem('add','animal')" }).append(langCompared['add'][langNow]))
                let resourceData = $('<div>', { id: 'resourceShowDiv', class: "nodeDataAreaContent" });
                if ('resource' in rawData[id] && rawData[id]['resource'].length != 0) {
                    rawData[id]['resource'].sort((a, b) => {
                        // 首先根据 activity 值排序
                        if (a.quentity > b.quentity) return -1;
                        if (a.quentity < b.quentity) return 1;

                        // activity 相同，按 name 排序
                        return a.name.localeCompare(b.name);
                    });
                    for (resourceID in rawData[id]['resource']) {
                        let figPath = '';
                        if (huntableAnimalList.includes(rawData[id]['resource'][resourceID]['name'])) {
                            figPath = staticPath + "static/cre/" + rawData[id]['resource'][resourceID]['name'].replace(/ /g, '-') + '.jpg';

                        }
                        else {
                            figPath = staticPath + "static/res/" + rawData[id]['resource'][resourceID]['name'].replace(/ /g, '-') + '.jpg';
                        }
                        let resourceFig = $('<img>', {
                            src: figPath, class: "itemFig", onclick: "setItem('edit','resource'," + resourceID + ")"
                        })

                        let name = rawData[id]['resource'][resourceID]['name'];
                        // 綁定 mouseenter 和 mouseleave 事件
                        resourceFig.mouseenter(function (e) {
                            $('.info-tag').text(name)
                                .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                        }).mouseleave(function () {
                            $('.info-tag').hide();
                        });

                        if (rawData[id]['resource'][resourceID]['quentity'] == 1) resourceFig.attr('class', 'itemFig redBorder');
                        else if (rawData[id]['resource'][resourceID]['quentity'] == 2) resourceFig.attr('class', 'itemFig orangeBorder');
                        else if (rawData[id]['resource'][resourceID]['quentity'] == 3) resourceFig.attr('class', 'itemFig yellowBorder');
                        else if (rawData[id]['resource'][resourceID]['quentity'] == 4) resourceFig.attr('class', 'itemFig greenBorder');
                        else if (rawData[id]['resource'][resourceID]['quentity'] == 0) resourceFig.attr('class', 'itemFig blackBorder');
                        else if (rawData[id]['resource'][resourceID]['quentity'] == 9000) resourceFig.attr('class', 'itemFig blueBorder');
                        resourceData.append(resourceFig)
                    }
                }
                resourceData.append($('<button>', { class: "addingBTN", onclick: "setItem('add','resource')" }).append(langCompared['add'][langNow]))
                let itemData = $('<div>', { id: 'itemShowDiv', class: "nodeDataAreaContent" });
                if ('item' in rawData[id] && rawData[id]['item'].length != 0) {
                    for (itemID in rawData[id]['item']) {
                        if('subtotals' in rawData[id]['item'][itemID]){
                            let QCArray = []
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][9])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][10])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][11])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][6])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][7])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][8])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][3])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][4])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][5])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][0])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][1])
                            QCArray.push(rawData[id]['item'][itemID]['subtotals'][2])
                            for(itemQCGroup in QCArray){
                                if(QCArray[itemQCGroup] == 0)continue;
                                let QCColor = {};
                                QCColor['Q'] = qualityColor[Math.floor((Number(itemQCGroup))/3)]
                                QCColor['C'] = conditionColor[(Number(itemQCGroup)+1)%3]
                                let figPath = staticPath + "static/res/" + rawData[id]['item'][itemID]['name'].replace(/ /g, '-') + '.jpg';
                                let itemFig = $('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                                    .append($('<img>', { class: 'itemFig', src: figPath }))
                                    .append($('<div>', {
                                        class: "itemQty",
                                        style: "border:solid 5px " + QCColor['C']
                                    }
                                    ).append(QCArray[itemQCGroup]))
                                    .append($('<div>', {
                                        id: String(Math.floor((Number(itemQCGroup)+1)/4))+' C:'+String((Number(itemQCGroup)+1)%4),
                                        class: "itemQty",
                                        style: "align-items: flex-start; justify-content: flex-start;"})
                                        .append($('<div>', {style: "background: "+QCColor['Q']+";width: 12px;height: 12px;margin: 2px;border-radius: 50%;" + QCColor['C']}))
                                    )

                                let name = rawData[id]['item'][itemID]['name'];
                                // 綁定 mouseenter 和 mouseleave 事件
                                itemFig.mouseenter(function (e) {
                                    $('.info-tag').text(name)
                                        .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                                }).mouseleave(function () {
                                    $('.info-tag').hide();
                                });

                                itemData.append(itemFig)
                            }
                        }
                        else{
                            let figPath = staticPath + "static/res/" + rawData[id]['item'][itemID]['name'].replace(/ /g, '-') + '.jpg';
                            let itemFig = $('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                                .append($('<img>', { class: 'itemFig', src: figPath }))
                                .append($('<div>', {
                                    class: "itemQty blackBorder",
                                    onclick: "setItem('edit','item'," + itemID + ")"
                                }
                                ).append(rawData[id]['item'][itemID]['quentity']))

                            let name = rawData[id]['item'][itemID]['name'];
                            // 綁定 mouseenter 和 mouseleave 事件
                            itemFig.mouseenter(function (e) {
                                $('.info-tag').text(name)
                                    .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                            }).mouseleave(function () {
                                $('.info-tag').hide();
                            });

                            itemData.append(itemFig)
                        }
                    }
                }
                itemData.append($('<button>', { class: "addingBTN", onclick: "setItem('add','item')" }).append(langCompared['add'][langNow]))
                $('#infoPage')
                    .append($('<div>', { id: 'showTimeStr' }).html(timeStr))
                    .append($('<div>', { id: 'EthnarIdDiv' }).html('Ethnar ID')
                        .append($('<input>', { id: 'EthnarId', type: 'text', style: 'margin-left:10px;' }))
                        .append($('<div>', { id: 'spacingDiv', style: "margin-left:30px;" }))
                    )

                    .append($('<div>', { class: "nodeDataArea" })
                        .append($('<div>', { class: "nodeDataAreaTitle" }).append(langCompared['creature'][langNow]))
                        .append(animalData)
                        .append($('<div>', { class: "nodeDataAreaTitle" }).append(langCompared['resource'][langNow]))
                        .append(resourceData)
                        .append($('<div>', { class: "nodeDataAreaTitle" }).append(langCompared['item'][langNow]))
                        .append(itemData)
                        .append($('<div>', { class: "nodeDataArea" })
                            .append($('<div>', { class: "nodeDataAreaTitle" }).append(langCompared['note'][langNow]))
                            .append($('<textarea>', {
                                id: "note",
                                type: "text",
                                rows: "2",
                                autocomplete: "off"
                            }))
                        )
                        .append($('<div>', { class: "form-head", style: "justify-content: center;" })
                            .append($('<button>', { onclick: "submit()" }).append(langCompared['submit'][langNow]))
                            .append($('<button>', { onclick: "cancel()" }).append(langCompared['cancel'][langNow]))
                        )
                    )
                if ('space' in rawData[id]) $('#spacingDiv').html('Spacing : ' + rawData[id]['space'])
                let nodeDict = {};
                Object.entries(nodeMaping).forEach(([key, value]) => {
                    nodeDict[value] = key;
                });
                if (id in nodeDict) $('#EthnarId').val(nodeDict[id]);
                $('#EthnarId').change(function () {
                    if ($('#EthnarId').val() in nodeMaping) {
                        if (id == nodeMaping[$('#EthnarId').val()]) return;
                        alert(langCompared['node'][langNow] + ' ' + $('#EthnarId').val() + langCompared['idShowAt'][langNow] + nodeMaping[$('#EthnarId').val()] + langCompared['pleaseEdit'][langNow])
                        return;
                    }
                    function containsSpecialCharacters(str) {
                        const specialCharacters = /[`!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?~]/;
                        return specialCharacters.test(str);
                    }
                    if (containsSpecialCharacters($('#EthnarId').val())) {
                        alert('Special characters are not accepted.')
                        return;
                    }
                    nodeIdChangeState = 1;
                    sendingQty = 1;
                    let dataContent = [];
                    let oneData = {};
                    oneData['authNodeId'] = $('#EthnarId').val();
                    oneData['mapNodeId'] = id;
                    dataContent.push(oneData)
                    sendData('nodeId', JSON.stringify(dataContent))
                });
                if ('note' in rawData[id]) $('#note').val(rawData[id]['note'])
                $('#infoPage').show();
                // handleResize();
                // RWD();
            }
            else if (jsonImportState == 1 && waitForClickNode == 1) {
                let innerColor = 'black';
                if (recordNodeList.includes(id)) innerColor = 'green';
                if (nodeNow != id) {
                    console.log('A')
                    if ($('#' + id).hasClass('orange')) {
                        console.log('E')
                        return;
                    }
                    else {
                        console.log('B')
                        innerColor = 'orange';
                        let lastInner = 'orange';
                        transformedData[verifiedData.length]['mapId'] = id;
                        nodeMaping[transformedData[verifiedData.length]['nodeId']] = id;
                        verifiedData.push(transformedData[verifiedData.length]);
                        if (nodeNow != '') $('#' + nodeNow).attr('class', 'interactive-circle blackCircle ' + lastInner)
                        nodeNow = id
                        $('#' + id).attr('class', 'interactive-circle redCircle ' + innerColor)
                    }
                }
                else {
                    console.log(nodeNow)
                    nodeNow = ''
                    verifiedData.pop();
                    $('#' + id).attr('class', 'interactive-circle blackCircle ' + innerColor)
                }
                $('.blackCircle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                $('.redCircle').css('border', 5 / nodeScaleNow + 'px #ff0000 solid')
                if (waitForClickNode == 1) {
                    waitForClickNode = 0
                    mutiNodeDataInput();
                }
            }
        }
        function buttonClick(state) {
            settingSelValue = state;
            if (typeNow == 'animal') {
                if (state) {
                    $('#stateDiv').attr('class', 'itemQty redBorder');
                }
                else {
                    $('#stateDiv').attr('class', 'itemQty greenBorder');
                }
            }
            else if (typeNow == 'resource') {
                if (state == 1) {
                    $('#resourceFig').attr('class', 'itemFig redBorder');
                }
                else if (state == 2) {
                    $('#resourceFig').attr('class', 'itemFig orangeBorder');
                }
                else if (state == 3) {
                    $('#resourceFig').attr('class', 'itemFig yellowBorder');
                }
                else if (state == 4) {
                    $('#resourceFig').attr('class', 'itemFig greenBorder');
                }
                else if (state == 0) {
                    $('#resourceFig').attr('class', 'itemFig blackBorder');
                }
            }

        }
        function setItem(func, type = '', index = '') {
            funcNow = func
            indexNow = index
            typeNow = type
            $('.info-tag').hide();
            $('#settingPage').html('')
            if (type == 'animal') {
                $('#settingPage')
                    .append($('<div>', { id: 'animalTitleDiv', class: "nodeDataAreaTitle" })
                        .append(langCompared['creature'][langNow])
                    )
                    .append($('<div>', { id: "animalDataDiv", class: "nodeDataAreaContent", style: "flex-direction: column;" }))

                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['ok'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    $('#infoPage').show();
                    settingSelDOM = ''
                    settingInputDOM = ''
                    settingSelValue = ''
                })
                if (func == 'edit') {
                    $('#saveBTN').show();
                    $('#animalDataDiv')
                        .append($('<div>', { class: "nodeDataSet" })
                            .append($('<button>', { id: 'delBTN' }).append(langCompared['del'][langNow]))
                        )
                        .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                            .append($('<img>', { id: "animalFig", class: "itemFig", src: staticPath + "static/cre/" + rawData[nodeNow]['animal'][index]['name'].replace(/ /g, '-') + '.jpg' }))
                            .append($('<div>', { id: 'stateDiv', class: 'itemQty greenBorder' })
                                .append(rawData[nodeNow]['animal'][index]['quentity'])
                            )
                        )
                        .append($('<div>', { class: "qtyDiv", style: "flex-direction: column;" })
                            .append($('<button>', { id: 'activeAnimal', class: 'redBTN', onclick: 'buttonClick(1)' }).append(langCompared['active'][langNow]))
                            .append($('<button>', { id: 'passiveAnimal', class: 'greenBTN', onclick: 'buttonClick(0)' }).append(langCompared['passive'][langNow]))
                        )
                        .append($('<div>', { class: "qtyDiv" })
                            .append(langCompared['quentity'][langNow])
                            .append($('<input>', { id: 'quentity', type: "number" }))
                        )
                    if (isMobileDevice() == false) {
                        $('#activeAnimal').html('1 - ' + $('#activeAnimal').html());
                        $('#passiveAnimal').html('2 - ' + $('#passiveAnimal').html());
                    }
                    settingSelDOM = 'animal'
                    settingInputDOM = document.getElementById('quentity');

                    settingSelValue = rawData[nodeNow]['animal'][index]['activity'];
                    buttonClick(settingSelValue);

                    $('#quentity').val(rawData[nodeNow]['animal'][index]['quentity'])
                    $('#quentity').keyup(function () {
                        $('#stateDiv').html($('#quentity').val());
                    })
                    $('#quentity').on('focus', function (e) {
                        e.target.select();
                    });
                    $('#saveBTN').click(function () {
                        rawData[nodeNow]['animal'][index]['activity'] = settingSelValue;
                        rawData[nodeNow]['animal'][index]['quentity'] = Number($('#quentity').val());
                        nodeOnclick(nodeNow);
                        $('#settingPage').hide();
                        $('#infoPage').show();
                        settingInputDOM = ''
                        settingSelDOM = ''
                        settingSelValue = ''
                    })
                    $('#delBTN').click(function () {
                        rawData[nodeNow]['animal'].splice(index, 1)
                        nodeOnclick(nodeNow);
                        $('#settingPage').hide();
                        $('#infoPage').show();
                        settingInputDOM = ''
                        settingSelDOM = ''
                        settingSelValue = ''
                    })
                }
                else if (func == 'add') {
                    $('#saveBTN').hide();
                    $('#animalTitleDiv').hide();
                    $('#animalDataDiv').hide();
                    $('#animalDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                    $('#animalDataDiv').after(
                        $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0;font-size:20px;" })
                            .append(langCompared['filterByName'][langNow])
                            .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                    )
                    $('#animalDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append(langCompared['creatureList'][langNow]))
                    $('#searchInput').keyup(function () {
                        let newList = []
                        for (i in animalList) {
                            if (animalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase())) newList.push(animalList[i])
                        }
                        filtiedAnimal(newList);
                    })
                    filtiedAnimal(animalList);
                    function filtiedAnimal(dataList) {
                        $('#optionDataDiv').html('')
                        for (var i = 0; i < dataList.length; i++) {
                            appendAnimalImage(i);
                        }
                        function appendAnimalImage(animalIndex) {
                            let name = dataList[animalIndex];

                            let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                .append($('<img>', { class: "itemFig", src: staticPath + "static/cre/" + dataList[animalIndex].replace(/ /g, '-') + '.jpg' })
                                    .click(function () {
                                        $('#saveBTN').show();
                                        nameNow = dataList[animalIndex];
                                        $('#optionDataDiv').hide();
                                        $('#searchDiv').hide();
                                        $('#optionTitleDiv').hide();
                                        $('#animalTitleDiv').show();
                                        $('#animalDataDiv').show();
                                        $('#animalDataDiv').html('');
                                        $('#animalDataDiv')
                                            // .append($('<div>', { class: "nodeDataSet" })
                                            //     .append($('<button>', { id: 'delBTN' }).append(langCompared['del'][langNow]))
                                            // )
                                            .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                                .append($('<img>', { id: "animalFig", class: "itemFig", src: staticPath + "static/cre/" + dataList[animalIndex].replace(/ /g, '-') + '.jpg' }))
                                                .append($('<div>', { id: 'stateDiv', class: 'itemQty greenBorder' }))
                                            )
                                            .append($('<div>', { class: "qtyDiv", style: "flex-direction: column;" })
                                                .append($('<button>', { id: 'activeAnimal', class: 'redBTN', onclick: 'buttonClick(1)' }).append(langCompared['active'][langNow]))
                                                .append($('<button>', { id: 'passiveAnimal', class: 'greenBTN', onclick: 'buttonClick(0)' }).append(langCompared['passive'][langNow]))
                                            )
                                            .append($('<div>', { class: "qtyDiv" })
                                                .append(langCompared['quentity'][langNow])
                                                .append($('<input>', { id: 'quentity', type: "number" }))
                                            )
                                        if (isMobileDevice() == false) {
                                            $('#activeAnimal').html('1 - ' + $('#activeAnimal').html());
                                            $('#passiveAnimal').html('2 - ' + $('#passiveAnimal').html());
                                        }
                                        settingSelDOM = 'animal';
                                        settingSelValue = 0;
                                        settingInputDOM = document.getElementById('quentity');
                                        buttonClick(0);

                                        $('#quentity').keyup(function () {
                                            $('#stateDiv').html($('#quentity').val())
                                        })
                                        $('#saveBTN').click(function () {
                                            let oneAnimalData = {
                                                'name': dataList[animalIndex],
                                                'quentity': Number($('#quentity').val()),
                                                'activity': settingSelValue
                                            }
                                            rawData[nodeNow]['animal'].push(oneAnimalData)
                                            settingInputDOM = ''
                                            settingSelDOM = ''
                                            settingSelValue = ''
                                            nodeOnclick(nodeNow);
                                            $('#settingPage').hide();
                                            $('#infoPage').show();
                                        })
                                        $('#delBTN').click(function () {
                                            settingInputDOM = ''
                                            settingSelDOM = ''
                                            settingSelValue = ''
                                            $('#animalDataDiv').html('');
                                            $('#optionDataDiv').show();
                                            $('#searchDiv').show();
                                            $('#optionTitleDiv').show();
                                            $('#animalTitleDiv').hide();
                                            $('#animalDataDiv').hide();
                                        })
                                    })
                                );

                            // 綁定 mouseenter 和 mouseleave 事件
                            newDiv.mouseenter(function (e) {
                                $('.info-tag').text(name)
                                    .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                            }).mouseleave(function () {
                                $('.info-tag').hide();
                            });

                            $('#optionDataDiv').append(newDiv);
                        }
                    }
                }
            }
            else if (type == 'elite') {
                let eliteData = eliteRecord[rawData[nodeNow]['animal'][index]['eliteId']]
                $('#settingPage')
                    .append($('<div>', { id: 'animalTitleDiv', class: "nodeDataAreaTitle" })
                        .append('Elite Note (')
                        .append($('<span>',{id:'eliteId'}).html(rawData[nodeNow]['animal'][index]['eliteId']))
                        .append(')')
                    )
                    .append($('<textarea>', { id: "eliteNote", type: "text", autocomplete:"off",style:"height:100px;"}))

                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['submit'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                if('note' in eliteRecord[$('#eliteId').html()]) $('#eliteNote').val(eliteRecord[$('#eliteId').html()]['note'])
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    $('#infoPage').show();
                    settingSelDOM = ''
                    settingInputDOM = ''
                    settingSelValue = ''
                })
                $('#saveBTN').click(function () {
                    if('note' in eliteRecord[$('#eliteId').html()] == false || eliteRecord[$('#eliteId').html()]['note'] != $('#eliteNote').val()){
                        let eliteNoteData = {};
                        eliteNoteData['note'] = $('#eliteNote').val();
                        eliteNoteData['id'] = $('#eliteId').html();
                        if (userName == '') {
                            let name = prompt(langCompared['yourName'][langNow] + '？')
                            if (name != null && name != '') userName = name;
                            else userName = ''
                        }
                        eliteNoteData['recorder'] = userName
                        var formData = new FormData();
                        formData.append('eliteNoteData', JSON.stringify(eliteNoteData));
                        showMsg(1, langCompared['uploading'][langNow])
                        fetch('/eliteNote', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                if (response.ok) {
                                    eliteRecord[$('#eliteId').html()]['note'] = $('#eliteNote').val()
                                    showMsg(1, langCompared['success'][langNow])
                                    setTimeout(function () {
                                        showMsg(0)
                                    }, 5000)
                                } else {
                                    // HTTP狀態碼在300以上，表示請求失敗
                                    throw new Error('Server response was not ok: ' + response.statusText);
                                }
                            })
                            .catch(error => {
                                // 這裡處理網絡錯誤和上面拋出的錯誤
                                showMsg(0)
                                console.error('There was a problem with the fetch operation:', error);
                                alert(langCompared['serverErr'][langNow]);
                            });
                            $('#settingPage').hide();
                        $('#infoPage').show();
                        settingSelDOM = ''
                        settingInputDOM = ''
                        settingSelValue = ''
                        cancel()
                    }
                    else{
                        $('#settingPage').hide();
                        $('#infoPage').show();
                        settingSelDOM = ''
                        settingInputDOM = ''
                        settingSelValue = ''
                        cancel()
                    }
                });
                $('#saveBTN').show();
            }
            else if (type == 'resource') {
                $('#settingPage')
                    .append($('<div>', { id: 'resourceTitleDiv', class: "nodeDataAreaTitle" })
                        .append(langCompared['resource'][langNow])
                    )
                    .append($('<div>', { id: "resourceDataDiv", class: "nodeDataAreaContent", style: "flex-direction: column;" }))

                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['ok'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    $('#infoPage').show();
                })
                if (func == 'edit') {
                    $('#saveBTN').show();
                    let figPath = '';
                    if (huntableAnimalList.includes(rawData[nodeNow]['resource'][index]['name'])) {
                        figPath = staticPath + "static/cre/" + rawData[nodeNow]['resource'][index]['name'].replace(/ /g, '-') + '.jpg';
                    }
                    else if (rawData[nodeNow]['resource'][index]['name'].replace(/ /g, '-') in foragingUrl) {
                        if (rawData[nodeNow]['resource'][index]['name'].includes('Seed') == false) {
                            figPath = staticPath + "static/res/" + rawData[nodeNow]['resource'][index]['name'].replace(/ /g, '-') + '.jpg';
                        }
                    }
                    else {
                        figPath = staticPath + "static/res/" + rawData[nodeNow]['resource'][index]['name'].replace(/ /g, '-') + '.jpg';
                    }
                    $('#resourceDataDiv')
                        .append($('<div>', { class: "nodeDataSet" })
                            .append($('<button>', { id: 'delBTN' }).append(langCompared['del'][langNow]))
                        )
                        .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                            .append($('<img>', { id: "resourceFig", class: "itemFig", src: figPath }))
                        )
                        .append($('<div>', { class: "qtyDiv", style: "flex-direction: column;" })
                            .append($('<button>', {class: 'greenBTN', onclick: 'buttonClick(4)' }).append(langCompared['full'][langNow]))
                            .append($('<button>', {class: 'yellowBTN', onclick: 'buttonClick(3)' }).append(langCompared['substantial'][langNow]))
                            .append($('<button>', {class: 'orangeBTN', onclick: 'buttonClick(2)' }).append(langCompared['partial'][langNow]))
                            .append($('<button>', {class: 'redBTN', onclick: 'buttonClick(1)' }).append(langCompared['empty'][langNow]))
                            .append($('<button>', {class: 'blackBTN', onclick: 'buttonClick(0)' }).append(langCompared['none'][langNow]))
                            .append($('<button>', {class: 'blueBTN', onclick: 'buttonClick(9000)' }).append(langCompared['unlimited'][langNow]))
                        )
                    // .append($('<div>', { class: "qtyDiv", style: "font-size:20px" })
                    //     .append(langCompared['state'][langNow]+'(1'+langCompared['empty'][langNow]+'~4'+langCompared['full'][langNow]+')')
                    //     .append($('<select>', { id: 'stateSel', class: "qtyDiv", style: "font-size:20px" })
                    //         .append($('<option>', { class: 'green', value: 4 }).append(langCompared['full'][langNow]))
                    //         .append($('<option>', { class: 'yellow', value: 3 }).append(langCompared['substantial'][langNow]))
                    //         .append($('<option>', { class: 'orange', value: 2 }).append(langCompared['partial'][langNow]))
                    //         .append($('<option>', { class: 'red', value: 1 }).append(langCompared['empty'][langNow]))
                    //     )
                    // )

                    settingSelDOM = 'resource'
                    settingSelValue = rawData[nodeNow]['resource'][index]['quentity'];
                    buttonClick(settingSelValue);

                    if (rawData[nodeNow]['resource'][index]['quentity'] == 1) $('#resourceFig').attr('class', 'itemFig redBorder');
                    else if (rawData[nodeNow]['resource'][index]['quentity'] == 2) $('#resourceFig').attr('class', 'itemFig orangeBorder');
                    else if (rawData[nodeNow]['resource'][index]['quentity'] == 3) $('#resourceFig').attr('class', 'itemFig yellowBorder');
                    else if (rawData[nodeNow]['resource'][index]['quentity'] == 4) $('#resourceFig').attr('class', 'itemFig greenBorder');
                    $('#stateSel').change(function (event) {
                        if ($('#stateSel').val() == 1) $('#resourceFig').attr('class', 'itemFig redBorder');
                        else if ($('#stateSel').val() == 2) $('#resourceFig').attr('class', 'itemFig orangeBorder');
                        else if ($('#stateSel').val() == 3) $('#resourceFig').attr('class', 'itemFig yellowBorder');
                        else if ($('#stateSel').val() == 4) $('#resourceFig').attr('class', 'itemFig greenBorder');
                    })
                    $('#saveBTN').click(function () {
                        rawData[nodeNow]['resource'][index]['quentity'] = settingSelValue;
                        nodeOnclick(nodeNow);
                        $('#settingPage').hide();
                        $('#infoPage').show();
                        settingInputDOM = ''
                        settingSelDOM = ''
                    })
                    $('#delBTN').click(function () {
                        rawData[nodeNow]['resource'].splice(index, 1)
                        nodeOnclick(nodeNow);
                        $('#settingPage').hide();
                        $('#infoPage').show();
                        settingInputDOM = ''
                        settingSelDOM = ''
                    })
                }
                else if (func == 'add') {
                    $('#saveBTN').hide();
                    $('#resourceTitleDiv').hide();
                    $('#resourceDataDiv').hide();
                    $('#resourceDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                    $('#resourceDataDiv').after(
                        $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0;font-size:20px;" })
                            .append(langCompared['filterByName'][langNow])
                            .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                    )
                    $('#resourceDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append(langCompared['resourceList'][langNow]))
                    $('#searchInput').keyup(function () {
                        let allResource = []
                        for (i in huntableAnimalList) {
                            if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                let oneDict = {}
                                oneDict['name'] = huntableAnimalList[i]
                                oneDict['url'] = staticPath + "static/cre/" + huntableAnimalList[i].replace(/ /g, '-') + '.jpg'
                                allResource.push(oneDict)
                            }
                        }
                        for (i of foragingUrl) {
                            if (i.includes('Seed') == false) {
                                if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                                    allResource.push(oneDict)
                                }
                            }

                        }
                        for (i of gatheringUrl) {
                            if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                let oneDict = {}
                                oneDict['name'] = i
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                                allResource.push(oneDict)
                            }
                        }
                        for (i of miningUrl) {
                            if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                let oneDict = {}
                                oneDict['name'] = i
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                                allResource.push(oneDict)
                            }
                        }
                        for (i of woodCuttingUrl) {
                            if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                let oneDict = {}
                                oneDict['name'] = i
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                                allResource.push(oneDict)
                            }
                        }
                        filtiedResource(allResource);
                    })
                    let allResource = []
                    for (i in huntableAnimalList) {
                        if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = huntableAnimalList[i]
                            oneDict['url'] = staticPath + "static/cre/" + huntableAnimalList[i].replace(/ /g, '-') + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of foragingUrl) {
                        if (i.includes('Seed') == false) {
                            if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                let oneDict = {}
                                oneDict['name'] = i
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                                allResource.push(oneDict)
                            }
                        }
                    }
                    for (i of gatheringUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of miningUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of woodCuttingUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    filtiedResource(allResource);
                    function filtiedResource(dataList) {
                        $('#optionDataDiv').html('');
                        for (var i = 0; i < dataList.length; i++) {
                            appendResourceImage(i);
                        }
                        function appendResourceImage(resourceIndex) {
                            let figPath = dataList[resourceIndex]['url'];
                            let name = dataList[resourceIndex]['name'];

                            let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                .append($('<img>', { class: "itemFig", src: figPath })
                                    .click(function () {
                                        let repeatResourceIndex = '';
                                        for (lastDBResourceIndex in rawData[nodeNow]['resource']) {
                                            if (rawData[nodeNow]['resource'][lastDBResourceIndex]['name'] == dataList[resourceIndex]['name']) {
                                                repeatResourceIndex = lastDBResourceIndex;
                                            }
                                        }
                                        if (repeatResourceIndex == '') {
                                            $('#saveBTN').show();
                                            nameNow = dataList[resourceIndex]['name']
                                            $('#optionDataDiv').hide();
                                            $('#searchDiv').hide();
                                            $('#optionTitleDiv').hide();
                                            $('#resourceTitleDiv').show();
                                            $('#resourceDataDiv').show();
                                            $('#resourceDataDiv').html('');
                                            $('#resourceDataDiv')
                                                // .append($('<div>', { class: "nodeDataSet" })
                                                //     .append($('<button>', { id: 'delBTN' }).append(langCompared['del'][langNow]))
                                                // )
                                                .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                                    .append($('<img>', { id: "resourceFig", class: "itemFig redBorder", src: figPath }))
                                                )
                                                .append($('<div>', { class: "qtyDiv", style: "flex-direction: column;" })
                                                    .append($('<button>', { id: 'greenResource', class: 'greenBTN', onclick: 'buttonClick(4)' }).append(langCompared['full'][langNow]))
                                                    .append($('<button>', { id: 'yellowResource', class: 'yellowBTN', onclick: 'buttonClick(3)' }).append(langCompared['substantial'][langNow]))
                                                    .append($('<button>', { id: 'orangeResource', class: 'orangeBTN', onclick: 'buttonClick(2)' }).append(langCompared['partial'][langNow]))
                                                    .append($('<button>', { id: 'redResource', class: 'redBTN', onclick: 'buttonClick(1)' }).append(langCompared['empty'][langNow]))
                                                    .append($('<button>', { id: 'blueResource', class: 'blueBTN', onclick: 'buttonClick(9000)' }).append(langCompared['unlimited'][langNow]))
                                                )
                                            settingSelDOM = 'resource'
                                            settingSelValue = 1;
                                            buttonClick(1);
                                            $('#saveBTN').click(function () {
                                                let oneResourceData = {
                                                    'name': dataList[resourceIndex]['name'],
                                                    'quentity': settingSelValue,
                                                }
                                                rawData[nodeNow]['resource'].push(oneResourceData)
                                                nodeOnclick(nodeNow);
                                                $('#settingPage').hide();
                                                $('#infoPage').show();
                                            })
                                            $('#delBTN').click(function () {
                                                $('#resourceDataDiv').html('');
                                                $('#optionDataDiv').show();
                                                $('#searchDiv').show();
                                                $('#optionTitleDiv').show();
                                                $('#resourceTitleDiv').hide();
                                                $('#resourceDataDiv').hide();
                                            })
                                        }
                                        else setItem('edit', 'resource', repeatResourceIndex)
                                    })
                                );

                            // 綁定 mouseenter 和 mouseleave 事件
                            newDiv.mouseenter(function (e) {
                                $('.info-tag').text(name)
                                    .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                            }).mouseleave(function () {
                                $('.info-tag').hide();
                            });

                            $('#optionDataDiv').append(newDiv);
                        }
                    }
                }
            }
            else if (type == 'item') {
                $('#settingPage')
                    .append($('<div>', { id: 'itemTitleDiv', class: "nodeDataAreaTitle" })
                        .append(langCompared['item'][langNow])
                    )
                    .append($('<div>', { id: "itemDataDiv", class: "nodeDataAreaContent" }))

                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['ok'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    $('#infoPage').show();
                })
                if (func == 'edit') {
                    $('#saveBTN').show();
                    let figPath = staticPath + "static/res/" + rawData[nodeNow]['item'][index]['name'].replace(/ /g, '-') + '.jpg';
                    $('#itemDataDiv')
                        .append($('<div>', { class: "nodeDataSet" })
                            .append($('<button>', { id: 'delBTN' }).append(langCompared['del'][langNow]))
                        )
                        .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                            .append($('<img>', { id: "itemFig", class: "itemFig", src: figPath }))
                            .append($('<div>', { id: 'stateDiv', class: 'itemQty' })
                                .append(rawData[nodeNow]['item'][index]['quentity'])
                            )
                        )
                        .append($('<div>', { class: "qtyDiv" })
                            .append(langCompared['quentity'][langNow])
                            .append($('<input>', { id: 'quentity', type: "number" }))
                        )
                    $('#quentity').val(rawData[nodeNow]['item'][index]['quentity'])

                    $('#quentity').keyup(function () {
                        $('#stateDiv').html($('#quentity').val())
                    })
                    $('#quentity').on('focus', function (e) {
                        e.target.select();
                    });
                    $('#saveBTN').click(function () {
                        rawData[nodeNow]['item'][index]['quentity'] = Number($('#quentity').val());
                        nodeOnclick(nodeNow);
                        $('#settingPage').hide();
                        $('#infoPage').show();
                        settingInputDOM = ''
                        settingSelDOM = ''
                    })
                    $('#delBTN').click(function () {
                        rawData[nodeNow]['item'].splice(index, 1)
                        nodeOnclick(nodeNow);
                        $('#settingPage').hide();
                        $('#infoPage').show();
                        settingInputDOM = ''
                        settingSelDOM = ''
                    })
                }
                else if (func == 'add') {
                    $('#saveBTN').hide();
                    let itemSel = ''
                    $('#itemTitleDiv').hide();
                    $('#itemDataDiv').hide();
                    $('#itemDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                    $('#itemDataDiv').after(
                        $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0" })
                            .append($('<div>', { id: 'searchMethodDiv', style: "font-size:20px" }).append(langCompared['filterByCategory'][langNow]))
                            .append($('<select>', { id: 'typeSel', class: "qtyDiv", style: " padding:0px; height:30px" }))
                            .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                            .append($('<button>', { id: 'backBTN', style: 'width: auto;' }).append(langCompared['switchTo'][langNow] + langCompared['filterByName'][langNow]).click(function () {
                                if (searchMethodState == 'type') {
                                    $('#optionDataDiv').html('');
                                    searchMethodState = 'name';
                                    $('#backBTN').html(langCompared['switchTo'][langNow] + langCompared['filterByCategory'][langNow])
                                    $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                                    $('#typeSel').hide()
                                    $('#searchInput').show()
                                }
                                else {
                                    $('#searchInput').val('');
                                    let allItem = [];
                                    for (i of cookedUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'cooked'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of corpseUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'corpse'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of furnitureUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'furniture'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of doctoringUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'doctoring'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of equipmentUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'equipment'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of foragingUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'foraging'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of gatheringUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'gathering'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of medicalUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'medical'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of miningUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'mining'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of otherUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'other'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of toolUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'tool'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of carpentryUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'carpentry'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of woodCuttingUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'woodcutting'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of smithingUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'smithing'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    filtiedResource(allItem);
                                    searchMethodState = 'type';
                                    $('#backBTN').html(langCompared['switchTo'][langNow] + langCompared['filterByName'][langNow])
                                    $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                                    $('#typeSel').show()
                                    $('#searchInput').hide()
                                }

                            }))
                    )
                    if (searchMethodState == 'name') {
                        $('#backBTN').html(langCompared['switchTo'][langNow] + langCompared['filterByCategory'][langNow])
                        $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                        $('#typeSel').hide()
                        $('#searchInput').show()
                    }
                    else {
                        $('#backBTN').html(langCompared['switchTo'][langNow] + langCompared['filterByName'][langNow])
                        $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                        $('#typeSel').show()
                        $('#searchInput').hide()
                    }
                    $('#itemDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle", style: "font-size:20px" }).append(langCompared['itemList'][langNow]))
                    for (i in itemTypeTranslate) {
                        if (langNow == 'zh') $('<option>', { value: i }).append(itemTypeTranslate[i]).appendTo($('#typeSel'))
                        else if (langNow == 'en') $('<option>', { value: i }).append(i).appendTo($('#typeSel'))
                    }
                    function appendItemImage(itemIndex, dataList) {
                        let figPath = dataList[itemIndex]['url'];
                        let name = dataList[itemIndex]['name'];

                        let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                            .append($('<img>', { class: "itemFig", src: figPath })
                                .click(function () {
                                    let repeatItemIndex = '';
                                    for (lastDBItemIndex in rawData[nodeNow]['item']) {
                                        if (rawData[nodeNow]['item'][lastDBItemIndex]['name'] == dataList[itemIndex]['name']) {
                                            repeatItemIndex = lastDBItemIndex;
                                        }
                                    }
                                    if (repeatItemIndex == '') {
                                        $('#saveBTN').show();
                                        nameNow = dataList[itemIndex]['name']
                                        $('#optionDataDiv').hide();
                                        $('#searchDiv').hide();
                                        $('#optionTitleDiv').hide();
                                        $('#itemTitleDiv').show();
                                        $('#itemDataDiv').show();
                                        $('#itemDataDiv').html('');
                                        $('#itemDataDiv')
                                            // .append($('<div>', { class: "nodeDataSet" })
                                            //     .append($('<button>', { id: 'delBTN' }).append(langCompared['del'][langNow]))
                                            // )
                                            .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                                .append($('<img>', { id: "itemFig", class: "itemFig", src: figPath }))
                                                .append($('<div>', { id: 'stateDiv', class: 'itemQty' }))
                                            )
                                            .append($('<div>', { class: "qtyDiv" })
                                                .append('數量')
                                                .append($('<input>', { id: 'quentity', type: "number" }))
                                            )

                                        $('#quentity').keyup(function () {
                                            $('#stateDiv').html($('#quentity').val())
                                        })
                                        $('#saveBTN').click(function () {
                                            let oneItemData = {
                                                'name': dataList[itemIndex]['name'],
                                                'quentity': Number($('#quentity').val())
                                            }
                                            rawData[nodeNow]['item'].push(oneItemData)
                                            nodeOnclick(nodeNow);
                                            $('#settingPage').hide();
                                            $('#infoPage').show();
                                            settingInputDOM = ''
                                            settingSelDOM = ''
                                        })
                                        $('#delBTN').click(function () {
                                            $('#itemDataDiv').html('');
                                            $('#optionDataDiv').show();
                                            $('#searchDiv').show();
                                            $('#optionTitleDiv').show();
                                            $('#itemTitleDiv').hide();
                                            $('#itemDataDiv').hide();
                                            settingInputDOM = ''
                                            settingSelDOM = ''
                                        })
                                        $("#quentity").focus();
                                    }
                                    else setItem('edit', 'item', repeatItemIndex)
                                })
                            );

                        // 綁定 mouseenter 和 mouseleave 事件
                        newDiv.mouseenter(function (e) {
                            $('.info-tag').text(name)
                                .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                        }).mouseleave(function () {
                            $('.info-tag').hide();
                        });

                        $('#optionDataDiv').append(newDiv);
                    }
                    function filtiedResource(dataList) {
                        $('#optionDataDiv').html('')
                        for (var i = 0; i < dataList.length; i++) {
                            if (dataList[i]['type'] == $('#typeSel').val()) appendItemImage(i, dataList);
                        }

                    }
                    let allItem = [];
                    for (i of cookedUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'cooked'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of corpseUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'corpse'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of furnitureUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'furniture'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of doctoringUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'doctoring'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of equipmentUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'equipment'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of foragingUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'foraging'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of gatheringUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'gathering'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of medicalUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'medical'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of miningUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'mining'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of otherUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'other'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of toolUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'tool'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of carpentryUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'carpentry'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of woodCuttingUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'woodcutting'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                    for (i of smithingUrl) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'smithing'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }

                    $('#typeSel').change(function (event) {
                        filtiedResource(allItem);
                    })
                    filtiedResource(allItem);
                    $('#searchInput').keyup(() => {
                        if ($('#searchInput').val().length >= 1) {
                            $('#optionDataDiv').html('')

                            let allItem = [];
                            for (i of cookedUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'cooked'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of corpseUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'corpse'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of furnitureUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'furniture'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of doctoringUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'doctoring'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of equipmentUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'equipment'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of foragingUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'foraging'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of gatheringUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'gathering'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of medicalUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'medical'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of miningUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'ore'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of otherUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'other'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of toolUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'tool'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                            for (i of woodCuttingUrl) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'wood'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }

                            let newList = []
                            for (i in allItem) {
                                if (allItem[i]['name'].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                    let oneDict = {}
                                    oneDict['name'] = allItem[i]['name']
                                    oneDict['url'] = allItem[i]['url']
                                    newList.push(oneDict)
                                }
                            }
                            for (i in newList) {
                                appendItemImage(i, newList);
                            }
                        }
                        else $('#optionDataDiv').html('');
                    })
                }
                setTimeout(function () {
                    $("#quentity").focus();
                }, 0);
            }

            $('#infoPage').hide();
            $('#settingPage').show();
            // if(type == 'item'){
            //     $("#quentity").focus();
            // }
        }

        function submit() {
            showMsg(1, langCompared['uploading'][langNow])
            fetch('/checkVer')
                .then(response => response.text())
                .then(serverVersion => {
                    // 比較伺服器版本和當前版本
                    if (serverVersion !== version) {
                        // 如果版本不一致，提示用戶
                        let update = confirm(langCompared['checkUpdate'][langNow]);
                        if (update) {
                            // 如果用戶選擇更新，則重新整理網頁
                            window.location.reload();
                        }
                        else showMsg(0)
                    }
                    else {
                        var formData = new FormData();
                        if (userName == '') {
                            let name = prompt(langCompared['yourName'][langNow] + '？')
                            if (name != null && name != '') userName = name;
                            else {
                                userName = ''
                                delete rawData[nodeNow]['recorder']
                            }
                        }
                        if (userName != '') {
                            rawData[nodeNow]['recorder'] = userName;
                            formData.append('userName', userName);
                        }
                        if ($('#note').val() != '' || ($('#note').val() == '' && rawData[nodeNow]['note'] != '')) rawData[nodeNow]['note'] = $('#note').val()
                        formData.append('data', JSON.stringify(rawData[nodeNow]));

                        $('#infoPage').hide();
                        $('#infoPage').html('');
                        fetch('/dataSubmition', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                if (response.ok) {
                                    // HTTP狀態碼在200-299之間，表示請求成功
                                    return response.text();  // 你可以用 response.json() 如果後端返回的是 JSON 格式
                                } else {
                                    // HTTP狀態碼在300以上，表示請求失敗
                                    throw new Error('Server response was not ok: ' + response.statusText);
                                }
                            })
                            .then(data => {
                                // 這裡的 data 是上面的 response.text() 的結果
                                if (data.length == 13) {
                                    showMsg(1, langCompared['success'][langNow])
                                    setTimeout(function () {
                                        showMsg(0)
                                    }, 5000)
                                    rawData[nodeNow]['recordTime'] = Number(data)
                                    for (i in searchSlot) {
                                        if (searchSlot[i]['type'] == 'time') {
                                            if (searchSlot[i]['display'] == langCompared['fill'][langNow]) recordTimeShow('inner')
                                            else recordTimeShow('outter')
                                        }
                                    }
                                    nodeNow = ''
                                } else {
                                    throw new Error('Server response was not expected: ' + data);
                                }
                            })
                            .catch(error => {
                                showMsg(0)
                                // 這裡處理網絡錯誤和上面拋出的錯誤
                                console.error('There was a problem with the fetch operation:', error);
                                alert(langCompared['serverErr'][langNow]);
                            });
                    }
                })
                .catch(error => {
                    showMsg(0)
                    console.error('server error:', error);
                });

        }
        function cancel() {
            rawData[nodeNow] = oriDataSet;
            $('#infoPage').hide();
            $('#infoPage').html('');
            nodeNow = ''
        }
        function search(func, slot = '') {
            if (func == 'start') {
                searchedName = '';
                if (slot == '') {
                    if (document.getElementById("slot0")) slot = '1';
                    else slot = '0';
                    searchSlot[slot] = {}
                    searchSlot[slot]['slot'] = slot
                }
                else $('#slot' + slot).remove();
                if (Object.keys(searchSlot).length == 2) $('#btnDiv').hide();
                $('#searchNodeDiv').prepend($('<div>', { id: 'slot' + slot, class: 'searchSettingPage' }))
                let fontSize = '20';
                if (langNow == 'en') fontSize = '15';
                $('#slot' + slot)
                    .append($('<button>', { onclick: "search('animal'," + slot + ");" }).append(langCompared['creature'][langNow]))
                    .append($('<button>', { onclick: "search('resource'," + slot + ");" }).append(langCompared['resource'][langNow]))
                    .append($('<button>', { onclick: "search('item'," + slot + ");" }).append(langCompared['item'][langNow]))
                    .append($('<button>', { onclick: "search('time'," + slot + ");" }).append(langCompared['renewTime'][langNow]))
                    .append($('<button>', { onclick: "search('cancel'," + slot + ");" }).append(langCompared['cancel'][langNow]))
            }
            else if (func == 'cancel') {
                if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) {
                    $('.greenCircle').removeClass('greenCircle');
                    $('.orangeCircle').removeClass('orangeCircle');
                    $('.yellowCircle').removeClass('yellowCircle');
                    $('.redCircle').removeClass('redCircle');
                }
                else if ($('#circleSearchDisplay' + slot).val() == langCompared['fill'][langNow]) {
                    $('.interactive-circle').addClass('black');
                    $('.green').removeClass('green');
                    $('.orange').removeClass('orange');
                    $('.yellow').removeClass('yellow');
                    $('.red').removeClass('red');
                }
                $('#slot' + slot).remove();
                $('#btnDiv').show();
                delete searchSlot[slot]
                if(Object.keys(searchSlot).length == 0)$('#houseDiv').css({border:'solid #000000 5px'})
                searchResultShow()
            }
            else if (func == 'animal') {
                let settingDiv = $('#slot' + slot);
                if (isMobileDevice()) {
                    settingDiv = $('#settingPageMobile');
                    settingDiv.show();
                }
                else settingDiv = $('#slot' + slot);
                searchSlot[slot]['type'] = 'animal'
                $('#slot' + slot).html('');
                settingDiv.html('');
                settingDiv.append($('<div>', { id: "optionTitleDiv" + slot, class: "nodeDataAreaTitle" }).append(langCompared['creatureList'][langNow]));
                settingDiv.append($('<div>', { id: "searchNodeDiv" + slot, class: "nodeDataAreaContent" })
                    .append(langCompared['filterByName'][langNow])
                    .append($('<input>', { id: 'searchInput' + slot, type: "text", class: "text" }))
                );
                settingDiv.append($('<div>', { id: "optionDataDiv" + slot, class: "nodeDataAreaContent" }));
                $('#searchInput' + slot).keyup(function () {
                    let newList = []
                    for (i in animalList) {
                        if (animalList[i].toLowerCase().includes($('#searchInput' + slot).val().toLowerCase())) newList.push(animalList[i])
                    }
                    filtiedAnimal(newList);
                })
                filtiedAnimal(animalList);
                function filtiedAnimal(dataList) {
                    $('#optionDataDiv' + slot).html('')
                    for (var i = 0; i < dataList.length; i++) {
                        appendAnimalImage(i);
                    }
                    function appendAnimalImage(animalIndex) {
                        $('#optionDataDiv' + slot)
                            .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                .append($('<img>', { class: "itemFig", src: staticPath + "static/cre/" + dataList[animalIndex].replace(/ /g, '-') + '.jpg' })
                                    .click(function () {
                                        searchedName = dataList[animalIndex];
                                        searchSlot[slot]['name'] = searchedName;
                                        if (isMobileDevice()) settingDiv.hide();
                                        settingDiv.html('');
                                        $('#slot' + slot)
                                            .append($('<img>', { class: "itemFig", src: staticPath + "static/cre/" + dataList[animalIndex].replace(/ /g, '-') + '.jpg', onclick: "search('cancel','" + slot + "');" }))
                                            .append($('<select>', { id: 'circleSearchMethod' + slot, onchange: 'searchResultShow();' })
                                                .append($('<option>').html(langCompared['newest'][langNow]))
                                                .append($('<option>').html(langCompared['ever'][langNow]))
                                            )
                                            .append($('<select>', { id: 'circleSearchDisplay' + slot, onchange: 'siteChange("' + slot + '");searchResultShow();' })
                                                .append($('<option>').html(langCompared['fill'][langNow]))
                                                .append($('<option>').html(langCompared['border'][langNow]))
                                            )
                                        if (Object.keys(searchSlot).length == 2) {
                                            if (slot == '0') {
                                                if ($('#circleSearchDisplay1').val() == langCompared['fill'][langNow]) {
                                                    $('#circleSearchDisplay0').val(langCompared['border'][langNow])
                                                }
                                            }
                                            else {
                                                if ($('#circleSearchDisplay0').val() == langCompared['fill'][langNow]) {
                                                    $('#circleSearchDisplay1').val(langCompared['border'][langNow])
                                                }
                                            }
                                        }

                                        searchResultShow();
                                    })
                                )
                            );
                    }
                }
            }
            else if (func == 'resource') {
                let settingDiv = $('#slot' + slot);
                if (isMobileDevice()) {
                    settingDiv = $('#settingPageMobile');
                    settingDiv.show();
                }
                else settingDiv = $('#slot' + slot);
                searchSlot[slot]['type'] = 'resource'
                settingDiv.html('');
                settingDiv
                    .append($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append(langCompared['resourceList'][langNow]))
                    .append($('<div>', { id: "searchDiv", class: "nodeDataAreaContent" })
                        .append(langCompared['filterByName'][langNow])
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                    )
                    .append($('<div>', { id: "optionDataDiv" + slot, class: "nodeDataAreaContent" }))
                $('#searchInput').keyup(function () {
                    let allResource = []
                    for (i in huntableAnimalList) {
                        if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = huntableAnimalList[i]
                            oneDict['url'] = staticPath + "static/cre/" + huntableAnimalList[i].replace(/ /g, '-') + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of foragingUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of gatheringUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of miningUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of woodCuttingUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    filtiedResource(allResource);
                })
                let allResource = []
                for (i in huntableAnimalList) {
                    if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                        let oneDict = {}
                        oneDict['name'] = huntableAnimalList[i]
                        oneDict['url'] = staticPath + "static/cre/" + huntableAnimalList[i].replace(/ /g, '-') + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                for (i of foragingUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                        let oneDict = {}
                        oneDict['name'] = i
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                for (i of gatheringUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                        let oneDict = {}
                        oneDict['name'] = i
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                for (i of miningUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                        let oneDict = {}
                        oneDict['name'] = i
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                for (i of woodCuttingUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                        let oneDict = {}
                        oneDict['name'] = i
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                filtiedResource(allResource);
                function filtiedResource(dataList) {
                    $('#optionDataDiv' + slot).html('');
                    for (var i = 0; i < dataList.length; i++) {
                        appendResourceImage(i);
                    }
                    function appendResourceImage(resourceIndex) {
                        let figPath = dataList[resourceIndex]['url'];

                        $('#optionDataDiv' + slot)
                            .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                                .append($('<img>', { class: "itemFig", src: figPath })
                                    .click(function () {
                                        searchedName = dataList[resourceIndex];
                                        searchSlot[slot]['name'] = searchedName['name'].replace(/-/g, ' ');
                                        if (isMobileDevice()) settingDiv.hide();
                                        $('#slot' + slot).html('');
                                        $('#slot' + slot)
                                            .append($('<img>', { class: "itemFig", src: figPath, onclick: "search('cancel','" + slot + "');" }))
                                            .append($('<select>', { id: 'circleSearchMethod' + slot, onchange: 'searchResultShow();' })
                                                .append($('<option>').html(langCompared['newest'][langNow]))
                                                .append($('<option>').html(langCompared['highest'][langNow]))
                                                .append($('<option>').html(langCompared['lowest'][langNow]))
                                            )
                                            .append($('<select>', { id: 'circleSearchDisplay' + slot, onchange: 'siteChange("' + slot + '");searchResultShow();' })
                                                .append($('<option>').html(langCompared['fill'][langNow]))
                                                .append($('<option>').html(langCompared['border'][langNow]))
                                            )
                                        if (Object.keys(searchSlot).length == 2) {
                                            if (slot == '0') {
                                                if ($('#circleSearchDisplay1').val() == langCompared['fill'][langNow]) {
                                                    $('#circleSearchDisplay0').val(langCompared['border'][langNow])
                                                }
                                            }
                                            else {
                                                if ($('#circleSearchDisplay0').val() == langCompared['fill'][langNow]) {
                                                    $('#circleSearchDisplay1').val(langCompared['border'][langNow])
                                                }
                                            }
                                        }
                                        searchResultShow();

                                    })
                                )
                            );
                    }
                }
            }
            else if (func == 'item') {
                let settingDiv = $('#slot' + slot);
                if (isMobileDevice()) {
                    settingDiv = $('#settingPageMobile');
                    settingDiv.show();
                }
                else settingDiv = $('#slot' + slot);
                searchSlot[slot]['type'] = 'item'
                settingDiv.html('');
                settingDiv
                    .append($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append(langCompared["itemList"][langNow]))
                    .append($('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0" })
                        .append($('<div>', { id: 'searchMethodDiv' }).append(langCompared['filterByCategory'][langNow]))
                        .append($('<select>', { id: 'typeSel', class: "qtyDiv", style: "font-size:20px; padding:0px; height:30px" }))
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                        .append($('<button>', { id: 'backBTN', style: 'width: auto;' })
                            .append(langCompared["filterByName"][langNow]).click(function () {
                                if (searchMethodState == 'type') {
                                    $('#optionDataDiv').html('');
                                    searchMethodState = 'name';
                                    $('#backBTN').html(langCompared["filterByCategory"][langNow])
                                    $('#searchMethodDiv').html(langCompared["filterByName"][langNow])
                                    $('#typeSel').hide()
                                    $('#searchInput').show()
                                }
                                else {
                                    $('#searchInput').val('');
                                    let allItem = [];
                                    for (i of cookedUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'cooked'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of corpseUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'corpse'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of furnitureUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'furniture'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of doctoringUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'doctoring'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of equipmentUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'equipment'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of foragingUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'foraging'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of gatheringUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'gathering'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of medicalUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'medical'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of miningUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'mining'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of otherUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'other'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of toolUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'tool'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of carpentryUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'carpentry'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of woodCuttingUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'woodcutting'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    for (i of smithingUrl) {
                                        let oneDict = {}
                                        oneDict['name'] = i
                                        oneDict['type'] = 'smithing'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                    filtiedResource(allItem);
                                    searchMethodState = 'type';
                                    $('#backBTN').html(langCompared["filterByName"][langNow])
                                    $('#searchMethodDiv').html(langCompared["filterByCategory"][langNow])
                                    $('#typeSel').show()
                                    $('#searchInput').hide()
                                }

                            })
                        )

                    )
                    .append($('<div>', { id: "optionDataDiv" + slot, class: "nodeDataAreaContent" }))

                let itemSel = ''
                $('#itemTitleDiv').hide();
                $('#itemDataDiv').hide();
                $('#itemDataDiv').after($('<div>', { id: "optionDataDiv" + slot, class: "nodeDataAreaContent" }))
                $('#itemDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0" })
                        .append($('<div>', { id: 'searchMethodDiv' }).append(langCompared['filterByCategory'][langNow]))
                        .append($('<select>', { id: 'typeSel', class: "qtyDiv", style: "font-size:20px; padding:0px; height:30px" }))
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                        .append($('<button>', { id: 'backBTN', style: 'width: 180px;' }).append(langCompared["filterByName"][langNow]).click(function () {
                            if (searchMethodState == 'type') {
                                $('#optionDataDiv' + slot).html('');
                                searchMethodState = 'name';
                                $('#backBTN').html(langCompared["filterByCategory"][langNow])
                                $('#searchMethodDiv').html(langCompared["filterByName"][langNow])
                                $('#typeSel').hide()
                                $('#searchInput').show()
                            }
                            else {
                                $('#searchInput').val('');
                                let allItem = [];
                                for (i of cookedUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'cooked'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of corpseUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'corpse'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of furnitureUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'furniture'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of doctoringUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'doctoring'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of equipmentUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'equipment'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of foragingUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'foraging'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of gatheringUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'gathering'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of medicalUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'medical'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of miningUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'mining'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of otherUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'other'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of toolUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'tool'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of carpentryUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'carpentry'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of woodCuttingUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'woodcutting'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                for (i of smithingUrl) {
                                    let oneDict = {}
                                    oneDict['name'] = i
                                    oneDict['type'] = 'smithing'
                                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                    allItem.push(oneDict)
                                }
                                filtiedResource(allItem);
                                searchMethodState = 'type';
                                $('#backBTN').html(langCompared["filterByName"][langNow])
                                $('#searchMethodDiv').html(langCompared["filterByCategory"][langNow])
                                $('#typeSel').show()
                                $('#searchInput').hide()
                            }

                        }))
                )
                if (searchMethodState == 'name') {
                    $('#backBTN').html(langCompared["filterByCategory"][langNow])
                    $('#searchMethodDiv').html(langCompared["filterByName"][langNow])
                    $('#typeSel').hide()
                    $('#searchInput').show()
                }
                else {
                    $('#backBTN').html(langCompared["filterByName"][langNow])
                    $('#searchMethodDiv').html(langCompared["filterByCategory"][langNow])
                    $('#typeSel').show()
                    $('#searchInput').hide()
                }
                $('#itemDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle", style: "font-size:20px" }).append(langCompared['itemList'][langNow]))
                for (i in itemTypeTranslate) {
                    if (langNow == 'zh') $('<option>', { value: i }).append(itemTypeTranslate[i]).appendTo($('#typeSel'))
                    else if (langNow == 'en') $('<option>', { value: i }).append(i).appendTo($('#typeSel'))
                }
                function appendItemImage(itemIndex, dataList) {
                    let figPath = dataList[itemIndex]['url']
                    $('#optionDataDiv' + slot)
                        .append($('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                            .append($('<img>', { class: "itemFig", src: figPath })
                                .click(function () {
                                    searchedName = dataList[itemIndex];
                                    searchSlot[slot]['name'] = searchedName['name'].replace(/-/g, ' ');
                                    if (isMobileDevice()) settingDiv.hide();
                                    $('#slot' + slot).html('');
                                    $('#slot' + slot)
                                        .append($('<img>', { class: "itemFig", src: figPath, onclick: "search('cancel','" + slot + "');" }))
                                        .append($('<select>', { id: 'circleSearchMethod' + slot, style: 'visibility:hidden;' })
                                        )
                                        .append($('<select>', { id: 'circleSearchDisplay' + slot, onchange: 'siteChange("' + slot + '");searchResultShow();' })
                                            .append($('<option>').html(langCompared['fill'][langNow]))
                                            .append($('<option>').html(langCompared['border'][langNow]))
                                        )
                                    if (Object.keys(searchSlot).length == 2) {
                                        if (slot == '0') {
                                            if ($('#circleSearchDisplay1').val() == langCompared['fill'][langNow]) {
                                                $('#circleSearchDisplay0').val(langCompared['border'][langNow])
                                            }
                                        }
                                        else {
                                            if ($('#circleSearchDisplay0').val() == langCompared['fill'][langNow]) {
                                                $('#circleSearchDisplay1').val(langCompared['border'][langNow])
                                            }
                                        }
                                    }
                                    searchResultShow();
                                })
                            )
                        );
                }
                function filtiedResource(dataList) {
                    $('#optionDataDiv' + slot).html('')
                    for (var i = 0; i < dataList.length; i++) {
                        if (dataList[i]['type'] == $('#typeSel').val()) appendItemImage(i, dataList);
                    }

                }
                let allItem = [];
                for (i of cookedUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'cooked'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of corpseUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'corpse'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of furnitureUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'furniture'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of doctoringUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'doctoring'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of equipmentUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'equipment'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of foragingUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'foraging'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of gatheringUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'gathering'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of medicalUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'medical'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of miningUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'mining'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of otherUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'other'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of toolUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'tool'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of carpentryUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'carpentry'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of woodCuttingUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'woodcutting'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }
                for (i of smithingUrl) {
                    let oneDict = {}
                    oneDict['name'] = i
                    oneDict['type'] = 'smithing'
                    oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                    allItem.push(oneDict)
                }

                $('#typeSel').change(function (event) {
                    filtiedResource(allItem);
                })
                filtiedResource(allItem);
                $('#searchInput').keyup(() => {
                    if ($('#searchInput').val().length >= 2) {
                        $('#optionDataDiv' + slot).html('')

                        let allItem = [];
                        for (i of cookedUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'cooked'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of corpseUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'corpse'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of furnitureUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'furniture'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of doctoringUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'doctoring'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of equipmentUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'equipment'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of foragingUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'foraging'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of gatheringUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'gathering'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of medicalUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'medical'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of miningUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'ore'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of otherUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'other'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of toolUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'tool'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }
                        for (i of woodCuttingUrl) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['type'] = 'wood'
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                            allItem.push(oneDict)
                        }

                        let newList = []
                        for (i in allItem) {
                            if (allItem[i]['name'].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                let oneDict = {}
                                oneDict['name'] = allItem[i]['name']
                                oneDict['url'] = allItem[i]['url']
                                newList.push(oneDict)
                            }
                        }
                        for (i in newList) {
                            appendItemImage(i, newList);
                        }
                    }
                    else $('#optionDataDiv' + slot).html('');
                })
            }
            else if (func == 'time') {
                let fontSize = '27';
                if (langNow == 'en') fontSize = '14';
                if (isMobileDevice()) {
                    fontSize = '100';
                    if (langNow == 'en') fontSize = '60';
                }
                $('#slot' + slot).html('');
                $('#slot' + slot)
                    .append($('<button>', { id: 'timeSearchBTN', class: 'itemFig', style: 'border: black solid;background: white;color: black;', onclick: "search('cancel','" + slot + "');" }).append(langCompared["renewTime"][langNow]))
                    .append($('<select>', { style: 'visibility:hidden;' }))
                    .append($('<select>', { id: 'circleSearchDisplay' + slot, onchange: 'siteChange(' + slot + ');searchResultShow();' })
                        .append($('<option>').html(langCompared["fill"][langNow]))
                        .append($('<option>').html(langCompared["border"][langNow]))
                    )
                if (Object.keys(searchSlot).length == 2) {
                    if (slot == '0') {
                        if ($('#circleSearchDisplay1').val() == langCompared["fill"][langNow]) {
                            $('#circleSearchDisplay0').val(langCompared["border"][langNow])
                        }
                    }
                    else {
                        if ($('#circleSearchDisplay0').val() == langCompared["fill"][langNow]) {
                            $('#circleSearchDisplay1').val(langCompared["border"][langNow])
                        }
                    }
                }
                searchSlot[slot]['type'] = 'time'
                searchResultShow()

            }
        }
        function siteChange(slot) {
            if (Object.keys(searchSlot).length == 2) {
                let otherSlot = '';
                if (slot == 1) otherSlot = 0;
                else otherSlot = 1
                if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) {
                    $('#circleSearchDisplay' + otherSlot).val(langCompared['fill'][langNow])
                    if (searchSlot[0]['slot'] == slot) {
                        searchSlot[0]['display'] = langCompared['border'][langNow]
                        searchSlot[1]['display'] = langCompared['fill'][langNow]
                    }

                }
                else $('#circleSearchDisplay' + otherSlot).val(langCompared['border'][langNow])
            }
        }
        function searchResultShow() {
            $('.interactive-circle').attr('class', 'interactive-circle black');
            $('.greenCircle').removeClass('greenCircle');
            $('.orangeCircle').removeClass('orangeCircle');
            $('.yellowCircle').removeClass('yellowCircle');
            $('.redCircle').removeClass('redCircle');
            for (i in searchSlot) {
                let slot = searchSlot[i]['slot']
                let type = searchSlot[i]['type']
                let name = searchSlot[i]['name']
                let inSubcribeHouse = 0;
                if (type == 'animal') {
                    if ($('#circleSearchMethod' + slot).val() == langCompared['newest'][langNow]) {
                        for (areaID in rawData) {
                            if (rawData[areaID]['recordTime'] == 1697212800000) continue;
                            if (rawData[areaID]['animal'].length != 0) {
                                let animalRepeatCheckList = []
                                for (animalID in rawData[areaID]['animal']) {
                                    if (rawData[areaID]['animal'][animalID]['name'] == name && rawData[areaID]['animal'][animalID]['quentity'] != 0) {
                                        if (animalRepeatCheckList.includes(name) && rawData[areaID]['animal'][animalID]['activity'] == 0) continue;
                                        else animalRepeatCheckList.push(name);
                                        if (rawData[areaID]['animal'][animalID]['activity'] == 1) {
                                            if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('redCircle');
                                            else {
                                                $('#' + areaID).removeClass('black');
                                                $('#' + areaID).addClass('red');
                                            }
                                            break
                                        }
                                        else {
                                            if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('greenCircle');
                                            else {
                                                $('#' + areaID).removeClass('black');
                                                $('#' + areaID).addClass('green');
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else if ($('#circleSearchMethod' + slot).val() == langCompared['ever'][langNow]) {
                        for (areaID in rawData) {
                            if (areaID in hisData && hisData[areaID]['animal'].includes(name)) {
                                if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('greenCircle');
                                else $('#' + areaID).addClass('green');
                            }
                        }
                    }
                }
                else if (type == 'resource') {
                    if ($('#circleSearchMethod' + slot).val() == langCompared['newest'][langNow]) {
                        for (areaID in rawData) {
                            if (rawData[areaID]['recordTime'] == 1697212800000) continue;
                            if (rawData[areaID]['resource'].length != 0) {
                                for (resourceID in rawData[areaID]['resource']) {
                                    if (rawData[areaID]['resource'][resourceID]['name'] == name && rawData[areaID]['resource'][resourceID]['quentity'] != 0) {
                                        if (rawData[areaID]['resource'][resourceID]['quentity'] == 1) {
                                            if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('redCircle');
                                            else {
                                                $('#' + areaID).removeClass('black');
                                                $('#' + areaID).addClass('red');
                                            }
                                            break
                                        }
                                        else if (rawData[areaID]['resource'][resourceID]['quentity'] == 2) {
                                            if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('orangeCircle');
                                            else {
                                                $('#' + areaID).removeClass('black');
                                                $('#' + areaID).addClass('orange');
                                            }
                                            break
                                        }
                                        else if (rawData[areaID]['resource'][resourceID]['quentity'] == 3) {
                                            if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('yellowCircle');
                                            else {
                                                $('#' + areaID).removeClass('black');
                                                $('#' + areaID).addClass('yellow');
                                            }
                                            break
                                        }
                                        else if (rawData[areaID]['resource'][resourceID]['quentity'] == 4) {
                                            if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('greenCircle');
                                            else {
                                                $('#' + areaID).removeClass('black');
                                                $('#' + areaID).addClass('green');
                                            }
                                            break
                                        }
                                        else if (rawData[areaID]['resource'][resourceID]['quentity'] == 9000) {
                                            if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('blueCircle');
                                            else {
                                                $('#' + areaID).removeClass('black');
                                                $('#' + areaID).addClass('blue');
                                            }
                                            break
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else if ($('#circleSearchMethod' + slot).val() == langCompared['highest'][langNow]) {
                        for (areaID in rawData) {
                            if (areaID in hisData && 'resource' in hisData[areaID] && name in hisData[areaID]['resource']) {
                                if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) {
                                    if (hisData[areaID]['resource'][name]['max'] == 4) $('#' + areaID).addClass('greenCircle');
                                    else if (hisData[areaID]['resource'][name]['max'] == 3) $('#' + areaID).addClass('yellowCircle');
                                    else if (hisData[areaID]['resource'][name]['max'] == 2) $('#' + areaID).addClass('orangeCircle');
                                    else if (hisData[areaID]['resource'][name]['max'] == 1) $('#' + areaID).addClass('redCircle');
                                    else if (hisData[areaID]['resource'][name]['max'] == 9000) $('#' + areaID).addClass('blueCircle');
                                }
                                else {
                                    if (hisData[areaID]['resource'][name]['max'] == 4) $('#' + areaID).addClass('green');
                                    else if (hisData[areaID]['resource'][name]['max'] == 3) $('#' + areaID).addClass('yellow');
                                    else if (hisData[areaID]['resource'][name]['max'] == 2) $('#' + areaID).addClass('orange');
                                    else if (hisData[areaID]['resource'][name]['max'] == 1) $('#' + areaID).addClass('red');
                                    else if (hisData[areaID]['resource'][name]['max'] == 9000) $('#' + areaID).addClass('blue');
                                }
                            }
                        }
                    }
                    else if ($('#circleSearchMethod' + slot).val() == langCompared['lowest'][langNow]) {

                        for (areaID in rawData) {
                            if (areaID in hisData && 'resource' in hisData[areaID] && name in hisData[areaID]['resource']) {
                                if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) {
                                    if (hisData[areaID]['resource'][name]['min'] == 4) $('#' + areaID).addClass('greenCircle');
                                    else if (hisData[areaID]['resource'][name]['min'] == 3) $('#' + areaID).addClass('yellowCircle');
                                    else if (hisData[areaID]['resource'][name]['min'] == 2) $('#' + areaID).addClass('orangeCircle');
                                    else if (hisData[areaID]['resource'][name]['min'] == 1) $('#' + areaID).addClass('redCircle');
                                    else if (hisData[areaID]['resource'][name]['min'] == 9000) $('#' + areaID).addClass('blueCircle');
                                }
                                else {
                                    if (hisData[areaID]['resource'][name]['min'] == 4) $('#' + areaID).addClass('green');
                                    else if (hisData[areaID]['resource'][name]['min'] == 3) $('#' + areaID).addClass('yellow');
                                    else if (hisData[areaID]['resource'][name]['min'] == 2) $('#' + areaID).addClass('orange');
                                    else if (hisData[areaID]['resource'][name]['min'] == 1) $('#' + areaID).addClass('red');
                                    else if (hisData[areaID]['resource'][name]['min'] == 9000) $('#' + areaID).addClass('blue');
                                }
                            }
                        }
                    }
                }
                else if (type == 'item') {
                    for (areaID in rawData) {
                        if (rawData[areaID]['recordTime'] == 1697212800000) continue;
                        if (rawData[areaID]['item'].length != 0) {
                            for (itemID in rawData[areaID]['item']) {
                                if (rawData[areaID]['item'][itemID]['name'] == name && rawData[areaID]['item'][itemID]['quentity'] != 0) {
                                    if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('greenCircle');
                                    else {
                                        $('#' + areaID).removeClass('black');
                                        $('#' + areaID).addClass('green');
                                    }
                                    if(areaID in houseListObject)inSubcribeHouse = 1
                                }
                            }
                        }
                    }
                }
                else if (type == 'time') {
                    if ($('#circleSearchDisplay' + slot).val() == langCompared['fill'][langNow]) recordTimeShow('inner');
                    else recordTimeShow('outter');

                }
                if(inSubcribeHouse) $('#houseDiv').css({border:'solid #00ff00 5px'})
                else $('#houseDiv').css({border:'solid #000000 5px'})
            }
            UpdateUrl();
            $('.interactive-circle').css({ width: 30 / nodeScaleNow + 'px', height: 30 / nodeScaleNow + 'px', fontSize: 20 / nodeScaleNow + 'px' })
            $('.interactive-circle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
            $('.blackCircle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
            $('.redCircle').css('border', 5 / nodeScaleNow + 'px #ff0000 solid')
            $('.orangeCircle').css('border', 5 / nodeScaleNow + 'px #ffb100 solid')
            $('.yellowCircle').css('border', 5 / nodeScaleNow + 'px #ffff00 solid')
            $('.greenCircle').css('border', 5 / nodeScaleNow + 'px #00ff00 solid')
            if($('#houseListPage').is(':visible'))resetHousePage();
        }
        function UpdateUrl() {
            let theOtherLang = ''
            let nodeIdDisplay = 'show';
            let nodeSize = $('#nodeScaleControl').val()
            if ($('#nodeIdSwitchBTN').html() == langCompared['show'][langNow]) nodeIdDisplay = 'hide';
            if (langNow == 'en') theOtherLang = 'zh';
            else theOtherLang = 'en';
            for (i in searchSlot) {
                searchSlot[i]['display'] = $('#circleSearchDisplay' + searchSlot[i]['slot']).val();
                if (searchSlot[i]['display'] == langCompared['border'][theOtherLang]) searchSlot[i]['display'] = langCompared['border'][langNow]
                else if (searchSlot[i]['display'] == langCompared['fill'][theOtherLang]) searchSlot[i]['display'] = langCompared['fill'][langNow]

                if (searchSlot[i]['type'] == 'animal' || searchSlot[i]['type'] == 'resource') {
                    searchSlot[i]['method'] = $('#circleSearchMethod' + searchSlot[i]['slot']).val();
                    if (searchSlot[i]['method'] == langCompared['newest'][theOtherLang]) searchSlot[i]['method'] = langCompared['newest'][langNow]
                    else if (searchSlot[i]['method'] == langCompared['ever'][theOtherLang]) searchSlot[i]['method'] = langCompared['ever'][langNow]
                    else if (searchSlot[i]['method'] == langCompared['highest'][theOtherLang]) searchSlot[i]['method'] = langCompared['highest'][langNow]
                    else if (searchSlot[i]['method'] == langCompared['lowest'][theOtherLang]) searchSlot[i]['method'] = langCompared['lowest'][langNow]
                }
            }
            $('#urlInput').val('?searchObj=' + JSON.stringify(searchSlot) + '&map=' + mapId + '&lang=' + langNow + '&node=' + nodeIdDisplay + '&defNode=' + defNodeId + '&defNodeSize=' + nodeSize);
        }
        function langChange() {
            if (langNow == 'zh') {
                langNow = 'en';
                $('#langBTN').html('中文');
                $('title').html('SoulForged Resource Sharing Map');
                if (isMobileDevice()) {
                    $('style').append("#timeSearchBTN{font-size:40px;width:200px;height:200px;}")
                    $('style').append("#settingManu{font-size: 75px; top:30%; left: 5%; right: 5%;}")

                }
                else {
                    $('style').append("#setDefault{font-size: 15px;}")
                    $('style').append("#timeSearchBTN{font-size: 14px;}")
                }
            }
            else if (langNow == 'en') {
                langNow = 'zh';
                $('#langBTN').html('English');
                $('title').html('SoulForged 資源共享地圖');
                if (isMobileDevice()) {
                    $('style').append("#timeSearchBTN{font-size:75px;width:200px;height:200px;}")
                    $('style').append("#settingManu{font-size: 100px; top:30%; left: 5%; right: 5%;}")

                }
                else {
                    $('style').append("#setDefault{font-size: 20px;}")
                    $('style').append("#timeSearchBTN{font-size: 27px;}")
                }
            }
            $('#search').html(langCompared['search'][langNow]);
            $('#settingCancel').html(langCompared['cancel'][langNow]);
            $('#setDefault').html(langCompared['setAsDefault'][langNow]);
            $('#display').html(langCompared['display'][langNow]);
            $('#langSwitch').html(langCompared['switchLanguage'][langNow]);
            $('#guide').html(langCompared['guide'][langNow]);
            $('#nodeIdSwitch').html(langCompared['nodeId'][langNow]);
            $('#mapEdit').html(langCompared['edit'][langNow]);
            $('#nodeEditBTN').html(langCompared['node'][langNow]);
            $('#routeEditBTN').html(langCompared['route'][langNow]);
            $('#prefixDiv').html(langCompared['prefix'][langNow]);
            $('#suffixDiv').html(langCompared['suffix'][langNow]);
            $('#mapEditDone').html(langCompared['done'][langNow]);
            $('#colorDiv').html(langCompared['color'][langNow]);
            $('#typeDiv').html(langCompared['type'][langNow]);
            $('#mainstream').html(langCompared['mainstream'][langNow]);
            $('#sidetrack').html(langCompared['sidetrack'][langNow]);
            $('#defaultNode').html(langCompared['defaultNode'][langNow]);
            $('#cancelNodeDefSel').html(langCompared['cancel'][langNow]);
            $('#nodeScaleSwitch').html(langCompared['nodeScaleSwitch'][langNow]);
            let otherLang = '';
            if (langNow == 'zh') otherLang = 'en';
            else otherLang = 'zh';
            if ($('#nodeIdSwitchBTN').html() == langCompared['hide'][otherLang]) {
                $('#nodeIdSwitchBTN').html(langCompared['hide'][langNow])
                for (entryID in entryList) $('#' + entryList[entryID]).html(langCompared['entry'][langNow]);
            }
            else $('#nodeIdSwitchBTN').html(langCompared['show'][langNow])

            UpdateUrl();
            resetSearchDiv(searchSlot)
        }
        function goUrl() {
            $('#setDefaultNode').html(defNodeId);
            UpdateUrl();
            history.replaceState({ id: 'defaultSetting' }, '', $('#urlInput').val());
            // window.open(document.getElementById("urlInput").value)
            // window.location.href =document.getElementById("urlInput").value;
        }
        function settingSwitch() {
            if ($('#settingManu').is(":visible")) $('#settingManu').hide();
            else $('#settingManu').show();
        }
        function nodeIdSwitch() {

            if ($('#nodeIdSwitchBTN').html() == langCompared['hide'][langNow]) {
                $('#nodeIdSwitchBTN').html(langCompared['show'][langNow])
                $(document).ready(function () {
                    $(".interactive-circle").each(function () {
                        $(this).html('');
                    });
                });
            }
            else {
                $('#nodeIdSwitchBTN').html(langCompared['hide'][langNow])
                $(document).ready(function () {
                    $(".interactive-circle").each(function () {
                        var elementId = $(this).attr("id"); // 獲取元素的 id 屬性值
                        if (elementId == 'Q21DM1' || elementId == 'M1UQ21' || elementId == 'EDM' || elementId == 'CDM' || elementId == 'W1DM' || elementId == 'W2DM' || elementId == 'W3DM' || elementId == 'W4DM') $(this).html(langCompared['entry'][langNow]);
                        else $(this).html(elementId);
                    });
                });
            }
            UpdateUrl();
        }

        function mapEdit(item) {
            if (item == 'node') {
                editMapNode = 1;
                editMapRoute = 0;
                $('#settingManu').hide();
                $('#searchNodeDiv').hide();
                $('#routePage').hide();
                $('#nodePage').show();
                $('#mapEditDiv').show();
            }
            else if (item == 'route') {
                editMapRoute = 1;
                editMapNode = 0;
                $('#settingManu').hide();
                $('#searchNodeDiv').hide();
                $('#nodePage').hide();
                $('#routePage').show();
                $('#mapEditDiv').show();
                routeSel('mainstream')
            }
            else {
                $('#searchNodeDiv').show();
                $('#mapEditDiv').hide();
                editMapNode = 0;
                editMapRoute = 0;
                if (routeNodePair.length == 1) $('#' + routeNodePair[0]).css('background-color', '');
                routeNodePair = []
                searchResultShow();
            }
        }
        function getDataFromBackend(item) {
            formData = new FormData();
            formData.append('item', item);
            fetch('/getDataSet', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        // HTTP狀態碼在200-299之間，表示請求成功
                        return response.text();  // 你可以用 response.json() 如果後端返回的是 JSON 格式
                    } else {
                        // HTTP狀態碼在300以上，表示請求失敗
                        throw new Error('Server response was not ok: ' + response.statusText);
                    }
                })
                .then(data => {
                    // if(item == 'eliteRecord')console.log(data.replace(/'/g, '"'))
                    let jsaonFromBE = JSON.parse(data.replace(/'/g, '"').replace(/True/g, 'true').replace(/False/g, 'false'))
                    if (item == 'newestData') rawData = jsaonFromBE;
                    if (item == 'mapDotMain') posisionDataMain = jsaonFromBE;
                    if (item == 'mapDotMH') posisionDataMH = jsaonFromBE;
                    if (item == 'mapDotTT') posisionDataTT = jsaonFromBE;
                    if (item == 'mapRouteMain') mapRouteMain = jsaonFromBE;
                    if (item == 'mapRouteMH') mapRouteMH = jsaonFromBE;
                    if (item == 'mapRouteTT') mapRouteTT = jsaonFromBE;
                    if (item == 'hisData') hisData = jsaonFromBE;
                    if (item == 'nodeMaping') {
                        nodeMaping = jsaonFromBE;
                        recordNodeList = Object.values(nodeMaping);
                    }
                    if(item == 'eliteRecord') eliteRecord = jsaonFromBE
                    loadingCount += 1
                    if (loadDoneState == 0) dataOnLoad();
                    else onReload();
                })
                .catch(error => {
                    // 這裡處理網絡錯誤和上面拋出的錯誤
                    console.error('There was a problem with the fetch operation:', error);
                    console.log(item)
                    if(alertInterval == 0){
                        alert(langCompared['serverErr'][langNow]);
                        alertInterval = 1
                        setTimeout(function () {
                            alertInterval = 0
                        }, 10000)
                    }
                });
        }
        function routeSel(item) {
            $('#routeColorDiv').html('')
            routeType = item;
            $('#' + item).attr('class', 'greenBTN')
            if (item == 'mainstream') {
                routeWidth = '8px';
                $('#sidetrack').removeClass('greenBTN');
                $('#routeColorDiv')
                    .append($('<div>', { id: "routeColor0", class: "colorSel", style: "background-color:#FFFF00", onclick: "colorChange(0)" }))
                    .append($('<div>', { id: "routeColor1", class: "colorSel", style: "background-color:#FF00FF", onclick: "colorChange(1)" }))
                    .append($('<div>', { id: "routeColor2", class: "colorSel", style: "background-color:#00FFFF", onclick: "colorChange(2)" }))
                    .append($('<div>', { id: "routeColor3", class: "colorSel", style: "background-color:#FF0000", onclick: "colorChange(3)" }))
                    .append($('<div>', { id: "routeColor4", class: "colorSel", style: "background-color:#00FF00", onclick: "colorChange(4)" }))
                    .append($('<div>', { id: "routeColor5", class: "colorSel", style: "background-color:#0000FF; color:#ffffff", onclick: "colorChange(5)" }))
            }
            else {
                routeWidth = '2px';
                $('#mainstream').removeClass('greenBTN');
                $('#routeColorDiv')
                    .append($('<div>', { id: "routeColor0", class: "colorSel", style: "background-color:#FFFFFF", onclick: "colorChange(0)" }))
                    .append($('<div>', { id: "routeColor1", class: "colorSel", style: "background-color:#888888", onclick: "colorChange(1)" }))
                    .append($('<div>', { id: "routeColor2", class: "colorSel", style: "background-color:#000000; color:#ffffff", onclick: "colorChange(2)" }))
            }
            colorChange(0)
        }
        function continueAdd() {
            if (continueAddState == 1) {
                continueAddState = 0;
                $('#continueAdd').html('連續編號')
                $('#continueAddDiv').hide();
            }
            else {
                continueAddState = 1;
                $('#continueAdd').html('獨立編號')
                $('#continueAddDiv').show();
            }
        }

        function colorChange(colorIndex) {
            let colorArray = []
            if (routeType == 'mainstream') colorArray = ['#FFFF00', '#FF00FF', '#00FFFF', '#FF0000', '#00FF00', '#0000FF'];
            else colorArray = ['#FFFFFF', '#888888', '#000000'];
            routeColorSetting = colorArray[colorIndex]
            $('.colorSel').html('');
            $('#routeColor' + colorIndex).html('○')
        }
        function drawLineBetweenCircles(circle1Id, circle2Id, color, Rwidth, map, idBetweenStr) {
            var circle1 = document.getElementById(circle1Id);
            var circle2 = document.getElementById(circle2Id);
            // 计算圆点中心的位置
            var x1 = parseFloat(circle1.style.left);
            var y1 = parseFloat(circle1.style.top);
            var x2 = parseFloat(circle2.style.left);
            var y2 = parseFloat(circle2.style.top);

            var dx = x2 - x1;
            var dy = y2 - y1;

            var length = Math.sqrt(dx * dx + dy * dy);
            var dxNormalized = dx / length;
            var dyNormalized = dy / length;
            var shortenLength = 15 / nodeScaleNow
            x1 = x1 + shortenLength * dxNormalized;
            y1 = y1 + shortenLength * dyNormalized;
            x2 = x2 - shortenLength * dxNormalized;
            y2 = y2 - shortenLength * dyNormalized;

            var svgNS = "http://www.w3.org/2000/svg";
            var line = document.createElementNS(svgNS, 'line');
            line.id = circle1Id + idBetweenStr + circle2Id;
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('style', 'stroke:' + color + ';stroke-width:' + Rwidth + ';pointer-events: auto;');
            let mapRouteData = []
            if (!pathPlainningState) {
                line.addEventListener('click', function () {
                    if (editMapRoute == 1) delRoute(circle1Id, circle2Id);
                    else if (pathPlainningState && planningMethod == 'Path') {
                        let thisbAP = 0;
                        let thisColor = '#FF0000'
                        let mapRouteData = []
                        if (mapId == 'Main') mapRouteData = mapRouteMain;
                        else if (mapId == 'MH') mapRouteData = mapRouteMH;
                        else if (mapId == 'TT') mapRouteData = mapRouteTT;
                        for (i of mapRouteData) {
                            if (i['start'] == circle1Id && i['end'] == circle2Id) {
                                if ('bAP' in i) {
                                    totalBAP *= 100;
                                    thisbAP = Math.round(i['bAP'] * 100)
                                    totalBAP += thisbAP
                                    totalBAP /= 100;
                                }
                                else {
                                    bAPEmptyCount += 1
                                    thisColor = '#FFC7C7'
                                }
                                break
                            }
                        }
                        drawLineBetweenCircles(circle1Id, circle2Id, thisColor, '8px', map, 'PathPlanningPath')
                        if (thisbAP != 0) appendBAP(i)
                        let bAPStr = 'bAP : ';
                        if (totalBAP != 0) bAPStr += Math.round(totalBAP * 100) / 100;
                        else bAPStr += 0;
                        if (bAPEmptyCount != 0) bAPStr += ', and ' + bAPEmptyCount + ' unknown paths.';
                        showMsg(true, bAPStr);
                    }
                });
            }
            if (idBetweenStr == 'PathPlanningPath') {
                line.addEventListener('click', function () {
                    $('#' + circle1Id + 'PathPlanningPath' + circle2Id).remove()
                    let mapRouteData = []
                    if (mapId == 'Main') mapRouteData = mapRouteMain;
                    else if (mapId == 'MH') mapRouteData = mapRouteMH;
                    else if (mapId == 'TT') mapRouteData = mapRouteTT;
                    for (i of mapRouteData) {
                        if (i['start'] == circle1Id && i['end'] == circle2Id) {
                            if ('bAP' in i) {
                                totalBAP *= 100;
                                totalBAP = totalBAP - Math.round(i['bAP'] * 100)
                                totalBAP /= 100;
                            }
                            else {
                                bAPEmptyCount -= 1
                            }
                            break
                        }
                    }
                    let bAPStr = 'bAP : ';
                    if (totalBAP != 0) bAPStr += Math.round(totalBAP * 100) / 100;
                    else bAPStr += 0;
                    if (bAPEmptyCount != 0) bAPStr += ', and ' + bAPEmptyCount + ' unknown paths.';
                    showMsg(true, bAPStr);
                });

            }

            if (map == 'Main') var svgContainer = document.getElementById("svgMain");
            else if (map == 'MH') var svgContainer = document.getElementById("svgMH");
            else if (map == 'TT') var svgContainer = document.getElementById("svgTT");


            svgContainer.appendChild(line);
        }
        function appendBAP(data) {
            $('#' + data['start'] + 'PathPlanningPath' + data['end']).mouseenter(function (e) {
                $('.info-tag').text(data['bAP'])
                    .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
            }).mouseleave(function () {
                $('.info-tag').hide();
            });
        }
        function setDefaultNode(func) {
            if (func == 'set') {
                editdefaultNode = 1;
                $('#settingManu').hide();
                $('#searchNodeDiv').hide();
                $('#canceldefaultNodeSelDiv').show();
            }
            else if (func == 'cancel') {
                editdefaultNode = 0;
                $('#searchNodeDiv').show();
                $('#canceldefaultNodeSelDiv').hide();
            }
            else {
                setDefaultNode('cancel');
                defNodeId = func;
                $('#setDefaultNode').html(defNodeId);
                window.scrollTo(0, 0);
                document.getElementById(func).scrollIntoView({ block: 'center', inline: 'center' });
                UpdateUrl();
                goUrl();
            }
        }
        function delRoute(start, end) {
            if (confirm(langCompared['delRouteConfirm'][langNow] + start + ' to ' + end + ' ?')) {
                formData = new FormData();
                formData.append('map', mapId);
                formData.append('start', start);
                formData.append('end', end);
                fetch('/delMapRoute', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            // HTTP狀態碼在200-299之間，表示請求成功
                            return response.text();  // 你可以用 response.json() 如果後端返回的是 JSON 格式
                        } else {
                            // HTTP狀態碼在300以上，表示請求失敗
                            throw new Error('Server response was not ok: ' + response.statusText);
                        }
                    })
                    .then(data => {
                        // 這裡的 data 是上面的 response.text() 的結果
                        if (data === 'OK') {
                            $('#' + start + 'Link' + end).remove();
                            if (mapId == 'Main') {
                                for (i in mapRouteMain) {
                                    if (mapRouteMain[i]['start'] === start && mapRouteMain[i]['end'] === end) mapRouteMain.splice(i, 1)
                                }
                            }
                            else if (mapId == 'MH') {
                                for (i in mapRouteMH) {
                                    if (mapRouteMH[i]['start'] === start && mapRouteMH[i]['end'] === end) mapRouteMH.splice(i, 1)
                                }
                            }
                            else if (mapId == 'TT') {
                                for (i in mapRouteTT) {
                                    if (mapRouteTT[i]['start'] === start && mapRouteTT[i]['end'] === end) mapRouteTT.splice(i, 1)
                                }
                            }
                        } else {
                            throw new Error('Server response was not expected: ' + data);
                        }
                    })
                    .catch(error => {
                        // 這裡處理網絡錯誤和上面拋出的錯誤
                        console.error('There was a problem with the fetch operation:', error);
                        alert(langCompared['serverErr'][langNow]);
                    });
            }

        }
        function guide() {
            if (langNow == 'zh') window.open('/pagefile/static/Guide-zh.pdf', '_blank');
            else if (langNow == 'en') window.open('/pagefile/static/Guide-en.pdf', '_blank');
        }
        function aim(nodeCode = "") {
            if (aimState == 0) {
                $('#msgDiv2').show();
                setTimeout(function () {
                    let nodeId = "";
                    if(nodeCode == "") nodeId = prompt(langCompared['whitchNode'][langNow]);
                    else nodeId = nodeCode;
                    if (nodeId != null && nodeId != "") {
                        lastAim = nodeId;
                        $('#syncDiv').hide();
                        $('#importDiv').hide();
                        $('#pathDiv').hide();
                        $('#houseDiv').hide();
                        $('#eliteDiv').hide();
                        $('#searchNodeDiv').hide();
                        lastSearchSlot = JSON.parse(JSON.stringify(searchSlot))
                        searchSlot = {}
                        searchResultShow()
                        if ($('#' + nodeId).length === 0) alert(langCompared['nodeUnavilible'][langNow])
                        else {
                            if (mapId == 'Main') {
                                if (nodeId in posisionDataMH) nodeOnclick('Q21DM1');
                                else if (nodeId in posisionDataTT) nodeOnclick('CDM');
                            }
                            else if (mapId == 'MH') {
                                if (nodeId in posisionDataMain) nodeOnclick('M1UQ21');
                                else if (nodeId in posisionDataTT) nodeOnclick('CDM');
                            }
                            else if (mapId == 'TT') {
                                if (nodeId in posisionDataMain) nodeOnclick('M1UQ21');
                                else if (nodeId in posisionDataMH) nodeOnclick('M1UQ21');
                            }
                            aimState = 1;
                            $('.greenCircle').removeClass('greenCircle');
                            $('.orangeCircle').removeClass('orangeCircle');
                            $('.yellowCircle').removeClass('yellowCircle');
                            $('.redCircle').removeClass('redCircle');
                            $('#' + nodeId).css({ border: 'solid #ff0000 ' + (1.25 * slider.value) + 'px' });
                            $('#aimDiv').css({ border: 'solid #ff0000 5px' });
                            window.scrollTo(0, 0);
                            document.getElementById(nodeId).scrollIntoView({ block: 'center', inline: 'center' });
                        }
                    }
                    $('#msgDiv2').hide();
                },0);
            }
            else {
                $('#syncDiv').show();
                $('#importDiv').show();
                $('#pathDiv').show();
                $('#houseDiv').show();
                $('#eliteDiv').show();
                $('#searchNodeDiv').show();
                $('#' + lastAim).css({ border: 'solid #000000 ' + (1.25 * slider.value) + 'px' });
                lastAim = ''
                aimState = 0;
                searchSlot = JSON.parse(JSON.stringify(lastSearchSlot))
                $('#aimDiv').css({ border: 'solid #000000 5px' });
                searchResultShow()
            }
        }
        function pathFinding() {
            if (pathPlainningState == 0) {
                pathPlainningState = 1
                planningMethodChange(planningMethod)
                if (planningMethod == 'Path') {
                    let bAPStr = 'bAP : ';
                    if (totalBAP != 0) bAPStr += Math.round(totalBAP * 100) / 100;
                    else bAPStr += 0;
                    if (bAPEmptyCount != 0) bAPStr += ', and ' + bAPEmptyCount + ' unknown paths.';
                    showMsg(true, bAPStr);
                    $('line[id*=PathPlanningPath]').show()
                }
                else {
                    for (id of pathFindingArray) $('#' + id).css({ 'background-color': '#ff0000' });
                    history.replaceState({ id: 'defaultSetting' }, '', '?pathArray=' + JSON.stringify(pathFindingArray) + '&lang=' + langNow);
                    $('line[id*=PathPlanningPath]').hide()
                }
                $('#pathDiv').css({ border: 'solid #ff0000 5px' });
                $('div[class*=interactive-circle]').attr('class', 'interactive-circle black');

                $('#syncDiv').hide();
                $('#importDiv').hide();
                $('#aimDiv').hide();
                $('#houseDiv').hide();
                $('#eliteDiv').hide();
                $('#searchNodeDiv').hide();
                $('#cleanDiv').show();
                $('#planningMethodDiv').show()
            }
            else {
                pathPlainningState = 0
                showMsg(false)
                searchResultShow()
                $('#syncDiv').show();
                $('#importDiv').show();
                $('#aimDiv').show();
                $('#houseDiv').show();
                $('#eliteDiv').show();
                $('#searchNodeDiv').show();
                $('#cleanDiv').hide();
                $('#planningMethodDiv').hide()
                $('line[id*=PathPlanningPath]').hide()
                aimState = 0;
                $('#pathDiv').css({ border: 'solid #000000 5px' });
                for (id of pathFindingArray) $('#' + id).css({ 'background-color': '' });
                history.replaceState({ id: 'defaultSetting' }, '', $('#urlInput').val());
            }
        }
        function planningMethodChange(method) {
            if (method == 'Node') {
                planningMethod = 'Node'
                showMsg(false)
                $('#setAsNode').attr('class', 'greenBTN')
                $('#setAsPath').attr('class', '')
                $('line[id*=PathPlanningPath]').hide()
                for (id of pathFindingArray) $('#' + id).css({ 'background-color': '#ff0000' });
                history.replaceState({ id: 'defaultSetting' }, '', '?pathArray=' + JSON.stringify(pathFindingArray) + '&lang=' + langNow);
            }
            else if(method == 'ShortCut'){
                $('#msgDiv2').show();
                setTimeout(function () {
                    let start = prompt(langCompared['enterStart'][langNow])
                    let end = prompt(langCompared['enterEnd'][langNow])
                    if(start && end) findShortCuts(start,end)
                    $('#msgDiv2').hide();
                },0);
            }
            else {
                planningMethod = 'Path'
                let bAPStr = 'bAP : ';
                if (totalBAP != 0) bAPStr += Math.round(totalBAP * 100) / 100;
                else bAPStr += 0;
                if (bAPEmptyCount != 0) bAPStr += ', and ' + bAPEmptyCount + ' unknown paths.';
                showMsg(true, bAPStr);
                $('#setAsNode').attr('class', '')
                $('#setAsPath').attr('class', 'greenBTN')
                $('line[id*=PathPlanningPath]').show()
                for (id of pathFindingArray) $('#' + id).css({ 'background-color': '' });
                history.replaceState({ id: 'defaultSetting' }, '', $('#urlInput').val());
            }
        }
        function parseData() {
            loadingCount = 0
            let paste = $('#jsonStrInput').val();
            transformedData = [];
            let errState = 0
            if (paste !== '') {
                try {
                    pasteData = JSON.parse(paste);
                    // 轉換格式
                    for (nodeId in pasteData['loc']) {
                        if ('indoors' in pasteData['loc'][nodeId] && nodeId in jsonFromBackend['nodeMaping'] == false) {
                            // mappingIndoorINV()
                            continue
                        }
                        let oneNodeResult = {};
                        oneNodeResult['Data'] = {}
                        oneNodeResult['space'] = pasteData['loc'][nodeId]['spacing'];
                        oneNodeResult['timestamp'] = pasteData['loc'][nodeId]['timestamp'];
                        // if(nodeId in nodeMaping)oneNodeResult['mapId'] = nodeMaping[nodeId];
                        let localCreatureArray = [];
                        for (creId of pasteData['loc'][nodeId]['creatures']) {
                            try {
                                if (pasteData['cre'][creId]['hostile'] == true) {
                                    let oneData = {}
                                    oneData['id'] = pasteData['cre'][creId]['icon'].substring(9, pasteData['cre'][creId]['icon'].lastIndexOf('.'))
                                    oneData['nonAggressive'] = pasteData['cre'][creId]['nonAggressive']
                                    localCreatureArray.push(oneData);
                                }
                            }
                            catch (e) {
                                console.log(creId, e);
                            }
                        }
                        oneNodeResult['Data']['CRE'] = localCreatureArray;
                        let localResourceArray = []
                        for (resId of pasteData['loc'][nodeId]['resources']) {
                            try {
                                let oneData = {}
                                oneData['id'] = pasteData['res'][resId]['icon'].substring(9, pasteData['res'][resId]['icon'].lastIndexOf('.'))
                                oneData['name'] = pasteData['res'][resId]['name'].substring(pasteData['res'][resId]['name'].lastIndexOf(':') + 1, pasteData['res'][resId]['name'].lastIndexOf('}'))
                                oneData['density'] = pasteData['res'][resId]['density']
                                localResourceArray.push(oneData)
                            }
                            catch (e) {
                                console.log(resId, e)
                            }
                        }
                        oneNodeResult['Data']['RES'] = localResourceArray;
                        let localItemArray = []
                        for (invId of pasteData['loc'][nodeId]['inventory']) {
                            try {
                                if (pasteData['inv'][invId]['durabilityStageName'] != 'Ruined' && pasteData['inv'][invId]['name'].includes('e9cdebe4c8') == false && pasteData['inv'][invId]['name'].includes('1542665668') == false && pasteData['inv'][invId]['name'].includes('Research problem') == false) {
                                    let oneData = {}
                                    oneData['id'] = pasteData['inv'][invId]['icon'].substring(9, pasteData['inv'][invId]['icon'].lastIndexOf('.'))
                                    oneData['name'] = pasteData['inv'][invId]['name'].substring(pasteData['inv'][invId]['name'].lastIndexOf(':') + 1, pasteData['inv'][invId]['name'].lastIndexOf('}'))
                                    oneData['amount'] = pasteData['inv'][invId]['amount']
                                    localItemArray.push(oneData)
                                }
                            }
                            catch (e) {
                                console.log(invId, e)
                            }
                        }
                        oneNodeResult['Data']['INV'] = localItemArray;
                        let localPathArray = []
                        for (pathId of pasteData['loc'][nodeId]['paths']) {
                            try {
                                let oneData = {}
                                oneData['id'] = pathId
                                oneData['data'] = pasteData['path'][pathId]
                                localPathArray.push(oneData)
                            }
                            catch (e) {
                                console.log(pathId, e)
                            }
                        }
                        oneNodeResult['Data']['PATH'] = localPathArray;
                        oneNodeResult['nodeId'] = nodeId;
                        transformedData.push(oneNodeResult);
                    }
                    $('#jsonInputDiv').hide();
                }
                catch (e) {
                    errState = 1
                    console.log(e)
                    alert(langCompared['inputErr'][langNow]);
                }
                $('#jsonStrInput').val('');
                if (errState == 0) {
                    console.log(transformedData)
                    mutiNodeDataInput();
                }
            }
        }
        function jsonImport() {
            if (jsonImportState == 0) {
                $('#syncDiv').hide();
                $('#aimDiv').hide();
                $('#pathDiv').hide();
                $('#houseDiv').hide();
                $('#eliteDiv').hide();
                $('#searchNodeDiv').hide();

                $('#jsonInputDiv').show();
                lastSearchSlot = JSON.parse(JSON.stringify(searchSlot))
                searchSlot = {}
                searchResultShow()
                for (nodeId of Object.values(nodeMaping)) {
                    $('#' + nodeId).addClass('green');
                }
                jsonImportState = 1;
                $('#importDiv').css({ border: 'solid #ff0000 5px' });

            }
            else {
                showMsg(0);
                waitForClickNode = 0
                $('#syncDiv').show();
                $('#aimDiv').show();
                $('#pathDiv').show();
                $('#houseDiv').show();
                $('#eliteDiv').show();
                $('#searchNodeDiv').show();
                transformedData = {}
                $('#jsonInputDiv').hide();
                $('#jsonStrInput').val('');
                searchSlot = JSON.parse(JSON.stringify(lastSearchSlot))
                jsonImportState = 0;
                $('#importDiv').css({ border: 'solid #000000 5px' });
                $('.interactive-circle').attr('class', 'interactive-circle blackCircle black')
                $('.blackCircle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                searchResultShow()
            }
        }
        function cleanPath() {
            if (planningMethod == 'Path') {
                totalBAP = 0
                bAPEmptyCount = 0
                $('line[id*=PathPlanningPath]').remove()
                let bAPStr = 'bAP : ' + 0;
                showMsg(true, bAPStr);
            }
            else {
                for (id of pathFindingArray) $('#' + id).css({ 'background-color': '' });
                pathFindingArray = []
                history.replaceState({ id: 'defaultSetting' }, '', '?pathArray=[]' + '&lang=' + langNow);
            }
        }
        function showMsg(show, str = '') {
            $('#msgDiv').html(str + ' ');
            if (waitForClickNode) {
                $('#msgDiv').append($('<span>', { id: "skip", class: "link" }).html(' Skip'))
                $('#skip').click(function () {
                    console.log(transformedData[verifiedData.length]['nodeId'])
                    transformedData.splice(verifiedData.length, 1)
                    mutiNodeDataInput();
                })
            }
            if (show) $('#msgDiv').show();
            else $('#msgDiv').hide();
        }
        function showSettingPage(type, data) {
            $('#settingPage').show();
            $('#settingPage').html('')
            var windowFeatures = "width=50,height=50,resizable=yes,scrollbars=yes";
            var x = window.screenX + 100; // 主窗口的位置 + 100px
            var y = window.screenY + 100; // 主窗口的位置 + 100px
            var width = 50;
            var height = 50;
            myWindow = window.open('https://play.soulforged.net/api/res/' + data['id'] + '.png', data['name'], "width=" + width + ",height=" + height + ",left=" + x + ",top=" + y);
            if (myWindow) myWindow.focus();
            if (type == 'RES') {
                $('#settingPage')
                    .append($('<div>', { id: 'resourceTitleDiv', class: "nodeDataAreaTitle" })
                        .append(langCompared['unMatchedRes'][langNow] + data['name'])
                    )
                    .append($('<div>', { id: "resourceDataDiv", class: "nodeDataAreaContent", style: "flex-direction: column;height:100px;" })
                        .append($('<img>', { id: "resourceFig", class: "itemFig" }))
                        .append($('<div>', { id: 'resName' })
                            .append(data['name'])))


                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'noFoundBTN' }).append(langCompared['cantFind'][langNow]))
                        .append($('<div>', { class: 'emptyFlex' }))
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['ok'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                $('#resourceFig').hide();
                $('#noFoundBTN').click(function () {
                    $('#settingPage').hide();
                    if (myWindow) myWindow.close();
                    if (confirm(langCompared['issueConfirm'][langNow]) == false) dataMaping('RES');
                    else sendData('Issue', JSON.stringify(verifiedData));
                })
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    if (myWindow) myWindow.close();
                    if (confirm(langCompared['cancelConfirm'][langNow]) == false) dataMaping('RES');
                    else {
                        $('.interactive-circle green').attr('class', 'interactive-circle blackCircle green')
                        transformedData = []
                        verifiedData = []
                        recordNodeList = Object.values(jsonData);
                        resetNodeColor()
                    }
                })
                $('#saveBTN').hide();
                $('#resourceDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                $('#resourceDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0;font-size:20px;" })
                        .append(langCompared['filterByName'][langNow])
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                )
                $('#resourceDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append(langCompared['resourceList'][langNow]))
                $('#searchInput').keyup(function () {
                    let allResource = []
                    for (i in huntableAnimalList) {
                        if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = huntableAnimalList[i]
                            oneDict['url'] = staticPath + "static/cre/" + huntableAnimalList[i].replace(/ /g, '-') + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of foragingUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && i.includes('Seed') == false) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of gatheringUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of miningUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    for (i of woodCuttingUrl) {
                        if (i.toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                            let oneDict = {}
                            oneDict['name'] = i
                            oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                            allResource.push(oneDict)
                        }
                    }
                    filtiedResource(allResource);
                })
                let allResource = []
                for (i in huntableAnimalList) {
                    if (huntableAnimalList[i].toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(huntableAnimalList[i]) == false) {
                        let oneDict = {}
                        oneDict['name'] = huntableAnimalList[i]
                        oneDict['url'] = staticPath + "static/cre/" + huntableAnimalList[i].replace(/ /g, '-') + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                for (i of foragingUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(i) == false && i.includes('Seed') == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                for (i of gatheringUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(i) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                for (i of miningUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(i) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                for (i of woodCuttingUrl) {
                    if (i.toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempRes).includes(i) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg'
                        allResource.push(oneDict)
                    }
                }
                filtiedResource(allResource);
                function filtiedResource(dataList) {
                    $('#optionDataDiv').html('');
                    for (var i = 0; i < dataList.length; i++) {
                        appendResourceImage(i);
                    }

                    function appendResourceImage(resourceIndex) {
                        let figPath = dataList[resourceIndex]['url'];
                        let name = dataList[resourceIndex]['name'];

                        let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                            .append($('<img>', { class: "itemFig", src: figPath })
                                .click(function () {
                                    $('.info-tag').hide();
                                    $('#saveBTN').click(function () {
                                        if (myWindow) myWindow.close();
                                        $('#settingPage').hide();
                                        tempRes[data['id']] = dataList[resourceIndex]['name'];
                                        // console.log(dataList[resourceIndex]['name'])
                                        dataMaping('RES');
                                    })
                                    $('#saveBTN').show();
                                    $('#resourceFig').show();
                                    $('#resName').html(dataList[resourceIndex]['name'])
                                    $('#resourceFig').attr('src', dataList[resourceIndex]['url'])
                                    // console.log(dataList[resourceIndex]['name'])

                                })
                            );

                        // 綁定 mouseenter 和 mouseleave 事件
                        newDiv.mouseenter(function (e) {
                            $('.info-tag').text(name)
                                .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                        }).mouseleave(function () {
                            $('.info-tag').hide();
                        });

                        $('#optionDataDiv').append(newDiv);
                    }
                }
            }
            else if (type == 'CRE') {
                $('#settingPage')
                    .append($('<div>', { id: 'animalTitleDiv', class: "nodeDataAreaTitle" })
                        .append(langCompared['unMatchedCre'][langNow])
                    )
                    .append($('<div>', { id: "animalDataDiv", class: "nodeDataAreaContent", style: "flex-direction: column;height:100px;" })
                        .append($('<img>', { id: "resourceFig", class: "itemFig" }))
                        .append($('<div>', { id: 'resName' })
                            .append(data['name'])))

                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'noFoundBTN' }).append(langCompared['cantFind'][langNow]))
                        .append($('<div>', { class: 'emptyFlex' }))
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['ok'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                $('#resourceFig').hide();
                $('#noFoundBTN').click(function () {
                    $('#settingPage').hide();
                    if (myWindow) myWindow.close();
                    if (confirm(langCompared['issueConfirm'][langNow]) == false) dataMaping('CRE');
                    else sendData('Issue', JSON.stringify(verifiedData));
                })
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    if (myWindow) myWindow.close();
                    if (confirm(langCompared['cancelConfirm'][langNow]) == false) dataMaping('CRE');
                    else {
                        $('.interactive-circle green').attr('class', 'interactive-circle blackCircle green')
                        transformedData = []
                        verifiedData = []
                        recordNodeList = Object.values(jsonData);
                        resetNodeColor()
                    }
                })
                $('#animalDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                $('#animalDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0;font-size:20px;" })
                        .append(langCompared['filterByName'][langNow])
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                )
                $('#animalDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle" }).append(langCompared['creatureList'][langNow]))
                $('#searchInput').keyup(function () {
                    let newList = []

                    for (i of animalUrl) {
                        if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempCre).includes(i) == false && i != 'Fishing-Spot') {
                            let oneDict = {}
                            oneDict['name'] = i.replace(/-/g, ' ')
                            oneDict['url'] = staticPath + "static/cre/" + i + '.jpg'
                            newList.push(oneDict)
                        }
                    }
                    filtiedAnimal(newList);
                })
                let newList = []
                for (i of animalUrl) {
                    if (i.replace(/-/g, ' ').toLowerCase().includes($('#searchInput').val().toLowerCase()) && Object.values(tempCre).includes(i) == false && i != 'Fishing-Spot') {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['url'] = staticPath + "static/cre/" + i + '.jpg'
                        newList.push(oneDict)
                    }
                }
                filtiedAnimal(newList);
                function filtiedAnimal(dataList) {
                    $('#optionDataDiv').html('')
                    for (var i = 0; i < dataList.length; i++) {
                        appendAnimalImage(i);
                    }
                    function appendAnimalImage(animalIndex) {
                        let figPath = dataList[animalIndex]['url'];
                        let name = dataList[animalIndex]['name'];

                        let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                            .append($('<img>', { class: "itemFig", src: figPath })
                                .click(function () {
                                    $('.info-tag').hide();
                                    $('#saveBTN').click(function () {
                                        if (myWindow) myWindow.close();
                                        $('#settingPage').hide();
                                        tempCre[data['id']] = dataList[animalIndex]['name'];
                                        // console.log(dataList[animalIndex]['name'])
                                        dataMaping('CRE');
                                    })
                                    $('#saveBTN').show();
                                    $('#resourceFig').show();
                                    $('#resName').html(dataList[animalIndex]['name'])
                                    $('#resourceFig').attr('src', dataList[animalIndex]['url'])
                                    // console.log(dataList[animalIndex]['name'])

                                })
                            );

                        // 綁定 mouseenter 和 mouseleave 事件
                        newDiv.mouseenter(function (e) {
                            $('.info-tag').text(name)
                                .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                        }).mouseleave(function () {
                            $('.info-tag').hide();
                        });

                        $('#optionDataDiv').append(newDiv);
                    }
                }
            }
            else if (type == 'INV') {
                $('#settingPage')
                    .append($('<div>', { id: 'itemTitleDiv', class: "nodeDataAreaTitle" })
                        .append(langCompared['unMatchedInv'][langNow])
                    )
                    .append($('<div>', { id: "itemDataDiv", class: "nodeDataAreaContent", style: "flex-direction: column;height:100px;" })
                        .append($('<img>', { id: "resourceFig", class: "itemFig" }))
                        .append($('<div>', { id: 'resName' })
                            .append(data['name'])))

                    .append($('<div>', { class: "form-head", style: "justify-content: flex-end;width: auto;" })
                        .append($('<button>', { id: 'noFoundBTN' }).append(langCompared['cantFind'][langNow]))
                        .append($('<div>', { class: 'emptyFlex' }))
                        .append($('<button>', { id: 'saveBTN' }).append(langCompared['ok'][langNow]))
                        .append($('<button>', { id: 'backBTN' }).append(langCompared['cancel'][langNow]))
                    )
                $('#resourceFig').hide();
                $('#noFoundBTN').click(function () {
                    $('#settingPage').hide();
                    if (myWindow) myWindow.close();
                    if (confirm(langCompared['issueConfirm'][langNow]) == false) dataMaping('INV');
                    else sendData('Issue', JSON.stringify(verifiedData));
                })
                $('#backBTN').click(function () {
                    $('#settingPage').hide();
                    if (myWindow) myWindow.close();
                    if (confirm(langCompared['cancelConfirm'][langNow]) == false) dataMaping('INV');
                    else {
                        $('.interactive-circle green').attr('class', 'interactive-circle blackCircle green')
                        transformedData = []
                        verifiedData = []
                        recordNodeList = Object.values(jsonData);
                        resetNodeColor()
                    }
                })
                $('#itemDataDiv').after($('<div>', { id: "optionDataDiv", class: "nodeDataAreaContent", style: "max-height: 400px; overflow: scroll;" }))
                $('#itemDataDiv').after(
                    $('<div>', { id: "searchDiv", class: "nodeDataAreaContent", style: "border-bottom-left-radius:0;border-bottom-right-radius:0" })
                        .append($('<div>', { id: 'searchMethodDiv', style: "font-size:20px" }).append(langCompared['filterByCategory'][langNow]))
                        .append($('<select>', { id: 'typeSel', class: "qtyDiv", style: "font-size:20px; padding:0px; height:30px" }))
                        .append($('<input>', { id: 'searchInput', type: "text", class: "text" }))
                        .append($('<button>', { id: 'backBTN', style: 'width: auto;' }).append(langCompared['switchTo'][langNow] + langCompared['filterByName'][langNow]).click(function () {
                            if (searchMethodState == 'type') {
                                $('#optionDataDiv').html('');
                                searchMethodState = 'name';
                                $('#backBTN').html(langCompared['switchTo'][langNow] + langCompared['filterByCategory'][langNow])
                                $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                                $('#typeSel').hide()
                                $('#searchInput').show()
                            }
                            else {
                                $('#searchInput').val('');
                                let allItem = [];
                                for (i of cookedUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'cooked'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of corpseUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'corpse'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of furnitureUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'furniture'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of doctoringUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'doctoring'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of equipmentUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'equipment'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of foragingUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'foraging'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of gatheringUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'gathering'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of medicalUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'medical'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of miningUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'mining'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of otherUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'other'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of toolUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'tool'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of carpentryUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'carpentry'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of woodCuttingUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'woodcutting'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                for (i of smithingUrl) {
                                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                        let oneDict = {}
                                        oneDict['name'] = i.replace(/-/g, ' ')
                                        oneDict['type'] = 'smithing'
                                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                        allItem.push(oneDict)
                                    }
                                }
                                filtiedResource(allItem);
                                searchMethodState = 'type';
                                $('#backBTN').html(langCompared['switchTo'][langNow] + langCompared['filterByName'][langNow])
                                $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                                $('#typeSel').show()
                                $('#searchInput').hide()
                            }

                        }))
                )
                if (searchMethodState == 'name') {
                    $('#backBTN').html(langCompared['switchTo'][langNow] + langCompared['filterByCategory'][langNow])
                    $('#searchMethodDiv').html(langCompared['filterByName'][langNow])
                    $('#typeSel').hide()
                    $('#searchInput').show()
                }
                else {
                    $('#backBTN').html(langCompared['switchTo'][langNow] + langCompared['filterByName'][langNow])
                    $('#searchMethodDiv').html(langCompared['filterByCategory'][langNow])
                    $('#typeSel').show()
                    $('#searchInput').hide()
                }
                $('#itemDataDiv').after($('<div>', { id: "optionTitleDiv", class: "nodeDataAreaTitle", style: "font-size:20px" }).append(langCompared['itemList'][langNow]))
                for (i in itemTypeTranslate) {
                    if (langNow == 'zh') $('<option>', { value: i }).append(itemTypeTranslate[i]).appendTo($('#typeSel'))
                    else if (langNow == 'en') $('<option>', { value: i }).append(i).appendTo($('#typeSel'))
                }
                function appendItemImage(itemIndex, dataList) {
                    let figPath = dataList[itemIndex]['url'];
                    let name = dataList[itemIndex]['name'];

                    let newDiv = $('<div>', { class: "form-head", style: "justify-content: center;width: auto;" })
                        .append($('<img>', { class: "itemFig", src: figPath })
                            .click(function () {
                                $('.info-tag').hide();
                                $('#saveBTN').click(function () {
                                    if (myWindow) myWindow.close();
                                    $('#settingPage').hide();
                                    tempInv[data['id']] = dataList[itemIndex]['name'];
                                    // console.log(dataList[itemIndex]['name'])
                                    if (indoorState == 1) mappingIndoorINV()
                                    else dataMaping('INV');
                                })
                                $('#saveBTN').show();
                                $('#resourceFig').show();
                                $('#resName').html(dataList[itemIndex]['name'])
                                $('#resourceFig').attr('src', dataList[itemIndex]['url'])
                                // console.log(dataList[itemIndex]['name'])
                            })
                        );

                    // 綁定 mouseenter 和 mouseleave 事件
                    newDiv.mouseenter(function (e) {
                        $('.info-tag').text(name)
                            .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                    }).mouseleave(function () {
                        $('.info-tag').hide();
                    });

                    $('#optionDataDiv').append(newDiv);
                }
                function filtiedResource(dataList) {
                    $('#optionDataDiv').html('')
                    for (var i = 0; i < dataList.length; i++) {
                        if (dataList[i]['type'] == $('#typeSel').val()) appendItemImage(i, dataList);
                    }

                }
                let allItem = [];
                for (i of cookedUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'cooked'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of corpseUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'corpse'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of doctoringUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'doctoring'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of furnitureUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'furniture'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of equipmentUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'equipment'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of foragingUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'foraging'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of gatheringUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'gathering'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of medicalUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'medical'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of miningUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'mining'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of otherUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'other'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of toolUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'tool'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of carpentryUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'carpentry'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of woodCuttingUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'woodcutting'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }
                for (i of smithingUrl) {
                    if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                        let oneDict = {}
                        oneDict['name'] = i.replace(/-/g, ' ')
                        oneDict['type'] = 'smithing'
                        oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                        allItem.push(oneDict)
                    }
                }

                $('#typeSel').change(function (event) {
                    filtiedResource(allItem);
                })
                filtiedResource(allItem);
                $('#searchInput').keyup(() => {
                    if ($('#searchInput').val().length >= 1) {
                        $('#optionDataDiv').html('')

                        let allItem = [];
                        for (i of cookedUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'cooked'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of corpseUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'corpse'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of furnitureUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'furniture'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of doctoringUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'doctoring'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of equipmentUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'equipment'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of foragingUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'foraging'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of gatheringUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'gathering'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of medicalUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'medical'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of miningUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'mining'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of otherUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'other'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of toolUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'tool'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of carpentryUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'carpentry'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of woodCuttingUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'woodcutting'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }
                        for (i of smithingUrl) {
                            if (Object.values(tempInv).includes(i.replace(/-/g, ' ')) == false) {
                                let oneDict = {}
                                oneDict['name'] = i.replace(/-/g, ' ')
                                oneDict['type'] = 'smithing'
                                oneDict['url'] = staticPath + "static/res/" + i + '.jpg';
                                allItem.push(oneDict)
                            }
                        }

                        let newList = []
                        for (i in allItem) {
                            if (allItem[i]['name'].toLowerCase().includes($('#searchInput').val().toLowerCase())) {
                                let oneDict = {}
                                oneDict['name'] = allItem[i]['name']
                                oneDict['url'] = allItem[i]['url']
                                newList.push(oneDict)
                            }
                        }
                        for (i in newList) {
                            appendItemImage(i, newList);
                        }
                    }
                    else $('#optionDataDiv').html('');
                })
            }
        }
        function dataMaping(type) {
            if (type == 'RES') {
                for (i of verifiedData) {
                    for (resData of i['Data']['RES']) {
                        if (resData['id'] in tempRes == false) {
                            for (typeName in jsonData) {
                                if (typeName != 'animalList') {
                                    if (resData['name'].replace(/ /g, '-') in jsonData[typeName]) {
                                        tempRes[resData['id']] = resData['name'];
                                        break
                                    }
                                }
                            }
                            if (resData['id'] in tempRes == false) {
                                showSettingPage('RES', resData);
                                return
                            }
                        }
                    }
                }
                for (let key in resDataDict) {
                    if (resDataDict.hasOwnProperty(key) && tempRes.hasOwnProperty(key)) {
                        delete tempRes[key];
                    }
                }
                if (Object.keys(tempRes).length != 0) {
                    sendData('RES', JSON.stringify(tempRes))
                    Object.assign(resDataDict, tempRes);
                }
                tempRes = JSON.parse(JSON.stringify(resDataDict))
                dataMaping('CRE')
            }
            else if (type == 'CRE') {
                for (i of verifiedData) {
                    for (creData of i['Data']['CRE']) {
                        if (creData['id'] in tempCre == false) {
                            showSettingPage('CRE', creData);
                            return
                        }
                    }
                }
                for (let key in creDataDict) {
                    if (creDataDict.hasOwnProperty(key) && tempCre.hasOwnProperty(key)) {
                        delete tempCre[key];
                    }
                }
                if (Object.keys(tempCre).length != 0) {
                    // console.log(tempCre)
                    sendData('CRE', JSON.stringify(tempCre))
                    Object.assign(creDataDict, tempCre);
                }
                tempCre = JSON.parse(JSON.stringify(creDataDict))
                dataMaping('INV')
            }
            else if (type == 'INV') {
                for (i of verifiedData) {
                    for (invData of i['Data']['INV']) {
                        if (invData['id'] in tempInv == false) {
                            for (typeName in jsonData) {
                                if (typeName != 'animalList' && typeName != 'animalUrl') {
                                    if (invData['name'].replace(/ /g, '-') in jsonData[typeName]) {
                                        tempInv[invData['id']] = invData['name'];
                                        break
                                    }
                                }
                            }
                            if (invData['id'] in tempInv == false) {
                                showSettingPage('INV', invData);
                                return
                            }
                        }
                    }
                }
                for (let key in invDataDict) {
                    if (invDataDict.hasOwnProperty(key) && tempInv.hasOwnProperty(key)) {
                        delete tempInv[key];
                    }
                }
                if (Object.keys(tempInv).length != 0) {
                    // console.log(tempInv)
                    sendData('INV', JSON.stringify(tempInv))
                    Object.assign(invDataDict, tempInv);
                }
                tempInv = JSON.parse(JSON.stringify(invDataDict))
                let outputRecord = []
                let outputInfo = {}
                if (userName == '') {
                    let name = prompt(langCompared['yourName'][langNow] + '？')
                    if (name != null && name != '') userName = name;
                    else {
                        userName = ''
                    }
                }
                sendingQty = verifiedData.length;
                for (oneData of verifiedData) {
                    if (oneData['timestamp'] <= rawData[oneData['mapId']]['recordTime']) continue;
                    let outputNode = {}
                    let outputCre = []
                    let outputRes = []
                    let outputInv = []
                    let oneInfo = {}
                    for (oneCreOri of oneData['Data']['CRE']) {
                        let hasShow = 0;
                        for (oneReadyCreIndex in outputCre) {
                            if (outputCre[oneReadyCreIndex]['name'] == tempCre[oneCreOri['id']] && outputCre[oneReadyCreIndex]['activity'] != oneCreOri['nonAggressive']) {
                                outputCre[oneReadyCreIndex]['quentity'] += 1;
                                hasShow = 1;
                                break
                            }
                        }
                        if (hasShow == 0) {
                            let oneCreData = {}
                            oneCreData['name'] = tempCre[oneCreOri['id']]
                            oneCreData['quentity'] = 1
                            if (oneCreOri['nonAggressive']) oneCreData['activity'] = 0
                            else oneCreData['activity'] = 1
                            outputCre.push(oneCreData)
                        }
                    }
                    for (oneResOri of oneData['Data']['RES']) {
                        let oneResData = {}
                        oneResData['name'] = tempRes[oneResOri['id']]
                        if (oneResOri['density'] > 4) oneResOri['density'] = 4
                        oneResData['quentity'] = oneResOri['density']
                        outputRes.push(oneResData)
                    }
                    for (oneInvOri of oneData['Data']['INV']) {
                        let hasShow = 0;
                        for (oneReadyInvIndex in outputInv) {
                            if (outputInv[oneReadyInvIndex]['name'] == tempInv[oneInvOri['id']] &&
                                oneInvOri['durabilityStageName'] != "Rotten" &&
                                oneInvOri['durabilityStageName'] != "Spoiling" &&
                                oneInvOri['durabilityStageName'] != "Ruined" &&
                                oneInvOri['durabilityStageName'] != "Battered") {
                                outputInv[oneReadyInvIndex]['quentity'] += oneInvOri['amount'];
                                hasShow = 1;
                                break
                            }
                        }
                        if (hasShow == 0 && oneInvOri['durabilityStageName'] != "Rotten" &&
                            oneInvOri['durabilityStageName'] != "Spoiling" &&
                            oneInvOri['durabilityStageName'] != "Ruined" &&
                            oneInvOri['durabilityStageName'] != "Battered") {
                            let oneInvData = {}
                            oneInvData['name'] = tempInv[oneInvOri['id']]
                            oneInvData['quentity'] = oneInvOri['amount']
                            outputInv.push(oneInvData)
                        }
                    }
                    outputNode['area'] = oneData['mapId']
                    outputNode['animal'] = outputCre
                    outputNode['resource'] = outputRes
                    outputNode['item'] = outputInv
                    if (userName != '') {
                        outputNode['recorder'] = userName
                        oneInfo['recorder'] = userName
                    }
                    // outputRecord.push(outputNode)

                    sendData('Record', JSON.stringify(outputNode))
                    oneInfo['timestamp'] = oneData['timestamp']
                    oneInfo['space'] = oneData['space']
                    oneInfo['path'] = oneData['Data']['PATH']
                    outputInfo[oneData['mapId']] = oneInfo
                }
                // sendData('Record',JSON.stringify(outputRecord))
                if (Object.keys(outputInfo).length != 0) sendData('Info', JSON.stringify(outputInfo))

            }
        }
        function sendData(type, data) {
            fetch('/checkVer')
                .then(response => response.text())
                .then(serverVersion => {
                    // 比較伺服器版本和當前版本
                    if (serverVersion !== version) {
                        // 如果版本不一致，提示用戶
                        let update = confirm(langCompared['checkUpdate'][langNow]);
                        if (update) {
                            // 如果用戶選擇更新，則重新整理網頁
                            window.location.reload();
                        }
                    }
                    else {
                        showMsg(1, langCompared['uploading'][langNow])
                        console.log(data)
                        var formData = new FormData();
                        formData.append('type', type);
                        formData.append('data', data);
                        fetch('/JsonImput', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                if (response.ok) {
                                    // HTTP狀態碼在200-299之間，表示請求成功
                                    return response.text();  // 你可以用 response.json() 如果後端返回的是 JSON 格式
                                } else {
                                    // HTTP狀態碼在300以上，表示請求失敗
                                    throw new Error('Server response was not ok: ' + response.statusText);
                                }
                            })
                            .then(textData => {
                                // 這裡的 data 是上面的 response.text() 的結果
                                if (textData.length == 13) {
                                    if (type == 'Record' || indoorState == 1 || nodeIdChangeState == 1) {
                                        sendingCount += 1
                                        verifiedData = []
                                        indoorState = 0;
                                        nodeIdChangeState = 0;

                                        console.log(sendingCount, sendingQty)
                                        if (sendingCount == sendingQty) {
                                            updateRawdata()
                                            sendingCount = 0;
                                            sendingQty = 0;
                                            showMsg(1, langCompared['success'][langNow])
                                            setTimeout(function () {
                                                showMsg(0)
                                            }, 5000)
                                        }
                                    }
                                }
                                else if (textData == 'dataErr') {
                                    showMsg(0)
                                    alert(langCompared['dataErr'][langNow])
                                }
                                else {
                                    throw new Error('Server response was not expected: ' + textData);
                                }
                            })
                            .catch(error => {
                                // 這裡處理網絡錯誤和上面拋出的錯誤
                                showMsg(0)
                                console.error('There was a problem with the fetch operation:', error);
                                alert(langCompared['serverErr'][langNow]);
                            });
                    }
                })
                .catch(error => {
                    console.error('server error:', error);
                });


        }
        function mutiNodeDataInput() {
            if (verifiedData.length != transformedData.length) {
                for (index = verifiedData.length; index < transformedData.length; index++) {
                    if (transformedData[index]['nodeId'] in nodeMaping == false) {
                        console.log(transformedData)
                        waitForClickNode = 1
                        showMsg(1, langCompared['node'][langNow] + ' ' + transformedData[index]['nodeId'] + langCompared['nodeUnmatch'][langNow] + '(' + verifiedData.length + ' / ' + transformedData.length + ')');
                        break
                    }
                    else {
                        transformedData[index]['mapId'] = nodeMaping[transformedData[index]['nodeId']];
                        verifiedData.push(transformedData[index]);
                        if (nodeNow !== '') $('#' + nodeNow).attr('class', 'interactive-circle blackCircle orange')

                        nodeNow = transformedData[index]['mapId'];
                        $('#' + nodeNow).attr('class', 'interactive-circle redCircle orange')
                        $('.blackCircle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                        $('.redCircle').css('border', 5 / nodeScaleNow + 'px #ff0000 solid')
                        showMsg(0)
                    }
                }
            }
            if (verifiedData.length == transformedData.length) {
                nodeNow = ''
                showMsg(0)
                setTimeout(function () {
                    $('.interactive-circle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                    if (confirm(langCompared['pathConfirm'][langNow])) {
                        let dataContent = []
                        for (i of verifiedData) {
                            if (i['nodeId'] in lastnodeMaping == false) {
                                let oneData = {}
                                oneData['authNodeId'] = i['nodeId']
                                oneData['mapNodeId'] = i['mapId']
                                dataContent.push(oneData)
                                nodeMaping[i['nodeId']] = i['mapId']
                            }
                        }
                        console.log(dataContent)
                        if (dataContent.length != 0) sendData('nodeId', JSON.stringify(dataContent));
                        recordNodeList = Object.values(nodeMaping);
                        lastnodeMaping = JSON.parse(JSON.stringify(nodeMaping))
                        jsonImport()
                        console.log(verifiedData);
                        transformedData = [];
                        dataMaping('RES');
                    }
                    else {
                        $('.interactive-circle orange').attr('class', 'interactive-circle blackCircle orange')
                        $('.interactive-circle green').attr('class', 'interactive-circle blackCircle green')
                        transformedData = []
                        verifiedData = []
                        nodeMaping = JSON.parse(JSON.stringify(lastnodeMaping))
                        recordNodeList = Object.values(nodeMaping);
                        jsonImport()
                    }
                }, 0)

            }
        }

        function dijkstra(graph, start) { 
            // from https://patrickkarsh.medium.com/dijkstras-shortest-path-algorithm-in-javascript-1621556a3a15
            let lastNode = '';
            let resultShow = 0;
            let distances = {};
            let visited = new Set();
            let nodes = Object.keys(graph);
            for (let node of nodes) {
                distances[node] = Infinity;
            }
            distances[start] = 0;
            while (nodes.length) {
                nodes.sort((a, b) => distances[a] - distances[b]);
                let closestNode = nodes.shift();
                if (distances[closestNode] === Infinity) break;
                visited.add(closestNode);
                for (let neighbor in graph[closestNode]) {
                    if (!visited.has(neighbor)) {
                        let newDistance = distances[closestNode] + graph[closestNode][neighbor];
                        if (newDistance < distances[neighbor]) {
                            distances[neighbor] = newDistance;
                            if (neighbor == finalNode) {
                                let nodepair = [closestNode,neighbor]
                                nodepair.sort(customSort);
                                pathResult[neighbor] = [nodepair[0],nodepair[1],graph[closestNode][neighbor]]
                                lastNode = closestNode
                                resultShow = 1
                            }
                        }
                    }
                }
                
            }
            finalNode = lastNode
            // Return the shortest distance from the start node to all nodes
            if(resultShow) return distances;
            else return null;
        }
        function findShortCuts(start, end) {
            
            let graph = {};
            for (node of recordNodeList) {
                if(node != "house") graph[node] = {};
            }

            for (path of mapRouteMain) {
                if (path.bAP) {
                    if (graph[path.start] && graph[path.end]) {
                        graph[path.start][path.end] = path.bAP;
                        graph[path.end][path.start] = path.bAP;
                    }
                }
            }

            for (path of mapRouteTT) {
                if (path.bAP) {
                    if (graph[path.start] && graph[path.end]) {
                        graph[path.start][path.end] = path.bAP;
                        graph[path.end][path.start] = path.bAP;
                    }
                }
            }

            for (path of mapRouteMH) {
                if (path.bAP) {
                    if (graph[path.start] && graph[path.end]) {
                        graph[path.start][path.end] = path.bAP;
                        graph[path.end][path.start] = path.bAP;
                    }
                }
            }
            // if(start in graph == false || end in graph == false){
            //     console.log('Err')
            //     return
            // }
            graph["Q21"]["M1"] = 0
            graph["M1"]["Q21"] = 0
            graph["M36"]["Q62"] = 0
            graph["Q62"]["M36"] = 0
            //graph["M24"]["Q56"] = 0
            //graph["Q56"]["M24"] = 0
            graph["M132"]["FT8"] = 0
            graph["FT8"]["M132"] = 0
            graph["H1"]["TT2"] = 0
            graph["TT2"]["H1"] = 0
            graph["SM1"]["JP14"] = 0
            graph["JP14"]["SM1"] = 0
            graph["SM25"]["GoP1"] = 0
            graph["GoP1"]["SM25"] = 0
            graph["SM36"]["BGP1"] = 0
            graph["BGP1"]["SM36"] = 0
            graph["SM50"]["WV10"] = 0
            graph["WV10"]["SM50"] = 0
            //graph["MHHW11"]["O28"] = 0
            //graph["O28"]["MHHW11"] = 0
            pathResult = {};
            finalNode = end;
            let bAPStr = 'bAP : ';
            // totalBAP = 0;
            let distances = 0
            while(finalNode != start){
                distances = dijkstra(graph, start);
                if(!distances){
                    alert(langCompared['cannotReach'][langNow])
                    return
                }
            }

            for(i of Object.values(pathResult)){
                let map = ''
                if(mapRouteMain.some(item => item.start === i[0]))map = 'Main'
                else if(mapRouteMH.some(item => item.start === i[0]))map = 'MH'
                else if(mapRouteTT.some(item => item.start === i[0]))map = 'TT'
                else console.log('Err')
                if (i[2] && $('#'+i[0]+'PathPlanningPath'+i[1]).length == 0){
                    drawLineBetweenCircles(i[0], i[1], '#FF0000', '8px', map, 'PathPlanningPath')
                    appendBAP({'start':i[0],'end':i[1],'bAP':i[2]})
                    totalBAP += i[2]
                } 
            }
            bAPStr += Math.round(totalBAP * 100) / 100;
            showMsg(true, bAPStr);
            // console.log(distances[end])
            // console.log(Object.values(pathResult))
        }
        
        function logIn(){
            urlNow = new URL(location.href);
            let herfStr = '/login?callback='
            $('#waitMessage').show();
            if(urlNow.searchParams.has('houseId'))herfStr += '&houseId='+urlNow.searchParams.get('houseId')
            window.location.href = herfStr
        }
        function logOut(){
            urlNow = new URL(location.href);
            let herfStr = '/logout?callback='
            $('#waitMessage').show();
            window.location.href = herfStr
        }
        function signUp(){
            if($('#userNameInput').val() == ''){
                if(confirm('No nickname entered, cancel?')){
                    $('#userNameInput').val('')
                }
            }
            else{
                $('#waitMessage').show();
                jsonFromBackend['username'] = $('#userNameInput').val()
                let formData = new FormData();
                formData.append('userName',$('#userNameInput').val())
                fetch('/signUp', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        response.text().then(text =>{
                            $('#userNameInput').val('')
                            $('#siginPage').hide()
                            resetHousePage()
                        })
                    })
            }
        }
        function housePageShow(){
            $('#infoPage').hide();
            if($('#houseListPage').is(':visible'))$('#houseListPage').hide()
            else $('#houseListPage').show()
            if(jsonFromBackend['username'] == 'undefined'){
                $('#siginPage').show()
                $('#signIn').hide()
                $('#signUp').show()
            }
            else if(jsonFromBackend['username'] == 'unSigned'){
                $('#waitMessage').hide();
                $('#siginPage').show()
                $('#signUp').hide()
                $('#signIn').show()
            }
            else resetHousePage();
        }
        function houseAddingForm(){
            $('#houseList').hide();
            $('#houseAddingDiv').show();
            $('#houseIdInput').focus();
        }
        function resetHousePage(){
            $('#houseList').show();
            $('#infoPage').hide();
            $('#infoPage').html('');
            $('#houseAddingDiv').hide();
            $('#houseIdInput').val('');
            $('#houseNameInput').val('');
            $('#houseLocationInput').val('');
            $('#houseIdInput').attr('disabled',false);
            $('#houseNameInput').attr('disabled',false);
            $('#houseLocationInput').attr('disabled',false);
            $('#houseFormBTN').show();
            showMsg(0);
            $('#houseList').html('');
            let formedHouseData = {}
            for(i in houseListObject){
                if(houseListObject[i]['location'] in formedHouseData == false) formedHouseData[houseListObject[i]['location']] = {}
                formedHouseData[houseListObject[i]['location']][i] = houseListObject[i]['name']
            }
            $('#houseList').append($('<div>',{style:'width:100%;display:flex;'})
                .append($('<div>',{class:'storage-button addHouse',onclick:'houseAddingForm()'}).html('ADD')))
            for(i in formedHouseData){
                $('#houseList').append($('<div>',{class:'storage-location-title'}).html(i))
                for(p in formedHouseData[i]){
                    $('#houseList').append($('<div>',{id:p,class:'storage-button',onclick:'houseOnClick("'+p+'")'}).html(formedHouseData[i][p]))
                }
            }
            // $('#houseList').append($('<div>',{id:'houseAddBTN',class:'houseLabel addHouse',onclick:'houseAddingForm()'}).html('ADD'))
            // for(i in houseListObject){
            //     $('#houseAddBTN').before($('<div>',{id:i,class:'houseLabel',onclick:'houseOnClick("'+i+'")'})
            //         .append($('<div>').html(i))
            //         .append($('<div>').html(houseListObject[i]['name']))
            //         .append($('<div>').html(houseListObject[i]['location']))
            //         )
            // }
            for (i in searchSlot){
                let slot = searchSlot[i]['slot']
                let type = searchSlot[i]['type']
                let name = searchSlot[i]['name']
                if (type == 'item'){
                    for (areaID in houseListObject) {
                        if(areaID in rawData == false) continue;
                        if (rawData[areaID]['recordTime'] == 1697212800000) continue;
                        if (rawData[areaID]['item'].length != 0) {
                            for (itemID in rawData[areaID]['item']) {
                                if (rawData[areaID]['item'][itemID]['name'] == name && rawData[areaID]['item'][itemID]['quentity'] != 0) {
                                    if ($('#circleSearchDisplay' + slot).val() == langCompared['border'][langNow]) $('#' + areaID).addClass('greenCircle');
                                    else {
                                        $('#' + areaID).removeClass('black');
                                        $('#' + areaID).addClass('green');
                                    }
                                }
                            }
                        }
                    }
                }
                else if (type == 'time') {
                    let displaySite = ''
                    if ($('#circleSearchDisplay' + slot).val() == langCompared['fill'][langNow]){
                        displaySite = 'inner';
                        recordTimeShow('inner');
                    } 
                    else{
                        displaySite = 'outter';
                        recordTimeShow('outter');
                    } 
                    for(areaId in houseListObject){
                        if(areaId in rawData == false) continue;
                        let nowTime = Date.now();
                        let timeDef = nowTime - rawData[areaId]['recordTime'];
                        let classStr = $('#' + areaId).attr('class') + ' '

                        if (rawData[areaId]['recordTime'] == 1697212800000) {
                            classStr += 'black'
                        }
                        else if (timeDef >= 72000000) {
                            classStr += 'red'
                        }
                        else if (timeDef < 72000000 && timeDef > 10800000) {
                            classStr += 'orange'
                        }
                        else if (timeDef <= 10800000 && timeDef > 1800000) {
                            classStr += 'yellow'
                        }
                        else if (timeDef <= 1800000) {
                            classStr += 'green'
                        }
                        if (displaySite == 'outter') {
                            classStr += 'Circle'
                        }

                        $('#' + areaId).attr('class', classStr)
                    }

                }
            }
        }
        function addingHouse(func){
            if(func == 'submit'){
                let inputErr = 0
                let housedata = {'func':'subcribe'}
                if($('#houseLocationInput').val() && $('#houseLocationInput').val().trim()) housedata['location'] = $('#houseLocationInput').val();
                else inputErr = 3
                if($('#houseNameInput').val() && $('#houseNameInput').val().trim()) housedata['name'] = $('#houseNameInput').val();
                else inputErr = 2
                if($('#houseIdInput').val() && $('#houseIdInput').val().trim()) housedata['id'] = $('#houseIdInput').val();
                else inputErr = 1
                if(inputErr == 0){
                    $('#houseIdInput').attr('disabled',true);
                    $('#houseNameInput').attr('disabled',true);
                    $('#houseLocationInput').attr('disabled',true);
                    $('#houseFormBTN').hide();
                    showMsg(1,'Uploading in progress...');
                    formData = new FormData();
                    formData.append('housedata', JSON.stringify(housedata));
                    fetch('/houseSubcribe', {method: 'POST', body: formData})
                        .then(response => {return response.text();})
                        .then(data => {
                            try{
                                houseListObject = JSON.parse(data.replace(/'/g,'"'))
                                resetHousePage();
                            }
                            catch{
                                console.log(data)
                                alert(langCompared['serverErr'][langNow]);
                                resetHousePage();
                            }
                        })
                }
                else if(inputErr == 1) alert('Please enter the house ID.')
                else if(inputErr == 2) alert('Please enter the house name.')
                else if(inputErr == 3) alert('Please enter the house location.')
            }
            else resetHousePage();

        }
        function houseOnClick(id){
            let selectedHouseId = id
            if(selectedHouseId in rawData == false){
                if(jsonFromBackend['nodeMaping'][id] in rawData == false){
                    if(confirm('This node has no data yet. Would you like to unsubscribe?')){
                        delPanding = 1
                        delHouse(id);
                        return;
                    }
                    else return;
                }
                else selectedHouseId = jsonFromBackend['nodeMaping'][id];
            }
            let nowTime = Date.now();
            let timeDef = nowTime - rawData[selectedHouseId]['recordTime'];
            $('#infoPage').html('');
            function formatToLocalTime(timestamp) {
                let date = new Date(timestamp);
                return date.toLocaleString(); // 轉換為本地時間格式
            }
            let timeStr =langCompared['lastUpdate'][langNow] + '：';
            if (rawData[selectedHouseId]['recordTime'] == 1697212800000) {
                timeStr = id + ' ' + langCompared['noRecord'][langNow];
            }
            else {
                timeStr += formatToLocalTime(rawData[selectedHouseId]['recordTime']) + ' (';
                let defDay = Math.floor(timeDef / (1000 * 60 * 60 * 24));
                let defHourMilli = (timeDef % (1000 * 60 * 60 * 24))
                let defHour = Math.floor(defHourMilli / (1000 * 60 * 60));
                let defMinute = Math.floor((timeDef % (1000 * 60 * 60)) / (1000 * 60))
                if (defDay != 0) timeStr += defDay + ' ' + langCompared['day'][langNow] + ' ';
                if (defHour != 0) timeStr += defHour + ' ' + langCompared['hour'][langNow] + ' ';
                timeStr += defMinute + ' ' + langCompared['min'][langNow];

                if ('recorder' in rawData[selectedHouseId]) timeStr += langCompared['by'][langNow] + ' ' + rawData[selectedHouseId]['recorder'] + ' ' + langCompared['record'][langNow]
            }
            let itemData = $('<div>', { id: 'itemShowDiv', class: "nodeDataAreaContent" });
            if ('item' in rawData[selectedHouseId] && rawData[selectedHouseId]['item'].length != 0) {
                for (itemID in rawData[selectedHouseId]['item']) {
                    if('subtotals' in rawData[selectedHouseId]['item'][itemID]){
                        let QCArray = []
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][9])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][10])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][11])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][6])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][7])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][8])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][3])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][4])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][5])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][0])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][1])
                        QCArray.push(rawData[selectedHouseId]['item'][itemID]['subtotals'][2])
                        for(itemQCGroup in QCArray){
                            if(QCArray[itemQCGroup] == 0)continue;
                            let QCColor = {};
                            QCColor['Q'] = qualityColor[Math.floor((Number(itemQCGroup))/3)]
                            QCColor['C'] = conditionColor[(Number(itemQCGroup)+1)%3]
                            let figPath = staticPath + "static/res/" + rawData[selectedHouseId]['item'][itemID]['name'].replace(/ /g, '-') + '.jpg';
                            let itemFig = $('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                                .append($('<img>', { class: 'itemFig', src: figPath }))
                                .append($('<div>', {
                                    class: "itemQty",
                                    style: "cursor: auto; border:solid 5px " + QCColor['C']
                                }
                                ).append(QCArray[itemQCGroup]))
                                .append($('<div>', {
                                    id: String(Math.floor((Number(itemQCGroup)+1)/4))+' C:'+String((Number(itemQCGroup)+1)%4),
                                    class: "itemQty",
                                    style: "align-items: flex-start; justify-content: flex-start;"})
                                    .append($('<div>', {style: "background: "+QCColor['Q']+";width: 12px;height: 12px;margin: 2px;border-radius: 50%;" + QCColor['C']}))
                                )
                            let name = rawData[selectedHouseId]['item'][itemID]['name'];
                            // 綁定 mouseenter 和 mouseleave 事件
                            itemFig.mouseenter(function (e) {
                                $('.info-tag').text(name)
                                    .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                            }).mouseleave(function () {
                                $('.info-tag').hide();
                            });

                            itemData.append(itemFig)    
                        }
                        
                            
                    }
                    else{
                        let figPath = staticPath + "static/res/" + rawData[selectedHouseId]['item'][itemID]['name'].replace(/ /g, '-') + '.jpg';
                        let itemFig = $('<div>', { class: "form-head figDiv", style: "justify-content: center;width: auto; padding:0;" })
                            .append($('<img>', { class: 'itemFig', src: figPath }))
                            .append($('<div>', {
                                class: "itemQty blackBorder",
                                style: "cursor: auto;"
                            }
                            ).append(rawData[selectedHouseId]['item'][itemID]['quentity']))
                        let name = rawData[selectedHouseId]['item'][itemID]['name'];
                        // 綁定 mouseenter 和 mouseleave 事件
                        itemFig.mouseenter(function (e) {
                            $('.info-tag').text(name)
                                .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                        }).mouseleave(function () {
                            $('.info-tag').hide();
                        });

                        itemData.append(itemFig)    
                    }
                    

                        
                }
            }
            $('#infoPage')
                .append($('<div>', { id: 'showTimeStr' }).html(timeStr))
                .append($('<div>', { id: 'EthnarIdDiv' }).html('Ethnar ID')
                    .append($('<input>', { id: 'EthnarId', type: 'text', style: 'margin-left:10px;',disabled:true }).val(id))
                    .append($('<div>',{class:'emptyFlex'}))
                    .append($('<button>',{ id:'delHouseBTN',class:'orangeBTN',onclick:'delHouse("'+id+'")'}).html('Unsubcribe'))
                )
                .append($('<div>', { id: 'HouseNameDiv' }).html('Owner')
                    .append($('<input>', { id: 'houseNameInput', type: 'text', style: 'margin-left:10px;'}).val(houseListObject[id]['name']))
                )
                .append($('<div>', { id: 'HouseNoteDiv' }).html('Location')
                    .append($('<input>', { id: 'houseLocationInput', type: 'text', style: 'margin-left:10px;'}).val(houseListObject[id]['location']))
                )
                .append($('<div>', { class: "nodeDataArea" })
                    .append($('<div>', { class: "nodeDataAreaTitle" }).append(langCompared['item'][langNow]))
                    .append(itemData)
                    .append($('<div>', { class: "nodeDataArea" })
                        .append($('<div>', { class: "nodeDataAreaTitle" }).append(langCompared['note'][langNow]))
                        .append($('<textarea>', {
                            id: "note",
                            type: "text",
                            rows: "2",
                            autocomplete: "off"
                        }))
                    )
                    .append($('<div>', { class: "form-head", style: "justify-content: center;" })
                        .append($('<button>', { id:'houseinfoCancelBTN', onclick: "housePageShow()" }).append(langCompared['cancel'][langNow]))
                    )
                )
            if ('note' in rawData[selectedHouseId]) $('#note').val(rawData[selectedHouseId]['note'])
            $('#infoPage').show();
            $('#houseListPage').hide();
            $('#houseNameInput').on('change',()=>{modifyHouseInfo('name')})
            $('#houseLocationInput').on('change',()=>{modifyHouseInfo('location')})
            $('#note').on('change',()=>{makeNote(id)})
        }
        function delHouse(id){
            let housedata = {'func':'unsubcribe'}
            housedata['id'] = id
            showMsg(1,'Uploading in progress...');
            $('#delHouseBTN').hide();
            $('#houseinfoCancelBTN').hide();
            formData = new FormData();
            formData.append('housedata', JSON.stringify(housedata));
            fetch('/houseSubcribe', {method: 'POST', body: formData})
                .then(response => {return response.text();})
                .then(data => {
                    console.log(data)
                    try{
                        houseListObject = JSON.parse(data.replace(/'/g,'"'))
                        if(delPanding){
                            delPanding = 0;
                            housePageShow();
                        }
                        housePageShow();
                    }
                    catch{
                        alert(langCompared['serverErr'][langNow]);
                        housePageShow();
                    }
                })
        }
        function modifyHouseInfo(field){
            let housedata = {'func':'modify'}
            housedata['id'] = $('#EthnarId').val();
            if(field == 'name'){
                housedata['field'] = 'name';
                housedata['data'] = $('#houseNameInput').val();
            }
            else if(field == 'location'){
                housedata['field'] = 'location';
                housedata['data'] = $('#houseLocationInput').val();
            }
            showMsg(1,'Uploading in progress...');
            formData = new FormData();
            formData.append('housedata', JSON.stringify(housedata));
            fetch('/houseSubcribe', {method: 'POST', body: formData})
                .then(response => {return response.text();})
                .then(data => {
                    try{
                        houseListObject = JSON.parse(data.replace(/'/g,'"'))
                        showMsg(0)
                    }
                    catch{
                        alert(langCompared['serverErr'][langNow]);
                        showMsg(0)
                    }
                })
            
        }
        function makeNote(id){
            showMsg(1,'Uploading in progress...');
            let housedata = {}
            housedata['id'] = $('#EthnarId').val();
            housedata['note'] = $('#note').val();
            formData = new FormData();
            formData.append('housedata', JSON.stringify(housedata));
            fetch('/makeNote', {method: 'POST', body: formData})
                .then(response => {
                    rawData[jsonFromBackend['nodeMaping'][id]]['note'] = $('#note').val();
                    showMsg(0);
                })
        }
        function elitePageShow(){
            console.log(eliteRecord)
            // $('#infoPage').hide();
            // if($('#houseListPage').is(':visible'))$('#houseListPage').hide()
            // else $('#houseListPage').show()
            // if(jsonFromBackend['username'] == 'undefined'){
            //     $('#siginPage').show()
            //     $('#signIn').hide()
            //     $('#signUp').show()
            // }
            // else if(jsonFromBackend['username'] == 'unSigned'){
            //     $('#waitMessage').hide();
            //     $('#siginPage').show()
            //     $('#signUp').hide()
            //     $('#signIn').show()
            // }
            // else resetHousePage();
        }
        function noteExistingCheck(){
            let checkState = 0
            if(pathFindingArray.length != 0){
                checkState = confirm('This action will clear all node markers and display existing image nodes in red. Do you want to proceed?')
            }
            else checkState = 1
            if(checkState){
                showMsg(1,'Loading...')
                fetch('/GetNodeFigList')
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        } else {
                            throw new Error('Server response was not ok: ' + response.statusText);
                        }
                    })
                    .then(textData => {
                        try {
                            pathFindingArray = JSON.parse(textData)
                            // console.log(pathFindingArray)
                            pathPlainningState = 0
                            pathFinding();
                            planningMethodChange('Node')
                            for (id of pathFindingArray) $('#' + id).css({ 'background-color': '#ff0000' });
                            showMsg(0)

                        }
                        catch {
                            throw new Error('Server response was not expected: ' + textData);
                            console.log(textData)
                        }
                    })
                    .catch(error => {
                        // 這裡處理網絡錯誤和上面拋出的錯誤
                        showMsg(0)
                        console.error('There was a problem with the fetch operation:', error);
                        alert(langCompared['serverErr'][langNow]);
                    });
            }
        }
        
        window.onload = init;
    </script>
</head>

<body style="height: 100%; display: flex; flex-direction: column;user-select: none;visibility: hidden;">
    <div>
        <div id="pageContainer">
            <div id="mapMain" class="image-container" style="position:absolute; top:0px; left:0px;">
                <!-- <img id="imgMain" src="static/map/MainMap.jpg"
                    style=" transition: transform 0.05s ease;" /> -->
                <img id="imgMain" style=" transition: transform 0.05s ease;" />
                <!-- <img id="imgMain" src="https://i.ibb.co/0VgtJWV/Main-0-01.jpg"
                    style=" transition: transform 0.05s ease;" /> -->
                <!-- <img id="imgMain" src="https://i.ibb.co/WHFn1PD/Main-L.jpg"
                    style=" transition: transform 0.05s ease;" /> -->
            </div>
            <div id="mapMineHead" class="image-container" style="position:absolute; top:4531px; left:4058px;">
                <img id="imgMH" src="https://i.ibb.co/DYRdT4f/MH.jpg"
                    style=" transition: transform 0.05s ease;position: relative;" />
            </div>
            <div id="mapTT" class="image-container" style="position:absolute; top:856px; left:1493px;">
                <img id="imgTT" src="https://i.ibb.co/DfCrDYQ/TT.jpg"
                    style=" transition: transform 0.05s ease;position: relative;" />
            </div>
            <svg id="svgMain" style="position: absolute;top:0px; left:0px;pointer-events: none;"></svg>
            <svg id="svgMH" style="position: absolute;top:4531px; left:4058px;pointer-events: none;"></svg>
            <svg id="svgTT" style="position: absolute;top:856px; left:1493px;pointer-events: none;"></svg>
        </div>
    </div>
    <div style="display: flex; justify-content: center;">
        <!-- <div class="leftBottomDiv" style="left:300px">
            
        </div> -->
        <div id="searchNodeDiv" class="leftBottomDiv">
            <div id="btnDiv">
                <button id="search" onclick="search('start');">搜尋</button>
            </div>
        </div>
        <div id="mapEditDiv" class="leftBottomDiv" style="display: none;">
            <div id="routePage" style="width: 450px;">
                <div style="display: flex; align-items: center; padding: 10px;">
                    <div id="typeDiv" style="margin-right: 20px; width: 45px;">種類</div>
                    <div style="display: flex;">
                        <button id="mainstream" class="greenBTN"
                            style="width: auto; padding-left: 10px; padding-right: 10px;"
                            onclick="routeSel('mainstream');">幹道</button>
                        <button id="sidetrack" style="width: auto; padding-left: 10px; padding-right: 10px;"
                            onclick="routeSel('sidetrack');">支線</button>
                    </div>
                </div>
                <div style="display: flex; align-items: center; padding: 10px;">
                    <div id="colorDiv" style="margin-right: 20px; width: 45px;">顏色</div>
                    <div id="routeColorDiv" style="display: flex;"></div>
                </div>
            </div>
            <div id="nodePage">
                <div style="display: flex; align-items: center; padding: 10px; display: none;">
                    <button id="continueAdd" style="width:110px;" onclick="continueAdd();">獨立編號</button>
                </div>
                <div id="continueAddDiv">
                    <div style="display: flex; align-items: center; padding: 10px;">
                        <div id="prefixDiv" style="margin-right: 20px; width: 45px;">前綴</div>
                        <input id="prefix" type="text" pattern="[A-Za-z]+" class="text" style="width: 40px;">
                    </div>
                    <div style="display: flex; align-items: center; padding: 10px;">
                        <div id="suffixDiv" style="margin-right: 20px; width: 45px;">後綴</div>
                        <input id="suffix" type="text" pattern="[A-Za-z]+" class="text" style="width: 40px;">
                    </div>
                </div>
            </div>
            <div id="editDoneDiv">
                <button id="mapEditDone" onclick="mapEdit('done');">完成</button>
            </div>
        </div>
        <div id="canceldefaultNodeSelDiv" class="leftBottomDiv" style="display: none;">
            <button id="cancelNodeDefSel" onclick="setDefaultNode('cancel');">取消</button>
        </div>
        <div id="settingIconDiv" onclick="settingSwitch();">
            <img id="settingIcon" src="https://i.ibb.co/mTw3msS/Setting-02.png" style=" width: 50px;" />
        </div>
        <div id="msgDiv" style="z-index:99;"></div>
        <div id="msgDiv2" style="z-index: 99;">
            <div>=== cheat sheet ===</div>
            <table>
                <tr>
                    <td>AB</td><td>：</td><td>AB1</td>
                </tr>
                <tr>
                    <td>FT</td><td>：</td><td>FT7</td>
                </tr>
                <tr>
                    <td>MH</td><td>：</td><td>Q20</td>
                </tr>
                <tr>
                    <td>MV</td><td>：</td><td>MV1</td>
                </tr>
                <tr>
                    <td>NG</td><td>：</td><td>G9</td>
                </tr>
                <tr>
                    <td>PP</td><td>：</td><td>AMP18</td>
                </tr>
                <tr>
                    <td>QC</td><td>：</td><td>Q2</td>
                </tr>
                <tr>
                    <td>TT</td><td>：</td><td>TT1</td>
                </tr>
                <tr>
                    <td>NSC</td><td>：</td><td>NSCB1</td>
                </tr>
            </table>
        </div>
        <div id="aimDiv" onclick="aim();">
            <img id="aimIcon" src="https://i.ibb.co/rstHZtH/aim.png" style=" width: 50px;" />
        </div>
        <div id="importDiv" onclick="jsonImport();">
            <img id="importIcon" src="https://i.ibb.co/K5HpvPQ/json.png" style=" width: 50px;" />
        </div>
        <div id="pathDiv" onclick="pathFinding();">
            <img id="pathIcon" style=" width: 50px;" />
        </div>
        <div id="houseDiv" onclick="housePageShow();">
            <img id="houseIcon" style=" width: 50px;" />
        </div>
        <div id="eliteDiv" onclick="elitePageShow();" style="visibility: hidden;">
            <img id="eliteIcon" style=" width: 50px;" />
        </div>
        <div id="planningMethodDiv" class="leftBottomDiv" style="display: none;">
            <button id="setAsPath" onclick="planningMethodChange('Path');">Path</button>
            <button id="setAsNode" onclick="planningMethodChange('Node');">Node</button>
            <button onclick="planningMethodChange('ShortCut');">ShortCut</button>
            <button onclick="noteExistingCheck();">Image Existence</button>
        </div>
        <div id="cleanDiv" onclick="cleanPath();" style="display: none;">
            <img id="cleanIcon" style=" width: 50px;" />
        </div>
        <div id="syncDiv" onclick="updateRawdata();">
            <img id="syncIcon" src="https://i.ibb.co/DzKh7bB/symc.png" style=" width: 50px;" />
        </div>
        <div id="infoPage" style="display: none;"></div>
        <!-- <div id="houseListPage">
            <div id="siginPage" style="display: flex;"> -->
        <div id="houseListPage" style="display: none;">
            <div id="siginPage" style="display: none;">
                <div id="signUp" class="flex" style=" align-items: center;">
                    <div class="flex">Your name　</div>
                    <input id="userNameInput" type="text"/>
                    <button onclick="signUp();">Register</button>
                </div>
                <div id="signIn" class="flex" style="display: flex;">
                    <button id="logInBTN" onclick="logIn();">Log in(Google)</button>
                </div>
            </div>
            
            <div id="houseAddingDiv" style="display: none;">
                <div class="row">
                    <div class="houseInputTitle">House Id　</div>
                    <input id="houseIdInput" type="text" autocomplete="off"/>
                </div>
                <div class="row">
                    <div class="houseInputTitle">Owner　</div>
                    <input id="houseNameInput" type="text" autocomplete="off"/>
                </div>
                <div class="row">
                    <div class="houseInputTitle">Location　</div>
                    <input id="houseLocationInput" type="text" autocomplete="off"/>
                </div>
                <div id="houseFormBTN" class="row">
                    <button onclick="addingHouse('submit');">OK</button>
                    <button onclick="addingHouse('cancel');">Cancel</button>
                </div>
            </div>
            <div id="houseList" class="storage-container" style="display: none;"></div>
        </div>
        <div id="settingPage" style="display: none;"></div>
        <div id="settingPageMobile" class='searchSettingPage'></div>
        <div id="jsonInputDiv">
            JSON Input :
            <input id="jsonStrInput" type="text" style="margin-left: 10px;width: 80px;height: 25px;" />
            <button id="jsonSubmitBTN" onclick="parseData();" style="width: 100px;">Submit</button>
        </div>
        <div id="settingManu" style="display: none;">
            <div>Version<span id="versionNum"></span></div>
            <div style="display:flex; align-items: center;justify-content: space-between;"><span
                    id="display">儲存頁面設定　</span><button id="setDefault" onclick="goUrl();">設為預設</button></div>
            <input id="urlInput" class="text" type="text" style="display:none;" disabled />
            <div style="display:flex; align-items: center;justify-content: space-between;"><span
                    id="langSwitch">切換語言</span><button id="langBTN" onclick="langChange();">English</button></div>
            <div style="display:flex; align-items: center;justify-content: space-between;">
                <span id="nodeScaleSwitch">節點大小</span><input type="range" id="nodeScaleControl" min="1" max="10"
                    value="3" step="1">
            </div>

            <!-- <div id="nodeScaleValue">1</div> -->
            <script>
                // 獲取滑動條元素
                var slider = document.getElementById('nodeScaleControl');

                // 滑動條滑動事件，暫時不更新數值
                slider.oninput = function () {
                    // 不立即更新，僅用於展示如何綁定事件
                }

                // 滑鼠按鍵放開或觸摸結束時更新數值
                function updateVolume() {
                    var value = slider.value;
                    // document.getElementById('nodeScaleValue').textContent = value;

                    nodeScaleNow = 4 / value;
                    $('.interactive-circle').css({ width: 30 / nodeScaleNow + 'px', height: 30 / nodeScaleNow + 'px', fontSize: 20 / nodeScaleNow + 'px' })
                    $('.interactive-circle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                    $('.blackCircle').css('border', 5 / nodeScaleNow + 'px #000000 solid')
                    $('.redCircle').css('border', 5 / nodeScaleNow + 'px #ff0000 solid')
                    $('.orangeCircle').css('border', 5 / nodeScaleNow + 'px #ffb100 solid')
                    $('.yellowCircle').css('border', 5 / nodeScaleNow + 'px #ffff00 solid')
                    $('.greenCircle').css('border', 5 / nodeScaleNow + 'px #00ff00 solid')
                    $('line').remove()
                    for (routeIndex in mapRouteMain) drawLineBetweenCircles(mapRouteMain[routeIndex]['start'], mapRouteMain[routeIndex]['end'], mapRouteMain[routeIndex]['color'], mapRouteMain[routeIndex]['width'], 'Main', 'Link');
                    for (routeIndex in mapRouteMH) drawLineBetweenCircles(mapRouteMH[routeIndex]['start'], mapRouteMH[routeIndex]['end'], mapRouteMH[routeIndex]['color'], mapRouteMH[routeIndex]['width'], 'MH', 'Link');
                    for (routeIndex in mapRouteTT) drawLineBetweenCircles(mapRouteTT[routeIndex]['start'], mapRouteTT[routeIndex]['end'], mapRouteTT[routeIndex]['color'], mapRouteTT[routeIndex]['width'], 'TT', 'Link');
                    for (pathData of mapRouteMain) {
                        if ('bAP' in pathData) {
                            (function (pathData) {
                                $('#' + pathData['start'] + 'Link' + pathData['end']).mouseenter(function (e) {
                                    $('.info-tag').text(pathData['bAP'])
                                        .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                                }).mouseleave(function () {
                                    $('.info-tag').hide();
                                });
                            })(pathData); // 使用IIFE将当前pathData传递给函数
                        }
                    }
                    for (pathData of mapRouteMH) {
                        if ('bAP' in pathData) {
                            (function (pathData) {
                                $('#' + pathData['start'] + 'Link' + pathData['end']).mouseenter(function (e) {
                                    $('.info-tag').text(pathData['bAP'])
                                        .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                                }).mouseleave(function () {
                                    $('.info-tag').hide();
                                });
                            })(pathData); // 使用IIFE将当前pathData传递给函数
                        }
                    }
                    for (pathData of mapRouteTT) {
                        if ('bAP' in pathData) {
                            (function (pathData) {
                                $('#' + pathData['start'] + 'Link' + pathData['end']).mouseenter(function (e) {
                                    $('.info-tag').text(pathData['bAP'])
                                        .css({ top: e.pageY + 50 + 'px', left: e.pageX - 10 + 'px', display: 'block' });
                                }).mouseleave(function () {
                                    $('.info-tag').hide();
                                });
                            })(pathData); // 使用IIFE将当前pathData传递给函数
                        }
                    }
                }

                // 為滑動條添加滑鼠按鍵放開事件監聽器
                slider.addEventListener('mouseup', updateVolume);

                // 為滑動條添加觸摸結束事件監聽器
                slider.addEventListener('touchend', updateVolume);

                // function nodeScale(value) {
                //     // document.getElementById('nodeScaleValue').textContent = value;
                //     nodeScaleNow = value;
                //     loadingCount = 8;
                //     onReload();
                // }
            </script>
            <div style="display:flex; align-items: center;justify-content: space-between;"><span
                    id="nodeIdSwitch">節點ID</span><button id="nodeIdSwitchBTN" onclick="nodeIdSwitch();">隱藏</button>
            </div>
            <div style="display:flex; align-items: center;justify-content: space-between;">
                <span id="mapEdit">編輯地圖</span>
                <button id="nodeEditBTN" onclick="mapEdit('node');">節點</button>
                <button id="routeEditBTN" onclick="mapEdit('route');">路徑</button>
            </div>
            <div style="display:flex; align-items: center;justify-content: space-between;"><span
                    id="defaultNode">起始節點</span><button id="setDefaultNode"
                    onclick="setDefaultNode('set');">W25</button></div>
            <div style="display:flex; align-items: center;justify-content: space-between;"><span
                    id="guide">說明文件</span><button onclick="guide();">OPEN</button></div>
            <div style="display: flex;justify-content: flex-end;">
                <button id="settingCancel" onclick="$('#settingManu').hide();">取消</button>
            </div>
        </div>
        <div class="info-tag"
            style="position: absolute; display: none;border-radius: 5px; border: 1px solid;background-color: #b1b1b1;padding: 5px;white-space: nowrap;">
        </div>
        <div id="waitMessage" style="visibility: visible;">
            <div style="display: flex;">
                Loading...(<span id="loadCount">0</span>/<span id="totalLoadCount">13</span>)
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <!-- <div id="searchSettingPage" style="display: none;"></div> -->
    <div id="getDataDiv" style="display: none;">{{data}}</div>
</body>

<script>
    if (urlNow.searchParams.has('miniMap') && urlNow.searchParams.get('miniMap') == 'Y') {
        $('#imgMain').attr('src', staticPath + 'static/map/MainMapMini.jpg')
    }
    else $('#imgMain').attr('src', staticPath + 'static/map/MainMap.jpg')
    $('#pathIcon').attr('src', staticPath + 'static/icon/path.jpg')
    $('#houseIcon').attr('src', staticPath + 'static/icon/hut.jpg')
    $('#eliteIcon').attr('src', staticPath + 'static/icon/elite.jpg')
    $('#cleanIcon').attr('src', staticPath + 'static/icon/clean.jpg')
    var img = document.getElementById('imgMain');
    var img2 = document.getElementById('imgMH');
    var img3 = document.getElementById('imgTT');
    img.onload = dataOnLoad();
    img2.onload = dataOnLoad();
    img3.onload = dataOnLoad();
    let scale = 1;
    const content = document.getElementById('pageContainer');
    content.style.transformOrigin = '0 0'; // 初始的變換原點設置為左上角

    function onWheel(event) {
        // 获取目标元素，即您想要检查鼠标是否在其上的元素
        var targetElement = document.getElementById('settingPage');
        // 确定鼠标位置
        var rect = targetElement.getBoundingClientRect();
        var rect1 = content.getBoundingClientRect();
        var isInDiv =
            event.clientX >= rect.left &&
            event.clientX <= rect.right &&
            event.clientY >= rect.top &&
            event.clientY <= rect.bottom;

        var targetElement2 = document.getElementById('searchNodeDiv');

        // 确定鼠标位置
        var rect2 = targetElement2.getBoundingClientRect();
        var isInDiv2 =
            event.clientX >= rect2.left &&
            event.clientX <= rect2.right &&
            event.clientY >= rect2.top &&
            event.clientY <= rect2.bottom;

        var targetElement3 = document.getElementById('infoPage');

        // 确定鼠标位置
        var rect3 = targetElement3.getBoundingClientRect();
        var isInDiv3 =
            event.clientX >= rect3.left &&
            event.clientX <= rect3.right &&
            event.clientY >= rect3.top &&
            event.clientY <= rect3.bottom;

        var targetElement4 = document.getElementById('houseListPage');

        // 确定鼠标位置
        var rect4 = targetElement4.getBoundingClientRect();
        var isInDiv4 =
            event.clientX >= rect4.left &&
            event.clientX <= rect4.right &&
            event.clientY >= rect4.top &&
            event.clientY <= rect4.bottom;
        if (isInDiv || isInDiv2 || isInDiv3 || isInDiv4) {
            // 如果鼠标在目标元素上，则允许默认滚动行为
            // 注意：由于您之前已经禁用了默认行为，这里您可能需要手动实现滚动，
            // 或者根据需要调整事件监听器的结构
            return;
        }
        else {
            // 阻止默认滚动行为
            event.preventDefault();

            // 在这里执行您的缩放逻辑
            // ...
        }
        
        // 獲取滾輪事件的座標
        const mouseX = event.clientX;
        const mouseY = event.clientY;

        // 計算滑鼠相對於元素的位置，考慮當前的縮放
        const relX = (mouseX - rect1.left) * (1 / scale);
        const relY = (mouseY - rect1.top) * (1 / scale);

        // 計算新的縮放級別
        let newScale = scale - event.deltaY * 0.003;

        // 如果新的縮放級別超出範圍，不要進行縮放
        if (newScale < 0.1 || newScale > 4) {
            return; // 直接返回，不做任何事情
        }


        // 設置變換原點為滑鼠當前的位置，考慮當前的縮放
        content.style.transformOrigin = `${relX}px ${relY}px`;

        // 應用縮放
        content.style.transform = `scale(${newScale})`;

        // 更新當前縮放級別
        scale = newScale;
        sacleRatio = scale
    }
    // 使用非被動（non-passive）事件監聽器來覆蓋默認的被動（passive）行為
    document.addEventListener('wheel', onWheel, { passive: false });
    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        if (document.getElementById(elmnt.id + "header")) {
            // if present, the header is where you move the DIV from:
            document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
        } else {
            // otherwise, move the DIV from anywhere inside the DIV:
            elmnt.onmousedown = dragMouseDown;
        }

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            // stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }
    let initialDistance = null;

    let initialScale = scale;
    let initialTouchMidpoint = { x: 0, y: 0 };

    content.addEventListener('touchstart', function (e) {
        if (e.touches.length === 2) {
            // 如果有兩個觸點，則開始縮放
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            initialDistance = Math.sqrt(Math.pow(touch2.clientX - touch1.clientX, 2) + Math.pow(touch2.clientY - touch1.clientY, 2));
            initialScale = scale;

            // 計算並存儲兩個觸點的中心點
            initialTouchMidpoint = {
                x: (touch1.clientX + touch2.clientX) / 2,
                y: (touch1.clientY + touch2.clientY) / 2
            };
            const rect = content.getBoundingClientRect();
            const relX = (initialTouchMidpoint.x - rect.left) * (1 / scale);
            const relY = (initialTouchMidpoint.y - rect.top) * (1 / scale);
            content.style.transformOrigin = `${relX}px ${relY}px`;
            e.preventDefault();
        }
    }, { passive: false });

    content.addEventListener('touchmove', function (e) {
        if (e.touches.length === 2) {
            // 如果有兩個觸點，則計算縮放比例
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            const currentDistance = Math.sqrt(Math.pow(touch2.clientX - touch1.clientX, 2) + Math.pow(touch2.clientY - touch1.clientY, 2));
            const scaleChange = currentDistance / initialDistance;

            const newScale = initialScale * scaleChange;
            // 如果新的縮放級別超出範圍，不要進行縮放
            if (newScale < 0.7 || newScale > 6) {
                return; // 直接返回，不做任何事情
            }
            // scale = initialScale * scaleChange;



            content.style.transform = `scale(${newScale})`;
            scale = newScale;
            e.preventDefault();
        }
    }, { passive: false });

    content.addEventListener('touchend', function (e) {
        if (e.touches.length < 2) {
            initialDistance = null;
        }
    });
    document.getElementById('houseIdInput').addEventListener('keypress', function (e) {
        if (event.keyCode === 13)$('#houseNameInput').focus();
    }
    )
    document.getElementById('houseNameInput').addEventListener('keypress', function (e) {
        if (event.keyCode === 13)$('#houseLocationInput').focus();
    }
    )
    document.getElementById('houseLocationInput').addEventListener('keypress', function (e) {
        if (event.keyCode === 13)addingHouse('submit');
    }
    )
</script>

</html>